import{c as clamp,l as lerp,a as clamp01,T as TypedMessenger,M as MapLoadError,B as BufferGeometry,b as BufferAttribute,d as Mesh,O as Object3D,e as Matrix4,p as processedSkinNames,t as traverseObject,V as Vector3,Q as Quaternion,D as DoubleSide,f as BackSide,A as AdditiveBlending,S as Scene,P as PlaneGeometry,C as Color,g as ShaderMaterial,F as FrontSide,h as Box3,i as Sphere,j as Vector2,k as PerspectiveCamera,m as mod,n as teamColors,o as modMinMax,E as Euler,q as mapValue,r as iLerp,L as Line3,s as LineBasicMaterial,u as Line,I as IcosahedronGeometry,v as hsvToRgb,w as rgbToHsv,x as SphereGeometry,y as Texture,N as NearestFilter,z as smoothClamp,W as WebGLRenderer,G as sRGBEncoding}from"./colors-15d54d87.js";!function(){function t(t,e){var i=new XMLHttpRequest;i.onreadystatechange=function(){4===i.readyState&&e(i.responseText)},i.open("GET",t,!0),i.send()}function e(t,e,i){Object.defineProperty?Object.defineProperty(t,e,i):t[e]=i.get()}var i,s=window.CSS;s||(window.CSS=s={}),s.supports||(s.supports=function t(e,i){if("paint"==e)return!0;if(i){var s=d.contentDocument.body;return s.style.cssText=e+":"+i,s.style.cssText.length>0}for(var n,a,o,r,l=/(^|not|(or)|(and))\s*\(\s*(.+?)\s*:(.+?)\)\s*|(.)/gi;o=l.exec(e);){if(o[6])return!1;r=t(o[4],o[5]),a=o[2]?a||r:o[3]?a&&r:(n=!o[1],r)}return a==n}),s.escape||(s.escape=function(t){return t.replace(/([^\w-])/g,"\\$1")});var n={};function a(t,e){var i=parseFloat(t);this.value=isNaN(i)?t:i,this.unit=e}s.registerProperty||(s.registerProperty=function(t){n[t.name]=t}),a.prototype.toString=function(){return this.value+("number"==this.unit?"":this.unit)},a.prototype.valueOf=function(){return this.value},"Hz Q ch cm deg dpcm dpi ddpx em ex fr grad in kHz mm ms number pc percent pt px rad rem s turn vh vmax vmin vw".split(" ").forEach((function(t){s[t]||(s[t]=function(e){return new a(e,t)})}));var o=/(background|mask|cursor|-image|-source)/,r=!!s.paintWorklet;r||(i=new nt,e(s,"paintWorklet",{enumerable:!0,configurable:!0,get:function(){return i}}));var l="css-paint-polyfill",h=document.createElement(l);r||document.documentElement.appendChild(h);var d=document.createElement("iframe");d.style.cssText="position:absolute; left:0; top:-999px; width:1px; height:1px;",h.appendChild(d);var c=document.createElement("style");c.id=l,c.$$isPaint=!0,h.appendChild(c);var u=c.sheet,p=h.style,g=!1,m=[],f=/(paint\(|-moz-element\(#paint-|-webkit-canvas\(paint-|[('"]blob:[^'"#]+#paint=|[('"]data:image\/paint-)/,w="getCSSCanvasContext"in document,b=(p.backgroundImage="-moz-element(#"+l+")")===p.backgroundImage,y="function"==typeof Promise;p.cssText="display:none !important;";var S=window.requestAnimationFrame||setTimeout,C=function(){return window.devicePixelRatio||1},v={},M={},k=0;function P(t){var e=t.bit^=1;return t.instances[e]||(t.instances[e]=new t.Painter)}function I(t,e){var i=t.cssText,s=f.test(i);if(!0===e.isNew&&s&&i!==(i=O(i))&&(t=function(t,e){for(var i=t.parentStyleSheet,s=t.parentRule,n=(s||i).cssRules,a=n.length-1,o=0;o<=a;o++)if(n[o]===t){(s||i).deleteRule(o),a=o;break}if(null!=e){if(s){var r=s.appendRule(e);return s.cssRules[r]}return i.insertRule(e,a),i.cssRules[a]}}(t,i)),s){var n,a,o,r=t.selectorText,l=G(t.style);if(n=null==e.counters[r]?e.counters[r]=1:++e.counters[r],null!=M[a="sheet"+e.sheetId+"\n"+r+"\n"+n]){if((o=M[a]).selector===r)return o.rule=t,void(o.cssText!==l&&e.toProcess.push(o));e.toRemove.push(o)}else o=M[a]={key:a,selector:r,cssText:l,properties:{},rule:t},e.toProcess.push(o.selector)}}function A(t,e){if(!("ownerSVGElement"in t)){e(t);for(var i=t.firstElementChild;i;)A(i,e),i=i.nextElementSibling}}function x(){for(var t,e=[].slice.call(document.styleSheets),i={toProcess:[],toRemove:[],counters:{},isNew:!1,sheetId:null,rules:null},s=0;s<e.length;s++){var n=e[s].ownerNode;if(!n.$$isPaint){try{i.rules=n.sheet.cssRules}catch(t){continue}if(i.sheetId=n.$$paintid,i.isNew=null==i.sheetId,i.isNew){if(i.sheetId=n.$$paintid=++k,!1===E(n))continue;t=!0}L(n.sheet,I,i)}}for(var a=i.toRemove.length;a--;)delete M[i.toRemove[a].key];i.toProcess.length>0&&H(i.toProcess.join(", ")),t&&H("[data-css-paint]",!0)}function L(e,i,s){var n=[[0,e.cssRules]],a=n[0],o=a[1];if(o)for(var r=0;n.length>0;r++)if(r>=o.length){n.pop();var l=n.length;l>0&&(o=(a=n[l-1])[1],r=a[0])}else{a[0]=r;var h=o[r];if(3!==h.type)if(1===h.type){var d=i(h,s);void 0!==d&&(s=d)}else h.cssRules&&h.cssRules.length>0&&n.push([0,h.cssRules]);else{if(h.$$isPaint)continue;var c=h.media&&h.media.mediaText;if(c&&!self.matchMedia(c).matches)continue;if(/ts\.g.{7}is\.com\/css/.test(h.href))continue;h.$$isPaint=!0,t(h.href,T)}}return s}function E(e){if(!e.$$isPaint){if(e.href)return t(e.href,T),!1;for(var i=e.childNodes.length;i--;){var s=e.childNodes[i].nodeValue,n=O(s);n!==s&&(e.childNodes[i].nodeValue=n)}}}function T(t){var e=function(t){var e=d.contentDocument.body,i=document.createElement("style");return i.media="print",i.$$paintid=++k,i.appendChild(document.createTextNode(t)),e.appendChild(i),i.sheet.remove=function(){return e.removeChild(i)},i.sheet}(O(t));try{e._=e.cssRules.length}catch(t){var i=function(){e&&D(e),e=null,clearTimeout(s)};e.ownerNode.onload=e.ownerNode.onerror=i;var s=setTimeout(i,5e3);return}D(e)}function D(t){var e="";if(L(t,(function(t){if(1===t.type){for(var i="",s=0;s<t.style.length;s++){var n=t.style.item(s),a=t.style.getPropertyValue(n);f.test(a)&&(i=n+": "+a+t.style.getPropertyPriority(n)+";")}if(i){i=t.selectorText+"{"+i+"}";for(var o=t;o=o.parentRule;)i=""+o.cssText.match(/^[\s\S]+?\{/)[0]+i+"}";e+=i}}})),t.remove(),e){var i=document.createElement("style");i.appendChild(document.createTextNode(e)),h.appendChild(i),x()}}function O(t){return t.replace(/( |;|,|\b)paint\s*\(\s*(['"]?)(.+?)\2\s*\)( |;|,|!|\b|$)/g,"$1url(data:image/paint-$3,=)$4")}var F,V,R,B=[];function U(t,e){e&&(t.$$paintObservedProperties=null,t.$$paintGeometry&&!t.$$paintGeometry.live&&(t.$$paintGeometry=null)),!0!==t.$$paintPending&&(t.$$paintPending=!0,-1===B.indexOf(t)&&1===B.push(t)&&S(N))}function N(){for(var t,e=0;e<B.length;e++)B[e]&&"style"===B[e].localName&&(t=!0,B[e]=null);if(t)return S(N),void x();var i=B.length&&B.some((function(t){return t&&!0===t.$$needsOverrides}));for(i&&X();B.length;){var s=B.pop();s&&_(s)}i&&Z()}function H(t,e){try{for(var i=document.querySelectorAll(t),s=0;s<i.length;s++)U(i[s],e)}catch(t){}}function W(t,e,i){for(var s=t.length,n=function(){--s||e.apply(null,i||m)},a=0;a<t.length;a++){var o=new Image;o.onload=n,o.onerror=onerror,o.src=t[a]}}function q(t){var e=t.$$paintId;return null==e&&(e=t.$$paintId=++Y),e}function j(t){var e=t.$$paintRule,i=q(t);if(Number(t.getAttribute("data-css-paint"))!==i&&t.setAttribute("data-css-paint",i),null==e){var s=u.insertRule('[data-css-paint="'+i+'"] {}',u.cssRules.length);e=t.$$paintRule=u.cssRules[s]}return e}function G(t){var e=t.cssText;if(e)return e;e="";for(var i=0,s=void 0;i<t.length;i++)0!==i&&(e+=" "),e+=s=t[i],e+=":",e+=t.getPropertyValue(s),e+=";";return e}function _(t){var e=getComputedStyle(t);if(t.$$paintObservedProperties&&!t.$$needsOverrides)for(var i=0;i<t.$$paintObservedProperties.length;i++){var s=t.$$paintObservedProperties[i];if(e.getPropertyValue(s).trim()!==t.$$paintedPropertyValues[s]){K(t,e);break}}else if(t.$$paintId||f.test(G(e)))K(t,e);else{var n=t.getAttribute("style");f.test(n)&&(t.style.cssText=n.replace(/;\s*$/,"")+"; "+t.style.cssText,K(t))}t.$$paintPending=!1}function z(t){t.$$paintGeometry&&!t.$$paintGeometry.live&&(t.$$paintGeometry=null),U(t)}var $={get:function(t){var e=n[t],i=e&&!1===e.inherits?V.style.getPropertyValue(t):$.getRaw(t);if(null==i&&e)i=e.initialValue;else if(e&&e.syntax){var a=e.syntax.replace(/[<>\s]/g,"");"function"==typeof s[a]&&(i=s[a](i))}return"string"==typeof i&&(i=i.trim()),i},getRaw:function(t){if(t in R)return R[t];var e=F.getPropertyValue(t);return"string"==typeof e&&(e=e.trim()),R[t]=e}},J=window.ResizeObserver&&new window.ResizeObserver((function(t){for(var e=0;e<t.length;e++){var i=t[e],s=i.target.$$paintGeometry;s?s.live=!0:s=i.target.$$paintGeometry={width:0,height:0,live:!0};var n=i.borderBoxSize;if(n&&n.length&&(n=n[0]),n)s.width=0|n.inlineSize,s.height=0|n.blockSize;else{var a=getComputedStyle(i.target),o=parseFloat(a.paddingLeft)+parseFloat(a.paddingRight),r=parseFloat(a.paddingTop)+parseFloat(a.paddingBottom);s.width=Math.round((i.contentRect.right-i.contentRect.left||i.contentRect.width)+o),s.height=Math.round((i.contentRect.bottom-i.contentRect.top||i.contentRect.height)+r)}U(i.target,!0)}})),Y=0;function K(t,e){!0===t.$$needsOverrides&&X();var i,s=F=null==e?getComputedStyle(t):e;V=t,R={};var n=[];t.$$paintPending=!1;var a=function(t){return t.$$paintGeometry||(t.$$paintGeometry={width:t.clientWidth,height:t.clientHeight,live:!1})}(t);!function(t){J&&!t.$$paintGeometry.live&&(t.$$paintGeometry.live=!0,J.observe(t))}(t),a={width:a.width,height:a.height};for(var r=C(),l=t.$$paintedProperties,d=0;d<s.length;d++){var c=s[d],u=$.getRaw(c),p=/(,|\b|^)(?:url\((['"]?))?((?:-moz-element\(#|-webkit-canvas\()paint-\d+-([^;,]+)|(?:data:image\/paint-|blob:[^'"#]+#paint=)([^"';, ]+)(?:[;,].*?)?)\2\)(;|,|\s|\b|$)/g,g="",m=0,f=[],y=!1,S=!1,M=void 0,k=void 0,I=!1,A=a;if(o.test(c)&&"-webkit-border-image"!==c){if(/border-image/.test(c)){var x=A.width,L=A.height,E=st($.getRaw("border-image-slice").replace(/\sfill/,"").split(" ")),T=st($.getRaw("border-width").split(" ")),D=st($.getRaw("border-image-outset").split(" "));x+=it("0"!=E.left&&parseFloat(T.left)||0,D.left||0,!0),x+=it("0"!=E.right&&parseFloat(T.right)||0,D.right||0,!0),L+=it("0"!=E.top&&parseFloat(T.top)||0,D.top||0,!0),I=!0,A={width:x,height:L+=it("0"!=E.bottom&&parseFloat(T.bottom)||0,D.bottom||0,!0)}}for(;k=p.exec(u);){!1===S&&(M=q(t)),S=!0,g+=u.substring(0,k.index);var O=k[4]||k[5],B=k[3],U=v[O],N=U&&U.Painter.contextOptions||{},H=I||!1===N.scaling?1:r,G=void 0;U&&(U.Painter.inputProperties&&n.push.apply(n,U.Painter.inputProperties),G=P(U)),!0===N.nativePixels&&(A.width*=r,A.height*=r,H=1);var _=H*A.width,z=H*A.height,Y=t.$$paintContext,K="paint-"+M+"-"+O,Q=Y&&Y.canvas;if(!Q||Q.width!=_||Q.height!=z||!0===w&&Y&&K!==Y.id){if(!0===w)(Y=document.getCSSCanvasContext("2d",K,_,z)).id=K,t.$$paintContext&&Y.clearRect(0,0,_,z);else{var nt=!1;Q||((Q=document.createElement("canvas")).id=K,nt=b),Q.width=_,Q.height=z,nt&&(Q.style.display="none",h.appendChild(Q)),Y=Q.getContext("2d")}t.$$paintContext=Y,Y.imageSmoothingEnabled=!1,1!==H&&Y.scale(H,H)}else Y.clearRect(0,0,_,z);if(G&&(Y.save(),Y.beginPath(),G.paint(Y,A,$),Y.closePath(),Y.restore(),!1===w&&!b&&"resetTransform"in Y&&Y.resetTransform()),g+=k[1],!0===w)g+="-webkit-canvas("+K+")",(null==k[4]||Q&&Q.id!==K)&&(y=!0);else if(!0===b)g+="-moz-element(#"+K+")",null==k[4]&&(y=!0),Q&&Q.id!==K&&(Q.id=K,y=!0);else{var at=Q.toDataURL("image/png").replace("/png","/paint-"+O);if("function"==typeof MSBlobBuilder&&(at=tt(at,O)),f.push(at),g+='url("'+at+'")',at!==B||!i){var ot=B?B.indexOf("#"):-1;~ot&&URL.revokeObjectURL(B.substring(0,ot)),y=!0}B=at}g+=k[6],m=k.index+k[0].length}!1!==S||null==l||null==l[c]?(g+=u.substring(m),y&&(i||(i=j(t)),null==l&&(l=t.$$paintedProperties={}),l[c]=!0,"background"===c.substring(0,10)&&1!==r&&et(i.style,"background-size","100% 100%"),/mask/.test(c)&&1!==r&&(et(i.style,"mask-size","contain"),w&&et(i.style,"-webkit-mask-size","contain")),/border-image/.test(c)&&w&&(et(i.style,"border-color","initial"),et(i.style,"image-rendering","optimizeSpeed")),0===f.length?et(i.style,c,g):W(f,et,[i.style,c,g]))):(i||(i=j(t)),i.style.removeProperty(c),J&&J.unobserve(t),t.$$paintGeometry&&(t.$$paintGeometry.live=!1))}}t.$$paintObservedProperties=0===n.length?null:n;for(var rt=t.$$paintedPropertyValues={},lt=0;lt<n.length;lt++){var ht=n[lt];rt[ht]=$.getRaw(ht)}!0===t.$$needsOverrides&&Z(),t.$$needsOverrides=null}var Q=0;function X(){Q++||(c.disabled=!0)}function Z(){--Q||(c.disabled=!1)}function tt(t,e){for(var i=atob(t.split(",")[1]),s=new Uint8Array(i.length),n=0;n<i.length;n++)s[n]=i.charCodeAt(n);return URL.createObjectURL(new Blob([s]))+"#paint="+e}function et(t,e,i){var s=g;g=!0,t.setProperty(e,i,"important"),g=s}function it(t,e,i){var s=i?0:t,n=parseFloat(e);return e?e.match("px")?s+n:(e.match("%")&&(n/=100),t*n):s}function st(t){return{top:t[0],bottom:t[2]||t[0],left:t[3]||t[1]||t[0],right:t[1]||t[0]}}function nt(){}if(nt.prototype.addModule=function(i){var s,n,a=this;return y&&(s=new Promise((function(t){return n=t}))),t(i,(function(t){var i={registerPaint:function(t,e){!function(t,e,i){v[t]={worklet:i,Painter:e,properties:e.inputProperties?[].slice.call(e.inputProperties):[],bit:0,instances:[]};for(var s="",n=u.cssRules.length;n--;){var a=u.cssRules[n];-1!==a.style.cssText.indexOf("-"+t)&&(s+=a.selectorText)}s&&H(s,!0)}(t,e,{context:i,realm:s})}};e(i,"devicePixelRatio",{get:C}),i.self=i;var s=new function(t,e){var i=document.createElement("iframe");i.style.cssText="position:absolute; left:0; top:-999px; width:1px; height:1px;",e.appendChild(i);var s=i.contentWindow,n=s.document,a="var window,$hook";for(var o in s)o in t||"eval"===o||(a+=",",a+=o);for(var r in t)a+=",",a+=r,a+="=self.",a+=r;var l=n.createElement("script");l.appendChild(n.createTextNode('function $hook(self,console) {"use strict";\n\t\t'+a+";return function() {return eval(arguments[0])}}")),n.body.appendChild(l),this.exec=s.$hook(t,console)}(i,d.contentDocument&&d.contentDocument.body||h);t=(a.transpile||String)(t),s.exec(t),n&&n()})),s},!r)try{!function(){var t=!1;new MutationObserver((function(e){if(!0!==t&&!Q){t=!0;for(var i=0;i<e.length;i++){var s=e[i],n=s.target,a=void 0,o=void 0;if(!n||!("ownerSVGElement"in n))if("childList"===s.type){if(a=s.addedNodes)for(var r=0;r<a.length;r++)1===a[r].nodeType&&A(a[r],U);if(o=s.removedNodes)for(var l=0;l<o.length;l++)J&&o[l].$$paintGeometry&&(o[l].$$paintGeometry.live=!1,J&&J.unobserve(o[l]))}else if("attributes"===s.type&&1===n.nodeType){if("data-css-paint"===s.attributeName&&s.oldValue&&null!=n.$$paintId&&!n.getAttribute("data-css-paint")){q(n);continue}A(n,z)}}t=!1}})).observe(document.body,{childList:!0,attributes:!0,attributeOldValue:!0,subtree:!0});var i=Object.getOwnPropertyDescriptor(Element.prototype,"setAttribute"),s=i.value;i.value=function(t,e){return"style"===t&&f.test(e)&&(e=O(e),q(this),this.$$needsOverrides=!0,z(this)),s.call(this,t,e)},e(Element.prototype,"setAttribute",i);var n=Object.getOwnPropertyDescriptor(Element.prototype,"removeAttribute"),a=n.value;n.value=function(t){if("data-css-paint"!==t)return a.call(this,t)},e(Element.prototype,"removeAttribute",n);var r=Object.getOwnPropertyDescriptor(HTMLElement.prototype,"style"),l=r.get;r.set=function(t){return r.get.call(this).cssText=t},r.get=function(){var t=l.call(this);return t.ownerElement!==this&&e(t,"ownerElement",{value:this}),t},e(HTMLElement.prototype,"style",r);var h={},d=Object.getOwnPropertyDescriptor(CSSStyleDeclaration.prototype,"cssText"),c=d.set;d.set=function(t){if(!Q&&f.test(t)){t=t&&O(t);var e=this.ownerElement;e&&(q(e),e.$$needsOverrides=!0,z(e))}return c.call(this,t)},h.cssText=d,Object.keys((window.CSS2Properties||CSSStyleDeclaration).prototype).filter((function(t){return o.test(t)})).forEach((function(t){var e=t.replace(/([A-Z])/g,"-$1").toLowerCase();h[t]={configurable:!0,enumerable:!0,get:function(){var t=this.getPropertyPriority(e);return this.getPropertyValue(e)+(t?" !"+t:"")},set:function(i){var s=String(i).match(/^(.*?)\s*(?:!\s*(important)\s*)?$/);return this.setProperty(e,s[1],s[2]),this[t]}}}));var u=Object.getOwnPropertyDescriptor(CSSStyleDeclaration.prototype,"setProperty"),p=u.value;u.value=function(t,e,i){if(!g&&!Q&&f.test(e)){e=e&&O(e);var s=this.ownerElement;s&&(q(s),s.$$needsOverrides=!0,z(s))}p.call(this,t,e,i)},h.setProperty=u,Object.defineProperties(CSSStyleDeclaration.prototype,h),window.CSS2Properties&&Object.defineProperties(window.CSS2Properties.prototype,h),addEventListener("resize",(function(){H("[data-css-paint]")}));var m={passive:!0};function w(t){for(var e=t.target;e;)1===e.nodeType&&U(e),e=e.parentNode}["animationiteration","animationend","animationstart","transitionstart","transitionend","transitionrun","transitioncancel","mouseover","mouseout","mousedown","mouseup","focus","blur"].forEach((function(t){addEventListener(t,w,m)})),x(),H('[style*="paint"]')}()}catch(t){}}(),function(){if("undefined"!=typeof document&&!("adoptedStyleSheets"in document)){var t="ShadyCSS"in window&&!ShadyCSS.nativeShadow,e=document.implementation.createHTMLDocument(""),i=new WeakMap,s="object"==typeof DOMException?Error:DOMException,n=Object.defineProperty,a=Array.prototype.forEach,o=/@import.+?;?$/gm,r=CSSStyleSheet.prototype;r.replace=function(){return Promise.reject(new s("Can't call replace on non-constructed CSSStyleSheets."))},r.replaceSync=function(){throw new s("Failed to execute 'replaceSync' on 'CSSStyleSheet': Can't call replaceSync on non-constructed CSSStyleSheets.")};var l=new WeakMap,h=new WeakMap,d=new WeakMap,c=new WeakMap,u=A.prototype;u.replace=function(t){try{return this.replaceSync(t),Promise.resolve(this)}catch(t){return Promise.reject(t)}},u.replaceSync=function(t){if(I(this),"string"==typeof t){var e=this;l.get(e).textContent=function(t){var e=t.replace(o,"");return e!==t&&console.warn("@import rules are not allowed here. See https://github.com/WICG/construct-stylesheets/issues/119#issuecomment-588352418"),e.trim()}(t),c.set(e,[]),h.get(e).forEach((function(t){t.isConnected()&&P(e,k(e,t))}))}},n(u,"cssRules",{configurable:!0,enumerable:!0,get:function(){return I(this),l.get(this).sheet.cssRules}}),n(u,"media",{configurable:!0,enumerable:!0,get:function(){return I(this),l.get(this).sheet.media}}),["addRule","deleteRule","insertRule","removeRule"].forEach((function(t){u[t]=function(){var e=this;I(e);var i=arguments;c.get(e).push({method:t,args:i}),h.get(e).forEach((function(s){if(s.isConnected()){var n=k(e,s).sheet;n[t].apply(n,i)}}));var s=l.get(e).sheet;return s[t].apply(s,i)}})),n(A,Symbol.hasInstance,{configurable:!0,value:v});var p={childList:!0,subtree:!0},g=new WeakMap,m=new WeakMap,f=new WeakMap,w=new WeakMap;if(O.prototype={isConnected:function(){var t=m.get(this);return t instanceof Document?"loading"!==t.readyState:function(t){return"isConnected"in t?t.isConnected:document.contains(t)}(t.host)},connect:function(){var t=T(this);w.get(this).observe(t,p),f.get(this).length>0&&D(this),E(t,(function(t){x(t).connect()}))},disconnect:function(){w.get(this).disconnect()},update:function(t){var e=this,i=m.get(e)===document?"Document":"ShadowRoot";if(!Array.isArray(t))throw new TypeError("Failed to set the 'adoptedStyleSheets' property on "+i+": Iterator getter is not callable.");if(!t.every(v))throw new TypeError("Failed to set the 'adoptedStyleSheets' property on "+i+": Failed to convert value to 'CSSStyleSheet'");if(t.some(M))throw new TypeError("Failed to set the 'adoptedStyleSheets' property on "+i+": Can't adopt non-constructed stylesheets");e.sheets=t;var s,n,a=f.get(e),o=(s=t).filter((function(t,e){return s.indexOf(t)===e}));(n=o,a.filter((function(t){return-1===n.indexOf(t)}))).forEach((function(t){var i;(i=k(t,e)).parentNode.removeChild(i),function(t,e){d.get(t).delete(e),h.set(t,h.get(t).filter((function(t){return t!==e})))}(t,e)})),f.set(e,o),e.isConnected()&&o.length>0&&D(e)}},window.CSSStyleSheet=A,L(Document),"ShadowRoot"in window){L(ShadowRoot);var b=Element.prototype,y=b.attachShadow;b.attachShadow=function(t){var e=y.call(this,t);return"closed"===t.mode&&i.set(this,e),e}}var S=x(document);S.isConnected()?S.connect():document.addEventListener("DOMContentLoaded",S.connect.bind(S))}function C(t){return t.shadowRoot||i.get(t)}function v(t){return"object"==typeof t&&(u.isPrototypeOf(t)||r.isPrototypeOf(t))}function M(t){return"object"==typeof t&&r.isPrototypeOf(t)}function k(t,e){return d.get(t).get(e)}function P(t,e){requestAnimationFrame((function(){e.textContent=l.get(t).textContent,c.get(t).forEach((function(t){return e.sheet[t.method].apply(e.sheet,t.args)}))}))}function I(t){if(!l.has(t))throw new TypeError("Illegal invocation")}function A(){var t=this,i=document.createElement("style");e.body.appendChild(i),l.set(t,i),h.set(t,[]),d.set(t,new WeakMap),c.set(t,[])}function x(t){var e=g.get(t);return e||(e=new O(t),g.set(t,e)),e}function L(t){n(t.prototype,"adoptedStyleSheets",{configurable:!0,enumerable:!0,get:function(){return x(this).sheets},set:function(t){x(this).update(t)}})}function E(t,e){for(var i=document.createNodeIterator(t,NodeFilter.SHOW_ELEMENT,(function(t){return C(t)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}),null,!1),s=void 0;s=i.nextNode();)e(C(s))}function T(t){var e=m.get(t);return e instanceof Document?e.body:e}function D(t){var e=document.createDocumentFragment(),i=f.get(t),s=w.get(t),n=T(t);s.disconnect(),i.forEach((function(i){e.appendChild(k(i,t)||function(t,e){var i=document.createElement("style");return d.get(t).set(e,i),h.get(t).push(e),i}(i,t))})),n.insertBefore(e,null),s.observe(n,p),i.forEach((function(e){P(e,k(e,t))}))}function O(e){var i=this;i.sheets=[],m.set(i,e),f.set(i,[]),w.set(i,new MutationObserver((function(e,s){document?e.forEach((function(e){t||a.call(e.addedNodes,(function(t){t instanceof Element&&E(t,(function(t){x(t).connect()}))})),a.call(e.removedNodes,(function(e){e instanceof Element&&(function(t,e){return e instanceof HTMLStyleElement&&f.get(t).some((function(e){return k(e,t)}))}(i,e)&&D(i),t||E(e,(function(t){x(t).disconnect()})))}))})):s.disconnect()})))}}();class IndexedDbUtil{constructor(t="keyValuesDb",{objectStoreNames:e=["keyValues"]}={}){this.dbName=t,this.objectStoreNames=e;const i=indexedDB.open(this.dbName);i.onupgradeneeded=()=>{for(const t of this.objectStoreNames)i.result.createObjectStore(t)},this._dbPromise=this._promisifyRequest(i),this._initDb()}async _initDb(){const t=await this._dbPromise;t.onversionchange=e=>{null==e.newVersion&&t.close()}}async closeConnection(){(await this._dbPromise).close()}async _promisifyRequest(t){return"done"==t.readyState?t.result:await new Promise(((e,i)=>{t.onsuccess=()=>{e(t.result)},t.onerror=i}))}async deleteDb(){await this.closeConnection(),await this._promisifyRequest(indexedDB.deleteDatabase(this.dbName))}async get(t,e=this.objectStoreNames[0]){const i=(await this._dbPromise).transaction(e,"readonly").objectStore(e).get(t);return await this._promisifyRequest(i)}set(t,e,i=this.objectStoreNames[0]){return this.getSet(t,(()=>e),i)}async getSet(t,e,i=this.objectStoreNames[0],s=!1){const n=(await this._dbPromise).transaction(i,"readwrite").objectStore(i),a=n.openCursor(t),o=await this._promisifyRequest(a);if(o)if(s){const t=o.delete();await this._promisifyRequest(t)}else{const t=e(o.value),i=o.update(t);await this._promisifyRequest(i)}else{const i=n.put(e(void 0),t);await this._promisifyRequest(i)}}async delete(t,e=this.objectStoreNames[0]){await this.getSet(t,(()=>{}),e,!0)}}class SettingsManager{constructor(t){this.indexedDb=t,this.defaultValues={sfxVolume:100,musicVolume:100,sfxDistanceCutoff:30,fov:90,quality:1,antialias:!0,smoothFiltering:!0,mouseAcceleration:!1,mouseSensitivity:1,invertMouseY:!1,autoShoot:!1,walkHeadBob:!0,landHeadBob:!0,theme:"system",hideUi:!1,uiScale:1,showStats:!1,smoothCam:!1,autoSkipStatsScreen:!0,chatEnabled:!0,crosshairAccuracyOffset:1,crosshairStyle:"three",crosshairColor:"#ffffff",crosshairOutlineColor:"#000000"},this.currentValues=new Map,this.onValueChangeCbs=new Map;for(const[t,e]of Object.entries(this.defaultValues)){const i=t;this.currentValues.set(i,e)}this.onSettingsLoadedCbs=new Set,this._settingsLoaded=!1,this._isLoadingSettings=!1}init(){this.loadSettings()}async loadSettings(){if(this.settingsLoaded||this._isLoadingSettings)return;this._isLoadingSettings=!0;let t=null;try{t=await this.indexedDb.get("settings")}catch(t){console.warn("Unable to load settings, third party cookies are probably blocked")}if(t)for(const[e,i]of Object.entries(t)){const t=e;this.currentValues.set(t,i),this.fireValueChange(t,i)}this._settingsLoaded=!0,this.onSettingsLoadedCbs.forEach((t=>t()))}get settingsLoaded(){return this._settingsLoaded}async saveSettings(){if(!this.settingsLoaded)return!1;const t={};for(const[e,i]of this.currentValues)this.defaultValues[e]!=i&&(t[e]=i);try{await this.indexedDb.set("settings",t)}catch(t){return!1}return!0}getValue(t){return this.currentValues.get(t)}setValue(t,e){this.currentValues.set(t,e),this.fireValueChange(t,e),this.saveSettings()}fireValueChange(t,e){const i=this.onValueChangeCbs.get(t);if(i)for(const t of i)t(e)}onValueChange(t,e){let i=this.onValueChangeCbs.get(t);i||(i=new Set,this.onValueChangeCbs.set(t,i)),i.add(e)}removeOnValueChange(t,e){const i=this.onValueChangeCbs.get(t);i&&(i.delete(e),i.size<=0&&this.onValueChangeCbs.delete(t))}onSettingsLoaded(t){this.onSettingsLoadedCbs.add(t)}}function randInt(t,e){return Math.floor(randRange(t,e))}function randRangeHelper(t,e,i){return i*(e-t)+t}function randRange(t,e){return randRangeHelper(t,e,Math.random())}function randSeed(t){const e=1e4*Math.sin(t);return e-Math.floor(e)}function randFromArray(t){return randFromArrayHelper(t,Math.random())}function randFromArrayHelper(t,e){return t[Math.floor(e*t.length)]}function randFromArrayWithProbabilityHelper(t,e){let i=0;for(const e of t)i+=e.probability;const s=randRangeHelper(0,i,e);let n=0;for(const e of t)if(n+=e.probability,n>s)return e.item;return null}function randFromArrayWithProbability(t){return randFromArrayWithProbabilityHelper(t,Math.random())}function randFromArrayWithProbabilitySeed(t,e){return randFromArrayWithProbabilityHelper(t,randSeed(e))}function recalculateStyle(t){window.getComputedStyle(t).getPropertyValue("top")}const inMemoryLocalStorage=new Map;function lsGet(t){try{return localStorage.getItem(t)}catch(e){return inMemoryLocalStorage.get(t)}}function searchToDict(t){const e=new URLSearchParams(t),i={};for(const t of e.entries())i[t[0]]=t[1];return i}function parseSearch(){return searchToDict(location.search)}function requestWithProgress(t,e){return new Promise(((i,s)=>{const n=new XMLHttpRequest;n.responseType="blob",n.addEventListener("progress",(t=>{if(e){let i=0;t.lengthComputable&&(i=t.loaded/t.total),e(i)}})),n.onload=e=>{200==n.status||0==n.status?i(n.response):s(new Error(`"${t}" responded with a non ok status code`))},n.onerror=t=>{s(t)},n.open("GET",t,!0),n.send()}))}async function addScript(t){const e=document.createElement("script");e.src=t,document.head.appendChild(e);const i=new Promise(((i,s)=>{const n=()=>{i(),e.removeEventListener("load",n)};e.addEventListener("load",n);const a=()=>{s(new Error("unable to load srcipt "+t)),e.removeEventListener("error",a)};e.addEventListener("error",a)}));await i}async function fetchWithTimeout(t,e={}){const{timeout:i=8e3}=e,s=new AbortController,n=setTimeout((()=>s.abort()),i);e.signal=s.signal;const a=await fetch(t,e);return clearTimeout(n),a}function uuidToBinary(t){const e=new ArrayBuffer(16);if(!t)return e;let i=0,s=0;const n=new DataView(e);for(;i<t.length;){"-"==t[i]&&i++;const e=t.slice(i,i+2),a=parseInt(e,16);n.setUint8(s++,a),i+=2}return e}class MenuButton{constructor({text:t="",icon:e="",testLabel:i="",iconSizeMultiplier:s=.9,isUpdateIcon:n=!1,isExitButton:a=!1,onClick:o=null}={}){this.containerEl=document.createElement("div"),this.containerEl.classList.add("main-menu-button-container"),this.el=document.createElement("button"),this.el.classList.add("wrinkledPaper"),this.el.classList.toggle("exit-button",a),this.containerEl.appendChild(this.el),this.el.style.cssText=`\n\t\t\t--wrinkled-paper-seed: ${randInt(1,99999)};\n\t\t`,t&&(this.el.ariaLabel=t),this.el.classList.add("main-menu-button"),this.el.addEventListener("click",(t=>{o&&o()})),this.textEl=document.createElement("div"),this.textEl.classList.add("main-menu-button-text","whiteBigText","blueNight"),this.textEl.textContent=t,this.textEl.ariaHidden="true",this.containerEl.appendChild(this.textEl),this.visible=!0,e&&(this.iconEl=document.createElement("div"),this.iconEl.classList.add("buttonImage"),this.iconEl.classList.toggle("update-icon",n),this.iconEl.style.backgroundImage=`url(${e})`,this.iconEl.style.backgroundSize=100*s+"%",this.el.appendChild(this.iconEl))}setVisibility(t){this.visible=t,this.containerEl.style.display=t?"":"none"}click(t=!1){t&&!this.visible||this.el.click()}setText(t){this.textEl.textContent=t}}class CurrencyContainer{constructor({amount:t=0,testLabel:e=""}={}){this._amount=t,this.el=document.createElement("div"),this.el.classList.add("currency-container");const i=document.createElement("div");i.classList.add("coin-icon"),this.el.appendChild(i),this.textEl=document.createElement("span"),this.textEl.classList.add("coin-count-text","blueNight"),this.el.appendChild(this.textEl),this.isAnimatingAmount=!1,this.animatingStartValue=0,this.animatingTargetValue=0,this.animatingCurrentValue=0,this.animatingDurationMs=0,this.animatingStartTime=0,this.animatingSfxEnabled=!0,this.lastIncrementSfxTime=0,this.boundAnimationLoop=this.animationLoop.bind(this),this.setAmount(t)}setAmount(t){this._amount=t,this._setAmountText(String(t))}_setAmountText(t){this.textEl.textContent=t,this.textEl.dataset.textContent=t}get amount(){return this._amount}animateAmount(t,{durationMultiplier:e=1,sfx:i=!0}={}){this.isAnimatingAmount?this.animatingStartValue=this.animatingCurrentValue:this.animatingStartValue=this._amount,this._amount=t,this.animatingTargetValue=t;const s=Math.abs(this.animatingTargetValue-this.animatingStartValue);this.animatingDurationMs=clamp(s,30,100)*e*30,this.animatingStartTime=performance.now(),this.animatingSfxEnabled=i;const n=!this.isAnimatingAmount;this.isAnimatingAmount=!0,n&&this.boundAnimationLoop()}animationLoop(){let t=(performance.now()-this.animatingStartTime)/this.animatingDurationMs;t=clamp01(t);const e=Math.pow(t,.2);let i=lerp(this.animatingStartValue,this.animatingTargetValue,e);if(i=Math.round(i),this.animatingCurrentValue!=i&&(this.animatingCurrentValue=i,this._setAmountText(String(i)),this.animatingSfxEnabled&&performance.now()>this.lastIncrementSfxTime+40)){this.lastIncrementSfxTime=performance.now(),getMainInstance().sfx.playSound("ui/coin/pile",{volume:.3*(1-t)});const i=lerp(.7,1,e),s=randInt(0,4);getMainInstance().sfx.playSound("ui/coin/"+s,{volume:.5*t,minPitch:i,maxPitch:i})}e>=1?this.isAnimatingAmount=!1:window.requestAnimationFrame(this.boundAnimationLoop)}}class UiButton{constructor({text:t="",ariaLabel:e="",onClick:i=null,showCurrency:s=!1,currency:n=0,extraClasses:a=[],testLabel:o="",isIconButton:r=!1,icon:l=null,iconSize:h=1,iconIsInvertable:d=!0}={}){this.el=document.createElement("button"),r?this.el.classList.add("icon-button",...a):this.el.classList.add("dialog-button","blueNight","wrinkledPaper",...a),this.el.classList.toggle("currency-button",s),this.el.style.cssText=`\n\t\t\t--wrinkled-paper-seed: ${randInt(1,99999)};\n\t\t`,e&&(this.el.ariaLabel=e),this.textEl=document.createElement("span"),this.textEl.textContent=t,this.el.appendChild(this.textEl),this._iconEl=null,this._iconSize=h,this._iconIsInvertable=d,this._currentIcon=null,this.setIcon(l),this._visible=!0,s&&(this.currencyContainer=new CurrencyContainer({amount:n}),this.el.appendChild(this.currencyContainer.el)),i&&this.onClick(i)}get visible(){return this._visible}set visible(t){this._visible=t,this.el.style.display=t?"":"none"}click(){this.el.click()}onClick(t){this.el.addEventListener("click",t)}set enabled(t){this.el.disabled=!t}get enabled(){return!this.el.disabled}setIcon(t){const e=!!t;!!this._iconEl!=e&&(e?(this._iconEl=document.createElement("div"),this._iconEl.classList.add("dialog-button-icon"),this._iconEl.classList.toggle("no-dark-mode-invert",!this._iconIsInvertable),this.el.insertBefore(this._iconEl,this.textEl),1!=this._iconSize&&(this._iconEl.style.transform=`scale(${this._iconSize})`)):(this._iconEl&&this.el.removeChild(this._iconEl),this._iconEl=null)),t&&this._iconEl&&(this._iconEl.style.backgroundImage=`url(${t})`),this._currentIcon=t}get icon(){return this._currentIcon}setText(t){this.textEl.textContent=t}}class DialogUi{constructor({allowCurtainClose:t=!0,customOnCurtainClickCb:e=null,startVisible:i=!0,needsCurtain:s=!0,needsUnlockedPointer:n=!0,extraClasses:a=[],testLabel:o="",indexPriority:r=0,needsWrapper:l=!1,title:h=null}={}){this.allowCurtainClose=t,this.customOnCurtainClickCb=e,this.needsCurtain=s,this.needsUnlockedPointer=n,this.indexPriority=r,this.zIndex=0,this.wrapperEl=null,l&&(this.wrapperEl=document.createElement("div"),this.wrapperEl.classList.add("dialogWrapper"),document.body.appendChild(this.wrapperEl)),this.el=document.createElement("div"),this.el.classList.add("dialog","wrinkledPaper",...a),this.el.style.setProperty("--wrinkled-paper-seed",String(randInt(1,99999))),this._transitionVisible=!1,this.rootEl.addEventListener("transitionend",(t=>{t.target==this.rootEl&&"visibility"==t.propertyName&&(this.rootEl.classList.contains("hidden")||(this._transitionVisible=!0))})),this.rootEl.classList.add("hidden"),l&&this.wrapperEl?this.wrapperEl.appendChild(this.el):document.body.appendChild(this.el),i&&(recalculateStyle(this.el),this.rootEl.classList.remove("hidden")),h&&(this.titleEl=document.createElement("h2"),this.titleEl.classList.add("dialogTitle","blueNight"),this.titleEl.textContent=h,this.el.appendChild(this.titleEl)),this.startVisible=i,this._visible=i,this._inert=!1,this.onVisibilityChangeCbs=new Set,this.onInertChangeCbs=new Set,this.closed=!1,this.onCloseCbs=new Set}destructor(){this.wrapperEl?document.body.removeChild(this.wrapperEl):document.body.removeChild(this.el)}get rootEl(){return this.wrapperEl?this.wrapperEl:this.el}setZIndex(t){this.zIndex=t,this.rootEl.style.zIndex=String(t)}setInert(t){this._inert=t,this.rootEl.inert=t,this.onInertChangeCbs.forEach((e=>e(t)))}get inert(){return this._inert}set visible(t){this._visible=t,t||(this._transitionVisible=!1),this.rootEl.classList.toggle("hidden",!t);for(const e of this.onVisibilityChangeCbs)e(t);this.onVisibilityChange(t)}get visible(){return this._visible}get transitionVisible(){return this._transitionVisible}close(){if(!this.closed){this.closed=!0,this.visible=!1;for(const t of this.onCloseCbs)t();this.onCloseCbs.clear(),this.onClose(),window.setTimeout((()=>{this.destructor()}),500)}}onVisibilityChange(t){}onClose(){}addOnVisibilityChangeCb(t){this.onVisibilityChangeCbs.add(t)}addOnInertChangeCb(t){this.onInertChangeCbs.add(t)}addOnCloseCb(t){this.onCloseCbs.add(t)}addButtonsContainer({vertical:t=!1,parent:e=this.el}={}){this.buttonsContainer=document.createElement("div"),this.buttonsContainer.classList.add("dialogButtonsContainer"),this.buttonsContainer.classList.toggle("vertical",t),e.appendChild(this.buttonsContainer)}addButton(t){const e=new UiButton(t);let i=this.el;return this.buttonsContainer&&(i=this.buttonsContainer),i.appendChild(e.el),e}removeButton(t){t.el.parentElement!=this.el&&t.el.parentElement!=this.buttonsContainer||t.el.parentElement.removeChild(t.el)}}class SettingUiItem{constructor(t){const{text:e,type:i,enumValues:s}=t;if(this.type=i,this.el=document.createElement("div"),this.el.classList.add("settings-item"),this.textEl=document.createElement("div"),this.el.appendChild(this.textEl),this.textEl.textContent=e,this.textEl.classList.add("settings-item-text"),this.onValueChangeCbs=new Set,"slider"==this.type){const e=document.createElement("div");e.classList.add("settings-item-slider"),this.el.appendChild(e),this.sliderEl=document.createElement("input"),this.sliderEl.classList.add("dialog-range-input"),e.appendChild(this.sliderEl),this.sliderEl.type="range",this.sliderEl.min=String(t.min),this.sliderEl.max=String(t.max),this.sliderEl.step=String(t.step||1),this.valueEl=document.createElement("div"),this.valueEl.classList.add("settings-item-slider-value"),e.appendChild(this.valueEl),this.valueEl.textContent=this.sliderEl.value;const i=t.triggerOnChange||!1,s=this.valueEl,n=this.sliderEl,a=()=>{const t=Number(n.value);this.onValueChangeCbs.forEach((e=>e(t)))};i&&this.sliderEl.addEventListener("change",a),this.sliderEl.addEventListener("input",(()=>{s.textContent=n.value,i||a()}))}else if("toggle"==this.type){this.toggleEl=document.createElement("input"),this.toggleEl.type="checkbox",this.toggleEl.classList.add("dialog-checkbox-input","wrinkledPaper"),this.el.appendChild(this.toggleEl);const t=this.toggleEl;this.toggleEl.addEventListener("input",(()=>{this.onValueChangeCbs.forEach((e=>e(t.checked)))}))}else if("enum"==i){const t=document.createElement("div");if(t.classList.add("dialog-select-wrapper","wrinkledPaper"),this.el.appendChild(t),this.dropdownEl=document.createElement("select"),this.dropdownEl.classList.add("dialog-select-input","blueNight"),t.appendChild(this.dropdownEl),s)for(const[t,e]of Object.entries(s)){const i=document.createElement("option");i.value=t,i.textContent=e,this.dropdownEl.appendChild(i)}const e=this.dropdownEl;this.dropdownEl.addEventListener("input",(()=>{this.onValueChangeCbs.forEach((t=>t(e.value)))}))}else if("color"==i){const t=document.createElement("input");this.colorEl=t,t.classList.add("dialog-color-input","wrinkledPaper"),t.type="color",this.el.appendChild(t),t.addEventListener("input",(()=>{this.onValueChangeCbs.forEach((e=>e(t.value)))}))}}setValue(t){if("slider"==this.type){if(!this.sliderEl)throw new Error("Assertion failed, slider element doesn't exist.");if("number"!=typeof t)throw new Error("Failed to set value of slider setting item: value is not a number");if(this.sliderEl.value=String(t),!this.valueEl)throw new Error("Assertion failed, value element doesn't exist.");this.valueEl.textContent=this.sliderEl.value}else if("toggle"==this.type&&"boolean"==typeof t){if(!this.toggleEl)throw new Error("Assertion failed, toggle element doesn't exist.");this.toggleEl.checked=t}else if("enum"==this.type){if(!this.dropdownEl)throw new Error("Assertion failed, dropdown element doesn't exist.");if("string"!=typeof t)throw new Error("Failed to set value of enum setting item: value is not a string");this.dropdownEl.value=t}else if("color"==this.type){if(!this.colorEl)throw new Error("Assertion failed, no color element");if("string"!=typeof t)throw new Error("Assertion failed, color value is not a string");this.colorEl.value=t}}onValueChange(t){this.onValueChangeCbs.add(t)}setDisabled(t){this.sliderEl&&(this.sliderEl.disabled=t),this.toggleEl&&(this.toggleEl.disabled=t),this.dropdownEl&&(this.dropdownEl.disabled=t)}}class SettingItem extends SettingUiItem{constructor(t,e){super(e),this.id=t}}class SettingsDialogUi extends DialogUi{constructor(t,e){super(),this.settingsManager=t,this.dialogManager=e,this.titleEl=document.createElement("h2"),this.titleEl.classList.add("dialogTitle","blueNight"),this.titleEl.textContent="Settings",this.el.appendChild(this.titleEl);const i=[{name:"Sound",settings:[new SettingItem("sfxVolume",{text:"Sound effects volume",type:"slider",min:0,max:100}),new SettingItem("musicVolume",{text:"Music volume",type:"slider",min:0,max:100}),new SettingItem("sfxDistanceCutoff",{text:"Sfx distance cutoff",type:"slider",min:0,max:100})]},{name:"Quality",settings:[new SettingItem("quality",{text:"Quality",type:"slider",min:.1,max:3,step:.1}),new SettingItem("antialias",{text:"Anti-Aliasing",type:"toggle"}),new SettingItem("smoothFiltering",{text:"Smooth filtering",type:"toggle"})]},{name:"Controls",settings:[new SettingItem("mouseSensitivity",{text:"Mouse sensitivity",type:"slider",min:.1,max:5,step:.01}),new SettingItem("invertMouseY",{text:"Invert vertical mouse",type:"toggle"}),new SettingItem("mouseAcceleration",{text:"Mouse Acceleration",type:"toggle"}),new SettingItem("autoShoot",{text:"Auto shoot",type:"toggle"})]},{name:"Gameplay",settings:[new SettingItem("fov",{text:"Field of view",type:"slider",min:40,max:140}),new SettingItem("walkHeadBob",{text:"Walk head bob",type:"toggle"}),new SettingItem("landHeadBob",{text:"Land head bob",type:"toggle"}),new SettingItem("smoothCam",{text:"Smooth camera",type:"toggle"})]},{name:"Crosshair",settings:[new SettingItem("crosshairStyle",{text:"Style",type:"enum",enumValues:{off:"Off",three:"Tri",four:"Quad","four-sharp":"Sharp Quad","three-low":"Horizon","four-flat":"Whiskers","three-extra-low":"Soul patch",six:"Wallmart"}}),new SettingItem("crosshairColor",{text:"Color",type:"color"}),new SettingItem("crosshairOutlineColor",{text:"Outline Color",type:"color"}),new SettingItem("crosshairAccuracyOffset",{text:"Accuracy Offset",type:"slider",min:0,max:4,step:.1})]},{name:"Interface",settings:[new SettingItem("theme",{text:"Theme",type:"enum",enumValues:{system:"Sync with system",light:"Light",dark:"Dark"}}),new SettingItem("uiScale",{text:"UI scale",type:"slider",step:.1,min:.5,max:2,triggerOnChange:!0}),new SettingItem("chatEnabled",{text:"Show chat in squads",type:"toggle"}),new SettingItem("autoSkipStatsScreen",{text:"Auto skip stats screen",type:"toggle"}),new SettingItem("showStats",{text:"Show ping and fps",type:"toggle"}),new SettingItem("hideUi",{text:"Hide in game UI",type:"toggle"})]}],s=document.createElement("div");s.classList.add("settings-list"),this.el.appendChild(s);for(const e of i){const i=document.createElement("div");s.appendChild(i);const n=document.createElement("h3");n.classList.add("settings-group-header"),n.textContent=e.name,i.appendChild(n);for(const s of e.settings){i.appendChild(s.el);const e=t.getValue(s.id);s.setValue(e),s.onValueChange((e=>{t.setValue(s.id,e)}))}}this.addButtonsContainer(),this.addButton({text:"Save",onClick:async()=>{await this.settingsManager.saveSettings()?this.close():this.dialogManager.showAlert({title:"Settings could not be saved.",text:"An error occurred while saving the settings. Are third party cookies disabled?"})}})}}const classConfigs=[{id:"scout",uiName:"Scout",bowId:"smallBow",shopSkeletonLayer:"shootingLoaded",bowHandleShopCategories:["smallBowHandle"],bowTipShopCategories:["smallBowTip"],bowShopCamPosition:"smallBow",bowHandleShopCamPosition:"smallBowHandle",bowTipShopCamPosition:"smallBowTip"},{id:"assault",uiName:"Assault",bowId:"mediumBow",shopSkeletonLayer:"shootingLoaded",bowHandleShopCategories:["mediumBowHandle"],bowTipShopCategories:["mediumBowTip"],bowShopCamPosition:"mediumBow",bowHandleShopCamPosition:"mediumBowHandle",bowTipShopCamPosition:"mediumBowTip"},{id:"sharpshooter",uiName:"Sharpshooter",bowId:"largeBow",shopSkeletonLayer:"shootingLoaded",bowHandleShopCategories:["largeBowHandle"],bowTipShopCategories:["largeBowTip"],bowShopCamPosition:"largeBow",bowHandleShopCamPosition:"largeBowHandle",bowTipShopCamPosition:"largeBowTip"},{id:"runner",uiName:"Runner",bowId:"smallCrossbow",shopSkeletonLayer:"shooting",bowHandleShopCategories:["smallCrossbowHandle"],bowTipShopCategories:["smallCrossbowTip"],bowShopCamPosition:"smallCrossbow",bowHandleShopCamPosition:"smallCrossbowHandle",bowTipShopCamPosition:"smallCrossbowTip"},{id:"support",uiName:"Support",bowId:"repeatingCrossbow",shopSkeletonLayer:"shootStart",bowHandleShopCategories:["repeatingCrossbowHandle"],bowTipShopCategories:["repeatingCrossbowTip"],bowShopCamPosition:"largeCrossbow",bowHandleShopCamPosition:"largeCrossbowHandle",bowTipShopCamPosition:"largeCrossbowTip"},{id:"defender",uiName:"Defender",bowId:"largeCrossbow",shopSkeletonLayer:"shooting",bowHandleShopCategories:["largeCrossbowHandle"],bowTipShopCategories:["largeCrossbowTip"],bowShopCamPosition:"largeCrossbow",bowHandleShopCamPosition:"largeCrossbowHandle",bowTipShopCamPosition:"largeCrossbowTip"}],classConfigsById=new Map;for(const t of classConfigs)classConfigsById.set(t.id,t);function getClassConfigById(t){const e=classConfigsById.get(t);if(!e)throw new Error(`No weapon config for class ${t}`);return e}class AssetPackageLoader{constructor(t){this.isDownloading=!1,this.loaded=!1,this.url=t,this.arrayBuffer=null,this.fileLocations=[],this.onLoadCbs=[],this.onProgressCbs=[],this.lastProgressValue=0,this.textureCache={}}async startDownloading(){if(this.loaded)return;if(this.isDownloading)return await this.waitForLoad();this.isDownloading=!0;const t=await requestWithProgress(this.url,(t=>{for(const e of this.onProgressCbs)e(t);this.lastProgressValue=t}));this.arrayBuffer=await new Response(t).arrayBuffer(),this.parseFilePositions(this.arrayBuffer),this.loaded=!0;for(const t of this.onLoadCbs)t();this.onLoadCbs=[],this.onProgressCbs=[],this.isDownloading=!1}parseFilePositions(t){let e=0;for(;e<t.byteLength;){let i=new Uint32Array(t,e,1)[0];const s=new Uint8Array(t,e+4,i),n=new TextDecoder("utf-8").decode(s);i%4!=0&&(i=4*Math.ceil(i/4));let a=new Uint32Array(t,e+4+i,1)[0];this.fileLocations.push({path:n,start:e+4+i+4,length:a}),a%4!=0&&(a=4*Math.ceil(a/4)),e+=4+i+4+a}}onLoad(t){this.loaded?t():this.onLoadCbs.push(t)}onProgress(t){this.loaded?t(1):this.onProgressCbs.push(t)}async waitForLoad(){if(this.loaded)return;const t=new Promise(((t,e)=>{this.onLoad((()=>{t()}))}));await t}async hasFile(t){return this.loaded||await this.waitForLoad(),this.fileLocations.some((e=>e.path==t))}async getFileAsBuffer(t){if(this.loaded||await this.waitForLoad(),!this.arrayBuffer)throw new Error("Assertion failed, arrayBuffer not loaded");for(const e of this.fileLocations)if(e.path==t)return this.arrayBuffer.slice(e.start,e.start+e.length);throw new Error(`Trying to load asset at ${t} but it doesn't exist!`)}async getAsObjectUrl(t,e){const i=await this.getFileAsBuffer(t);if(!i)return null;const s=new Blob([new Uint8Array(i)],{type:e});return URL.createObjectURL(s)}async getAsSvg(t){return await this.getAsObjectUrl(t,"image/svg+xml")}async getAsText(t){const e=await this.getFileAsBuffer(t),i=new Uint8Array(e);return new TextDecoder("utf-8").decode(i)}async getAsJSON(t){const e=await this.getAsText(t);return JSON.parse(e)}async blobToArrayBuffer(t){return await new Response(t).arrayBuffer()}}const messengerResponseHandlers={mapCached(t){getMainInstance().mapLoader.markMapAsCached(t)},reportMapLoadProgress(t,e){getMainInstance().mapLoader.reportMapLoadProgress(t,e)},firstMapDownloaded(){getMainInstance().mapLoader.reportFirstMapDownloaded()},mapGameplayObjects(t,e){getMainInstance().mapLoader.setGamplayObjects(t,e)}};class AssetsManager{constructor(){const t=["main"];this.onPackageAddCbs=[],this.packages={};for(const e of t)this.addPackage(e);this.lastWorkerRequestId=0,this.onWorkerMessageCbs=new Map,this.onWorkerErrorCbs=new Map,this.messenger=new TypedMessenger({deserializeErrorHook(t){const e=t;return e.isAggregateError?new AggregateError(e.errors,e.message):e.isMapLoadError?new MapLoadError(e.message,e.name):t}}),this.workerPromise=this.loadWorker(),this.abortSignalIds=new WeakMap,this.lastAbortSignalId=0}async loadWorker(){const{worker:t}=await import("./assetWorkerPreload-ceea6c02.js");this.messenger.initialize(t,messengerResponseHandlers),t.addEventListener("error",(t=>{throw console.error("error occurred while initializing asset loader worker"),t}));const e=new URL(".",location.href).href;return this.messenger.send.setBasePath(e),t}async getMessenger(){return await this.workerPromise,this.messenger}async registerAbortSignal(t){await this.workerPromise;let e=this.abortSignalIds.get(t);void 0===e&&(e=this.lastAbortSignalId++,this.abortSignalIds.set(t,e));const i=e;return t.addEventListener("abort",(()=>{this.messenger.send.signalAborted(i)})),{abortSignalId:e,messenger:this.messenger,unregister:()=>{this.messenger.send.removeAbortSignal(i)}}}addPackage(t,{waitForOtherPackages:e=null,expectedOtherPackageCount:i=1,manualDownload:s=!1}={}){let n=null;if(t in this.packages)n=this.packages[t];else{n=new AssetPackageLoader("assetPackages"+"/"+t+".bin?v=1685095066"),this.packages[t]=n;for(const t of this.onPackageAddCbs)t();this.onPackageAddCbs=[]}return s||this.waitAndDownloadPack(n,e,i),n}async waitAndDownloadPack(t,e,i){if(e)for(;;){const s=[];for(const[i,n]of Object.entries(this.packages))for(const a of e)i.startsWith(a)&&n!=t&&s.push(n);if(!(s.length<i)){for(const t of s)await t.waitForLoad();break}await this.waitForPackageAdd()}t.startDownloading()}async waitForPackageAdd(){const t=new Promise((t=>this.onPackageAddCbs.push(t)));await t}getPackage(t){return this.packages[t]}async getPackageAsync(t){for(;;){const e=this.packages[t];if(e)return e;await this.waitForPackageAdd()}}onWorkerMessage(t,e,i=!1){let s=this.onWorkerMessageCbs.get(t);s||(s=new Set,this.onWorkerMessageCbs.set(t,s)),s.add({cb:e,endOnly:i})}onWorkerError(t,e){let i=this.onWorkerErrorCbs.get(t);i||(i=new Set,this.onWorkerErrorCbs.set(t,i)),i.add(e)}static deserializeThreeObject(t){if(!t)return null;const e=[];for(const i of t.geometries){const t=new BufferGeometry;for(const e of i.attributes)t.setAttribute(e.name,new BufferAttribute(e.array,e.itemSize,e.normalized));i.index&&t.setIndex(new BufferAttribute(i.index.array,1));for(const{start:e,count:s,materialIndex:n}of i.groups)t.addGroup(e,s,n);e.push(t)}const i=this.deserializeThreeObjectRecursive(t.object,e);return i.updateWorldMatrix(!1,!0),i}static deserializeThreeObjectRecursive(t,e){let i=null;const s=getMainInstance().materials;if(null!=t.geo&&t.geo>=0){let n=null;if(Array.isArray(t.material)){n=[];for(const e of t.material){const t=s.getMaterialByName(e);t&&n.push(t)}}else t.material&&(n=getMainInstance().materials.getMaterialByName(t.material)||null);n&&(i=new Mesh(e[t.geo],n))}i||(i=new Object3D),i.name=t.name;const n=(new Matrix4).fromArray(t.matrix);i.applyMatrix4(n);for(const s of t.children){const t=this.deserializeThreeObjectRecursive(s,e);i.add(t)}return i}async loadGlbViaWorker(t,{packageName:e="main",teamId:i=0,keepCustomProperties:s=[],merge:n=!0,signal:a=null}={}){const o=await getMainInstance().assets.getPackage(e).getFileAsBuffer(t);if(!a){a=(new AbortController).signal}const{messenger:r,abortSignalId:l,unregister:h}=await this.registerAbortSignal(a),d=await r.send.loadGlbAsset({glbBuffer:o,teamId:i,keepCustomProperties:s,merge:n,abortSignalId:l});return h(),AssetsManager.deserializeThreeObject(d)}}const baseSkins=["base","baseClothes","baseEyes"],genders=["male","female"],hairColors=[{cssColor:"#fff6ed",skinColor:[1,1,1]},{cssColor:"#c05f18",skinColor:[.45,.15,0]},{cssColor:"#362c29",skinColor:[.04,.03,.025]},{cssColor:"#794b32",skinColor:[.15,.08,.05]},{cssColor:"#feed9a",skinColor:[.95,.83,.4]}];function parseSkinDataString(t){let e;try{e=JSON.parse(t)}catch{e={}}return sanitizeSkinData(e)}function sanitizeSkinData(t=null){if("object"!=typeof t||Array.isArray(t)||null==t)return{equippedSkinIds:[],hairColorMultiplier:[1,1,1],eyebrowColorMultiplier:[1,1,1],beardColorMultiplier:[1,1,1]};t.equippedSkinIds&&Array.isArray(t.equippedSkinIds)||(t.equippedSkinIds=[]);for(const[e,i]of t.equippedSkinIds.entries())"string"!=typeof i&&(t.equippedSkinIds[e]="");return t.equippedSkinIds=t.equippedSkinIds.filter((t=>""!=t)),t.hairColorMultiplier&&(t.hairColorMultiplier=sanitizeSkinColorMultiplier(t.hairColorMultiplier)),t.eyebrowColorMultiplier&&(t.eyebrowColorMultiplier=sanitizeSkinColorMultiplier(t.eyebrowColorMultiplier)),t.beardColorMultiplier&&(t.beardColorMultiplier=sanitizeSkinColorMultiplier(t.beardColorMultiplier)),t}function sanitizeSkinColorMultiplier(t){if(!Array.isArray(t))return[1,1,1];if(3!=t.length)return[1,1,1];for(const e of t.keys())"number"!=typeof t[e]&&(t[e]=1),t[e]=clamp01(t[e]),isNaN(t[e])&&(t[e]=1);return t}class SkinManager{constructor(){this.purchasableItems=new Map,this.defaultSkinPresets=[],this.skinPresets=[],this.classSkins={},this.onSkinConfigChangeCbs=new Set}init(){this.initBaseSkins(),getMainInstance().config.shopConfig.onConfigChange((async t=>{for(const e of t.purchasableItems)if(this.purchasableItems.set(e.id,e),!e.slots||!Array.isArray(e.slots)){if(e.slots=[],e.maleSkin){if(e.maleSkin.additions)for(const t of Object.keys(e.maleSkin.additions))e.slots.push(t);if(e.maleSkin.removals)for(const t of Object.keys(e.maleSkin.removals))e.slots.push(t)}if(e.femaleSkin){if(e.femaleSkin.additions)for(const t of Object.keys(e.femaleSkin.additions))e.slots.push(t);if(e.femaleSkin.removals)for(const t of Object.keys(e.femaleSkin.removals))e.slots.push(t)}}this.defaultSkinPresets=t.skinPresets||[];const e=await this.loadSkinPreference("skinPresets");e&&(this.skinPresets=e);const i=await this.loadSkinPreference("classSkins");i&&(this.classSkins=i),0==this.skinPresets.length&&this.addPreset({fireConfigChanged:!1}),this.fireConfigChanged()}))}async loadSkinPreference(t){let e=null;try{e=await getMainInstance().indexedDb.get(t)}catch(t){}return e}async loadSkinIdsPreference(t){const e=await this.loadSkinPreference(t);let i=new Set;if(e&&"string"==typeof e){const t=e.split(",");i=new Set(t)}return i}async initBaseSkins(){const t=[],e=[];for(const t of genders)for(const i of baseSkins)e.push(`baseSkins/${t}/${i}.glb`);for(const{bowId:t}of classConfigs)e.push(`bows/${t}.glb`);e.push("baseSkins/arrow.glb");const i={};for(const s of e){const e=(async()=>{i[s]=await getMainInstance().assets.getPackage("main").getFileAsBuffer(s)})();t.push(e)}await Promise.all(t);const s=await getMainInstance().assets.getMessenger();await s.send.setBaseSkinBuffers(i)}skinObjectOptsToCacheKey(t){const e=[];e.push(t.teamId),t.teamColor?(e.push(t.teamColor.r),e.push(t.teamColor.g),e.push(t.teamColor.b)):e.push("teamColorEmpty"),e.push("skinstart");const i=t.skin.equippedSkinIds||[];e.push(i.join("|")),e.push("skinend"),e.push(t.skin.gender||"male");const s=t.skin.hairColorMultiplier||[1,1,1];e.push("hairColor"+s.join(","));const n=t.skin.eyebrowColorMultiplier||[1,1,1];e.push("eyebrowColor"+n.join(","));const a=t.skin.beardColorMultiplier||[1,1,1];return e.push("beardColor"+a.join(",")),e.join("-")}async getSkinObject(t,e){let i,s=!1;t.rawSkin?(i=t.rawSkin,s=!0):i=this.skinNetworkDataToSkinConfig(t.skin);let n=null;const a=[],{messenger:o,abortSignalId:r,unregister:l}=await getMainInstance().assets.registerAbortSignal(e);try{try{n=await o.send.buildSkin({skin:i,teamId:t.teamId,teamColor:t.teamColor,allowNetworkErrors:s,abortSignalId:r})}catch(t){if(t instanceof DOMException&&"AbortError"==t.name)throw t;a.push(t)}if(e.aborted)throw new DOMException("Request aborted by signal.","AbortError");if(!n&&!s){const e=this.skinNetworkDataToSkinConfig({gender:t.skin.gender});try{n=await o.send.buildSkin({skin:e,teamId:t.teamId,teamColor:t.teamColor,allowNetworkErrors:!1,abortSignalId:r})}catch(t){if(t instanceof DOMException&&"AbortError"==t.name)throw t;throw a.push(t),new AggregateError(a)}}}finally{l()}if(!n)return null;return AssetsManager.deserializeThreeObject(n)}async getBowObject(t,e){const{messenger:i,abortSignalId:s,unregister:n}=await getMainInstance().assets.registerAbortSignal(e),a=await i.send.buildBow({...t,abortSignalId:s});return n(),{bow:AssetsManager.deserializeThreeObject(a.bow),arrowPointIdleMatrix:(new Matrix4).fromArray(a.arrowPointIdleMatrix),arrowPointLoadedMatrix:(new Matrix4).fromArray(a.arrowPointLoadedMatrix)}}async buildConfigObject(t,e){const{messenger:i,abortSignalId:s,unregister:n}=await getMainInstance().assets.registerAbortSignal(e),a=await i.send.buildConfigObject({...t,abortSignalId:s});return n(),{asset:AssetsManager.deserializeThreeObject(a.asset)}}addShopItemToSkinData(t,e){const i=new Set(e.equippedSkinIds),s=this.addItemAndRemoveDuplicateSlots(i,t);return e.equippedSkinIds=Array.from(i),s}removeShopItemFromSkinData(t,e){const i=new Set(e.equippedSkinIds);i.delete(t),e.equippedSkinIds=Array.from(i)}addPreset({fireConfigChanged:t=!0}={}){let e=randFromArray(this.defaultSkinPresets);e||(e={});const i=e.equippedSkinIds||[],s={gender:e.gender||"male",equippedSkinIds:[...i]};e.hairColorMultiplier&&(s.hairColorMultiplier=[...e.hairColorMultiplier]),e.eyebrowColorMultiplier&&(s.eyebrowColorMultiplier=[...e.eyebrowColorMultiplier]),e.beardColorMultiplier&&(s.beardColorMultiplier=[...e.beardColorMultiplier]),this.skinPresets.push(s),this.savePresets(),t&&this.fireConfigChanged()}deletePreset(t){if(t<0||t>=this.skinPresets.length)throw new Error("Invalid preset index");this.skinPresets.splice(t,1);for(const e of Object.values(this.classSkins))null!=e.presetId&&(e.presetId==t?delete e.presetId:e.presetId>t&&e.presetId--);this.savePresets(),this.saveClassSkins(),this.fireConfigChanged()}getPreset(t,e=!0){const i=this.skinPresets[t];if(!i){if(e)throw new Error(`Preset ${t} does not exist`);return{}}return i}addShopItemToPreset(t,e){const i=this.getPreset(e),s=this.addShopItemToSkinData(t,i);return this.savePresets(),this.fireConfigChanged(),s}removeShopItemFromPreset(t,e){const i=this.getPreset(e);if(!i)throw new Error(`Preset with id ${e} does not exist`);this.removeShopItemFromSkinData(t,i),this.savePresets(),this.fireConfigChanged()}setPresetGender(t,e){this.getPreset(t).gender=e,this.savePresets(),this.fireConfigChanged()}setPresetSkinItemColor(t,e,i){const s=this.getPreset(t);"hair"==e?s.hairColorMultiplier=i:"eyebrows"==e?s.eyebrowColorMultiplier=i:"beard"==e&&(s.beardColorMultiplier=i),this.savePresets(),this.fireConfigChanged()}async savePresets(){try{await getMainInstance().indexedDb.set("skinPresets",this.skinPresets)}catch{}}getClassSkinData(t,e){let i=this.classSkins[t];return i||(i={},this.skinPresets.length>0&&(i.presetId=0),e&&(this.classSkins[t]=i)),i}getClassSkinDataWithAppliedPreset(t){const e=this.getClassSkinData(t,!1);let i;i=null!=e.presetId?this.getPreset(e.presetId,!1):{};const s=new Set(i.equippedSkinIds);if(e.equippedSkinIds)for(const t of e.equippedSkinIds)this.addItemAndRemoveDuplicateSlots(s,t);if(e.unequippedSkinIds)for(const t of e.unequippedSkinIds)s.delete(t);return{gender:e.gender||i.gender,equippedSkinIds:Array.from(s),hairColorMultiplier:e.hairColorMultiplier||i.hairColorMultiplier,eyebrowColorMultiplier:e.eyebrowColorMultiplier||i.eyebrowColorMultiplier,beardColorMultiplier:e.beardColorMultiplier||i.beardColorMultiplier}}setClassPreset(t,e){const i=this.getClassSkinData(t,!0);delete i.equippedSkinIds,delete i.unequippedSkinIds,delete i.gender,delete i.hairColorMultiplier,delete i.eyebrowColorMultiplier,delete i.beardColorMultiplier,null==e?delete i.presetId:i.presetId=e,this.saveClassSkins(),this.fireConfigChanged()}addShopItemToClass(t,e){const i=this.getClassSkinData(e,!0),s=new Set(i.unequippedSkinIds);s.delete(t),0==s.size?delete i.unequippedSkinIds:i.unequippedSkinIds=Array.from(s);let n=!1;if(null!=i.presetId){const e=this.getPreset(i.presetId,!1);e.equippedSkinIds&&e.equippedSkinIds.includes(t)&&(n=!0)}this.addShopItemToSkinData(t,i),n&&this.removeShopItemFromSkinData(t,i),this.saveClassSkins(),this.fireConfigChanged()}removeShopItemFromClass(t,e){const i=this.getClassSkinData(e,!0);let s=!1;if(null!=i.presetId){const e=this.getPreset(i.presetId,!1);e.equippedSkinIds&&e.equippedSkinIds.includes(t)&&(s=!0)}if(this.removeShopItemFromSkinData(t,i),s){const e=new Set(i.unequippedSkinIds);e.add(t),i.unequippedSkinIds=Array.from(e)}this.saveClassSkins(),this.fireConfigChanged()}setClassGender(t,e){const i=this.getClassSkinData(t,!0);let s="male";if(null!=i.presetId){s=this.getPreset(i.presetId,!1).gender||"male"}e==s?delete i.gender:i.gender=e,this.saveClassSkins(),this.fireConfigChanged()}setClassSkinItemColor(t,e,i){const s=this.getClassSkinData(t,!0);let n=null;null!=s.presetId&&(n=this.getPreset(s.presetId,!1));const a=n;function o(t){s[t]=i;let e=[1,1,1];if(a){const i=a[t];i&&(e=i)}Math.abs(i[0]-e[0])<.01&&Math.abs(i[1]-e[1])<.01&&Math.abs(i[2]-e[2])<.01&&delete s[t]}"hair"==e?o("hairColorMultiplier"):"eyebrows"==e?o("eyebrowColorMultiplier"):"beard"==e&&o("beardColorMultiplier"),this.saveClassSkins(),this.fireConfigChanged()}saveClassSkins(){try{getMainInstance().indexedDb.set("classSkins",this.classSkins)}catch{}}fireConfigChanged(){for(const t of this.onSkinConfigChangeCbs)t()}addItemAndRemoveDuplicateSlots(t,e){const i=new Set,s=this.purchasableItems.get(e);if(s&&(e&&t.add(e),s.slots))for(const n of s.slots)for(const s of t){if(s==e)continue;const a=this.purchasableItems.get(s);a&&a.slots&&a.slots.includes(n)&&(t.delete(s),i.add(s))}return i}getStatClassValuesFromShopSkinIds(t){const e=new Map;for(const i of t){const t=this.purchasableItems.get(i);if(t&&t.statClasses)for(const[i,s]of Object.entries(t.statClasses)){let t=e.get(i);t||(t=0),t+=s,e.set(i,t)}}return e}skinNetworkDataToSkinConfig(t){const e=t.gender||"male",i=new Map;for(const t of processedSkinNames){let s=i.get(t);s||(s=new Set,i.set(t,s));for(const t of baseSkins)s.add(`${e}/${t}`)}const s=[];if(t.equippedSkinIds){for(const n of t.equippedSkinIds){const a=this.purchasableItems.get(n);if(!a)continue;const o=this.getSkinFromShopItem(a,e);if(o&&o.additions)for(const[e,n]of Object.entries(o.additions)){const o=e;if(n&&Array.isArray(n)){let e=i.get(o);e||(e=new Set,i.set(o,e));for(const i of n)if(e.add(i),a.colorizableCategory){let e;"hair"==a.colorizableCategory?e=t.hairColorMultiplier:"eyebrows"==a.colorizableCategory?e=t.eyebrowColorMultiplier:"beard"==a.colorizableCategory&&(e=t.beardColorMultiplier),e&&s.push({assetName:i,colorMultiplier:e,joints:[o]})}}}}for(const s of t.equippedSkinIds){const t=this.purchasableItems.get(s);if(!t)continue;const n=this.getSkinFromShopItem(t,e);if(n&&n.removals)for(const[t,s]of Object.entries(n.removals)){const n=t;if(s&&Array.isArray(s)){const t=i.get(n);if(t)for(const i of s)baseSkins.includes(i)?t.delete(`${e}/${i}`):t.delete(i)}}}for(const s of t.equippedSkinIds){const t=this.purchasableItems.get(s);if(!t)continue;const n=this.getSkinFromShopItem(t,e);if(n&&n.replaceAssets)for(const t of n.replaceAssets)for(const s of i.values()){const i=[t.asset,`${e}/${t.asset}`];for(const e of i)s.has(e)&&(s.delete(e),s.add(t.replaceWith))}}}const n={};for(const[t,e]of i){const i=Array.from(e);i.length>0&&(n[t]=i)}return{equippedItems:n,colorizedItems:s}}skinNetworkDataToBowAssetData(t,e){const i=new Set;if(e.equippedSkinIds)for(const s of e.equippedSkinIds){const e=this.purchasableItems.get(s);if(e&&e.bowSkin){if(t&&e.bowSkin.bowId!=t)continue;for(const t of e.bowSkin.skins)i.add(t)}}return{skins:Array.from(i),arrowSkin:this.skinNetworkDataToArrowSkinConfig(e)}}skinNetworkDataToMeleeSkinConfig(t){if(t.equippedSkinIds){const e=[];for(const i of t.equippedSkinIds){const t=this.purchasableItems.get(i);t&&(t.meleeSkin&&e.push(t.meleeSkin))}if(1==e.length)return e[0]}return null}skinNetworkDataToArrowSkinConfig(t){if(t.equippedSkinIds){const e=[];for(const i of t.equippedSkinIds){const t=this.purchasableItems.get(i);t&&(t.arrowSkin&&e.push(t.arrowSkin))}if(1==e.length)return e[0]}return"baseSkins/arrow.glb"}getSkinFromShopItem(t,e){let i;return"male"==e?i=t.maleSkin:"female"==e&&(i=t.femaleSkin),i||null}getConfigForPreviewShopItemId(t,{itemId:e,colorCategory:i,colorMultiplier:s}){const n=new Set(t.equippedSkinIds);e&&this.addItemAndRemoveDuplicateSlots(n,e);const a={gender:t.gender,equippedSkinIds:Array.from(n),beardColorMultiplier:t.beardColorMultiplier,hairColorMultiplier:t.hairColorMultiplier,eyebrowColorMultiplier:t.eyebrowColorMultiplier};return i&&s&&("hair"==i?a.hairColorMultiplier=s:"eyebrows"==i?a.eyebrowColorMultiplier=s:"beard"==i&&(a.beardColorMultiplier=s)),a}onSkinConfigChange(t){this.onSkinConfigChangeCbs.add(t)}removeOnSkinConfigChange(t){this.onSkinConfigChangeCbs.delete(t)}}class PagedView{constructor({extraClasses:t=[]}={}){this.el=document.createElement("div"),this.el.classList.add("paged-view-container",...t),this.createdPageEls=[],this.rootStructure=null}setActiveStructure(t){this.rootStructure=t,this.createAndPushPage(t)}createAndPushPage(t){const e=document.createElement("div");if(e.classList.add("paged-view-page"),t.headerVisible||void 0===t.headerVisible){const i=document.createElement("div");i.classList.add("paged-view-page-header","blueNight"),e.appendChild(i);const s=document.createElement("div");s.classList.add("paged-view-page-header-line","wrinkledLine"),e.appendChild(s);const n=t==this.rootStructure;if(!n||t.onBackButtonClick){const e=new UiButton({ariaLabel:"Back",isIconButton:!0,icon:"static/img/arrow.svg",extraClasses:["header-button","header-back-button"],onClick:()=>{t.onBackButtonClick&&t.onBackButtonClick(),n||this.popPage()}});i.appendChild(e.el)}const a=document.createElement("h2");if(a.classList.add("paged-view-page-header-title"),a.textContent=t.header||t.itemName||"",i.appendChild(a),t.rightCorner){const e=document.createElement("div");e.classList.add("paged-view-page-header-corner"),i.appendChild(e),t.rightCorner(e)}}if(t.subPages&&t.customSubPage)throw new Error("Structures cannot have both subPages and customSubPage");if(t.customSubPageDestroyed&&!t.customSubPage)throw new Error("customSubPageDestroyed is only supported when customSubPage is also provided");let i=null;const s=[];if(t.subPages){const i=document.createElement("div");i.classList.add("paged-view-page-items-list"),e.appendChild(i);for(const e of t.subPages||[]){const t=new UiButton({icon:e.buttonIcon,iconSize:e.buttonIconSize});t.setText(e.itemName||""),t.onClick((()=>{this.createAndPushPage(e)})),i.appendChild(t.el),s.push({button:t,structure:e})}}else t.customSubPage&&(i=document.createElement("div"),i.classList.add("paged-view-page-custom-subpage"),e.appendChild(i),t.customSubPage(i));this.el.appendChild(e),this.createdPageEls.push({el:e,structure:t,visible:!1,customSubPageEl:i,createdButtons:s}),e.classList.add("hiddenright","hidden"),e.style.transition="none",e.offsetWidth,e.style.transition="",this.updatePageVisibilities(),this.updateButtonVisibilies()}popPage(){const t=this.createdPageEls.pop();t&&(t.el.classList.add("hiddenright"),t.el.classList.add("hidden"),setTimeout((()=>{this.el.removeChild(t.el);const e=t.structure;t.customSubPageEl&&e.customSubPageDestroyed&&e.customSubPageDestroyed(t.customSubPageEl)}),1e3)),this.updatePageVisibilities()}updateButtonVisibilies(){const t=this.createdPageEls[this.createdPageEls.length-1];if(t)for(const{button:e,structure:i}of t.createdButtons){let t=!0;i.buttonVisible&&!i.buttonVisible()&&(t=!1),e.el.style.display=t?"":"none"}}jumpToSubPage(t){if(!this.rootStructure)throw new Error("Failed to jump to subpage, no root structure set");const e=function t(e,i){if(e===i)return[i];if(!i.subPages)return null;for(const s of i.subPages){const n=t(e,s);if(n)return[i,...n]}return null}(t,this.rootStructure);if(!e)throw new Error("Failed to jump to subpage, structure not found in the current root structure");const i=e.slice(1);for(;this.createdPageEls.length>1;)this.popPage();for(const t of i)this.createAndPushPage(t)}updatePageVisibilities(){for(let t=0;t<this.createdPageEls.length;t++){const e=this.createdPageEls[t],i=e.visible,s=t>=this.createdPageEls.length-1,n=e.el;if(n.classList.toggle("hiddenleft",!s),n.classList.toggle("hidden",!s),n.inert=!s,n.classList.remove("hiddenright"),i!=s){const t=e.structure;s&&t.onBecomeVisible&&t.onBecomeVisible()}}}}class PlayerSkeletonLayer{constructor(t,e){this.skeletonPath=t,this.skeletonObject=null,this.onSkeletonLoadCbs=new Set,this.onObjectLinksBuilt=new Set,this._currentGender=e,this.weight=1,this.currentlyLoadingPoseAbortController=null,this.objectLinksBuilt=!1,this.objectLinks=[],this.reloadPose()}setGender(t){this._currentGender=t,this.reloadPose()}async reloadPose(){if(this.currentlyLoadingPoseAbortController){this.currentlyLoadingPoseAbortController.abort(),this.currentlyLoadingPoseAbortController=null;const t=new DOMException("Request aborted by signal.","AbortError");for(const{reject:e}of this.onSkeletonLoadCbs)e(t);this.onSkeletonLoadCbs.clear()}this.objectLinksBuilt=!1,this.skeletonObject=null;const t=`${this._currentGender}/${this.skeletonPath}`,e=new AbortController;this.currentlyLoadingPoseAbortController=e;let i=null;try{this.skeletonObject=await getMainInstance().skeletons.getSkeleton(t,{signal:this.currentlyLoadingPoseAbortController.signal})}catch(t){t instanceof DOMException&&t.name,i=t}if(i||this.skeletonObject||(i=new Error("Failed to load skeleton, result is null")),i){for(const{reject:t}of this.onSkeletonLoadCbs)t(i);this.onSkeletonLoadCbs.clear()}else if(!e.signal.aborted){for(const{resolve:t}of this.onSkeletonLoadCbs)t();this.onSkeletonLoadCbs.clear()}}async waitForLoad(){if(this.skeletonObject)return;const t=new Promise(((t,e)=>this.onSkeletonLoadCbs.add({resolve:t,reject:e})));await t}buildObjectLinks(t){if(this.objectLinks=[],!this.skeletonObject)throw new Error("Cannot build object links before the skeleton object is loaded");for(const e of traverseObject(this.skeletonObject)){const i=t.getObjectByName(e.name);i&&this.objectLinks.push([i,e])}this.objectLinksBuilt=!0,this.onObjectLinksBuilt.forEach((t=>t())),this.onObjectLinksBuilt.clear()}async waitForObjectLinks(){if(this.objectLinksBuilt)return;const t=new Promise((t=>this.onObjectLinksBuilt.add(t)));await t}apply(){if(0!=this.weight)if(1==this.weight)for(const[t,e]of this.objectLinks)t.position.copy(e.position),t.quaternion.copy(e.quaternion),t.scale.copy(e.scale);else for(const[t,e]of this.objectLinks)t.position.lerp(e.position,this.weight),t.quaternion.slerp(e.quaternion,this.weight),t.scale.lerp(e.scale,this.weight)}}class PlayerSkeleton{constructor({player:t=null,gender:e="male"}={}){this.player=t,this.isInit=!1,this.onInitCbs=new Set,this.onAllLinkLayerObjectsBuiltCbs=new Set,this._currentGender=e,this.poseLayers=[],this.skeletonMatrixObjects=[],this.baseSkeletonObject=null,this.headObj=null,this.bodyObj=null,this.armLObj=null,this.armRObj=null,this.legLObj=null,this.legRObj=null,this.initCalled=!1}async init(){if(this.initCalled)return await this.waitForLoad();this.initCalled=!0,this.baseSkeletonObject=await getMainInstance().skeletons.getSkeleton("male/baseRig",{clone:!0});for(const[t,e]of processedSkinNames.entries()){const i=this.baseSkeletonObject.getObjectByName(e);if(!i)throw new Error(`Assertion failed, skeleton does not have object with name ${e}`);this.skeletonMatrixObjects[t]=i}this.headObj=this.baseSkeletonObject.getObjectByName("head"),this.bodyObj=this.baseSkeletonObject.getObjectByName("torso"),this.armLObj=this.baseSkeletonObject.getObjectByName("upperArmL"),this.armRObj=this.baseSkeletonObject.getObjectByName("upperArmR"),this.legLObj=this.baseSkeletonObject.getObjectByName("upperLegL"),this.legRObj=this.baseSkeletonObject.getObjectByName("upperLegR"),this.isInit=!0;for(const t of this.onInitCbs)t();this.onInitCbs.clear()}async waitForLoad(){if(this.isInit)return;const t=new Promise((t=>this.onInitCbs.add(t)));await t}assertInit(){if(!this.isInit)throw new Error("PlayerSkeleton not initialized")}createPoseLayer(t){const e=new PlayerSkeletonLayer(t,this._currentGender);return this.linkLayerObjects(e),e}addPoseLayer(t){const e=this.createPoseLayer(t);return this.poseLayers.push(e),e}removePoseLayer(t){const e=this.poseLayers.indexOf(t);e>=0&&this.poseLayers.splice(e,1)}get gender(){return this._currentGender}setGender(t){if(this._currentGender!=t){this._currentGender=t;for(const e of this.poseLayers)e.setGender(t),this.linkLayerObjects(e)}}async linkLayerObjects(t){await this.waitForLoad();try{await t.waitForLoad()}catch(t){if(t instanceof DOMException&&"AbortError"==t.name)return;throw t}if(!this.baseSkeletonObject)throw new Error("Assertion failed, baseSkeletonObject not set");t.buildObjectLinks(this.baseSkeletonObject),this.allObjectLinksBuilt&&(this.onAllLinkLayerObjectsBuiltCbs.forEach((t=>t())),this.onAllLinkLayerObjectsBuiltCbs.clear())}get allObjectLinksBuilt(){for(const t of this.poseLayers)if(!t.objectLinksBuilt)return!1;return!0}async waitForLinkLayerObjects(){if(this.allObjectLinksBuilt)return;const t=new Promise((t=>this.onAllLinkLayerObjectsBuiltCbs.add(t)));await t}replacePoseLayer(t,e){const i=this.createPoseLayer(e);return this.poseLayers[t]=i,i}insertPoseLayer(t,e){const i=this.createPoseLayer(e);return this.poseLayers.splice(t,0,i),i}setLookRotY(t,e){if(this.bodyObj){const i=e.head??.3;this.applyLookRotation(this.bodyObj,new Vector3(1,0,0),t*i)}if(this.headObj){const i=e.head??.3;this.applyLookRotation(this.headObj,new Vector3(1,0,0),t*i)}if(this.armLObj){const i=e.armL||0;this.applyLookRotation(this.armLObj,new Vector3(1,0,0),t*i)}if(this.armRObj){const i=e.armR||0;this.applyLookRotation(this.armRObj,new Vector3(1,0,0),t*i)}}applyLookRotation(t,e,i){if(!t)return;const s=t.getWorldQuaternion(new Quaternion);s.invert();const n=e;n.applyQuaternion(s);const a=new Quaternion;a.setFromAxisAngle(n,i),t.quaternion.multiply(a)}applyLayers(){this.assertInit();for(const t of this.poseLayers)t.apply()}updateMatrices(){this.assertInit(),this.baseSkeletonObject&&this.baseSkeletonObject.updateWorldMatrix(!1,!0)}getMatrices(){return this.assertInit(),this.skeletonMatrixObjects.map((t=>t.matrixWorld))}}function isDay(t,e){const i=new Date(Date.now());return i.getUTCMonth()==e-1&&(i.getUTCDate()==t&&i.getUTCHours()>=7||i.getUTCDate()==t+1&&i.getUTCHours()<7)}const PLAYER_HIT_FLASH_ARRAY_LENGTH=5;class MaterialsManager{constructor(){this.materialsCache=new Map,this.extraMaterials=new Set,this.shadersHavePrecompiled=!1,this.hashes="\n\t\t\t// Hash without Sine\n\t\t\t// MIT License...\n\t\t\t// Copyright (c)2014 David Hoskins.\n\t\t\tfloat hash13(vec3 p3)\n\t\t\t{\n\t\t\t\tp3  = fract(p3 * .1031);\n\t\t\t\tp3 += dot(p3, p3.yzx + 33.33);\n\t\t\t\treturn fract((p3.x + p3.y) * p3.z);\n\t\t\t}\n\t\t\tfloat hash12(vec2 p)\n\t\t\t{\n\t\t\t\tvec3 p3  = fract(vec3(p.xyx) * .1031);\n\t\t\t\tp3 += dot(p3, p3.yzx + 33.33);\n\t\t\t\treturn fract((p3.x + p3.y) * p3.z);\n\t\t\t}\n\t\t\tvec3 hash33(vec3 p3)\n\t\t\t{\n\t\t\t\tp3 = fract(p3 * vec3(.1031, .1030, .0973));\n\t\t\t    p3 += dot(p3, p3.yxz+33.33);\n\t\t\t    return fract((p3.xxy + p3.yxx)*p3.zyx);\n\t\t\t}\n\t\t",this.saturateColorFn="\n\t\t\tvec3 saturateColor(vec3 rgb, float adjustment){\n\t\t\t\tconst vec3 W = vec3(0.2125, 0.7154, 0.0721);\n\t\t\t\tvec3 intensity = vec3(dot(rgb, W));\n\t\t\t\treturn mix(intensity, rgb, adjustment);\n\t\t\t}\n\t\t",this.gradientNoiseFn="\n\t\t\t// The MIT License\n\t\t\t// Copyright (c) 2013 Inigo Quilez\n\t\t\tfloat gradientNoise( in vec3 p )\n\t\t\t{\n\t\t\t    vec3 i = floor( p );\n\t\t\t    vec3 f = fract( p );\n\n\t\t\t\tvec3 u = f*f*(3.0-2.0*f);\n\n\t\t\t    return mix( mix( mix( dot( hash33( i + vec3(0.0,0.0,0.0) ), f - vec3(0.0,0.0,0.0) ),\n\t\t\t                          dot( hash33( i + vec3(1.0,0.0,0.0) ), f - vec3(1.0,0.0,0.0) ), u.x),\n\t\t\t                     mix( dot( hash33( i + vec3(0.0,1.0,0.0) ), f - vec3(0.0,1.0,0.0) ),\n\t\t\t                          dot( hash33( i + vec3(1.0,1.0,0.0) ), f - vec3(1.0,1.0,0.0) ), u.x), u.y),\n\t\t\t                mix( mix( dot( hash33( i + vec3(0.0,0.0,1.0) ), f - vec3(0.0,0.0,1.0) ),\n\t\t\t                          dot( hash33( i + vec3(1.0,0.0,1.0) ), f - vec3(1.0,0.0,1.0) ), u.x),\n\t\t\t                     mix( dot( hash33( i + vec3(0.0,1.0,1.0) ), f - vec3(0.0,1.0,1.0) ),\n\t\t\t                          dot( hash33( i + vec3(1.0,1.0,1.0) ), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );\n\t\t\t}\n\t\t"}init(){const t={vertexShaderOpts:{modifyColFn:"\n\t\t\t\t\tfloat upDot = dot(normal, vec3(0.0, 1.0, 0.0));\n\t\t\t\t\tcol += clamp(upDot * lightning, 0.0, 1.0);\n\t\t\t\t",extraVariables:"\n\t\t\t\t\tuniform float lightning;\n\t\t\t\t"},uniforms:{lightning:{value:0}}};this.basicUnlitMat=this.createMaterial({name:"default",...t}),this.basicUnlitMatDouble=this.createMaterial({name:"defaultDouble",side:DoubleSide,...t}),this.skyDomeMat=this.createMaterial({name:"skydome",fragmentShaderOpts:{modifyColFn:"\n\t\t\t\t\tcol = getFogcolor();\n\t\t\t\t"},fog:!1,needsFogColor:!0,needsModelPosVarying:!0,depthWrite:!1}),this.skyDomeMat.side=BackSide,this.lightsMat=this.createMaterial({name:"lights",fog:!1,applyWorldColor:!1,depthWrite:!1,depthTest:!0}),this.lightsMat.blending=AdditiveBlending,this.screenFlashMat=this.createMaterial({name:"screenFlash",fog:!1,applyWorldColor:!1,depthWrite:!1,depthTest:!1,uniforms:{vignetteAmount:{value:0},hasDirection:{value:0},theta:{value:0},baseOpacity:{value:0},opacity:{value:0},color:{value:new Vector3}},vertexShaderOpts:{useMvp:!1,needsUv:!0},fragmentShaderOpts:{needsUv:!0,extraVariables:"\n\t\t\t\t\tuniform float vignetteAmount;\n\t\t\t\t\tuniform float hasDirection;\n\t\t\t\t\tuniform float theta;\n\t\t\t\t\tuniform float baseOpacity;\n\t\t\t\t\tuniform float opacity;\n\t\t\t\t\tuniform vec3 color;\n\t\t\t\t",modifyColFn:"\n\t\t\t\t\tcol = color;\n\t\t\t\t\tfloat centerDist = length(vUv.xy - vec2(0.5));\n\t\t\t\t\talpha = mix(1.0, centerDist, vignetteAmount);\n\n\t\t\t\t\tvec2 rotatedUv = vUv.xy;\n\t\t\t\t\trotatedUv -= vec2(0.5);\n\t\t\t\t\trotatedUv = vec2(\n\t\t\t\t\t\trotatedUv.x * cos(theta) - rotatedUv.y * sin(theta),\n\t\t\t\t\t\trotatedUv.x * sin(theta) + rotatedUv.y * cos(theta)\n\t\t\t\t\t);\n\t\t\t\t\trotatedUv += vec2(0.5);\n\t\t\t\t\talpha *= mix(1.0, rotatedUv.y, hasDirection);\n\t\t\t\t\talpha *= opacity;\n\t\t\t\t\talpha = mix(alpha, 1.0, baseOpacity);\n\t\t\t\t"}}),this.screenFlashMat.transparent=!0,this.snowMat=this.createMaterial({name:"snow",vertexShaderOpts:{modifyColFn:"\n\t\t\t\t\tvec3 deltaPos = cameraPosition - worldPos.xyz;\n\t\t\t\t\t// edge = 1.0 - dot(normal, normalize(deltaPos));\n\t\t\t\t\tcol = vec3(0.6, 0.7, 0.8);\n\n\t\t\t\t\tfloat edge = pow(1.0 - dot(normal, normalize(deltaPos)), 3.0);\n\t\t\t\t\tedge = clamp(edge, 0.0, 1.0);\n\t\t\t\t\tcol = mix(vec3(0.6, 0.7, 0.8), vec3(1.5,1.5,1.5), edge);\n\t\t\t\t"}});const e={vertexShaderOpts:{extraVariables:"\n\t\t\t\t\tattribute float bowMorph;\n\t\t\t\t\tuniform float bowMorphAmount;\n\t\t\t\t",modifyWorldPosBeforeModelMatrixFn:"\n\t\t\t\t\tpos.z -= bowMorph * bowMorphAmount;\n\t\t\t\t"},uniforms:{bowMorphAmount:{value:0}}};this.bowMorph=this.createMaterial({...e,name:"bowMorph"}),this.bowMorphDouble=this.createMaterial({...e,name:"bowMorphDouble",side:DoubleSide});const i=isDay(11,5);this.arrowTrailMat=this.createMaterial({name:"arrowTrail",vertexShaderOpts:{extraVariables:"\n\t\t\t\t\tattribute float arrowT;\n\t\t\t\t\tvarying float vArrowT;\n\t\t\t\t\tattribute vec3 linePoint;\n\t\t\t\t",modifyWorldPosFn:"\n\t\t\t\t\tfloat camDist = length(cameraPosition - pos.xyz);\n\t\t\t\t\tfloat requiredVectorLength = camDist * 0.001;\n\t\t\t\t\tfloat currentNormalLength = length(normal);\n\t\t\t\t\tfloat desiredNormalLength = max(requiredVectorLength, currentNormalLength);\n\t\t\t\t\tvec3 clampedNormal = normal * (desiredNormalLength / currentNormalLength);\n\t\t\t\t\tpos.xyz += clampedNormal;\n\t\t\t\t\tvArrowT = arrowT;\n\t\t\t\t"},fragmentShaderOpts:{extraVariables:"\n\t\t\t\t\tuniform float arrowPosT;\n\t\t\t\t\tuniform float arrowShootT;\n\t\t\t\t\tuniform vec3 shootStartPos;\n\t\t\t\t\tuniform float estimatedXLength;\n\t\t\t\t\tvarying float vArrowT;\n\t\t\t\t",modifyColFn:`\n\t\t\t\t\tfloat t = arrowPosT - vArrowT;\n\t\t\t\t\tfloat shootT = arrowShootT - vArrowT;\n\t\t\t\t\talpha = 1.0;\n\n\t\t\t\t\t// fade in at start of trail\n\t\t\t\t\talpha = min(alpha, 0.2 * t - 0.5);\n\n\t\t\t\t\t// fade out at end of trail\n\t\t\t\t\talpha = min(alpha, 1.0 - 3.0 * (shootT / estimatedXLength));\n\n\t\t\t\t\talpha = min(alpha, length(shootStartPos - worldPos.xyz));\n\n\t\t\t\t\talpha = min(alpha, length(cameraPosition - worldPos.xyz) - 0.3);\n\n\t\t\t\t\talpha *= 0.4;\n\n\t\t\t\t\t${i?"\n\t\t\t\t\t\tfloat dist = length(cameraPosition - worldPos.xyz);\n\t\t\t\t\t\tfloat rainbowDist = 1.0 - exp(-dist * 0.05);\n\t\t\t\t\t\tvec4 rainbow = .5+.5*cos(6.283185*(rainbowDist +vec4(0,1,-1,0)/3.));\n\t\t\t\t\t\trainbow = min(rainbow,2.-rainbow);\n\t\t\t\t\t\tcol = mix(rainbow.rgb, vec3(1.), 0.0);\n\t\t\t\t\t\talpha *= 3.0;\n\t\t\t\t\t":""}\n\t\t\t\t`},depthWrite:!1,uniforms:{arrowPosT:{value:0},arrowShootT:{value:0},shootStartPos:{value:new Vector3},estimatedXLength:{value:1}}}),this.arrowTrailMat.transparent=!0;const s=processedSkinNames.length,n=[];for(let t=0;t<s;t++)n.push(new Matrix4);const a=[],o=[];for(let t=0;t<5;t++)a.push(0),o.push(new Vector3);const r={vertexShaderOpts:{extraVariables:`\n\t\t\t\t\tattribute float skinIndex;\n\t\t\t\t\tuniform mat4 skinMatrices[${s}];\n\t\t\t\t\tvarying vec3 vModelPos;\n\t\t\t\t`,modifyWorldPosBeforeModelMatrixFn:"\n\t\t\t\t\tpos = skinMatrices[int(skinIndex)] * pos;\n\t\t\t\t\tvModelPos = pos.xyz;\n\t\t\t\t"},fragmentShaderOpts:{extraVariables:"\n\t\t\t\t\tuniform float time;\n\t\t\t\t\tuniform float hitFlashTimes[5];\n\t\t\t\t\tuniform vec3 hitFlashPositions[5];\n\t\t\t\t\tvarying vec3 vModelPos;\n\t\t\t\t",modifyColFn:"\n\t\t\t\t\tfloat hitFlashAmount = 0.0;\n\t\t\t\t\tfor (int i = 0; i < 5; i++) {\n\t\t\t\t\t\tfloat t = time - hitFlashTimes[i];\n\t\t\t\t\t\tt *= 0.002;\n\t\t\t\t\t\tfloat centerDist = length(vModelPos - hitFlashPositions[i]);\n\t\t\t\t\t\tfloat flash = 1.0 - (centerDist - t * 6.0) * 50.0;\n\t\t\t\t\t\tflash = clamp(flash, 0.0, 1.0);\n\t\t\t\t\t\tflash *= clamp(1.0 - t, 0.0, 1.0);\n\t\t\t\t\t\thitFlashAmount = mix(hitFlashAmount, 1.0, flash);\n\t\t\t\t\t}\n\t\t\t\t\thitFlashAmount = clamp(hitFlashAmount, 0.0, 1.0);\n\t\t\t\t\tcol = mix(col, vec3(1.0, 0.0, 0.0), hitFlashAmount);\n\t\t\t\t"},uniforms:{skinMatrices:{value:n},time:{value:0},hitFlashTimes:{value:a},hitFlashPositions:{value:o}}};this.defaultMatSkinned=this.createMaterial({...r,name:"defaultSkinned"}),this.defaultDoubleMatSkinned=this.createMaterial({...r,name:"defaultDoubleSkinned",side:DoubleSide})}async precompileShaders(){if(this.shadersHavePrecompiled)return;const t=new Scene,e=new PlaneGeometry;e.setAttribute("color",new BufferAttribute(new Float32Array(16),4));const i=new Mesh(e);t.add(i);const s=getMainInstance(),n=s.renderer.renderer;if(!n)return;const a=s.cam.cam;for(const e of this.materialsCache.values())await getMainInstance().renderer.waitForFrameRender(),i.material=e,n.compile(t,a);this.shadersHavePrecompiled=!0}*allMaterials(){for(const t of this.materialsCache.values())yield t;for(const t of this.extraMaterials)yield t}getMaterialByName(t){return this.materialsCache.has(t)?this.materialsCache.get(t):this.basicUnlitMat}addCachedMaterial(t){t.name?this.materialsCache.set(t.name,t):console.warn("material doesn't have a name!")}addExtraMaterial(t){this.extraMaterials.add(t)}removeExtraMaterial(t){this.extraMaterials.delete(t)}applyWeatherParams(t){for(const e of this.allMaterials())e.uniforms.colorMultiplier.value.copy(t.colorMultiplier),e.uniforms.colorAdder.value.copy(t.colorAdder),e.uniforms.saturation.value=t.saturation,e.uniforms.skyLowCol.value.copy(t.skyLowColor),e.uniforms.skyHighCol.value.copy(t.skyHighColor),e.uniforms.skyMidCol.value.copy(t.skyMidColor),e.uniforms.skyPower.value=t.skyPower,e.uniforms.fogAmount.value=t.fogAmount,e.uniforms.fogHeightAmount.value=t.fogHeightAmount,e.uniforms.fogHeightOffset.value=t.fogHeightOffset,e.uniforms.fogHeightDistFalloff.value=t.fogHeightDistFalloff+1,e.uniforms.fogHeightAmountMin.value=t.fogHeightAmountMin,e.uniforms.fogHeightAmountMax.value=t.fogHeightAmountMax}static resetWeatherUniforms(t){t.uniforms.colorMultiplier.value.set(new Color(1,1,1)),t.uniforms.colorAdder.value.set(new Color(0,0,0)),t.uniforms.saturation.value=1,t.uniforms.fogAmount.value=0,t.uniforms.fogHeightAmountMin.value=0,t.uniforms.fogHeightAmountMax.value=0}setLightningValue(t){this.basicUnlitMat&&(this.basicUnlitMat.uniforms.lightning.value=t),this.basicUnlitMatDouble&&(this.basicUnlitMatDouble.uniforms.lightning.value=t)}buildVertexShader({name:t="",extraVariables:e="",modifyWorldPosFn:i="",modifyWorldPosAfterColorFn:s="",modifyWorldPosBeforeModelMatrixFn:n="",modifyColFn:a="",extraFunctions:o="",fog:r=!0,needsFogColor:l=!1,applyWorldColor:h=!0,useMvp:d=!0,needsModelPosVarying:c=!1,needsUv:u=!1}={}){return`\n\t\t\t//vertex shader for ${t}\n\n\t\t\t${r?"#define FOG":""}\n\t\t\t${l?"#define NEEDS_FOG_COLOR":""}\n\t\t\t${h?"#define APPLY_WORLD_COLOR":""}\n\t\t\t${d?"#define USE_MVP":""}\n\t\t\t${c?"#define NEEDS_MODEL_POS_VARYING":""}\n\t\t\t${u?"#define NEEDS_UV":""}\n\n\t\t\t#define PI 3.141592653589793\n\n\t\t\tvarying vec3 vColor;\n\t\t\tvarying vec4 worldPos;\n\t\t\t#ifdef FOG\n\t\t\t\t#define NEEDS_FOG_COLOR\n\t\t\t#endif\n\t\t\t#ifdef NEEDS_FOG_COLOR\n\t\t\t\tvarying float skyColorLerpValue;\n\t\t\t#endif\n\t\t\t#ifdef NEEDS_MODEL_POS_VARYING\n\t\t\t\tvarying vec3 vModelPos;\n\t\t\t#endif\n\t\t\t#ifdef NEEDS_UV\n\t\t\t\tvarying vec2 vUv;\n\t\t\t#endif\n\n\t\t\tuniform float saturation;\n\t\t\tuniform vec3 colorMultiplier;\n\t\t\tuniform vec3 colorAdder;\n\n\t\t\tvarying vec2 vHighPrecisionZW;\n\n\t\t\t${e}\n\n\t\t\t${o}\n\n\t\t\tvec4 modifyWorldPos(vec4 pos){\n\t\t\t\t${i}\n\t\t\t\treturn pos;\n\t\t\t}\n\n\t\t\tvec4 modifyWorldPosAfterColor(vec4 pos){\n\t\t\t\t${s}\n\t\t\t\treturn pos;\n\t\t\t}\n\n\t\t\tvec4 modifyWorldPosBeforeModelMatrix(vec4 pos){\n\t\t\t\t${n}\n\t\t\t\treturn pos;\n\t\t\t}\n\n\t\t\tvec3 modifyCol(vec3 col){\n\t\t\t\t${a}\n\t\t\t\treturn col;\n\t\t\t}\n\n\t\t\t${this.saturateColorFn}\n\n\t\t\tvoid main(){\n\t\t\t\tvec3 modelPosition = vec3(position);\n\t\t\t\tworldPos = vec4(modelPosition, 1.0);\n\t\t\t\t#ifdef USE_INSTANCING\n\t\t\t\t\tworldPos = instanceMatrix * worldPos;\n\t\t\t\t#endif\n\t\t\t\tworldPos = modifyWorldPosBeforeModelMatrix(worldPos);\n\t\t\t\t#ifdef USE_MVP\n\t\t\t\t\tworldPos = modelMatrix * worldPos;\n\t\t\t\t#endif\n\t\t\t\tworldPos = modifyWorldPos(worldPos);\n\t\t\t\t#ifdef NEEDS_UV\n\t\t\t\t\tvUv = uv;\n\t\t\t\t#endif\n\t\t\t\tvec3 col = modifyCol(color.rgb);\n\t\t\t\t#ifdef APPLY_WORLD_COLOR\n\t\t\t\t\tcol = saturateColor(col, saturation);\n\t\t\t\t\tcol *= colorMultiplier;\n\t\t\t\t\tcol += colorAdder;\n\t\t\t\t#endif\n\t\t\t\tvColor = col;\n\n\t\t\t\t#ifdef NEEDS_FOG_COLOR\n\t\t\t\t\tvec3 deltaPos = cameraPosition - vec3(worldPos);\n\t\t\t\t\tfloat angle = dot(vec3(0.0,-1.0,0.0), normalize(deltaPos));\n\t\t\t\t\tangle = clamp(angle, -PI, PI);\n\t\t\t\t\tangle = acos(angle);\n\t\t\t\t\tskyColorLerpValue = 1.0 - angle / 1.57;\n\t\t\t\t#endif\n\t\t\t\t#ifdef NEEDS_MODEL_POS_VARYING\n\t\t\t\t\tvModelPos = position;\n\t\t\t\t#endif\n\t\t\t\t#ifdef FOG\n\t\t\t\t#endif\n\n\t\t\t\tworldPos = modifyWorldPosAfterColor(worldPos);\n\n\t\t\t\t#ifdef USE_MVP\n\t\t\t\t\tvec4 modelViewPosition = viewMatrix * worldPos;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewPosition;\n\t\t\t\t#else\n\t\t\t\t\tgl_Position = worldPos;\n\t\t\t\t#endif\n\t\t\t}\n\t\t`}buildFragShader({name:t="",extraVariables:e="",modifyColFn:i="",modifyTexColFn:s="",extraFunctions:n="",fog:a=!0,needsFogColor:o=!1,needsModelPosVarying:r=!1,needsUv:l=!1}={}){return`\n\t\t\t//fragment shader for ${t}\n\n\t\t\t${a?"#define FOG":""}\n\t\t\t${o?"#define NEEDS_FOG_COLOR":""}\n\t\t\t${r?"#define NEEDS_MODEL_POS_VARYING":""}\n\t\t\t${l?"#define NEEDS_UV":""}\n\n\t\t\tvarying vec3 vColor;\n\t\t\tvarying vec4 worldPos;\n\n\t\t\tuniform vec3 skyHighCol;\n\t\t\tuniform vec3 skyMidCol;\n\t\t\tuniform vec3 skyLowCol;\n\t\t\tuniform float skyPower;\n\t\t\t#ifdef FOG\n\t\t\t\tuniform float fogAmount;\n\t\t\t\tuniform float fogHeightAmount;\n\t\t\t\tuniform float fogHeightOffset;\n\t\t\t\tuniform float fogHeightDistFalloff;\n\t\t\t\tuniform float fogHeightAmountMin;\n\t\t\t\tuniform float fogHeightAmountMax;\n\t\t\t\tfloat fogLerpValue;\n\t\t\t\t#define NEEDS_FOG_COLOR\n\t\t\t#endif\n\t\t\t#ifdef NEEDS_FOG_COLOR\n\t\t\t\tvarying float skyColorLerpValue;\n\t\t\t#endif\n\t\t\t#ifdef NEEDS_MODEL_POS_VARYING\n\t\t\t\tvarying vec3 vModelPos;\n\t\t\t#endif\n\t\t\t#ifdef NEEDS_UV\n\t\t\t\tvarying vec2 vUv;\n\t\t\t#endif\n\n\t\t\tfloat alpha = 1.0;\n\n\t\t\t#include <packing>\n\t\t\tvarying vec2 vHighPrecisionZW;\n\n\t\t\t${e}\n\n\t\t\t#ifdef NEEDS_FOG_COLOR\n\t\t\t\tvec3 getFogcolor(){\n\t\t\t\t\tfloat absLerpValue = abs(skyColorLerpValue);\n\t\t\t\t\tfloat lerpValue = pow(max(0.0, absLerpValue), skyPower);\n\t\t\t\t\tif (skyColorLerpValue < 0.0) {\n\t\t\t\t\t\treturn mix(skyMidCol, skyLowCol, lerpValue);\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn mix(skyMidCol, skyHighCol, lerpValue);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t#endif\n\n\t\t\t#ifdef FOG\n\t\t\tvec3 applyFog(vec3 col){\n\t\t\t\tcol = mix(col, getFogcolor(), fogLerpValue);\n\t\t\t\treturn col;\n\t\t\t}\n\t\t\t#endif\n\n\t\t\t${n}\n\n\t\t\tvec3 modifyCol(vec3 col){\n\t\t\t\t${i}\n\t\t\t\treturn col;\n\t\t\t}\n\n\t\t\tvec4 modifyTexCol(vec4 col, vec2 uv){\n\t\t\t\t${s}\n\t\t\t\treturn col;\n\t\t\t}\n\n\t\t\tfloat computeFog(float dist, float fogAmount) {\n\t\t\t\treturn 1.0 - exp(-dist * fogAmount);\n\t\t\t}\n\n\t\t\tfloat computeHeightFog(float fogAmount, float fogHeightAmount, float dist, float originHeight, float deltaHeight) {\n\t\t\t\tfloat h = fogHeightAmount;\n\t\t\t\tfloat fog = (fogAmount / h) * exp(-originHeight * h) * (1.0 - exp(-dist * deltaHeight * h)) / deltaHeight;\n\t\t\t\treturn clamp(fog, 0.0, 1.0);\n\t\t\t}\n\n\t\t\tvoid main(){\n\t\t\t\t#ifdef FOG\n\t\t\t\t\tvec3 deltaPos = vec3(worldPos) - cameraPosition;\n\t\t\t\t\tfloat fogDistValue = length(deltaPos);\n\t\t\t\t\tif (fogHeightAmount < 0.00001) {\n\t\t\t\t\t\tfogLerpValue = computeFog(fogDistValue, fogAmount);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tfloat min = computeFog(fogDistValue, fogHeightAmountMin);\n\t\t\t\t\t\tfloat max = computeFog(fogDistValue, fogHeightAmountMax);\n\t\t\t\t\t\tfloat distAmount = fogHeightAmount * pow(fogHeightDistFalloff, - fogDistValue);\n\t\t\t\t\t\tfloat heightFog = computeHeightFog(fogAmount, distAmount, fogDistValue, cameraPosition.y - fogHeightOffset, normalize(deltaPos).y);\n\t\t\t\t\t\tfogLerpValue = clamp(heightFog, min, max);\n\t\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\tvec3 col = modifyCol(vColor);\n\t\t\t\t#ifdef FOG\n\t\t\t\t\tcol = applyFog(col);\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = LinearTosRGB(vec4(col, alpha));\n\t\t\t}\n\t\t`}createMaterial({name:t="",vertexShaderOpts:e={},fragmentShaderOpts:i={},exactVertShader:s=null,exactFragShader:n=null,uniforms:a={},defaultAttributeValues:o={},fog:r=!0,needsFogColor:l=!1,applyWorldColor:h=!0,needsModelPosVarying:d=!1,needsUv:c=!1,depthWrite:u=!0,depthTest:p=!0,side:g=FrontSide}={}){const m={fog:r,needsFogColor:l,needsModelPosVarying:d,needsUv:c,applyWorldColor:h};let f,w;e={name:t,...m,...e},i={name:t,...m,...i},f=s||this.buildVertexShader(e),w=n||this.buildFragShader(i),a={saturation:{value:1},colorMultiplier:{value:new Color(1,1,1)},colorAdder:{value:new Color(0,0,0)},skyHighCol:{value:new Color},skyMidCol:{value:new Color},skyLowCol:{value:new Color},skyPower:{value:1},fogAmount:{value:.002},fogHeightAmount:{value:0},fogHeightOffset:{value:0},fogHeightDistFalloff:{value:0},fogHeightAmountMin:{value:0},fogHeightAmountMax:{value:0},...a};const b=new ShaderMaterial({name:t,vertexShader:f,fragmentShader:w,uniforms:a,side:g,vertexColors:!0,depthWrite:u,depthTest:p});return b.defaultAttributeValues={...b.defaultAttributeValues,...o},this.addCachedMaterial(b),b}}function computeApproximateBoundingSphere(t,{skinMatrices:e=null}={}){let i=null;const s=new Vector3;for(const n of traverseObject(t))if(n instanceof Mesh&&n.geometry){const t=n.geometry.attributes.position,a=n.geometry.attributes.skinIndex;for(let n=0;n<t.count;n++){if(s.fromBufferAttribute(t,n),a&&e){const t=e[a.getX(n)];s.applyMatrix4(t)}i?i.expandByPoint(s):i=new Box3(s.clone(),s.clone())}}if(!i)return new Sphere(new Vector3(0,0,0),1);const n=i.getCenter(new Vector3);let a=0;for(const i of traverseObject(t))if(i instanceof Mesh&&i.geometry){const t=i.geometry.attributes.position,o=i.geometry.attributes.skinIndex;for(let i=0;i<t.count;i++){if(s.fromBufferAttribute(t,i),o&&e){const t=e[o.getX(i)];s.applyMatrix4(t)}const r=n.distanceTo(s);a=Math.max(a,r)}}return new Sphere(n,a)}class PlayerModel{constructor({skinObjectOpts:t,init:e=!0,useWorldWeather:i=!0}){this.skinObjectOpts=t,this.isInit=!1,this.destructed=!1,this.obj=null,this.materials=[],this.lastSetMatrices=null,this.onInitCbs=new Set,this.getSkinAbortController=new AbortController,this.useWorldWeather=i,this.initCalled=!1,e&&this.init()}destructor(){this.destructed=!0;for(const t of this.materials)t.dispose();if(this.materials=[],this.obj){for(const t of traverseObject(this.obj))t instanceof Mesh&&t.geometry.dispose();this.obj=null}this.getSkinAbortController.abort()}async init(){if(this.initCalled)return await this.waitForInit();this.initCalled=!0;let t=null;try{t=await getMainInstance().skins.getSkinObject(this.skinObjectOpts,this.getSkinAbortController.signal)}catch(t){if(!(this.destructed&&t instanceof DOMException&&"AbortError"==t.name))throw t}if(t&&(t.geometry.boundingSphere=new Sphere(new Vector3(0,1,0),1),!this.destructed)){this.obj=t;const e=new Map;this.obj.traverse((t=>{if(t instanceof Mesh)if(Array.isArray(t.material)){const i=t.material;for(const[s,n]of i.entries()){let i=e.get(n);i||(i=n.clone(),this.materials.push(i),e.set(n,i)),t.material[s]=i}}else{let i=e.get(t.material);if(!i){i=t.material.clone(),this.materials.push(i),e.set(t.material,i)}t.material=i}}))}if(!this.useWorldWeather)for(const t of this.materials)MaterialsManager.resetWeatherUniforms(t);this.isInit=!0;for(const t of this.onInitCbs)t();this.onInitCbs.clear()}async waitForInit(){if(this.isInit)return;const t=new Promise((t=>this.onInitCbs.add(t)));await t}applySkeleton(t){this.lastSetMatrices=t.getMatrices();for(const t of this.materials)t.uniforms.skinMatrices&&(t.uniforms.skinMatrices.value=this.lastSetMatrices)}setHitFlashMaterialsTime(t){for(const e of this.materials)e.uniforms.time.value=t}setHitFlashMaterialsValue(t,e,i){if(t<0||t>=5)throw new Error("Invalid index");for(const s of this.materials)s.uniforms.hitFlashTimes.value[t]=e,s.uniforms.hitFlashPositions.value[t].copy(i)}computeApproximateBoundingSphere(){if(!this.obj)throw new Error("No model loaded");return computeApproximateBoundingSphere(this.obj,{skinMatrices:this.lastSetMatrices})}}class ConfirmItemPurchaseDialogUi extends DialogUi{constructor(t,{renderOptions:e}){super({title:"Confirm your purchase",testLabel:"confirmPurchase"}),this.onPurchaseSuccessCbs=new Set,this.shopItem=new ShopItem(t,{usage:"confirmPurchase",renderOptions:e,dialog:this}),this.el.appendChild(this.shopItem.el),this.addButtonsContainer(),this.addButton({text:"Cancel",testLabel:"cancel",onClick:()=>{this.close()}});const i={testLabel:"purchase",onClick:async()=>{await this.purchaseButtonClick()}};t.price&&t.price>0?(i.showCurrency=!0,i.currency=t.price):(i.text="Get Item",t.hasRewardedAd&&(i.icon="static/img/rewardedAdIcon.svg")),this.purchaseButton=this.addButton(i),getMainInstance().shopState.isPurchasingItem(t.id)&&(this.setButtonEnabled(!1),(async()=>{await getMainInstance().shopState.waitForItemPurchase(t.id),this.setButtonEnabled(!0)})())}destructor(){this.shopItem.destructor(),super.destructor()}setButtonEnabled(t){this.purchaseButton.enabled=t}async purchaseButtonClick(){this.setButtonEnabled(!1);const t=getMainInstance();await t.shopState.purchaseItem(this.shopItem.config,t.poki,t.dialogManager,"shop")?(this.onPurchaseSuccessCbs.forEach((t=>t())),this.close()):this.setButtonEnabled(!0)}onPurchaseSuccess(t){this.onPurchaseSuccessCbs.add(t)}}class ConfigObjectAssetLoader{constructor({useWorldWeather:t=!0,label:e=""}={}){this.obj=new Object3D,this.obj.name=`${e} asset loader`,this.label=e,this.useWorldWeather=t,this.currentlyLoadingAbortController=null,this.currentAssetName="",this.currentMeleeAsset=null,this.onFirstAssetLoadCbs=new Set,this.onNewAssetLoadedCbs=new Set,this.currentlyLoadedMaterials=[]}destructor(){this.destroyMaterials(),this.destroyBowMeshes()}async setConfig(t){this.currentlyLoadingAbortController&&this.currentlyLoadingAbortController.abort();const e=new AbortController;this.currentlyLoadingAbortController=e;const i=getMainInstance();let s=null;if(t.skinAssetName){const e=t.skinAssetName,n=t.fallbackSkinAssetName;let a;try{a=await i.skins.buildConfigObject({...t,label:this.label,skinAssetName:e,fallbackSkinAssetName:n},this.currentlyLoadingAbortController.signal)}catch(t){if(t instanceof DOMException&&"AbortError"==t.name)return;throw t}s=a.asset}this.currentMeleeAsset&&this.obj.remove(this.currentMeleeAsset),this.currentMeleeAsset=null,this.destroyMaterials(),this.destroyBowMeshes(),s&&(this.currentMeleeAsset=s,this.obj.add(s)),this.currentlyLoadingAbortController=null,this.onFirstAssetLoadCbs.forEach((t=>t())),this.onFirstAssetLoadCbs.clear(),this.onNewAssetLoadedCbs.forEach((t=>t()))}destroyMaterials(){for(const t of this.currentlyLoadedMaterials)t.dispose();this.currentlyLoadedMaterials=[]}destroyBowMeshes(){if(this.currentMeleeAsset)for(const t of traverseObject(this.currentMeleeAsset))t instanceof Mesh&&t.geometry.dispose()}async waitForLoad(){if(!this.isLoadingAsset)return;const t=new Promise((t=>this.onFirstAssetLoadCbs.add(t)));await t}get isLoadingAsset(){return!this.currentMeleeAsset||Boolean(this.currentlyLoadingAbortController)}onNewAssetLoaded(t){this.onNewAssetLoadedCbs.add(t)}}const bowMorphOpts={smallBow:{stringPullAmountTop:.12,stringPullAmountMiddle:.26,stringPullAmountBottom:.17},mediumBow:{bendAmount:.2,stringDistFar:.7,stringPullAmountTop:.045,stringPullAmountMiddle:.53,stringPullAmountBottom:.135},largeBow:{stringPullAmountTop:.24,stringPullAmountMiddle:.53,stringPullAmountBottom:.25},smallCrossbow:{stringDistNear:.02,stringDistFar:.2,stringPullAmountTop:0,stringPullAmountMiddle:.09,stringPullAmountBottom:0},largeCrossbow:{stringDistFar:.7,stringPullAmountTop:.12,stringPullAmountMiddle:.26,stringPullAmountBottom:.12},repeatingCrossbow:{stringDistNear:.1,stringDistFar:.2,bendAmount:.1,stringPullAmountTop:.02,stringPullAmountMiddle:.135,stringPullAmountBottom:.02}};class BowAssetLoader{constructor({useWorldWeather:t=!0}={}){this.obj=new Object3D,this.obj.name="Bow asset loader",this.useWorldWeather=t,this.lastFireAmount01=0,this.lastVisibleCount=0,this.currentBowAsset=null,this.onFirstAssetLoadCbs=new Set,this.onAssetChangeCbs=new Set,this.currentlyLoadingAbortController=null,this.currentlyLoadedMaterials=[],this.currentArrowObjs=[],this.currentArrowOffsets=[],this.onArrowDestroyCallbacks=new Set,this.arrowAssetLoader=new ConfigObjectAssetLoader({useWorldWeather:t,label:"Arrow"}),this.arrowAssetLoader.onNewAssetLoaded((()=>{this.rebuildArrowObjects(),this.onArrowDestroyCallbacks.forEach((t=>t())),this.onArrowDestroyCallbacks.clear()})),this.arrowObjectsConfig={arrowCount:0,arrowPositions:"stacked"},this.arrowPointIdle=new Object3D,this.arrowPointIdle.name="Arrow point idle",this.obj.add(this.arrowPointIdle),this.arrowPointLoaded=new Object3D,this.arrowPointLoaded.name="Arrow point loaded",this.obj.add(this.arrowPointLoaded)}destructor(){this.destroyMaterials(),this.destroyBowMeshes(),this.arrowAssetLoader.setConfig({skinAssetName:null})}async setConfig(t){this.arrowAssetLoader.setConfig({skinAssetName:t.arrowSkin,fallbackSkinAssetName:"baseSkins/arrow.glb",teamColor:t.teamColor,teamId:t.teamId}),this.currentlyLoadingAbortController&&this.currentlyLoadingAbortController.abort();const e=new AbortController;this.currentlyLoadingAbortController=e;const i=getMainInstance();let s,n={};t.bowId&&(n=bowMorphOpts[t.bowId]||{});try{s=await i.skins.getBowObject({name:t.bowId,teamId:t.teamId,teamColor:t.teamColor,morphOpts:n,skinAssets:t.skins,separateObjectNames:t.separateObjectNames||[]},this.currentlyLoadingAbortController.signal)}catch(t){if(t instanceof DOMException&&"AbortError"==t.name)return;throw t}const{bow:a,arrowPointIdleMatrix:o,arrowPointLoadedMatrix:r}=s;if(this.currentBowAsset&&this.obj.remove(this.currentBowAsset),this.destroyMaterials(),this.destroyBowMeshes(),this.currentBowAsset=a,this.obj.add(a),!(a instanceof Mesh))throw new Error("Assertion failed, bow is not a mesh");const l=a.material;if(!Array.isArray(l))throw new Error("Assertion failed, materials is not an array");for(let t=0;t<l.length;t++){const e=l[t].clone();l[t]=e,e instanceof ShaderMaterial&&(this.useWorldWeather||MaterialsManager.resetWeatherUniforms(e)),this.currentlyLoadedMaterials.push(e)}this.arrowPointIdle.position.set(0,0,0),this.arrowPointIdle.quaternion.identity(),this.arrowPointIdle.scale.set(1,1,1),this.arrowPointIdle.applyMatrix4(o),this.arrowPointLoaded.position.set(0,0,0),this.arrowPointLoaded.quaternion.identity(),this.arrowPointLoaded.scale.set(1,1,1),this.arrowPointLoaded.applyMatrix4(r);const h=t.arrowCount??1,d=t.arrowPositions??"stacked";this.arrowObjectsConfig.arrowCount==h&&this.arrowObjectsConfig.arrowPositions==d||(this.arrowObjectsConfig={arrowCount:h,arrowPositions:d},this.rebuildArrowObjects()),this.internalUpdateFireAmount(),this.currentlyLoadingAbortController=null,this.onFirstAssetLoadCbs.forEach((t=>t())),this.onFirstAssetLoadCbs.clear(),this.onAssetChangeCbs.forEach((t=>t(a)))}rebuildArrowObjects(){this.currentArrowOffsets=[];for(const t of this.currentArrowObjs)this.obj.remove(t);this.currentArrowObjs=[];const t=this.arrowAssetLoader.obj.children[0];if(t){for(let e=0;e<this.arrowObjectsConfig.arrowCount;e++){const i=t.clone();i.position.z=.6,this.obj.add(i),this.currentArrowObjs.push(i);const s=new Vector2;"stacked"==this.arrowObjectsConfig.arrowPositions?s.set(0,.01*e):(s.x=Math.cos(e)*e*.01,s.y=Math.sin(e)*e*.01),this.currentArrowOffsets.push(s)}this.internalUpdateFireAmount()}}getClonedArrowObject(t){const e=this.arrowAssetLoader.obj.children[0];return e?(this.onArrowDestroyCallbacks.add(t),e.clone()):null}destroyMaterials(){for(const t of this.currentlyLoadedMaterials)t.dispose();this.currentlyLoadedMaterials=[]}destroyBowMeshes(){if(this.currentBowAsset)for(const t of traverseObject(this.currentBowAsset))t instanceof Mesh&&t.geometry.dispose()}async waitForLoad(){if(!this.isLoadingAsset)return;const t=new Promise((t=>this.onFirstAssetLoadCbs.add(t)));await t}onAssetChange(t){this.onAssetChangeCbs.add(t)}get isLoadingAsset(){return!this.currentBowAsset||Boolean(this.currentlyLoadingAbortController)}get assetLoaded(){return Boolean(this.currentBowAsset)}getLoadedArrowPointScale(){return this.arrowPointLoaded.scale}updateFireAmount(t,e){this.lastFireAmount01=t,this.lastVisibleCount=e,this.internalUpdateFireAmount()}internalUpdateFireAmount(){for(const[t,e]of this.currentArrowObjs.entries()){e.position.lerpVectors(this.arrowPointIdle.position,this.arrowPointLoaded.position,this.lastFireAmount01);const i=this.currentArrowOffsets[t];e.position.x+=i.x,e.position.y+=i.y,e.scale.lerpVectors(this.arrowPointIdle.scale,this.arrowPointLoaded.scale,this.lastFireAmount01),e.quaternion.slerpQuaternions(this.arrowPointIdle.quaternion,this.arrowPointLoaded.quaternion,this.lastFireAmount01),e.visible=this.lastVisibleCount>t}for(const t of this.currentlyLoadedMaterials)t instanceof ShaderMaterial&&(t.uniforms.bowMorphAmount.value=this.lastFireAmount01)}}const statClassConfigs=new Map;statClassConfigs.set("movementSpeed",{icon:"static/img/menuUI/shop/classIcons/movementSpeed.svg",uiName:"Movement Speed",defaultValue:0,min:0,max:20}),statClassConfigs.set("armorStrength",{icon:"static/img/menuUI/shop/classIcons/armorStrength.svg",uiName:"Damage Protection",defaultValue:0,min:0,max:20}),statClassConfigs.set("healthRegenSpeed",{icon:"static/img/menuUI/shop/classIcons/healthRegenSpeed.svg",uiName:"Health Regen Speed",defaultValue:0,min:0,max:20}),statClassConfigs.set("shootingFocus",{icon:"static/img/menuUI/shop/classIcons/shootingFocus.svg",uiName:"Focus",defaultValue:0,min:0,max:10}),statClassConfigs.set("bowAttackStrength",{icon:"static/img/menuUI/shop/classIcons/bowAttackStrength.svg",uiName:"Attack Strength",defaultValue:0,min:0,max:10}),statClassConfigs.set("arrowLoadingSpeed",{icon:"static/img/menuUI/shop/classIcons/arrowLoadingSpeed.svg",uiName:"Loading Speed",defaultValue:0,min:0,max:5}),statClassConfigs.set("arrowFlySpeed",{icon:"static/img/menuUI/shop/classIcons/arrowFlySpeed.svg",uiName:"Travel Speed",defaultValue:0,min:0,max:5}),statClassConfigs.set("arrowEnemyStun",{icon:"static/img/menuUI/shop/classIcons/arrowEnemyStun.svg",uiName:"Stun Enemy",defaultValue:0,min:0,max:5}),statClassConfigs.set("meleeAttackStrength",{icon:"static/img/menuUI/shop/classIcons/meleeAttackStrength.svg",uiName:"Strength",defaultValue:0,min:0,max:5}),statClassConfigs.set("meleeAttackSpeed",{icon:"static/img/menuUI/shop/classIcons/meleeAttackSpeed.svg",uiName:"Speed",defaultValue:0,min:0,max:5}),statClassConfigs.set("meleeAttackReach",{icon:"static/img/menuUI/shop/classIcons/meleeAttackReach.svg",uiName:"Reach",defaultValue:0,min:0,max:5}),statClassConfigs.set("bloodlust",{icon:"static/img/menuUI/shop/classIcons/bloodlust.svg",uiName:"Bloodlust",defaultValue:0,min:0,max:11});class StatClassTooltip{constructor({zIndex:t,statClasses:e,aboveRect:i,showTotal:s}){this.el=document.createElement("div"),this.el.classList.add("stat-class-tooltip","transitioning","wrinkledPaper"),this.el.style.setProperty("--wrinkled-paper-seed",String(randInt(1,99999))),this.el.style.zIndex=String(t),document.body.appendChild(this.el);const n=document.createElement("ul");this.el.appendChild(n);for(const[t,i]of statClassConfigs){const a=e[t]||0;if(!s&&0==a)continue;const o=document.createElement("li");n.appendChild(o);const r=document.createElement("span");let l;if(r.classList.add("stat-class-icon"),r.style.backgroundImage=`url("${i.icon}")`,o.appendChild(r),s){const t=Math.min(a+i.defaultValue,i.max);l=`${i.uiName}: ${t}/${i.max}`}else l=`+${a} ${i.uiName}`;const h=document.createTextNode(l);o.appendChild(h)}this.el.style.left=i.left+i.width/2+"px",this.el.style.top=i.top+"px",getComputedStyle(this.el).left,this.el.classList.remove("transitioning")}destructor(){this.el.remove()}}class ShopItem{constructor(t,{configIndex:e=0,usage:i="shop",renderOptions:s,dialog:n,scrollingContainer:a}){if(this.configIndex=e,this.config=t,this.usage=i,this.renderOptions=s,this.dialog=n,this.destructed=!1,"shop"==i)this.el=document.createElement("button");else{if("confirmPurchase"!=i)throw new Error(`Unknown usage: ${i}`);this.el=document.createElement("div")}this.el.classList.add("shopItem","wrinkledPaper","shopItemUsage-"+i),t.preventUnequip&&this.el.classList.add("preventUnequip"),this.el.style.cssText=`\n\t\t\t--wrinkled-paper-seed: ${randInt(1,99999)};\n\t\t`,this.onSelectedChangeRequestCbs=new Set,this.statsTooltip=null,this.onHoveringChangeCbs=new Set,this.selected=!1,this.owned=!1,this.isHovering=!1,this.isLooping=!1,this.shouldStopLooping=!1,this.prevNow=0,this.boundAnimationLoop=this.animationLoop.bind(this),this.el.addEventListener("pointerenter",(()=>{this.setIsHovering(!0),this.addStatsTooltip()})),this.el.addEventListener("pointerleave",(()=>{this.setIsHovering(!1),this.removeStatsTooltip()})),this.boundRemoveStatsTooltip=this.removeStatsTooltip.bind(this),this.scrollingContainer=a,a&&a.addEventListener("scroll",this.boundRemoveStatsTooltip),this.el.addEventListener("click",(()=>{"confirmPurchase"!=this.usage&&(this.owned||this.selected?this.requestSelectedState(!this.selected):this.openConfirmPurchaseDialog())})),this.onConfirmPurchaseDialogOpenCbs=new Set;this.renderView=getMainInstance().renderer.createRenderView({width:200,height:200}),(this.config.meleeSkin||this.config.bowSkin)&&this.renderView.canvas.classList.add("needs-mask"),this.el.appendChild(this.renderView.canvas),this.cam=new PerspectiveCamera,this.cam.name="cam",this.cam.far=10,this.camTarget=new Object3D,this.camTarget.name="cam target",this.rotY=0,this.defaultRotY=0,this.setDefaultRotY(.2*Math.PI),this.camTarget.add(this.cam),this.scene=new Scene,this.scene.add(this.camTarget),this.renderView.setRenderObjects(this.scene,this.cam,!1),this.skeleton=new PlayerSkeleton({gender:this.renderOptions.gender}),this.skeleton.addPoseLayer("shopItem"),this.loadingModelSym=null,this.loadingModel=null,this.visibleModel=null,this.skinObject=null,this.bowAsset=null,this.skinObjectAsset=null,this.currencyWrapperEl=null,this.currencyContainer=null,"shop"==i?this.setOwned(!this.config.price&&!this.config.hasRewardedAd):this.setOwned(!0),this.lockEl=document.createElement("div"),this.lockEl.classList.add("shopItemLock"),this.lockEl.classList.toggle("rewarded-break-unlockable",this.config.hasRewardedAd||!1),this.el.appendChild(this.lockEl),this.elementVisible=!1,this.skinObjectDirty=!0,this.intersectionObserver=new IntersectionObserver((t=>{this.elementVisible=!1;for(const e of t)e.target==this.el&&e.isIntersecting&&(this.elementVisible=!0);this.elementVisible&&this.reloadSkinObjectNow()})),this.intersectionObserver.observe(this.el),this.setSelectedState(this.selected),this.setOwned(this.owned),"confirmPurchase"==this.usage&&this.startLooping(),this.updateAriaLabel()}get id(){return this.config.id}destructor(){this.destructed=!0,getMainInstance().renderer.removeRenderView(this.renderView),this.loadingModel&&this.loadingModel.destructor(),this.visibleModel&&this.visibleModel.destructor(),this.bowAsset&&this.bowAsset.destructor(),this.stopLooping(),this.intersectionObserver.unobserve(this.el),this.intersectionObserver.disconnect(),this.removeStatsTooltip(),this.scrollingContainer&&this.scrollingContainer.removeEventListener("scroll",this.boundRemoveStatsTooltip)}setRenderOptions(t){this.renderOptions=t,this.skinObjectDirty=!0,this.elementVisible&&this.reloadSkinObjectNow()}setDefaultRotY(t){this.defaultRotY=t,this.camTarget.rotation.set(-.1*Math.PI,this.defaultRotY,0,"YZX")}async reloadSkinObjectNow(){if(!this.skinObjectDirty)return;const t=Symbol("Loading model");this.loadingModelSym=t,this.loadingModel&&(this.loadingModel.destructor(),this.loadingModel=null);let e=new Sphere;if(this.bowAsset&&this.bowAsset.destructor(),this.skinObjectAsset&&this.skinObjectAsset.destructor(),this.config.bowSkin){const{skins:i,arrowSkin:s}=getMainInstance().skins.skinNetworkDataToBowAssetData(this.config.bowSkin.bowId,{equippedSkinIds:[this.config.id]});if(this.bowAsset=new BowAssetLoader({useWorldWeather:!1}),this.bowAsset.setConfig({bowId:this.config.bowSkin.bowId,teamId:1,skins:i,arrowSkin:s,arrowCount:0}),this.config.categories){let t=!1;const e=["smallBowHandle","mediumBowHandle","largeBowHandle"];for(const i of this.config.categories)if(e.includes(i)){t=!0;break}t&&this.bowAsset.obj.rotateZ(-.4)}if(this.scene.add(this.bowAsset.obj),await this.bowAsset.waitForLoad(),t!=this.loadingModelSym)return;e=computeApproximateBoundingSphere(this.bowAsset.obj)}else if(this.config.meleeSkin){if(getMainInstance().skins.skinNetworkDataToMeleeSkinConfig({equippedSkinIds:[this.config.id]})){if(this.skinObjectAsset=new ConfigObjectAssetLoader({useWorldWeather:!1,label:"melee"}),this.skinObjectAsset.setConfig({skinAssetName:this.config.meleeSkin.skin,teamId:1}),this.scene.add(this.skinObjectAsset.obj),await this.skinObjectAsset.waitForLoad(),t!=this.loadingModelSym)return;e=computeApproximateBoundingSphere(this.skinObjectAsset.obj)}}else if(this.config.arrowSkin){if(this.skinObjectAsset=new ConfigObjectAssetLoader({useWorldWeather:!1,label:"arrow"}),this.skinObjectAsset.setConfig({skinAssetName:this.config.arrowSkin,teamId:1}),this.scene.add(this.skinObjectAsset.obj),this.skinObjectAsset.obj.position.add(new Vector3(0,.35,.35)),this.skinObjectAsset.obj.rotateX(-.25*Math.PI),await this.skinObjectAsset.waitForLoad(),t!=this.loadingModelSym)return;e=new Sphere(new Vector3,.4),this.setDefaultRotY(.5*Math.PI)}else{const i=[],s=this.config.colorizableCategory;let n={};if("male"==this.renderOptions.gender&&this.config.maleSkin?n=this.config.maleSkin:"female"==this.renderOptions.gender&&this.config.femaleSkin&&(n=this.config.femaleSkin),s&&n.additions)for(const[t,e]of Object.entries(n.additions)){const s=t;for(const t of e)i.push({assetName:t,colorMultiplier:this.renderOptions.colorMultiplier,joints:[s]})}let a={};if(n.additions&&(a=n.additions),this.config.showFullBodyInShopItem){a=getMainInstance().skins.skinNetworkDataToSkinConfig({equippedSkinIds:[this.config.id],gender:this.renderOptions.gender}).equippedItems}if(this.loadingModel=new PlayerModel({init:!1,skinObjectOpts:{teamId:1,skin:{},rawSkin:{colorizedItems:i,equippedItems:a}},useWorldWeather:!1}),await this.loadingModel.init(),await this.skeleton.init(),await this.skeleton.waitForLinkLayerObjects(),!this.loadingModel.obj)return;if(t!=this.loadingModelSym)return;this.skinObject&&this.scene.remove(this.skinObject),this.skinObject=this.loadingModel.obj,this.visibleModel&&this.visibleModel.destructor(),this.visibleModel=this.loadingModel,this.loadingModel=null,this.skeleton.applyLayers(),this.skeleton.updateMatrices(),this.visibleModel.applySkeleton(this.skeleton),e=this.visibleModel.computeApproximateBoundingSphere(),this.scene.add(this.skinObject)}if(e){let t=0,i=0,s=1,n=!1;if(this.config.bowSkin){const e=this.config.categories;e&&(e.includes("smallBowTip")?(t=.55,s=.3):e.includes("smallBowHandle")?(i=.05,s=.5):e.includes("mediumBowTip")?(t=.7,s=.3):e.includes("mediumBowHandle")?(i=.08,s=.7):e.includes("largeBowTip")?(t=1,s=.3):e.includes("largeBowHandle")?(i=.1,s=.7):e.includes("repeatingCrossbowTip")?(i=.3,s=.6):e.includes("repeatingCrossbowHandle")?(i=.15,s=.7):e.includes("largeCrossbowTip")?(i=.3,s=.7):e.includes("largeCrossbowHandle")&&(s=.7))}else if(this.config.meleeSkin){const e=this.config.meleeSkin.meleeId;"bluntLight"==e?(t=.2,s=.6):"bluntHeavy"==e?(t=.45,s=.4):"pokeLight"==e?(t=.3,s=.4):"pokeHeavy"==e&&(t=.6,s=.5),n=!0}this.camTarget.position.copy(e.center),this.camTarget.position.y+=t,this.camTarget.position.z+=i,this.cam.position.z=3*Math.max(e.radius,.05)*s,n&&this.cam.rotateZ(.25*-Math.PI)}this.renderView.markDirty(),this.skinObjectDirty=!1}onSelectedChangeRequest(t){this.onSelectedChangeRequestCbs.add(t)}setOwned(t){this.owned=t,this.el.classList.toggle("shopItemOwned",t),this.el.classList.toggle("shopItemLocked",!t),t||!this.config.price?this.currencyWrapperEl&&this.currencyWrapperEl.remove():this.currencyWrapperEl||(this.currencyWrapperEl=document.createElement("div"),this.currencyWrapperEl.classList.add("currency-wrapper"),this.el.appendChild(this.currencyWrapperEl),this.currencyContainer=new CurrencyContainer({amount:this.config.price}),this.currencyWrapperEl.appendChild(this.currencyContainer.el))}setIsHovering(t){if(t!=this.isHovering){this.isHovering=t,t&&this.startLooping();for(const e of this.onHoveringChangeCbs)e(t)}}startLooping(){this.isLooping||(this.isLooping=!0,this.renderView.alwaysDirty=!0,this.animationLoop())}stopLooping(){this.shouldStopLooping=!0}animationLoop(){const t=performance.now();this.prevNow||(this.prevNow=t);const e=t-this.prevNow;if(this.prevNow=t,this.isHovering||"confirmPurchase"==this.usage?(this.rotY-=.001*e,this.rotY=mod(this.rotY+Math.PI,2*Math.PI)-Math.PI):(this.rotY=lerp(this.rotY,0,.1),Math.abs(this.rotY)<.001&&this.stopLooping()),this.camTarget.rotation.y=this.rotY+this.defaultRotY,this.shouldStopLooping)return this.isLooping=!1,this.shouldStopLooping=!1,this.prevNow=0,void(this.renderView&&(this.renderView.alwaysDirty=!1));window.requestAnimationFrame(this.boundAnimationLoop)}onHoveringChange(t){this.onHoveringChangeCbs.add(t)}addStatsTooltip(){if(this.statsTooltip)return;if("shop"!=this.usage)return;const t=this.dialog.zIndex+1;if(!this.config.statClasses)return;const e=this.el.getBoundingClientRect();this.statsTooltip=new StatClassTooltip({zIndex:t,statClasses:this.config.statClasses,aboveRect:e})}removeStatsTooltip(){this.statsTooltip&&(this.statsTooltip.destructor(),this.statsTooltip=null)}setSelectedState(t){this.selected=t,this.el.classList.toggle("selected",this.selected),this.updateAriaLabel()}updateAriaLabel(){let t="";if("shop"==this.usage){let e="";e=this.selected?"equipped":this.owned?"not equipped":this.config.hasRewardedAd?"locked, click to watch rewarded ad and unlock":this.config.price?`locked, unlock for ${this.config.price} coins`:"locked",t=`Shop item, ${this.config.id}, ${e}`}else"confirmPurchase"==this.usage&&(t="Shop item preview");this.el.setAttribute("aria-label",t)}*getSkinSlots(){this.config.slots&&(yield*this.config.slots)}highlight(){this.el.classList.add("highlight"),this.el.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})}openConfirmPurchaseDialog(){const t=new ConfirmItemPurchaseDialogUi(this.config,{renderOptions:this.renderOptions});getMainInstance().dialogManager.addDialog(t),t.onPurchaseSuccess((()=>{this.requestSelectedState(!0)})),this.onConfirmPurchaseDialogOpenCbs.forEach((e=>e(t)))}requestSelectedState(t){this.config.preventUnequip&&!t||this.onSelectedChangeRequestCbs.forEach((e=>e(t)))}onConfirmPurchaseDialogOpen(t){this.onConfirmPurchaseDialogOpenCbs.add(t)}}class ShopItemsGridView{constructor(){this.el=document.createElement("div"),this.el.classList.add("shop-items-grid-view"),this.shopItems=new Map,this.activeConfirmPurchaseDialogs=new Set,this.currentHoveringItem=null,this.onHoveringItemChangeCbs=new Set,this.onSelectedItemChangeRequestCbs=new Set}destructor(){this.destructShopItems()}addShopItem(t,e){const i=new ShopItem(t,e);this.el.appendChild(i.el),i.onHoveringChange((t=>{const e=this.currentHoveringItem;if(t?this.currentHoveringItem=i:this.currentHoveringItem==i&&(this.currentHoveringItem=null),this.currentHoveringItem!=e)for(const t of this.onHoveringItemChangeCbs)t(this.currentHoveringItem)})),i.onConfirmPurchaseDialogOpen((t=>{this.activeConfirmPurchaseDialogs.add(t),t.addOnCloseCb((()=>{this.activeConfirmPurchaseDialogs.delete(t)}))})),i.onSelectedChangeRequest((t=>{this.onSelectedItemChangeRequestCbs.forEach((e=>e(i.id,t)))})),this.shopItems.set(i.id,i)}closeCreatedConfirmPurchaseDialogs(){for(const t of this.activeConfirmPurchaseDialogs)t.close()}destructShopItems(){for(const t of this.shopItems.values())t.destructor();for(this.shopItems.clear();this.el.lastChild;)this.el.removeChild(this.el.lastChild)}loadShopItems(t,e){this.destructShopItems();for(const[i,s]of t.entries())this.addShopItem(s,{configIndex:i,...e});this.sortShopItems()}setRenderOptions(t){for(const e of this.shopItems.values())e.setRenderOptions(t)}setSelectedItems(t){for(const e of this.shopItems.values())e.setSelectedState(t.has(e.id))}setSelectedItemState(t,e){const i=this.shopItems.get(t);i&&i.setSelectedState(e)}onSelectedItemChangeRequest(t){this.onSelectedItemChangeRequestCbs.add(t)}setPurchasedItems(t){for(const e of this.shopItems.values())(e.config.price&&e.config.price>0||e.config.hasRewardedAd)&&e.setOwned(t.has(e.id));this.sortShopItems()}markItemAsPurchased(t){const e=this.shopItems.get(t);e&&e.setOwned(!0)}onHoveringItemChange(t){this.onHoveringItemChangeCbs.add(t)}sortShopItems(){const t=Array.from(this.shopItems.values());t.sort(((t,e)=>{if(t.owned&&!e.owned)return-1;if(!t.owned&&e.owned)return 1;const i=t.config.price||0,s=e.config.price||0;return i!=s?i-s:t.configIndex-e.configIndex}));for(const e of t)this.el.appendChild(e.el)}performHighlightShopItemAction(t,e){const i=this.shopItems.get(t);i&&(i.highlight(),"highlight"==e||("highlight-and-equip"==e?i.requestSelectedState(!0):"open"==e&&i.openConfirmPurchaseDialog()))}}class SkinDownloaderDialogUi extends DialogUi{constructor(t,e,i){super(),this.avatarsManager=t,this.contentEl=document.createElement("div"),this.contentEl.classList.add("skin-downloader-dialog-content"),this.el.appendChild(this.contentEl);const s=document.createElement("div");s.classList.add("skin-downloader-dialog-controls"),this.contentEl.appendChild(s);const n=document.createElement("div");n.textContent="Team color ",s.appendChild(n),this.teamColorInput=document.createElement("input"),this.teamColorInput.type="color",this.teamColorInput.value=teamColors[1].cssColor,this.teamColorInput.addEventListener("change",(()=>this.reloadPreview())),n.appendChild(this.teamColorInput);const a=document.createElement("div");a.textContent="Background color ",s.appendChild(a),this.backgroundColorInput=document.createElement("input"),this.backgroundColorInput.type="color",this.backgroundColorInput.value=teamColors[2].cssColor,this.backgroundColorInput.addEventListener("change",(()=>this.reloadPreview())),a.appendChild(this.backgroundColorInput);const o=document.createElement("div");o.textContent="Background opacity ",s.appendChild(o),this.backgroundOpacityInput=document.createElement("input"),this.backgroundOpacityInput.type="range",this.backgroundOpacityInput.min="0",this.backgroundOpacityInput.max="1",this.backgroundOpacityInput.step="0.01",this.backgroundOpacityInput.value="1",this.backgroundOpacityInput.addEventListener("change",(()=>this.reloadPreview())),o.appendChild(this.backgroundOpacityInput);const r=document.createElement("div");r.textContent="Shape ",s.appendChild(r),this.shapeInput=document.createElement("select");for(const t of["none","circle"]){const e=document.createElement("option");e.value=t,e.textContent=t,this.shapeInput.appendChild(e)}this.shapeInput.value="circle",this.shapeInput.addEventListener("change",(()=>this.reloadPreview())),r.appendChild(this.shapeInput);const l=document.createElement("div");l.textContent="Camera ",s.appendChild(l),this.cameraInput=document.createElement("select");for(const t of["face-close","face","upper-body","full-body"]){const e=document.createElement("option");e.value=t,e.textContent=t.replaceAll("-"," "),this.cameraInput.appendChild(e)}this.cameraInput.value="face-close",this.cameraInput.addEventListener("change",(()=>this.reloadPreview())),l.appendChild(this.cameraInput);const h=document.createElement("div");h.textContent="Pose ",s.appendChild(h),this.poseInput=document.createElement("select");const d=[];d.push(["","None"]);for(const{uiName:t,id:e}of classConfigs)d.push([e,t]);for(const[t,e]of d){const i=document.createElement("option");i.value=t,i.textContent=e,this.poseInput.appendChild(i)}this.poseInput.value="",this.poseInput.addEventListener("change",(()=>this.reloadPreview())),h.appendChild(this.poseInput);const c=document.createElement("div");c.textContent="Size ",s.appendChild(c),this.widthInput=document.createElement("input"),this.widthInput.classList.add("skin-downloader-size-input"),this.widthInput.type="number",this.widthInput.value="1024",c.appendChild(this.widthInput),c.appendChild(document.createTextNode(" x ")),this.heightInput=document.createElement("input"),this.heightInput.classList.add("skin-downloader-size-input"),this.heightInput.type="number",this.heightInput.value="1024",c.appendChild(this.heightInput);const u=document.createElement("div");u.classList.add("skin-downloader-download-container"),s.appendChild(u);const p=new UiButton({text:"Download",onClick:()=>this.downloadCurrentAvatar()});u.appendChild(p.el),this.imageEl=document.createElement("div"),this.imageEl.classList.add("downloadable-skin-preview"),this.contentEl.appendChild(this.imageEl),this.currentBlobReference=null,this.createdDownloadBlobReferences=[],this.skinConfig=i,this.reloadPreview()}destructor(){super.destructor(),this.currentBlobReference&&(this.currentBlobReference.destructor(),this.currentBlobReference=null);for(const t of this.createdDownloadBlobReferences)t.destructor();this.createdDownloadBlobReferences=[]}getCurrentAvatarConfig(t,e){const i=this.shapeInput.value??"none",s=this.cameraInput.value??"face-close",n=this.teamColorInput.value,a={r:parseInt(n.substring(1,3),16)/255,g:parseInt(n.substring(3,5),16)/255,b:parseInt(n.substring(5,7),16)/255};let o=null,r=null;if(this.poseInput.value){const t=getClassConfigById(this.poseInput.value);o=[`bows/${t.bowId}/shopClassItem`];const{skins:e,arrowSkin:i}=getMainInstance().skins.skinNetworkDataToBowAssetData(t.bowId,this.skinConfig);r={teamId:1,teamColor:a,bowId:t.bowId,arrowCount:1,skins:e,arrowSkin:i}}const l={backgroundColor:this.backgroundColorInput.value,backgroundAlpha:Number(this.backgroundOpacityInput.value),width:t,height:e,cameraType:s,clipPathType:i,bow:r,skinObjectOpts:{teamColor:a,skin:this.skinConfig}};return o&&(l.skeletonPoseLayers=o),l}reloadPreview(){if(!this.skinConfig)return;const t=250*globalThis.devicePixelRatio,e=this.getCurrentAvatarConfig(t,t),i=this.avatarsManager.getAvatar(e).getBlobUrlReference();this.currentBlobReference&&this.currentBlobReference.destructor(),this.currentBlobReference=i,(async()=>{if(i!=this.currentBlobReference)return void i.destructor();const t=await i.getBlobUrl();this.imageEl.style.backgroundImage=`url("${t}")`})()}downloadCurrentAvatar(){if(!this.skinConfig)return;const t=Number(this.widthInput.value),e=Number(this.heightInput.value),i=this.getCurrentAvatarConfig(t,e),s=this.avatarsManager.getAvatar(i).getBlobUrlReference();this.createdDownloadBlobReferences.push(s),(async()=>{const t=await s.getBlobUrl(),e=document.createElement("a");e.href=t,e.download="skin.png",e.click()})()}}class ShopSkinPreview{constructor(){this.destructed=!1,this.el=document.createElement("div"),this.el.classList.add("shopSkinPreview","wrinkledPaper","wrinkled-paper-mask"),this.currentlyLoadedSkinData=null,this.currentTeamId=1,this.el.addEventListener("click",(()=>{this.currentTeamId++,this.currentTeamId>2&&(this.currentTeamId=0),this.updateBackgroundColor(),this.updateSkinModel()})),this.statsTooltip=null,this.el.addEventListener("pointerenter",(()=>{if(this.statsTooltip)return;if(!this.currentlyLoadedSkinData)return;const t=this.el.getBoundingClientRect(),e=getMainInstance().skins.getStatClassValuesFromShopSkinIds(this.currentlyLoadedSkinData.equippedSkinIds||[]),i={};for(const[t,s]of e)i[t]=s;this.statsTooltip=new StatClassTooltip({zIndex:1e3,statClasses:i,aboveRect:t,showTotal:!0})})),this.el.addEventListener("pointerleave",(()=>{this.statsTooltip&&(this.statsTooltip.destructor(),this.statsTooltip=null)})),this.renderView=getMainInstance().renderer.createRenderView({width:200,height:300}),this.renderView.canvas.classList.add("shop-skin-preview-canvas"),this.el.appendChild(this.renderView.canvas),this.downloadButton=document.createElement("div"),this.downloadButton.classList.add("shop-skin-preview-download-button"),this.downloadButton.addEventListener("click",(()=>{if(this.currentlyLoadedSkinData){const t=new SkinDownloaderDialogUi(getMainInstance().avatars,getMainInstance().skins,this.currentlyLoadedSkinData);getMainInstance().dialogManager.addDialog(t)}})),this.el.appendChild(this.downloadButton),this.cam=new PerspectiveCamera(45,200/300,.1,5),this.cam.far=10,this.camTarget=new Object3D,this.rotY=0,this.currentMouseYMultiplier=1,this.camTarget.add(this.cam),this.scene=new Scene,this.scene.add(this.camTarget),this.modelRotationContainer=new Object3D,this.scene.add(this.modelRotationContainer),this.bowParentObj=new Object3D,this.modelRotationContainer.add(this.bowParentObj),this.bowParentObj.matrixAutoUpdate=!1,this.meleeParentObj=new Object3D,this.modelRotationContainer.add(this.meleeParentObj),this.meleeParentObj.matrixAutoUpdate=!1,this.smoothCamPosOffset=new Vector3,this.smoothCamTargetRot=0,this.activeCamFollowingTarget=null,this.activeSlotPositionId=null,this.camPositions=new Map,this.camPositions.set("full",{pos:new Vector3(0,1,2.8)}),this.camPositions.set("head",{pos:new Vector3(0,1.8,1.3),mouseYMultiplier:.2}),this.camPositions.set("torso",{pos:new Vector3(0,1.1,1.7)}),this.camPositions.set("arms",{pos:new Vector3(0,1.3,1.5),rot:.3,mouseYMultiplier:.5}),this.camPositions.set("legs",{pos:new Vector3(0,.35,1.3)}),this.camPositions.set("quiver",{pos:new Vector3(0,1.1,2),rot:-2.5}),this.camPositions.set("face",{pos:new Vector3(0,1.75,.6),rot:.2,mouseYMultiplier:.1}),this.camPositions.set("smallBow",{pos:new Vector3(-.3,0,1.9),activeFollowingTarget:this.bowParentObj,rot:-.5*Math.PI}),this.camPositions.set("smallBowHandle",{pos:new Vector3(0,0,1.1),activeFollowingTarget:this.bowParentObj,rot:-.5*Math.PI}),this.camPositions.set("smallBowTip",{pos:new Vector3(-.3,.4,.8),activeFollowingTarget:this.bowParentObj,rot:-.5*Math.PI}),this.camPositions.set("mediumBow",{pos:new Vector3(-.3,0,2.2),activeFollowingTarget:this.bowParentObj,rot:-.5*Math.PI}),this.camPositions.set("mediumBowHandle",{pos:new Vector3(-.1,0,1.5),activeFollowingTarget:this.bowParentObj,rot:-.5*Math.PI}),this.camPositions.set("mediumBowTip",{pos:new Vector3(-.2,.5,1),activeFollowingTarget:this.bowParentObj,rot:-.5*Math.PI}),this.camPositions.set("largeBow",{pos:new Vector3(-.3,0,3),activeFollowingTarget:this.bowParentObj,rot:-.5*Math.PI}),this.camPositions.set("largeBowHandle",{pos:new Vector3(-.1,0,1.8),activeFollowingTarget:this.bowParentObj,rot:-.5*Math.PI}),this.camPositions.set("largeBowTip",{pos:new Vector3(-.3,.9,1.2),activeFollowingTarget:this.bowParentObj,rot:-.5*Math.PI}),this.camPositions.set("smallCrossbow",{pos:new Vector3(.1,0,1.9),activeFollowingTarget:this.bowParentObj,rot:-.3*Math.PI}),this.camPositions.set("smallCrossbowHandle",{pos:new Vector3(.1,0,1.2),activeFollowingTarget:this.bowParentObj,rot:-.5*Math.PI}),this.camPositions.set("smallCrossbowTip",{pos:new Vector3(0,0,1.7),activeFollowingTarget:this.bowParentObj,rot:.3}),this.camPositions.set("largeCrossbow",{pos:new Vector3(0,0,2.7),activeFollowingTarget:this.bowParentObj,rot:-.3*Math.PI}),this.camPositions.set("largeCrossbowHandle",{pos:new Vector3(0,0,2.5),activeFollowingTarget:this.bowParentObj,rot:-.5*Math.PI}),this.camPositions.set("largeCrossbowTip",{pos:new Vector3(-.1,0,2.2),activeFollowingTarget:this.bowParentObj,rot:.7}),this.camPositions.set("melee",{pos:new Vector3(.3,.5,2),activeFollowingTarget:this.meleeParentObj,rot:-1.7}),this.camPositions.set("arrow",{pos:new Vector3(0,0,1),activeFollowingTarget:this.bowParentObj,rot:.9}),this.setActiveSlotPosition("full",!0),this.renderView.setRenderObjects(this.scene,this.cam),this.boundOnMouseMove=this.onMouseMove.bind(this),window.addEventListener("mousemove",this.boundOnMouseMove),this.lastMouseX=0,this.lastMouseY=0,this.skeleton=new PlayerSkeleton,this.skeleton.init(),this.activeExtraPoseLayer=null,this.bowAssetLoader=new BowAssetLoader({useWorldWeather:!1}),this.bowAssetLoader.updateFireAmount(1,1),this.hoveringBowAssetLoader=new BowAssetLoader({useWorldWeather:!1}),this.hoveringBowAssetLoader.updateFireAmount(1,1),this.bowParentObj.add(this.bowAssetLoader.obj),this.bowParentObj.add(this.hoveringBowAssetLoader.obj),this.bowSkeletonObj=null,this.currentVisibleBowId=null,this.currentEquippedSkinIds=[],this.hoveringBowVisible=!1,this.meleeAssetLoader=new ConfigObjectAssetLoader({useWorldWeather:!1,label:"melee"}),this.hoveringMeleeAssetLoader=new ConfigObjectAssetLoader({useWorldWeather:!1,label:"melee"}),this.meleeParentObj.add(this.meleeAssetLoader.obj),this.meleeParentObj.add(this.hoveringMeleeAssetLoader.obj),this.meleeSkeletonObj=null,this.currentVisibleMeleeSkinAssetName=null,this.hoveringMeleeVisible=!1,this.activeModel=null,this.loadingModel=null,this.hoveringModel=null,this.hoveringModelVisible=!1,this.lastHoveringModelCacheKey="",this.initSkeleton(),this.updateSkinModel(),this.updateBackgroundColor()}destructor(){this.destructed=!0,this.bowAssetLoader.destructor(),this.hoveringBowAssetLoader.destructor(),this.meleeAssetLoader.destructor(),this.hoveringMeleeAssetLoader.destructor(),getMainInstance().renderer.removeRenderView(this.renderView),this.removeModel(this.activeModel),this.activeModel=null,this.removeModel(this.loadingModel),this.loadingModel=null,this.removeModel(this.hoveringModel),this.hoveringModel=null,window.removeEventListener("mousemove",this.boundOnMouseMove)}async initSkeleton(){await this.skeleton.waitForLoad();const t=this.skeleton.addPoseLayer("shopPreview");if(await t.waitForObjectLinks(),this.skeleton.applyLayers(),this.skeleton.updateMatrices(),this.updateModelRotation(),!this.skeleton.baseSkeletonObject)throw new Error("Assertion failed, skeleton is not initialized");const e=this.skeleton.baseSkeletonObject.getObjectByName("bowHoldingPos");if(!e)throw new Error("Assertion failed, bow holding pos object not found");this.bowSkeletonObj=e;const i=this.skeleton.baseSkeletonObject.getObjectByName("meleeHoldingPos");if(!i)throw new Error("Assertion failed, melee holding pos object not found");this.meleeSkeletonObj=i}async addModel(t){t&&(await t.waitForInit(),t.obj&&this.modelRotationContainer.add(t.obj))}removeModel(t){t&&(t.obj&&this.modelRotationContainer.remove(t.obj),t.destructor())}loop(t,e){let i=!1;this.cam.position.distanceTo(this.smoothCamPosOffset)>.01&&(i=!0),this.cam.position.lerp(this.smoothCamPosOffset,.1);let s=new Vector3;this.activeCamFollowingTarget&&(s=this.activeCamFollowingTarget.getWorldPosition(new Vector3));this.camTarget.position.distanceTo(s)>.01&&(i=!0),this.camTarget.position.lerp(s,.1);Math.abs(this.camTarget.rotation.y-this.smoothCamTargetRot)>.01&&(i=!0),this.camTarget.rotation.y=lerp(this.camTarget.rotation.y,this.smoothCamTargetRot,.1),i&&this.renderView.markDirty()}setHoveringModel(t){if(this.hoveringModelVisible=!1,t){this.hoveringModelVisible=!0;const e=getMainInstance().skins.skinObjectOptsToCacheKey(t);this.lastHoveringModelCacheKey!=e&&(this.lastHoveringModelCacheKey=e,this.removeModel(this.hoveringModel),this.hoveringModel=null,t&&(this.hoveringModel=new PlayerModel({skinObjectOpts:t,useWorldWeather:!1}),this.addModel(this.hoveringModel),this.updateVisibleModelAfterHoveringInit()))}if(this.updateVisibleModel(),this.hoveringBowVisible=!1,this.hoveringMeleeVisible=!1,t)if(this.currentVisibleBowId){const{skins:e,arrowSkin:i}=getMainInstance().skins.skinNetworkDataToBowAssetData(this.currentVisibleBowId,t.skin);e.length>0&&(this.hoveringBowAssetLoader.setConfig({bowId:this.currentVisibleBowId,arrowCount:1,skins:e,arrowSkin:i,teamId:this.currentTeamId}),(async()=>{await this.hoveringBowAssetLoader.waitForLoad(),this.updateVisibleBow()})()),this.hoveringBowVisible=!0}else if(this.currentVisibleMeleeSkinAssetName){const e=getMainInstance().skins.skinNetworkDataToMeleeSkinConfig(t.skin);e&&(this.hoveringMeleeAssetLoader.setConfig({skinAssetName:e.skin,teamId:this.currentTeamId}),(async()=>{await this.hoveringMeleeAssetLoader.waitForLoad(),this.updateVisibleMelee()})()),this.hoveringMeleeVisible=!0}this.updateVisibleBow(),this.updateVisibleMelee()}setHoveringShopItemId(t){if(!this.currentlyLoadedSkinData)return;const e={teamId:this.currentTeamId,skin:getMainInstance().skins.getConfigForPreviewShopItemId(this.currentlyLoadedSkinData,{itemId:t})};this.setHoveringModel(e)}setTemporaryColorCategory(t,e){this.currentlyLoadedSkinData&&this.setHoveringModel({teamId:this.currentTeamId,skin:getMainInstance().skins.getConfigForPreviewShopItemId(this.currentlyLoadedSkinData,{colorCategory:t,colorMultiplier:e})})}resetHoveringModel(){this.setHoveringModel(null)}async updateVisibleModelAfterHoveringInit(){this.hoveringModel&&await this.hoveringModel.waitForInit(),this.updateVisibleModel()}updateSkinModel(){this.currentlyLoadedSkinData&&this.setCurrentSkinConfig(this.currentlyLoadedSkinData)}setCurrentSkinConfig(t){this.currentlyLoadedSkinData=t,this.removeModel(this.loadingModel),this.loadingModel=new PlayerModel({skinObjectOpts:{teamId:this.currentTeamId,skin:t},useWorldWeather:!1}),this.addModel(this.loadingModel),this.replaceLoadingModel(),this.currentEquippedSkinIds=t.equippedSkinIds||[],this.updateBowConfig(),this.updateMeleeConfig()}updateBackgroundColor(){const t=(this.currentTeamId+1)%teamColors.length,e=teamColors[t];this.el.style.background=e.cssColor}async replaceLoadingModel(){this.loadingModel&&(await this.loadingModel.waitForInit(),this.loadingModel&&(this.removeModel(this.activeModel),this.activeModel=this.loadingModel,this.loadingModel=null,this.removeModel(this.hoveringModel),this.hoveringModel=null,this.updateVisibleModel()))}onMouseMove(t){const e=t.clientX/window.innerWidth*2-1,i=t.clientY/window.innerHeight*2-1;this.lastMouseX=e,this.lastMouseY=i*this.currentMouseYMultiplier,this.updateModelRotation()}getVisibleModel(){return this.hoveringModel&&this.hoveringModel.obj?this.hoveringModel:this.activeModel&&this.activeModel.obj?this.activeModel:null}updateVisibleModel(){let t=!1;this.hoveringModel&&this.hoveringModel.obj&&(this.hoveringModel.obj.visible=this.hoveringModelVisible,t=this.hoveringModelVisible),this.activeModel&&this.activeModel.obj&&(this.activeModel.obj.visible=!t),this.updateSkeletonGender(),this.updateModelRotation()}updateVisibleBow(){const t=Boolean(this.currentVisibleBowId),e=this.hoveringBowVisible&&!this.hoveringBowAssetLoader.isLoadingAsset;this.bowAssetLoader.obj.visible=t&&!e,this.hoveringBowAssetLoader.obj.visible=t&&e}updateVisibleMelee(){const t=Boolean(this.currentVisibleMeleeSkinAssetName),e=this.hoveringMeleeVisible&&!this.hoveringMeleeAssetLoader.isLoadingAsset;this.meleeAssetLoader.obj.visible=t&&!e,this.hoveringMeleeAssetLoader.obj.visible=t&&e}async updateSkeletonGender(){const t=this.getVisibleModel();if(t){const e=t.skinObjectOpts.skin.gender||"male";this.skeleton.gender!=e&&(this.skeleton.setGender(e),await this.skeleton.waitForLinkLayerObjects(),this.updateModelRotation())}}updateModelRotation(){const t=this.getVisibleModel();t&&t.obj&&(this.modelRotationContainer.rotation.y=this.lastMouseX,this.skeleton.isInit&&this.skeleton.allObjectLinksBuilt&&(this.skeleton.applyLayers(),this.skeleton.setLookRotY(this.lastMouseY,{}),this.skeleton.updateMatrices(),t.applySkeleton(this.skeleton),this.bowSkeletonObj&&this.bowParentObj.matrix.copy(this.bowSkeletonObj.matrixWorld),this.meleeSkeletonObj&&this.meleeParentObj.matrix.copy(this.meleeSkeletonObj.matrixWorld),this.renderView.markDirty()))}setActiveSlotPosition(t,e=!1){this.activeSlotPositionId=t,this.activeCamFollowingTarget=null;const i=this.camPositions.get(t);i&&(i.activeFollowingTarget&&(this.activeCamFollowingTarget=i.activeFollowingTarget),i.pos&&(this.smoothCamPosOffset.copy(i.pos),e&&this.cam.position.copy(i.pos)),this.smoothCamTargetRot=i.rot||0,void 0!==i.mouseYMultiplier?this.currentMouseYMultiplier=i.mouseYMultiplier:this.currentMouseYMultiplier=1)}async setSkeletonPose(t){let e=!1;if(this.activeExtraPoseLayer&&(this.skeleton.removePoseLayer(this.activeExtraPoseLayer),e=!0),t){const i=this.skeleton.addPoseLayer(t);if(this.activeExtraPoseLayer=i,await this.activeExtraPoseLayer.waitForObjectLinks(),this.activeExtraPoseLayer!=i)return;e=!0}e&&(await this.skeleton.waitForLoad(),this.skeleton.applyLayers(),this.skeleton.updateMatrices(),this.updateModelRotation())}setBow(t){this.currentVisibleBowId=t,this.updateBowConfig(),this.updateVisibleBow()}updateBowConfig(){if(this.currentVisibleBowId){const{skins:t,arrowSkin:e}=getMainInstance().skins.skinNetworkDataToBowAssetData(this.currentVisibleBowId,{equippedSkinIds:this.currentEquippedSkinIds});this.bowAssetLoader.setConfig({bowId:this.currentVisibleBowId,arrowCount:1,skins:t,arrowSkin:e,teamId:this.currentTeamId})}}setMelee(t){this.currentVisibleMeleeSkinAssetName=t,this.updateMeleeConfig(),this.updateVisibleMelee()}updateMeleeConfig(){if(this.currentVisibleMeleeSkinAssetName){const t=getMainInstance().skins.skinNetworkDataToMeleeSkinConfig({equippedSkinIds:this.currentEquippedSkinIds});t&&this.meleeAssetLoader.setConfig({skinAssetName:t.skin,teamId:this.currentTeamId})}}}class ShopSkinCustomizationView{constructor(t,{id:e,rootHeader:i,dialog:s}){let n;this.el=document.createElement("div"),this.el.classList.add("shopDialogContent"),this.dialog=s,this.skinManager=t,this.customizationId=e,this.onBackButtonClickCbs=new Set,this.pagedView=new PagedView({extraClasses:["shop-paged-view-container"]}),this.el.appendChild(this.pagedView.el),this.createdGrids=new Map,this.skinPreview=new ShopSkinPreview,this.el.appendChild(this.skinPreview.el),this.updateSkinPreviewConfig(),this.filterSubPages=new Map;let a=null;if("class"==e.type){const t=getClassConfigById(e.classId);n={itemName:"Bow",buttonIcon:"static/img/menuUI/shop/categoryIcons/bow.svg",buttonIconSize:2.2,subPages:[this.createGridViewSubPage({itemName:"Handle",buttonIcon:"static/img/menuUI/shop/categoryIcons/bowHandle.svg",buttonIconSize:2.2,...this.createBowGridViewConfig(t,"handle")}),this.createGridViewSubPage({itemName:"Tip",buttonIcon:"static/img/menuUI/shop/categoryIcons/bowTip.svg",buttonIconSize:2.2,...this.createBowGridViewConfig(t,"tip")})],onBecomeVisible:()=>{this.setSkinPreview(this.createBowGridViewConfig(t,"full"))}},a=t.bowId}else{const t=[];for(const e of classConfigs)t.push({itemName:e.uiName,subPages:[this.createGridViewSubPage({itemName:"Handle",buttonIcon:"static/img/menuUI/shop/categoryIcons/bowHandle.svg",buttonIconSize:2.2,...this.createBowGridViewConfig(e,"handle")}),this.createGridViewSubPage({itemName:"Tip",buttonIcon:"static/img/menuUI/shop/categoryIcons/bowTip.svg",buttonIconSize:2.2,...this.createBowGridViewConfig(e,"tip")})],onBecomeVisible:()=>{this.setSkinPreview(this.createBowGridViewConfig(e,"full"))}});n={itemName:"Bow",buttonIcon:"static/img/menuUI/shop/categoryIcons/bow.svg",buttonIconSize:2.2,subPages:t,onBecomeVisible:()=>{this.resetSkinPreview()}}}this.pagedView.setActiveStructure({header:i,onBecomeVisible:()=>{this.resetSkinPreview()},onBackButtonClick:()=>{this.onBackButtonClickCbs.forEach((t=>t()))},rightCorner:i=>{if("class"==e.type){const s=e.classId,n=this.skinManager.getClassSkinData(s,!1),a=document.createElement("div");a.classList.add("dialog-select-wrapper","wrinkledPaper"),i.appendChild(a);const o=document.createElement("select");o.classList.add("dialog-select-input","blueNight"),a.appendChild(o);const r=document.createElement("option");r.value="none",r.textContent="None",o.appendChild(r);for(const e of t.skinPresets.keys()){const t=document.createElement("option");t.value=String(e),t.textContent=`Preset ${e+1}`,o.appendChild(t)}null==n.presetId?o.value="none":o.value=String(n.presetId),o.addEventListener("change",(()=>{let t;t="none"==o.value?null:Number(o.value),this.skinManager.setClassPreset(s,t),this.updateSkinPreviewConfig()}))}},subPages:[{itemName:"Looks",buttonIcon:"static/img/menuUI/shop/categoryIcons/face.svg",buttonIconSize:2.2,onBecomeVisible:()=>{this.resetSkinPreview({camPosition:"face"})},rightCorner:t=>{const i=document.createElement("div");i.classList.add("shop-gender-toggle-container"),t.appendChild(i);const s=document.createElement("div");s.classList.add("gender-icon","male"),i.appendChild(s);const n=document.createElement("input");n.type="checkbox",n.classList.add("dialog-toggle-input","wrinkledPaper"),n.ariaLabel="Gender";let a="male";if("preset"==e.type){const t=e.presetId;a=this.skinManager.getPreset(t).gender||"male"}else if("class"==e.type){const t=e.classId,i=this.skinManager.getClassSkinData(t,!1);let s;if(null!=i.presetId){s=this.skinManager.getPreset(i.presetId,!1).gender}a=i.gender||s||"male"}n.checked="female"==a,n.addEventListener("change",(()=>{const t=n.checked?"female":"male";"preset"==e.type?this.skinManager.setPresetGender(e.presetId,t):"class"==e.type&&this.skinManager.setClassGender(e.classId,t),this.updateSkinPreviewConfig(),this.pagedView.updateButtonVisibilies()})),i.appendChild(n);const o=document.createElement("div");o.classList.add("gender-icon","female"),i.appendChild(o)},subPages:[this.createGridViewSubPage({itemName:"Skin color",buttonIcon:"static/img/menuUI/shop/categoryIcons/skinTone.svg",buttonIconSize:1.2,filterOptions:{shopCategoriesFilter:["skinTone"]}}),this.createGridViewSubPage({itemName:"Hair",buttonIcon:"static/img/menuUI/shop/categoryIcons/hair.svg",buttonIconSize:1.2,filterOptions:{shopCategoriesFilter:["faceHair"]},colorButtonsCategory:"hair"}),this.createGridViewSubPage({itemName:"Eyebrows",buttonIcon:"static/img/menuUI/shop/categoryIcons/eyebrows.svg",buttonIconSize:1.4,filterOptions:{shopCategoriesFilter:["faceEyebrows"]},colorButtonsCategory:"eyebrows"}),this.createGridViewSubPage({itemName:"Eyes",buttonIcon:"static/img/menuUI/shop/categoryIcons/eyes.svg",buttonIconSize:1.4,filterOptions:{shopCategoriesFilter:["faceEyes"]}}),this.createGridViewSubPage({itemName:"Beard",buttonIcon:"static/img/menuUI/shop/categoryIcons/face.svg",buttonIconSize:2.2,filterOptions:{shopCategoriesFilter:["faceMustache","faceBeard"]},colorButtonsCategory:"beard"}),this.createGridViewSubPage({itemName:"Miscellaneous",buttonIcon:"static/img/menuUI/shop/categoryIcons/misc.svg",buttonIconSize:1.4,filterOptions:{shopCategoriesFilter:["faceMisc"]}})]},{itemName:"Gear",buttonIcon:"static/img/menuUI/shopChest.svg",buttonIconSize:2,onBecomeVisible:()=>{this.resetSkinPreview()},subPages:[this.createGridViewSubPage({itemName:"Head",buttonIcon:"static/img/menuUI/shop/categoryIcons/head.svg",buttonIconSize:1.7,filterOptions:{shopCategoriesFilter:["head"]},skinPreviewCamPosition:"head"}),this.createGridViewSubPage({itemName:"Torso",buttonIcon:"static/img/menuUI/shop/categoryIcons/torso.svg",buttonIconSize:1.7,filterOptions:{shopCategoriesFilter:["torso"]},skinPreviewCamPosition:"torso"}),this.createGridViewSubPage({itemName:"Arms",buttonIcon:"static/img/menuUI/shop/categoryIcons/arms.svg",buttonIconSize:1.7,filterOptions:{shopCategoriesFilter:["arms","hands"]},skinPreviewCamPosition:"arms"}),this.createGridViewSubPage({itemName:"Legs",buttonIcon:"static/img/menuUI/shop/categoryIcons/legs.svg",buttonIconSize:1.7,filterOptions:{shopCategoriesFilter:["legs","feet"]},skinPreviewCamPosition:"legs"}),this.createGridViewSubPage({itemName:"Quiver",buttonIcon:"static/img/menuUI/shop/categoryIcons/quiver.svg",buttonIconSize:1.2,filterOptions:{shopCategoriesFilter:["quiver"]},skinPreviewCamPosition:"quiver"})]},n,this.createGridViewSubPage({itemName:"Arrow",bowId:"mediumBow",skeletonPose:"bows/mediumBow/shootingLoaded",buttonIcon:"static/img/menuUI/shop/categoryIcons/arrow.svg",buttonIconSize:1.9,skinPreviewCamPosition:"arrow",filterOptions:{shopCategoriesFilter:["arrow"]}}),this.createGridViewSubPage({itemName:"Melee",meleeSkinAssetName:"meleePokeHeavySword",skeletonPose:"melee/bladedHeavy/idle",buttonIcon:"static/img/menuUI/shop/categoryIcons/melee.svg",buttonIconSize:1.9,skinPreviewCamPosition:"melee",filterOptions:{shopCategoriesFilter:["meleeBladed","meleeBlunt","meleePoke"]}}),this.createGridViewSubPage({itemName:"Rewarded",buttonIcon:"static/img/rewardedAdIcon.svg",buttonIconSize:1.4,filterOptions:{filterType:"rewarded",useSingleWeaponType:a}}),this.createGridViewSubPage({itemName:"Uncategorized",filterOptions:{filterType:"uncategorized"}}),this.createGridViewSubPage({itemName:"Missing",filterOptions:{filterType:"missing"}})]})}destructor(){this.closeCreatedDialogs();for(const{grid:t}of this.createdGrids.values())t.destructor();this.createdGrids.clear(),this.skinPreview.destructor()}onBackButtonClick(t){this.onBackButtonClickCbs.add(t)}closeCreatedDialogs(){for(const{grid:t}of this.createdGrids.values())t.closeCreatedConfirmPurchaseDialogs()}loop(t,e){this.skinPreview.loop(t,e)}updateShopState(t){for(const{grid:e}of this.createdGrids.values())e.setPurchasedItems(t)}highlightOrOpenShopItem(t,e,i){let s,n;for(const e of t){s=this.filterSubPages.get(e);break}if(!s)throw new Error(`No subpage structure found for shop item "${e}"`);this.pagedView.jumpToSubPage(s);for(const{grid:t,pagedViewStructure:e}of this.createdGrids.values())if(e===s){n=t;break}if(!n)throw new Error("Assertion failed, no grid was created for the subpage");n.performHighlightShopItemAction(e,i)}resetSkinPreview({camPosition:t="full"}={}){this.skinPreview.setActiveSlotPosition(t),this.skinPreview.setSkeletonPose(null),this.skinPreview.setBow(null),this.skinPreview.setMelee(null)}createBowGridViewConfig(t,e){let i="full",s=[];"full"==e?i=t.bowShopCamPosition:"handle"==e?(i=t.bowHandleShopCamPosition,s=t.bowHandleShopCategories):"tip"==e&&(i=t.bowTipShopCamPosition,s=t.bowTipShopCategories);const n={useSingleWeaponType:t.bowId,hideNonBowSkins:!0,shopCategoriesFilter:s};return{skinPreviewCamPosition:i,skeletonPose:`bows/${t.bowId}/${t.shopSkeletonLayer}`,bowId:t.bowId,filterOptions:n}}setSkinPreview({skinPreviewCamPosition:t=null,skeletonPose:e=null,bowId:i=null,meleeSkinAssetName:s=null}){t&&this.skinPreview.setActiveSlotPosition(t),this.skinPreview.setSkeletonPose(e),this.skinPreview.setBow(i),this.skinPreview.setMelee(s)}createGridViewSubPage({itemName:t,buttonIcon:e,buttonIconSize:i,filterOptions:s,skinPreviewCamPosition:n=null,skeletonPose:a=null,bowId:o=null,meleeSkinAssetName:r=null,colorButtonsCategory:l="none"}){const h={itemName:t,buttonIcon:e,buttonIconSize:i,buttonVisible:()=>{const t=getMainInstance().config.shopConfig.loadedConfigData;if(!t)return!0;const e=this.getCurrentSkinData().gender||"male";return this.filterPurchasableItems(t.purchasableItems,e,s).length>0},onBecomeVisible:()=>{this.setSkinPreview({skinPreviewCamPosition:n,skeletonPose:a,bowId:o,meleeSkinAssetName:r})},customSubPage:t=>{this.createShopItemsGrid(t,{filterOptions:s,pagedViewStructure:h,colorButtonsCategory:l})},customSubPageDestroyed:t=>{this.destroyShopItemsGrid(t)}};if("none"!=l&&(h.rightCorner=t=>{t.classList.add("shop-color-buttons-corner");for(const{cssColor:e,skinColor:i}of hairColors){const s=document.createElement("button");s.classList.add("shop-color-button"),s.style.backgroundColor=e,t.appendChild(s),s.addEventListener("click",(()=>{const t=getMainInstance().skins;"preset"==this.customizationId.type?t.setPresetSkinItemColor(this.customizationId.presetId,l,i):"class"==this.customizationId.type&&t.setClassSkinItemColor(this.customizationId.classId,l,i),this.updateSkinPreviewConfig();const e=this.getShopItemRenderOptions(l);for(const t of this.createdGrids.values())t.grid.setRenderOptions(e)})),s.addEventListener("mouseenter",(()=>{this.skinPreview.setTemporaryColorCategory(l,i)})),s.addEventListener("mouseleave",(()=>{this.skinPreview.resetHoveringModel()}))}}),s.shopCategoriesFilter)for(const t of s.shopCategoriesFilter)this.filterSubPages.set(t,h);return h}filterPurchasableItems(t,e,{filterType:i="default",shopCategoriesFilter:s,useSingleWeaponType:n,hideNonBowSkins:a}){if("missing"==i)return[];if("uncategorized"==i)return t.filter((t=>!t.categories));{const o=getMainInstance().shopState.purchasedItems;return t.filter((t=>{if("rewarded"==i){if(!t.hasRewardedAd)return!1;if(o.has(t.id))return!1}if(n&&t.bowSkin&&n!=t.bowSkin.bowId)return!1;if(a&&!t.bowSkin)return!1;if(!(t.showFullBodyInShopItem||t.bowSkin||t.meleeSkin||t.arrowSkin)){if("male"==e&&!t.maleSkin)return!1;if("female"==e&&!t.femaleSkin)return!1}if(s){if(!t.categories)return!1;let e=!1;for(const i of t.categories)if(s.includes(i)){e=!0;break}if(!e)return!1}if(!this.showHiddenItems){if("hidden"==t.shopVisibility)return!1;if(!("seasonal"!=t.shopVisibility||t.price&&o.has(t.id))){const e=t.seasonalRange;if(!e)return!1;if(e.startDay&&e.endDay&&e.startMonth&&e.endMonth){const t=new Date,i=new Date(t.getFullYear(),e.startMonth-1,e.startDay),s=new Date(t.getFullYear(),e.endMonth-1,e.endDay),n=new Date(t.getFullYear(),t.getMonth(),t.getDate());if(n<i||n>s)return!1}}}return!0}))}}getShopItemRenderOptions(t){const e=this.getCurrentSkinData(),i=e.gender||"male";let s=[1,1,1];"hair"==t&&e.hairColorMultiplier?s=e.hairColorMultiplier:"eyebrows"==t&&e.eyebrowColorMultiplier?s=e.eyebrowColorMultiplier:"beard"==t&&e.beardColorMultiplier&&(s=e.beardColorMultiplier);return{colorMultiplier:s,gender:i}}createShopItemsGrid(t,{filterOptions:e,pagedViewStructure:i,colorButtonsCategory:s}){const n=new ShopItemsGridView;t.appendChild(n.el);const a=()=>{const i=this.getShopItemRenderOptions(s),a=getMainInstance().config.shopConfig.loadedConfigData,o=a?a.purchasableItems:[],r=this.filterPurchasableItems(o,i.gender,e);n.loadShopItems(r,{renderOptions:i,dialog:this.dialog,scrollingContainer:t})},o=getMainInstance();if(o.config.shopConfig.onConfigChange(a),n.onHoveringItemChange((t=>{let e=null;t&&t.selected||(t&&t.config&&t.config.id&&(e=t.config.id),e?this.skinPreview.setHoveringShopItemId(e):this.skinPreview.resetHoveringModel())})),n.setPurchasedItems(o.shopState.purchasedItems),"preset"==this.customizationId.type){const t=this.customizationId.presetId,e=this.skinManager.getPreset(t),i=new Set(e.equippedSkinIds);n.setSelectedItems(i),n.onSelectedItemChangeRequest(((e,i)=>{if(i){const i=this.skinManager.addShopItemToPreset(e,t);for(const t of i)n.setSelectedItemState(t,!1)}else this.skinManager.removeShopItemFromPreset(e,t);n.setSelectedItemState(e,i),this.updateSkinPreviewConfig()}))}else if("class"==this.customizationId.type){const t=this.customizationId.classId;this.updateSelectedItemsForClass(t,n),n.onSelectedItemChangeRequest(((e,i)=>{i?this.skinManager.addShopItemToClass(e,t):this.skinManager.removeShopItemFromClass(e,t),this.updateSelectedItemsForClass(t,n),this.updateSkinPreviewConfig()}))}this.createdGrids.set(t,{grid:n,reloadFilteredItems:a,pagedViewStructure:i})}updateSelectedItemsForClass(t,e){const i=this.skinManager.getClassSkinData(t,!1);let s=[];if(null!=i.presetId){const t=this.skinManager.getPreset(i.presetId,!1);t.equippedSkinIds&&(s=t.equippedSkinIds)}const n=new Set(s);if(i.equippedSkinIds)for(const t of i.equippedSkinIds)this.skinManager.addItemAndRemoveDuplicateSlots(n,t);if(i.unequippedSkinIds)for(const t of i.unequippedSkinIds)n.delete(t);e.setSelectedItems(n)}getCurrentSkinData(){if("preset"==this.customizationId.type)return this.skinManager.getPreset(this.customizationId.presetId);if("class"==this.customizationId.type)return this.skinManager.getClassSkinDataWithAppliedPreset(this.customizationId.classId);throw new Error("Assertion failed, unknown customization type.")}updateSkinPreviewConfig(){const t=this.getCurrentSkinData();this.skinPreview.setCurrentSkinConfig(t)}destroyShopItemsGrid(t){const e=this.createdGrids.get(t);if(!e)return;const{grid:i,reloadFilteredItems:s}=e;i.destructor(),this.createdGrids.delete(t),getMainInstance().config.shopConfig.removeOnConfigChange(s)}}class ClassSelectionImage{constructor(t,{extraClasses:e=[]}={}){this.el=document.createElement("div"),this.el.classList.add("class-selection-image-container","wrinkledPaper","wrinkled-paper-mask",...e),this.backgroundEl=document.createElement("div"),this.backgroundEl.classList.add("class-selection-image-background","wrinkledPaper"),this.el.appendChild(this.backgroundEl),this.imageEl=document.createElement("div"),this.imageEl.classList.add("class-selection-image"),this.el.appendChild(this.imageEl),this.seed=randInt(0,99999);const i=`\n\t\t\t--wrinkled-paper-seed: ${this.seed};\n\t\t`;this.el.style.cssText=i,this.backgroundEl.style.cssText=i,this.classId=t;const s=getMainInstance().classSelectionImageManager;this.updateReference=s.createUpdateReference(t),this.updateReference.onBlobUrlChange((t=>{this.imageEl.style.backgroundImage=`url("${t}")`})),this.updateReference.needsUpdates=!0}destructor(){this.updateReference.destructor()}set needsUpdates(t){this.updateReference.needsUpdates=t}setCssColor(t,e){this.backgroundEl.style.cssText=`\n\t\t\t--wrinkled-paper-seed: ${this.seed};\n\t\t\t--wrinkled-paper-color: ${t};\n\t\t\t--wrinkled-paper-border-color: ${e};\n\t\t`}}class ClassSelectionItem{constructor(t){this.el=document.createElement("div"),this.el.classList.add("shop-skin-selection-item","shop-class-selection-item");const e=document.createElement("h3");e.classList.add("dialogTitle","blueNight"),e.textContent=t.uiName,this.el.appendChild(e),this.onClickCbs=new Set,this.classSelectionImage=new ClassSelectionImage(t.id);const{colors:i}=getMainInstance().gameManager.getMyTeamColor();this.classSelectionImage.setCssColor(i.cssColor,i.cssColorDark),this.el.appendChild(this.classSelectionImage.el);const s=new UiButton({text:"Edit",onClick:()=>{this.onClickCbs.forEach((t=>t()))},extraClasses:["shop-skin-selection-edit-button"]});this.el.appendChild(s.el)}set needsAvatarUpdates(t){this.classSelectionImage.needsUpdates=t}destructor(){this.classSelectionImage.destructor()}onClick(t){this.onClickCbs.add(t)}}class ShopPresetItem{constructor({preset:t,onEditButtonClick:e,showDeleteButton:i,onDeleteButtonClick:s}){this.el=document.createElement("div"),this.el.classList.add("shop-skin-selection-item");const n=document.createElement("div");n.classList.add("shop-skin-selection-image","wrinkledPaper","wrinkled-paper-mask"),n.style.cssText=`\n\t\t\t--wrinkled-paper-seed: ${randInt(1,99999)};\n\t\t`,this.el.appendChild(n);const a=new UiButton({text:"Edit",onClick:e,extraClasses:["shop-skin-selection-edit-button"]});this.el.appendChild(a.el);const o=getMainInstance().avatars.getAvatar({skinObjectOpts:{skin:t,teamId:1},width:200,height:300,clipPathType:"none",cameraType:"full-body",backgroundColor:teamColors[2].cssColor});if(this.avatarBlobUrlReference=o.getBlobUrlReference(),(async()=>{const t=await this.avatarBlobUrlReference.getBlobUrl();n.style.backgroundImage=`url("${t}")`})(),i){const t=new UiButton({text:"x",extraClasses:["corner-delete-button"],onClick:s});t.el.ariaLabel="Delete preset",this.el.appendChild(t.el)}}destructor(){this.avatarBlobUrlReference.destructor()}}class ShopPresetsView{constructor(t){this.skinManager=t,this.onPresetOpenClickCbs=new Set,this.onBackButtonClickCbs=new Set,this.el=document.createElement("div");const e=document.createElement("div");e.classList.add("dialog-title-header-container"),this.el.appendChild(e);const i=new UiButton({isIconButton:!0,ariaLabel:"Back",icon:"static/img/arrow.svg",extraClasses:["header-button","header-back-button"],onClick:()=>{this.onBackButtonClickCbs.forEach((t=>t()))}});e.appendChild(i.el);const s=document.createElement("h2");s.textContent="Presets",s.classList.add("dialogTitle","blueNight","shop-presets-title"),e.appendChild(s),this.presetsList=document.createElement("div"),this.presetsList.classList.add("shop-skin-selection-list"),this.el.appendChild(this.presetsList),this.createdPresetItems=[],this.addPresetButton=new UiButton({text:"+",extraClasses:["shop-skin-selection-list-add-button"],onClick:()=>{t.addPreset(),this.updatePresetList(),this.presetsList.scroll(this.presetsList.scrollWidth,0)}}),this.updatePresetList()}destructor(){for(const t of this.createdPresetItems)t.destructor()}updatePresetList(){for(;this.presetsList.firstChild;)this.presetsList.removeChild(this.presetsList.firstChild);const t=this.createdPresetItems;this.createdPresetItems=[];for(const[t,e]of this.skinManager.skinPresets.entries()){const i=new ShopPresetItem({preset:e,onEditButtonClick:()=>{this.onPresetOpenClickCbs.forEach((e=>e(t)))},showDeleteButton:this.skinManager.skinPresets.length>1,onDeleteButtonClick:async()=>{getMainInstance().dialogManager.showAlert({text:"Are you sure you want to delete this preset?",buttons:[{text:"Yes",onClick:()=>{this.skinManager.deletePreset(t),this.updatePresetList()}},{text:"No"}]})}});this.presetsList.appendChild(i.el),this.createdPresetItems.push(i)}this.presetsList.appendChild(this.addPresetButton.el);for(const e of t)e.destructor()}onPresetOpenClick(t){this.onPresetOpenClickCbs.add(t)}onBackButtonClick(t){this.onBackButtonClickCbs.add(t)}}class ShopDialogUi extends DialogUi{constructor(){super({testLabel:"shop"}),this.currentCustomizationView=null,this.currentPresetsView=null,this.mainViewVisible=!0,this.ownedCoinsContainer=document.createElement("div"),this.ownedCoinsContainer.classList.add("ownedCoinsContainer","wrinkledPaper","allow-select"),this.el.appendChild(this.ownedCoinsContainer),this.currencyContainer=new CurrencyContainer;document.createElement("div").classList.add("currency-container"),this.ownedCoinsContainer.appendChild(this.currencyContainer.el),this.classSelectionContainer=document.createElement("div"),this.classSelectionContainer.classList.add("shop-class-selection-container"),this.el.appendChild(this.classSelectionContainer),this.presetsButton=new UiButton({text:"Presets",onClick:()=>{this.showPresetsView()}}),this.classSelectionContainer.appendChild(this.presetsButton.el),this.classSelectionListEl=document.createElement("div"),this.classSelectionListEl.classList.add("shop-skin-selection-list","shop-class-selection-list"),this.classSelectionContainer.appendChild(this.classSelectionListEl),this.createdClassSelectionItems=[];for(const t of classConfigs){const e=new ClassSelectionItem(t);this.classSelectionListEl.appendChild(e.el),e.onClick((()=>{this.showCustomizationView({id:{type:"class",classId:t.id},rootHeader:t.uiName,dialog:this})})),this.createdClassSelectionItems.push(e)}this.boundUpdateShopState=this.updateShopState.bind(this),getMainInstance().shopState.onStateChanged(this.boundUpdateShopState),getMainInstance().shopState.fetchCurrentData(),this.updateShopState()}destructor(){getMainInstance().shopState.removeOnStateChanged(this.boundUpdateShopState),this.hideCustomizationView(),this.hidePresetsView(),super.destructor();for(const t of this.createdClassSelectionItems)t.destructor();this.createdClassSelectionItems=[],this.hidePresetsView()}onClose(){this.currentCustomizationView&&this.currentCustomizationView.closeCreatedDialogs()}loop(t,e){this.currentCustomizationView&&this.currentCustomizationView.loop(t,e)}updateShopState(){this.currencyContainer.setAmount(getMainInstance().shopState.ownedCoins),this.currentCustomizationView&&this.currentCustomizationView.updateShopState(getMainInstance().shopState.purchasedItems)}updateMainViewVisibility(){const t=null==this.currentCustomizationView&&null==this.currentPresetsView;if(t!=this.mainViewVisible){this.mainViewVisible=t,this.classSelectionContainer.style.display=t?"":"none";for(const e of this.createdClassSelectionItems)e.needsAvatarUpdates=t}}showPresetCustomizationView(t){this.showCustomizationView({id:{type:"preset",presetId:t},rootHeader:"Preset "+(t+1),dialog:this})}showCustomizationView(t){if(this.currentCustomizationView)return;const e=getMainInstance().skins;this.currentCustomizationView=new ShopSkinCustomizationView(e,t),this.el.appendChild(this.currentCustomizationView.el),this.currentCustomizationView.onBackButtonClick((()=>{this.hideCustomizationView(),"preset"==t.id.type&&this.showPresetsView(),this.updateMainViewVisibility()})),this.hidePresetsView(),this.updateMainViewVisibility()}hideCustomizationView(){this.currentCustomizationView&&(this.el.contains(this.currentCustomizationView.el)&&this.el.removeChild(this.currentCustomizationView.el),this.currentCustomizationView.destructor(),this.currentCustomizationView=null)}showPresetsView(){this.currentPresetsView||(this.currentPresetsView=new ShopPresetsView(getMainInstance().skins),this.currentPresetsView.onPresetOpenClick((t=>{this.showPresetCustomizationView(t)})),this.currentPresetsView.onBackButtonClick((()=>{this.hidePresetsView(),this.updateMainViewVisibility()})),this.el.appendChild(this.currentPresetsView.el),this.updateMainViewVisibility())}hidePresetsView(){this.currentPresetsView&&(this.el.contains(this.currentPresetsView.el)&&this.el.removeChild(this.currentPresetsView.el),this.currentPresetsView.destructor(),this.currentPresetsView=null)}openShopItemSubPage(t,e){const i=getMainInstance(),s=i.skins,n=i.config.shopConfig.loadedConfigData;if(!n)throw new Error("Assertion failed, the shop config hasn't been loaded");const a=new Map;for(const t of Object.values(s.classSkins))if(null!=t.presetId){const e=a.get(t.presetId)||0;a.set(t.presetId,e+1)}let o=0,r=0;for(const[t,e]of a)e>r&&(o=t,r=e);if(this.showPresetCustomizationView(o),!this.currentCustomizationView)throw new Error("Assertion failed, customization view not visible");const l=n.purchasableItems.find((e=>e.id==t));if(!l)throw new Error(`The item "${t}" doesn't exist in the currently loaded shop config.`);if(l.categories)return this.currentCustomizationView.highlightOrOpenShopItem(l.categories,t,e);throw new Error("Uncategorized shop items are not supported yet")}highlightShopItem(t,e){this.openShopItemSubPage(t,e)}openShopItem(t){this.openShopItemSubPage(t,"open")}}class UserProfileDialogUi extends DialogUi{constructor(){super(),this.userNameText=document.createElement("input"),this.userNameText.placeholder="Username",this.userNameText.maxLength=20,this.userNameText.addEventListener("change",(async()=>{await getMainInstance().profileState.setUsername(this.userNameText.value)||this.updateProfileState()})),this.el.appendChild(this.userNameText),this.addButtonsContainer(),this.linkAccountButton=this.addButton({text:"Link account",onClick:async()=>{const t=await getMainInstance().auth.showLoginDialog("linknew");if(t)if(t.success)getMainInstance().dialogManager.showAlert({title:"Account linked",text:"You can now use this account for logging in as well."});else if("account-already-exists"==t.error){const{authTokenData:e,usedNonce:i}=t;getMainInstance().dialogManager.showAlert({title:"Account already exists",text:"Would you like to merge the existing account with this one?",buttons:[{text:"Cancel"},{text:"Merge Accounts",onClick:async()=>{await getMainInstance().auth.mergeAccountToCurrent(e,i)?getMainInstance().dialogManager.showAlert({title:"Accounts merged",text:"The accounts have been merged."}):getMainInstance().dialogManager.showAlert({title:"Merge error",text:"An error occurred while merging the accounts."})}}]})}else{let e="An error occurred while trying to link your account.";"already-linked"==t.error?e="This account is already linked to you.":console.error("Account link error: "+t.error),getMainInstance().dialogManager.showAlert({title:"Account linking failed",text:e})}}}),this.linkAccountButton.visible=!1,this.logoutButton=this.addButton({text:"Logout",onClick:async()=>{await getMainInstance().auth.logout()?this.close():getMainInstance().dialogManager.showAlert({title:"Error logging out",text:"An error occurred while logging out everywhere."})}}),this.logoutButton.visible=!1,this.logoutEverywhereButton=this.addButton({text:"Logout everywhere",onClick:async()=>{await getMainInstance().auth.logoutEverywhere()?this.close():getMainInstance().dialogManager.showAlert({title:"Error logging out",text:"An error occurred while logging out everywhere."})}}),this.logoutEverywhereButton.visible=!1,this.init()}async init(){await getMainInstance().auth.loginIfNotLoggedIn(!0)?(this.linkAccountButton.visible=!0,this.logoutButton.visible=!0,this.logoutEverywhereButton.visible=!0):this.close(),this.boundUpdateProfileState=this.updateProfileState.bind(this),getMainInstance().profileState.onStateChanged(this.boundUpdateProfileState),getMainInstance().profileState.fetchCurrentData(),this.updateProfileState()}updateProfileState(){this.userNameText.value=getMainInstance().profileState.username||""}}const blueNightGlyphs=" !%*+,-.:;=?0123456789abcdefghijklmnopqrstuvwxyz";function stringContainsOnlyBlueNightGlyphs(t,e=!0){e&&(t=t.toLowerCase());for(const e of t)if(!blueNightGlyphs.includes(e))return!1;return!0}class CornerProfile{constructor(){this.el=document.createElement("div"),this.el.classList.add("main-menu-corner-profile"),this.usernameEl=document.createElement("div"),this.usernameEl.classList.add("main-menu-username","blueNight","whiteBigText"),this.usernameEl.textContent="Guest",this.el.appendChild(this.usernameEl),this.ownedCoins=new CurrencyContainer({testLabel:"cornerProfile"}),this.el.appendChild(this.ownedCoins.el)}init(){getMainInstance().shopState.onStateChanged((()=>{this.ownedCoins.setAmount(getMainInstance().shopState.ownedCoins)})),getMainInstance().profileState.onStateChanged((()=>{this.setUsername(getMainInstance().profileState.username)}))}setUsername(t){t||(t="Guest"),this.usernameEl.textContent=t,this.usernameEl.classList.toggle("blueNight",stringContainsOnlyBlueNightGlyphs(t))}}class MainMenuPromoBanner{constructor(t,e,i,s,n,a,o,r){this.configManager=t,this.mainMenu=e,this.gameManager=i,this.shopStateManager=s,this.pokiManager=n,this.dialogManager=a,this.skinManager=o,this.indexedDb=r,this.promoViewData=new Map,this.activePromo=null,this.activePromos=[],this.el=document.createElement("div"),this.el.classList.add("main-menu-promo-banner-container","hidden"),this.bannerEl=document.createElement("div"),this.bannerEl.classList.add("main-menu-promo-banner","wrinkledPaper","wrinkled-paper-mask"),this.bannerEl.style.cssText=`\n\t\t\t--wrinkled-paper-seed: ${randInt(1,99999)};\n\t\t`,this.el.appendChild(this.bannerEl),this.bannerEl.addEventListener("click",(()=>{this.onPromoClick()})),this.button=new UiButton({text:"",extraClasses:["main-menu-promo-button"],onClick:()=>{this.onPromoClick()}}),this.el.appendChild(this.button.el)}async init(){await this.loadPromoViewData(),this.configManager.promosConfig.onConfigChange((t=>{this.activePromos=t.activePromos,this.loadNewBestPromo()})),this.shopStateManager.onStateChanged((()=>{const t=this.activePromo?.actionShopItem;t&&this.shopStateManager.itemIsPurchased(t)&&this.loadNewBestPromo()})),this.mainMenu.onVisibilityChange((()=>{this.updateVisibility()})),this.gameManager.onIsInGamesLoopChange((()=>{this.updateVisibility()}))}loadNewBestPromo(){let t=null,e=1/0,i=this.activePromos;const s=new Set(this.promoViewData.keys());for(const t of i)s.delete(t.id);for(const t of s)this.promoViewData.delete(t);i=i.filter((t=>!!(t&&t.id&&t.image))),i=i.filter((t=>{if(t.actionShopItem&&this.shopStateManager.itemIsPurchased(t.actionShopItem))return!1;if(t.seasonalRange){const e=t.seasonalRange;if(e.startDay&&e.endDay&&e.startMonth&&e.endMonth){const t=new Date,i=new Date(t.getFullYear(),e.startMonth-1,e.startDay),s=new Date(t.getFullYear(),e.endMonth-1,e.endDay),n=new Date(t.getFullYear(),t.getMonth(),t.getDate());if(n<i||n>s)return!1}}const e=this.getPromoViewData(t.id),i=t.maxViewCount||5;return!(-1!=i&&e.viewCount>=i)}));Boolean(i.find((t=>t.seasonalRange)))&&(i=i.filter((t=>t.seasonalRange)));for(const s of i){const i=this.getPromoViewData(s.id);i.viewCount<=e&&(t=s,e=i.viewCount)}this.setActivePromo(t)}async loadPromoViewData(){let t=[];try{t=await this.indexedDb.get("promoViewData")}catch{}t||(t=[]),this.promoViewData=new Map;for(const e of t)e&&e.id&&this.promoViewData.set(e.id,e)}async savePromoViewData(){const t=[];for(const e of this.promoViewData.values())t.push(e);try{await this.indexedDb.set("promoViewData",t)}catch{}}setActivePromo(t){if(this.el.classList.add("hidden"),!t||!t.id||!t.image)return;this.activePromo=t;const e=`url("${this.configManager.basePath}promos/${t.image}")`;this.bannerEl.style.backgroundImage=`${e}`,this.bannerEl.style.backgroundImage=`${e} !important`,t.buttonText&&this.button.setText(t.buttonText),t.buttonIcon?this.button.setIcon(`static/img/${t.buttonIcon}`):this.button.setIcon(null),this.button.visible=!!t.buttonText,this.updateVisibility(),this.updatePromoViewdata(t.id,(t=>{t.viewCount++}))}async onPromoClick(){if(!this.activePromo)return;let t="highlightShopItem";if(this.activePromo.action&&(t=this.activePromo.action),"highlightShopItem"==t){if(this.activePromo.actionShopItem){this.mainMenu.openShopDialog().highlightShopItem(this.activePromo.actionShopItem,"highlight")}}else if("openShopItem"==t){if(this.activePromo.actionShopItem){this.mainMenu.openShopDialog().openShopItem(this.activePromo.actionShopItem)}}else if("purchaseRewardedShopItem"==t){const t=this.activePromo.actionShopItem;if(t){const e=this.configManager.shopConfig.getPurchaseableItem(t);if(e&&!e.price&&e.hasRewardedAd){const i=this.mainMenu.openShopDialog();let s;s=await this.shopStateManager.purchaseItem(e,this.pokiManager,this.dialogManager,"in-menu")?"highlight-and-equip":"open",i.highlightShopItem(t,s)}}}else if("openShop"==t)this.mainMenu.openShopDialog();else if("openUrl"==t){const t=this.activePromo.actionOpenUrl;t&&window.open(t,"_blank","noopener,noreferrer")}}updateVisibility(){this.el.classList.toggle("hidden",!this.activePromo)}getPromoViewData(t){const e=this.promoViewData.get(t);return e||{id:t,viewCount:0}}updatePromoViewdata(t,e){let i=this.getPromoViewData(t);const s=e(i);s&&(i=s),this.promoViewData.set(t,i),this.savePromoViewData()}}class UiTextInput{constructor({value:t="",placeholder:e="",extraClasses:i=[],onInput:s=null,spellCheck:n=!1,maxLength:a=null}={}){this.el=document.createElement("input"),this.el.value=t,this.el.placeholder=e,this.el.classList.add("dialog-text-input","blueNight","wrinkledPaper",...i),n||(this.el.autocomplete="off",this.el.setAttribute("autocorrect","off"),this.el.autocapitalize="off",this.el.spellcheck=!1),null!=a&&(this.el.maxLength=a),s&&this.el.addEventListener("input",s)}get value(){return this.el.value}set value(t){this.el.value=t}}class MatchMakeConnectionError extends Error{constructor(){super("Unable to connect to matchmake server")}}class SquadSettingsDialogUi extends DialogUi{constructor(t){super(),this.squadManager=t,this.settings=new Map,this.settings.set("privateSquad",new SettingUiItem({text:"Private squad",type:"toggle",min:0,max:100})),this.leaderOnlyMessage=document.createElement("div"),this.leaderOnlyMessage.classList.add("squad-settings-leader-only-message"),this.leaderOnlyMessage.textContent="Only the squad leader can change these settings.",this.el.appendChild(this.leaderOnlyMessage);for(const[e,i]of this.settings)t.currentSquadSettings&&i.setValue(t.currentSquadSettings[e]),this.el.appendChild(i.el),i.onValueChange((i=>{t.setSquadSetting(e,i)}));t.onSquadSettingChange(((t,e)=>{const i=this.settings.get(t);i&&i.setValue(e)})),t.onMySquadLeaderStateChange((()=>{this.updateLeaderState()})),this.updateLeaderState()}updateLeaderState(){const t=this.squadManager.myClientIsSquadLeader;this.leaderOnlyMessage.style.display=t?"none":"";for(const e of this.settings.values())e.setDisabled(!t)}}class SquadDialogUi extends DialogUi{constructor(t,e,i,s,n){super(),this.networkManager=t,this.squadManager=e,this.gameManager=i,this.avatarsManager=s,this.skinManager=n;const a=document.createElement("div");a.classList.add("squad-split-container"),this.el.appendChild(a);const o=document.createElement("div");o.classList.add("squad-split-section"),a.appendChild(o);const r=document.createElement("h3");r.classList.add("dialogTitle","blueNight"),r.textContent="Invite someone",o.appendChild(r);const l=document.createElement("div");l.classList.add("squad-id-block"),o.appendChild(l);const h=document.createElement("div");h.textContent="Invite Code:",l.appendChild(h);const d=document.createElement("div");d.classList.add("squad-id-container"),l.appendChild(d),this.currentSquadId=null,this.squadIdText=document.createElement("div"),this.squadIdText.classList.add("allow-select","squad-id"),d.appendChild(this.squadIdText);const c=document.createElement("div");c.classList.add("squad-id-copied-text"),c.textContent="Copied!",this.copyUrlButton=new UiButton({isIconButton:!0,ariaLabel:"Copy squad id to clipboard",icon:"static/img/menuUI/copy.svg",extraClasses:["squad-id-button"],onClick:async()=>{null!=this.currentSquadId&&(await navigator.clipboard.writeText(this.currentSquadId),c.classList.remove("animating"),c.offsetHeight,c.classList.add("animating"))}}),d.appendChild(this.copyUrlButton.el),this.copyUrlButton.el.appendChild(c),this.clipboardPermissionGranted=!1,this.updateCopyUrlButtonVisibility(),this.queryClipboardPermission();const u=document.createElement("div");u.classList.add("squad-split-divider"),a.appendChild(u);const p=document.createElement("div");p.classList.add("squad-split-divider-line","wrinkledLine"),p.style.cssText="--wrinkled-line-seed: 18",u.appendChild(p);const g=document.createElement("span");g.textContent="or",u.appendChild(g);const m=document.createElement("div");m.classList.add("squad-split-divider-line","wrinkledLine"),m.style.cssText="--wrinkled-line-seed: 12",u.appendChild(m);const f=document.createElement("div");f.classList.add("squad-split-section"),a.appendChild(f);const w=document.createElement("h3");w.classList.add("dialogTitle","blueNight"),w.textContent="Join existing squad",f.appendChild(w);const b=document.createElement("form");b.classList.add("text-with-submit-form"),f.appendChild(b),b.addEventListener("submit",(async t=>{if(t.preventDefault(),this.networkManager.hasGameServerConnection){const t=getMainInstance().dialogManager.showAlert({title:"Are you sure?",text:"If you join this squad, you'll leave the current match.",buttons:[{text:"Yes"},{text:"No"}]});if(0!=await t.waitForButton())return}e.joinExistingSquad(this.joinSquadIdInput.value)})),this.joinSquadIdInput=new UiTextInput({placeholder:"Enter a code",extraClasses:["join-squad-input"],maxLength:8,onInput:()=>{this.updateJoinButtonVisibility()}}),b.appendChild(this.joinSquadIdInput.el),this.joinSquadIdButton=new UiButton({text:"Join"}),b.appendChild(this.joinSquadIdButton.el),this.updateJoinButtonVisibility();const y=document.createElement("div");y.classList.add("in-squad-content"),this.el.appendChild(y);const S=document.createElement("div");S.classList.add("squad-players-list","wrinkledPaper","wrinkled-paper-mask"),S.style.cssText=`\n\t\t\t--wrinkled-paper-seed: ${randInt(1,99999)};\n\t\t`,y.appendChild(S);const C=document.createElement("table");C.classList.add("itemsTable"),S.appendChild(C),this.membersTbody=document.createElement("tbody"),C.appendChild(this.membersTbody),this.inSquadButtonsContainer=document.createElement("div"),this.inSquadButtonsContainer.classList.add("in-squad-buttons"),y.appendChild(this.inSquadButtonsContainer);const v=new UiButton({text:"Ready",onClick:()=>{i.joinGameWithoutAd()}});this.inSquadButtonsContainer.appendChild(v.el),v.enabled=i.readyToJoin,this.boundOnReadyToJoinChange=t=>{v.enabled=t},i.onReadyToJoinChange(this.boundOnReadyToJoinChange),this.startButton=new UiButton({text:"Start",onClick:()=>{e.startSquad()}}),this.inSquadButtonsContainer.appendChild(this.startButton.el),this.squadSettingsDialog=null;const M=new UiButton({isIconButton:!0,ariaLabel:"Squad settings",icon:"static/img/menuUI/settings.svg",extraClasses:["squad-settings-button"],iconSize:1.5,onClick:()=>{this.squadSettingsDialog||(this.squadSettingsDialog=new SquadSettingsDialogUi(this.squadManager),getMainInstance().dialogManager.addDialog(this.squadSettingsDialog),this.squadSettingsDialog.addOnCloseCb((()=>{this.squadSettingsDialog=null})))}});this.el.appendChild(M.el),this.currentAvatarBlobUrlReferences=new Set,this.boundUpdateSquadId=this.updateSquadId.bind(this),this.boundOnSquadIdChange=this.onSquadIdChanged.bind(this),e.onUserVisibleSquadIdChange(this.boundOnSquadIdChange),e.onIsJoiningSquadChange(this.boundUpdateSquadId),this.boundOnSquadMembersChange=()=>{this.updateMembersUi(),this.updateReadyStartButtonVisibility()},e.onSquadMembersChange(this.boundOnSquadMembersChange),this.boundUpdateStartButtonEnabled=this.updateStartButtonEnabled.bind(this),e.onServerReadyForStartStateChange(this.boundUpdateStartButtonEnabled),this.boundUpdateStartButtonEnabledFromStartClicked=()=>{this.updateStartButtonEnabled(!0)},e.onStartClickedChange(this.boundUpdateStartButtonEnabledFromStartClicked),this.boundOnInGameChange=()=>{this.updateReadyStartButtonVisibility()},i.onActiveGameChange(this.boundOnInGameChange),this.updateSquadId(),this.updateMembersUi(),this.updateReadyStartButtonVisibility(),this.handleRequestInitialSquadId()}destructor(){super.destructor(),this.squadManager.removeOnUserVisibleSquadIdChange(this.boundOnSquadIdChange),this.squadManager.removeOnIsJoiningSquadChange(this.boundUpdateSquadId),this.squadManager.removeOnSquadMembersChange(this.boundOnSquadMembersChange),this.squadManager.removeOnServerReadyForStartStateChange(this.boundUpdateStartButtonEnabled),this.squadManager.removeOnStartClickedChange(this.boundUpdateStartButtonEnabledFromStartClicked),this.gameManager.removeOnReadyToJoinChange(this.boundOnReadyToJoinChange),this.gameManager.removeOnCurrentGameChange(this.boundOnInGameChange),this.squadSettingsDialog&&this.squadSettingsDialog.close();for(const t of this.currentAvatarBlobUrlReferences)t.destructor();this.currentAvatarBlobUrlReferences.clear()}async handleRequestInitialSquadId(){try{await this.squadManager.requestInitialSquadId()}catch(t){console.error(t);let e="An unknown error occurred while requesting the squad id.";t instanceof MatchMakeConnectionError&&(e="Could not connect to the server. Please try again later."),getMainInstance().dialogManager.showAlert({title:"Error getting squad id",text:e}),this.close()}}onSquadIdChanged(){let t=this.squadManager.userVisibleSquadId;t&&(t=t.trim().toUpperCase()),this.joinSquadIdInput.value.trim().toUpperCase()==t&&(this.joinSquadIdInput.value=""),this.updateSquadId(),this.updateReadyStartButtonVisibility()}updateSquadId(){let t="...",e=null;this.squadManager.userVisibleSquadId&&!this.squadManager.isJoiningSquad&&(t=this.squadManager.userVisibleSquadId,e=this.squadManager.userVisibleSquadId),this.currentSquadId=e,this.squadIdText.textContent=t,this.updateCopyUrlButtonVisibility()}async queryClipboardPermission(){let t;try{t=(await navigator.permissions.query({name:"clipboard-write"})).state}catch{this.clipboardPermissionGranted=!1}"granted"==t&&(this.clipboardPermissionGranted=!0),this.updateCopyUrlButtonVisibility()}updateCopyUrlButtonVisibility(){const t=this.clipboardPermissionGranted&&!!this.currentSquadId;this.copyUrlButton.visible=t}updateMembersUi(){for(;this.membersTbody.firstChild;)this.membersTbody.removeChild(this.membersTbody.firstChild);const t=Array.from(this.squadManager.getSquadMembers()),e=t.every((t=>t.ready)),i=t.every((t=>t.joined)),s=Array.from(this.currentAvatarBlobUrlReferences);this.currentAvatarBlobUrlReferences.clear();for(const s of t){const t=document.createElement("tr");this.membersTbody.appendChild(t),t.style.cssText=`\n\t\t\t\t--wrinkled-paper-seed: ${randInt(1,99999)};\n\t\t\t`;const n=document.createElement("td");if(n.classList.add("squad-players-leader-container"),t.appendChild(n),s.leader){const t=document.createElement("div");t.classList.add("squad-leader-icon"),n.appendChild(t)}const a=document.createElement("td");a.classList.add("squad-players-avatar-container"),t.appendChild(a);const o=document.createElement("div");o.classList.add("player-avatar"),a.appendChild(o);const r=40*globalThis.devicePixelRatio,l=this.avatarsManager.getAvatar({backgroundColor:teamColors[s.teamId].cssColor,width:r,height:r,skinObjectOpts:{teamId:s.teamId,skin:s.skinData}}).getBlobUrlReference();this.currentAvatarBlobUrlReferences.add(l),(async()=>{const t=await l.getBlobUrl();o.style.backgroundImage=`url("${t}")`})();const h=document.createElement("td");t.appendChild(h),h.textContent=s.name;let d="";if(s.joined&&!i?d="Joined":s.ready&&!e&&(d="Ready"),d){const t=document.createElement("span");t.classList.add("players-list-label"),t.textContent=d,h.appendChild(t)}}for(const t of s)t.destructor();this.updateStartButtonEnabled()}updateJoinButtonVisibility(){const t=this.joinSquadIdInput.value.trim().length>0;this.joinSquadIdButton.el.style.display=t?"":"none"}updateStartButtonEnabled(t=!1){this.startButton.enabled=this.squadManager.startButtonEnabled,this.squadManager.startClicked&&t&&this.close()}updateReadyStartButtonVisibility(){let t=!1;for(const e of this.squadManager.getSquadMembers()){t=!0;break}const e=this.gameManager.getOnlineGame(),i=(!e||e.gameEnded)&&null!=this.squadManager.userVisibleSquadId&&t;this.inSquadButtonsContainer.classList.toggle("hidden",!i)}}class MapItemUi{constructor(t,e){this.onJoinClickedCbs=new Set,this.el=document.createElement("div"),this.el.classList.add("map-item"),this.titleEl=document.createElement("h2"),this.titleEl.classList.add("map-item-title","blueNight"),this.titleEl.textContent=e.name,this.el.appendChild(this.titleEl),this.thumbEl=document.createElement("div"),this.thumbEl.classList.add("map-item-thumb","wrinkled-paper-mask"),this.el.appendChild(this.thumbEl);const i=`url("${t.basePath}mapThumbs/${e.assetName}.webp")`;this.thumbEl.style.cssText=`\n\t\t\t--wrinkled-paper-seed: ${randInt(1,99999)};\n\t\t`,this.thumbEl.style.backgroundImage=`${i}`,this.thumbEl.style.backgroundImage=`${i} !important`;const s=new UiButton({text:"Join",extraClasses:["map-item-join-button"],onClick:()=>{this.onJoinClickedCbs.forEach((t=>t()))}});this.el.appendChild(s.el)}onJoinClicked(t){this.onJoinClickedCbs.add(t)}}class MapsDialogUi extends DialogUi{constructor(t,e,i){super(),this.configManager=t,this.preferredMapManager=e,this.gameManager=i,this.mapsContainer=document.createElement("div"),this.mapsContainer.classList.add("maps-container"),this.el.appendChild(this.mapsContainer),this.maps=[],this.configManager.mapsConfig.onConfigChange((t=>{this.updateMaps(t)}))}updateMaps(t){for(this.maps=[];this.mapsContainer.firstChild;)this.mapsContainer.removeChild(this.mapsContainer.firstChild);for(const e of t.maps){const t=new MapItemUi(this.configManager,e);this.maps.push(t),this.mapsContainer.appendChild(t.el),t.onJoinClicked((async()=>{const t=getMainInstance(),i=t.network.squadManager;if(!i.isInSquad||i.myClientIsSquadLeader)if(this.preferredMapManager.forceSoloMap(e.hash),i.myClientIsSquadLeader&&!t.gameManager.getOnlineGame())i.startSquad(),this.close();else{await this.gameManager.checkExistingGameAndJoin()?this.close():this.preferredMapManager.disableForcedSoloMap()}else t.dialogManager.showAlert({title:"You are currently in a squad",text:"Only the squad leader may choose a map."})}))}}}let supported="serviceWorker"in navigator;navigator.userAgent.includes("AppleWebKit/605.1.15")&&!parseSearch().serviceWorker&&(supported=!1);let installCalled=!1,registration=null;async function installServiceWorker(){if(installCalled)throw new Error("install() is already called");if(installCalled=!0,!supported)return;if(getMainInstance().poki.isPokiBuild)return;let t;t="./sw.js";const e=new URL("./sw.js",import.meta.url),i=await navigator.serviceWorker.register(e.href,{scope:"./"});registration=i,i.addEventListener("updatefound",(t=>{const e=i.installing;i.active&&e&&e.addEventListener("statechange",(t=>{"installed"==e.state&&markUpdateReady()}))})),registration.waiting&&markUpdateReady(),navigator.serviceWorker.addEventListener("controllerchange",(()=>{window.location.reload()}))}const onUpdateReadyCbs=new Set;let beforeInstallPromptEvent,updateReady=!1;function markUpdateReady(){updateReady=!0,onUpdateReadyCbs.forEach((t=>t()))}function getIsInstalled(){return!!supported&&(!getMainInstance().poki.isPokiBuild&&!(!registration||!registration.active))}function onUpdateReady(t){onUpdateReadyCbs.add(t)}function getUpdateReady(){return updateReady}function skipWaiting(){if(!registration)throw new Error("No active service worker registration");const t=registration.waiting;if(!t)throw new Error("No service worker is currently waiting");t.postMessage({type:"skipWaiting"})}window.addEventListener("beforeinstallprompt",(t=>{onInstallAvailableCbs.forEach((t=>t())),beforeInstallPromptEvent=t,t.preventDefault()}));const onInstallAvailableCbs=new Set;function onInstallAvailable(t){onInstallAvailableCbs.add(t)}async function promptInstall(){if(!beforeInstallPromptEvent)throw new Error("Install available event hasn't fired yet");return beforeInstallPromptEvent.prompt(),await beforeInstallPromptEvent.userChoice}class Timeout{constructor(t,e,i=!1){this.cb=t,this.id=-1,this.ms=e,this.isDestructed=!1,i&&this.start()}destructor(){this.stop(),this.isDestructed=!0}get isRunning(){return-1!=this.id}stop(){if(!this.isDestructed)return this.id>=0&&(clearTimeout(this.id),this.id=-1,!0)}start(t=this.ms){this.isDestructed||(this.stop(),this.id=setTimeout(this.execute.bind(this),t))}execute(){this.id=-1,this.cb&&this.cb()}static promise(t){return new Promise(((e,i)=>{setTimeout((()=>{e()}),t)}))}}class PhysicsValue{constructor({startValue:t=0,springMultiplier:e=.02,maxSpring:i=1/0,dampening:s=.6,loopValue:n=!1,loopStart:a=-Math.PI,loopEnd:o=Math.PI}={}){this.value=t,this.target=t,this.velocity=0,this.springMultiplier=e,this.maxSpring=i,this.dampening=s,this.loopValue=n,this.loopStart=a,this.loopEnd=o}loop(t,e){let i=this.target-this.value;if(this.loopValue){this.target=this.performValueLoop(this.target);const t=this.loopEnd-this.loopStart,e=this.target,s=this.target-t,n=this.target+t,a=e-this.value,o=s-this.value,r=n-this.value;i=a,Math.abs(o)<Math.abs(i)&&(i=o),Math.abs(r)<Math.abs(i)&&(i=r)}i*=this.springMultiplier,i=clamp(i,-this.maxSpring,this.maxSpring),this.velocity+=i,this.velocity*=this.dampening,this.value+=this.velocity*e,this.loopValue&&(this.value=this.performValueLoop(this.value))}performValueLoop(t){return modMinMax(t,this.loopStart,this.loopEnd)}}class PhysicsValue3d{constructor({startValue:t=new Vector3,springMultiplier:e=.02,maxSpring:i=1/0,dampening:s=.6}={}){this.xValue=new PhysicsValue({startValue:t.x,springMultiplier:e,maxSpring:i,dampening:s}),this.yValue=new PhysicsValue({startValue:t.y,springMultiplier:e,maxSpring:i,dampening:s}),this.zValue=new PhysicsValue({startValue:t.z,springMultiplier:e,maxSpring:i,dampening:s})}loop(t,e){this.xValue.loop(t,e),this.yValue.loop(t,e),this.zValue.loop(t,e)}get value(){return new Vector3(this.xValue.value,this.yValue.value,this.zValue.value)}set value(t){this.xValue.value=t.x,this.yValue.value=t.y,this.zValue.value=t.z}get target(){return new Vector3(this.xValue.target,this.yValue.target,this.zValue.target)}set target(t){this.xValue.target=t.x,this.yValue.target=t.y,this.zValue.target=t.z}addImpulse(t){this.xValue.velocity+=t.x,this.yValue.velocity+=t.y,this.zValue.velocity+=t.z}}const configDefaults={posOffset:new Vector3,rotOffset:new Vector3,posFovMultiplierX:0,posFovMultiplierY:0,posBaseFovMultiplierX:0,walkBobMultiplier:1,valuesSmoothing:.2,pitchHeightMultiplier:.3,minFov:0,maxFov:180};class PlayerHoldingHandler{constructor(t,{holdingObject:e,thirdPersonParentName:i,secondaryThirdPersonParentName:s,firstPersonConfig:n}){this.player=t,this.holdingObject=e,this.usePrimaryParent=!0,this.thirdPersonParentName=i,this.secondaryThirdPersonParentName=s||null,this.firstPersonPosOffset=new Vector3,this.firstPersonRotOffset=new Quaternion,this.smoothFirstPersonPosOffset=new Vector3,this.smoothFirstPersonRotOffset=new Quaternion,this.smoothFirstPersonPosFovMultiplierX=0,this.smoothFirstPersonPosBaseFovMultiplierX=0,this.smoothFirstPersonPosFovMultiplierY=0,this.smoothFirstPersonWalkBobMultiplier=0,this.smoothFirstPersonPitchHeightMultiplier=0,this.smoothFirstPersonMinFov=0,this.smoothFirstPersonMaxFov=0,this.prevCamPosValid=!1,this.prevCamRotValid=!1,this.prevCamPos=new Vector3,this.prevCamRotForwardVector=new Vector3,this.camPosOffsetPhysics=new PhysicsValue3d({springMultiplier:.01,maxSpring:.001,dampening:.6}),this.camRotOffsetPhysics=new PhysicsValue({springMultiplier:.003,maxSpring:.001,dampening:.8}),this.renderOverlay=getMainInstance().renderer.createRenderOverlay(),this.firstPersonObjContainer=new Object3D,this.firstPersonObjContainer.name="FirstPersonObjContainer",this.renderOverlay.scene.add(this.firstPersonObjContainer),this.linkedThirdPersonObject=null,this.firstPersonConfig={...configDefaults},this.setFirstPersonConfig(n||{},!0),this.updateRenderOverlayEnabled(),this.updateParent(),this.updateFirstPersonPosition(),this.firstPersonMoveDown()}destructor(){this.player.removeHoldingHandler(this),getMainInstance().renderer.removeRenderOverlay(this.renderOverlay),this.firstPersonObjContainer.parent&&this.firstPersonObjContainer.parent.remove(this.firstPersonObjContainer),this.holdingObject.parent&&this.holdingObject.parent.remove(this.holdingObject)}updateRenderOverlayEnabled(){this.renderOverlay.enabled=this.player.useFirstPersonHoldingHandlers}setUsePrimaryParent(t){this.usePrimaryParent!=t&&(this.usePrimaryParent=t,this.updateParent())}updateParent(){if(this.holdingObject.parent&&this.holdingObject.parent.remove(this.holdingObject),this.player.useFirstPersonHoldingHandlers)this.firstPersonObjContainer.add(this.holdingObject),this.holdingObject.position.set(0,0,0),this.holdingObject.rotation.set(0,0,0);else if(this.player.obj&&this.player.skeleton&&this.player.skeleton.isInit){if(!this.player.skeleton.baseSkeletonObject)throw new Error("Assertion failed, skeleton is not initialized");let t;t=this.usePrimaryParent?this.thirdPersonParentName:this.secondaryThirdPersonParentName,t&&(this.linkedThirdPersonObject=this.player.skeleton.baseSkeletonObject.getObjectByName(t),this.linkedThirdPersonObject&&(this.player.obj.add(this.holdingObject),this.holdingObject.position.set(0,0,0),this.holdingObject.rotation.set(0,0,0),this.holdingObject.scale.setScalar(1)))}}loop(t,e){if(this.player.useFirstPersonHoldingHandlers){this.smoothFirstPersonPosOffset.lerp(this.firstPersonPosOffset,this.firstPersonConfig.valuesSmoothing),this.smoothFirstPersonRotOffset.slerp(this.firstPersonRotOffset,this.firstPersonConfig.valuesSmoothing),this.smoothFirstPersonPosFovMultiplierX=lerp(this.smoothFirstPersonPosFovMultiplierX,this.firstPersonConfig.posFovMultiplierX,this.firstPersonConfig.valuesSmoothing),this.smoothFirstPersonPosBaseFovMultiplierX=lerp(this.smoothFirstPersonPosBaseFovMultiplierX,this.firstPersonConfig.posBaseFovMultiplierX,this.firstPersonConfig.valuesSmoothing),this.smoothFirstPersonPosFovMultiplierY=lerp(this.smoothFirstPersonPosFovMultiplierY,this.firstPersonConfig.posFovMultiplierY,this.firstPersonConfig.valuesSmoothing),this.smoothFirstPersonWalkBobMultiplier=lerp(this.smoothFirstPersonWalkBobMultiplier,this.firstPersonConfig.walkBobMultiplier,this.firstPersonConfig.valuesSmoothing),this.smoothFirstPersonPitchHeightMultiplier=lerp(this.smoothFirstPersonPitchHeightMultiplier,this.firstPersonConfig.pitchHeightMultiplier,this.firstPersonConfig.valuesSmoothing),this.smoothFirstPersonMinFov=lerp(this.smoothFirstPersonMinFov,this.firstPersonConfig.minFov,this.firstPersonConfig.valuesSmoothing),this.smoothFirstPersonMaxFov=lerp(this.smoothFirstPersonMaxFov,this.firstPersonConfig.maxFov,this.firstPersonConfig.valuesSmoothing);const i=this.player.getCamPos(),s=this.player.getCamRot();this.prevCamPosValid||(this.prevCamPos.copy(i),this.prevCamPosValid=!0);const n=i.clone().sub(this.prevCamPos);n.applyQuaternion(s.invert());const a=new Vector3(0,0,1).clone().applyQuaternion(s);a.y=0,this.prevCamRotValid||(this.prevCamRotForwardVector.copy(a),this.prevCamRotValid=!0);let o=this.prevCamRotForwardVector.angleTo(a);this.prevCamRotForwardVector.clone().cross(a).y>0&&(o*=-1),this.prevCamPos.copy(i),this.prevCamRotForwardVector.copy(a);const r=n.clone();r.clampLength(0,.07),this.camPosOffsetPhysics.target=r,this.camPosOffsetPhysics.loop(t,e),this.camRotOffsetPhysics.target=o,this.camRotOffsetPhysics.loop(t,e),this.updateFirstPersonPosition()}else if(this.player.obj&&this.linkedThirdPersonObject){this.holdingObject.matrixWorld.multiplyMatrices(this.player.obj.matrixWorld,this.linkedThirdPersonObject.matrixWorld);for(const t of this.holdingObject.children)t.updateWorldMatrix(!1,!0)}}setFirstPersonConfig(t,e=!1){const i=t;this.firstPersonConfig={...configDefaults,...i},this.firstPersonPosOffset.copy(this.firstPersonConfig.posOffset);const s=(new Euler).setFromVector3(this.firstPersonConfig.rotOffset,"YXZ");this.firstPersonRotOffset.setFromEuler(s),this.firstPersonRotOffset.multiply((new Quaternion).setFromAxisAngle(new Vector3(0,1,0),Math.PI)),e&&(this.smoothFirstPersonPosOffset.copy(this.firstPersonConfig.posOffset),this.smoothFirstPersonRotOffset.copy(this.firstPersonRotOffset),this.smoothFirstPersonPosFovMultiplierX=this.firstPersonConfig.posFovMultiplierX,this.smoothFirstPersonPosBaseFovMultiplierX=this.firstPersonConfig.posBaseFovMultiplierX,this.smoothFirstPersonPosFovMultiplierY=this.firstPersonConfig.posFovMultiplierY,this.smoothFirstPersonWalkBobMultiplier=this.firstPersonConfig.walkBobMultiplier,this.smoothFirstPersonPitchHeightMultiplier=this.firstPersonConfig.pitchHeightMultiplier,this.smoothFirstPersonMinFov=this.firstPersonConfig.minFov,this.smoothFirstPersonMaxFov=this.firstPersonConfig.maxFov,this.updateRenderOverlayFovs(),this.renderOverlay.updateProjectionMatrix()),this.updateFirstPersonPosition()}updateFirstPersonPosition(){if(!this.player.useFirstPersonHoldingHandlers)return;const t=getMainInstance(),e=this.player.getCamRot(),i=new Vector3(0,1,0),s=new Vector3(0,0,1),n=new Vector3(1,0,0),a=i.clone().applyQuaternion(e),o=s.clone().applyQuaternion(e),r=n.clone().applyQuaternion(e),l=o.clone();a.y<.1&&(l.copy(a),o.y>0&&l.negate()),l.y=0;let h=l.angleTo(s);s.clone().cross(l).y>0&&(h=-h);let d=o.angleTo(l);o.clone().cross(l).dot(r)>0&&(d=-d);const c=new Quaternion;n.applyQuaternion(e),c.setFromAxisAngle(n,d);(new Quaternion).setFromAxisAngle(new Vector3(0,1,0),-h);const u=this.smoothFirstPersonPosOffset.clone(),p=Math.min(window.innerWidth/window.innerHeight,2),g=this.renderOverlay.cam.fov,m=Math.tan(g/115)*p,f=Math.tan(g/115),w=Math.tan(t.cam.baseFov/115)*p;u.x+=m*this.smoothFirstPersonPosFovMultiplierX,u.x+=w*this.smoothFirstPersonPosBaseFovMultiplierX,u.y-=f*this.smoothFirstPersonPosFovMultiplierY,u.y-=d*this.smoothFirstPersonPitchHeightMultiplier,t.settingsManager.getValue("walkHeadBob")&&(u.x+=.1*Math.cos(this.player.legsMoveTForCos/2)*this.smoothFirstPersonWalkBobMultiplier,u.y+=-.07*Math.sin(this.player.legsMoveTForCos)*this.smoothFirstPersonWalkBobMultiplier),u.sub(this.camPosOffsetPhysics.value),u.x+=this.camRotOffsetPhysics.value;const b=new Quaternion;b.multiply(this.smoothFirstPersonRotOffset),this.firstPersonObjContainer.position.copy(u),this.firstPersonObjContainer.quaternion.copy(b),this.updateRenderOverlayFovs(),this.firstPersonObjContainer.updateWorldMatrix(!1,!0)}updateRenderOverlayFovs(){this.renderOverlay.minFov=this.smoothFirstPersonMinFov,this.renderOverlay.maxFov=this.smoothFirstPersonMaxFov}useFirstPersonUpdated(){this.updateRenderOverlayEnabled(),this.updateParent()}playerObjectChanged(){this.updateParent()}addFirstPersonImpulse(t){this.player.useFirstPersonHoldingHandlers&&this.camPosOffsetPhysics.addImpulse(t)}firstPersonMoveDown(){this.camPosOffsetPhysics.yValue.value=.3}}class SingleInstancePromise{constructor(t,{once:e=!1}={}){this.once=e,this.promiseFn=t,this._queue=[],this._isEmptyingQueue=!1,this.hasRun=!1,this._onceReturnValue=void 0,this._onFinishCbs=new Set}async run(...t){if(this.hasRun&&this.once)return this._onceReturnValue;const e=new Promise((e=>this._queue.push({resolve:e,args:t})));return this._emptyQueue(),await e}async _emptyQueue(){if(!this._isEmptyingQueue){for(this._isEmptyingQueue=!0;this._queue.length>0;){if(this.once&&this.hasRun){const t=this._onceReturnValue;this._queue.forEach((e=>e.resolve(t))),this._queue=[];break}const t=this._queue;this._queue=[];const e=t[t.length-1];if(!e)throw new Error("Assertion failed, queue is empty.");this._isEmptyingQueue=!0;const i=await this.promiseFn(...e.args);this._isEmptyingQueue=!1,this.hasRun=!0,this._onFinishCbs.forEach((t=>t())),this._onFinishCbs.clear(),this.once&&(this._onceReturnValue=i);for(const{resolve:e}of t)e(i)}this._isEmptyingQueue=!1}}async waitForFinish(){if(this.hasRun)return;const t=new Promise((t=>this._onFinishCbs.add(t)));await t}async waitForFinishIfRunning(){if(!this._isEmptyingQueue)return;const t=new Promise((t=>this._onFinishCbs.add(t)));await t}}class MatchMakingManager{constructor(){this.matchMakingSocketUrl="",this.ws=null,this.onJoinServerReceivedCbs=new Set,this.nextCloseIsIntentional=!1,this.onConnectionCloseCbs=new Set,this.onConnectionOpenCbs=new Set,this.onConnectionCloseDuringMatchMakingCbs=new Set,this.onSquadMessageCbs=new Set,this.onIsMatchMakingChangeCbs=new Set,this.matchMakingLoadingText=null,this.isMatchMaking=!1,this.shouldApplyLoadingText=!0,this.valuesLoaded=!1,this.onValuesLoadCbs=new Set,this.elo=0,this.smoothSkillLevel=0,this.smoothSkillLevelGameCount=0,this.isInUnreadyQueue=!1,this.initConnectionInstance=new SingleInstancePromise((async()=>{if(this.connected)return!0;for(let t=0;t<3;t++){t>0&&await Timeout.promise(2e3*t);const e=await this.attemptSingleWsConnection();if(e)return this.send({op:"myClientVersion",version:"1685095066"}),this.sendDownloadedMapHashes(),this.sendSkillLevel(),this.onConnectionOpenCbs.forEach((t=>t())),e.addEventListener("close",(()=>{e==this.ws&&this.fireOnCloseCbs()})),!0}return!1}))}init(){this.matchMakingLoadingText=getMainInstance().mainInfoTextManager.requestInfoText("Searching for players...");const t=parseSearch();if("local"!=getMainInstance().env||t.useProductionServers)this.matchMakingSocketUrl="wss://matchmaking.narrow-one.com/";else{let t="wss";"http:"==location.protocol&&(t="ws"),this.matchMakingSocketUrl=`${t}://${window.location.host}/matchmaking`}getMainInstance().preferredMapManager.onMatchMakeDataChange((()=>{this.sendDownloadedMapHashes()})),getMainInstance().config.mapsConfig.onConfigChange((()=>{this.sendDownloadedMapHashes()})),this.loadValues()}setIsMatchMaking(t){this.isMatchMaking=t,this.onIsMatchMakingChangeCbs.forEach((t=>t())),this.updateLoadingText()}setShouldApplyLoadingText(t){this.shouldApplyLoadingText=t,this.updateLoadingText()}updateLoadingText(){this.matchMakingLoadingText&&this.matchMakingLoadingText.setIsLoading(this.isMatchMaking&&this.shouldApplyLoadingText)}async loadValues(){try{const t=await getMainInstance().indexedDb.get("matchMakeSavedValues");t&&(this.smoothSkillLevel=t.smoothSkillLevel,this.smoothSkillLevelGameCount=t.smoothSkillLevelGameCount,this.elo=t.elo)}catch(t){}(isNaN(this.smoothSkillLevel)||isNaN(this.smoothSkillLevelGameCount)||"number"!=typeof this.smoothSkillLevel||"number"!=typeof this.smoothSkillLevelGameCount)&&(this.smoothSkillLevel=0,this.smoothSkillLevelGameCount=0),(isNaN(this.elo)||"number"!=typeof this.elo)&&(this.elo=0),this.valuesLoaded=!0,this.onValuesLoadCbs.forEach((t=>t())),this.sendSkillLevel()}async waitForValuesLoad(){if(this.valuesLoaded)return;const t=new Promise((t=>{this.onValuesLoadCbs.add(t)}));await t}async saveValues(){const t={elo:this.elo,smoothSkillLevel:this.smoothSkillLevel,smoothSkillLevelGameCount:this.smoothSkillLevelGameCount};try{await getMainInstance().indexedDb.set("matchMakeSavedValues",t)}catch(t){}}async initConnection(){return this.nextCloseIsIntentional=!1,await this.initConnectionInstance.run()}async assertInitConnection(){if(!await this.initConnection())throw new MatchMakeConnectionError}get connected(){return this.ws&&this.ws.readyState==WebSocket.OPEN}async attemptSingleWsConnection(){const t=new WebSocket(this.matchMakingSocketUrl);this.ws=t;const e=["squadId","squadJoinError","fullSquadMembersList","squadMemberUpdated","squadMemberRemoved","squadStartedState","squadSettings","squadSettingChanged","yourSquadLeaderState","squadReadyForStartState"];return this.ws.addEventListener("message",(i=>{if(t!=this.ws)return;const s=JSON.parse(i.data);if("joinGame"==s.op){this.setIsMatchMaking(!1);for(const t of this.onJoinServerReceivedCbs)t(s.game)}else"reloadMapsConfig"==s.op?getMainInstance().config.mapsConfig.load():e.includes(s.op)&&this.onSquadMessageCbs.forEach((t=>t(s)))})),await new Promise((e=>{t.addEventListener("close",(t=>{e(null)})),t.addEventListener("open",(i=>{e(t)}))}))}closeMatchMakingConnection(){if(!this.ws)return;this.markNextCloseAsIntentional();const t=this.ws;this.ws=null,t.close(),this.fireOnCloseCbs()}markNextCloseAsIntentional(){this.nextCloseIsIntentional=!0}fireOnCloseCbs(){this.isMatchMaking&&(this.onConnectionCloseDuringMatchMakingCbs.forEach((t=>t())),this.setIsMatchMaking(!1)),this.onConnectionCloseCbs.forEach((t=>t(this.nextCloseIsIntentional)))}async updateQueueState({isReadyToJoin:t=!0,maxWaitTimeMs:e}={}){this.setIsMatchMaking(!0),this.isInUnreadyQueue=!t;try{await this.assertInitConnection()}catch(t){throw this.setIsMatchMaking(!1),t}const i=getMainInstance(),s=!i.gameManager.joinedOnce;let n;n=null==e?s||i.preferredMapManager.isForcingSoloMap?0:Math.min(5e3,1e3*this.smoothSkillLevelGameCount):e,this.send({op:"updateQueueState",maxWaitTimeMs:n,isFirstGame:s,isReadyToJoin:t})}async leaveQueue(){this.isInUnreadyQueue=!1,await this.initConnection(),this.connected&&(this.setIsMatchMaking(!1),this.isInUnreadyQueue=!1,this.send({op:"leaveQueue"}))}onConnectionOpen(t){this.onConnectionOpenCbs.add(t)}onConnectionClose(t){this.onConnectionCloseCbs.add(t)}onConnectionCloseDuringMatchMaking(t){this.onConnectionCloseDuringMatchMakingCbs.add(t)}onIsMatchMakingChange(t){this.onIsMatchMakingChangeCbs.add(t)}send(t){if(!this.connected||!this.ws)return;const e=JSON.stringify(t);this.ws.send(e)}sendDownloadedMapHashes(){const t=getMainInstance().preferredMapManager.getMatchMakeData();t&&this.send(t)}getMappedSmoothSkillLevel(){const t=this.smoothSkillLevel/100,e=-5.7,i=-Math.pow(2,5.7-12.8*t),s=(Math.log10(i*e*Math.log10(2)+1)+e*Math.log10(2))/(e*Math.log10(2));return Math.max(0,s)}sendSkillLevel(){this.valuesLoaded&&(this.send({op:"skillLevel",skillLevel:this.getMappedSmoothSkillLevel()}),this.send({op:"elo",elo:this.elo}))}onJoinServerReceived(t){this.onJoinServerReceivedCbs.add(t)}updateSmoothSkillLevel(t){this.smoothSkillLevelGameCount++;const e=mapValue(0,5,.7,.4,this.smoothSkillLevelGameCount,!0);this.smoothSkillLevel=lerp(this.smoothSkillLevel,t,e),this.saveValues()}updateElo(t){this.valuesLoaded&&(this.elo+=t,this.saveValues())}async sendRequestSquadId(){await this.assertInitConnection(),this.send({op:"requestSquadId"})}async sendJoinSquad(t,e,i){await this.assertInitConnection(),this.send({op:"joinSquad",squadId:t,allowJoinExistingGame:e,allowCreate:i})}onSquadMessage(t){this.onSquadMessageCbs.add(t)}sendSquadSettingChange(t,e){this.send({op:"changeSquadSetting",setting:t,value:e})}sendAllSquadSettings(t){this.send({op:"allSquadSettings",settings:t})}sendUsername(t){this.send({op:"username",username:t})}sendStartSquad(){this.send({op:"startSquad"})}sendAllowAutoStartSquad(){this.send({op:"allowAutoStartSquad"})}sendRequestSquadLeadership(t){this.send({op:"requestSquadLeadership",token:t})}sendMySkinData(t){this.send({op:"mySkinData",skinData:t})}}class SquadManager{constructor(t,e,i){this.networkManager=t,this.matchMakeManager=e,this.gameManager=i,this.isJoiningSquad=!1,this.matchmakeServerSquadId=null,this.gameServerSquadId=null,this.onBeforeJoinFired=!1,this.lastSentUsername=null,this.lastSentSkinDataStr=null,this.shouldShowSquadDialogForCurrentSquadId=!1,this.matchMakeSquadMembers=new Map,this.matchMakeSquadMembersOnGameJoin=new Map,this.includeUnjoinedMembers=!1,this.includeUnjoinedMembersTimeout=new Timeout((()=>{this.includeUnjoinedMembers=!1,this.updateSquadMembersData()}),3e4),this.gameSquadPlayers=[],this.mySquadPlayerId=0,this.matchMakeAllReady=!1,this.serverReadyForStartState=!1,this.onServerReadyForStartStateChangeCbs=new Set,this.onServerReadyForStartTrueCbs=new Set,this.clientStartClicked=!1,this.clientStartClickedTimeout=new Timeout((()=>{this.clientStartClicked=!1,this.updateStartClicked()}),2e3),this.serverStartClicked=!1,this.startClicked=!1,this.onStartClickedChangeCbs=new Set,this.prevUserVisibleSquadId=null,this.onUserVisibleSquadIdChangeCbs=new Set,this.onIsJoiningSquadChangeCbs=new Set,this.onSquadMembersChangeCbs=new Set,this.currentSquadSettings=null,this.beforeMatchmakeConnectSquadSettings=null,this.myClientIsSquadLeader=!1,this.lastSquadLeaderToken=null,this.onSquadSettingChangeCbs=new Set,this.onMySquadLeaderStateChangeCbs=new Set,this.matchMakeManager.onSquadMessage((t=>{if("squadId"==t.op)this.setIsJoiningSquad(!1),this.setMatchmakeServerSquadId(t.squadId),this.sendCurrentUsername(),this.sendMySkinIds(),this.setMyClientIsSquadLeader(!1),this.shouldShowSquadDialogForCurrentSquadId&&(this.shouldShowSquadDialogForCurrentSquadId=!1,t.willJoinImmediately||getMainInstance().mainMenu.openSquadDialog()),this.lastSquadLeaderToken&&this.matchMakeManager.sendRequestSquadLeadership(this.lastSquadLeaderToken);else if("squadJoinError"==t.op)this.handleSquadJoinError(t.errorType,t.squadId);else if("squadSettings"==t.op)this.currentSquadSettings=t.settings;else if("squadSettingChanged"==t.op)this.currentSquadSettings&&(this.currentSquadSettings[t.setting]=t.value),this.onSquadSettingChangeCbs.forEach((e=>e(t.setting,t.value)));else if("yourSquadLeaderState"==t.op)t.token&&(this.lastSquadLeaderToken=t.token),this.setMyClientIsSquadLeader(t.isLeader);else if("fullSquadMembersList"==t.op){for(const e of t.members)e.myPlayer&&(this.mySquadPlayerId=e.id),this.matchMakeSquadMembers.set(e.id,{name:e.name,skinData:parseSkinDataString(e.skinDataStr),ready:e.ready,leader:e.leader});this.updateSquadMembersData()}else if("squadMemberUpdated"==t.op){let e=this.matchMakeSquadMembers.get(t.member.id);e||(e={name:"",ready:!1,skinData:sanitizeSkinData(),leader:!1},this.matchMakeSquadMembers.set(t.member.id,e)),e.name=t.member.name,e.ready=t.member.ready,e.skinData=parseSkinDataString(t.member.skinDataStr),e.leader=t.member.leader,this.updateSquadMembersData()}else"squadMemberRemoved"==t.op?(this.matchMakeSquadMembers.delete(t.id),this.updateSquadMembersData()):"squadReadyForStartState"==t.op?(this.serverReadyForStartState=t.readyForStart,this.onServerReadyForStartStateChangeCbs.forEach((t=>t())),t.readyForStart&&this.onServerReadyForStartTrueCbs.forEach((t=>t()))):"squadStartedState"==t.op&&(this.serverStartClicked=t.started,this.updateStartClicked(),this.updateLoadingText())})),t.onBeforeConnectGameServer((()=>{this.onBeforeJoinFired=!0,this.gameServerSquadId=this.matchmakeServerSquadId,this.matchMakeSquadMembersOnGameJoin=new Map(this.matchMakeSquadMembers),this.includeUnjoinedMembers=!0,this.includeUnjoinedMembersTimeout.start(),this.updateSquadMembersData(),this.updateUserVisibleSquadId()})),t.onConnectionOpen((()=>{t.sendSquadData(this.userVisibleSquadId||"",this.mySquadPlayerId,this.lastSquadLeaderToken)})),t.onConnectionClosed(((t,e)=>{this.setIsJoiningSquad(!1),!t&&this.gameServerSquadId&&"afk"!=e&&this.joinExistingSquad(this.gameServerSquadId,!1),this.setGameServerSquadId(null)})),t.onSquadJoinError((t=>{this.handleSquadJoinError(t)})),this.matchMakeManager.onConnectionOpen((()=>{if(this.onBeforeJoinFired=!1,this.includeUnjoinedMembersTimeout.stop(),this.serverReadyForStartState=!1,this.mySquadPlayerId=0,this.currentSquadSettings){const t={};for(const[e,i]of Object.entries(this.currentSquadSettings)){t[e]=i}this.beforeMatchmakeConnectSquadSettings=t}else this.beforeMatchmakeConnectSquadSettings=null;if(this.gameServerSquadId){let t=!0;const e=i.getOnlineGame();e&&e.gameEnded&&(t=!1),this.joinExistingSquad(this.gameServerSquadId,t,t),this.matchMakeManager.sendAllowAutoStartSquad()}this.serverStartClicked=!1,this.updateStartClicked()})),this.matchMakeManager.onConnectionClose((t=>{t?this.setMatchmakeServerSquadId(null):this.matchmakeServerSquadId&&this.joinExistingSquad(this.matchmakeServerSquadId),this.lastSentUsername=null,this.lastSentSkinDataStr=null,this.matchMakeSquadMembers.clear(),this.updateSquadMembersData()})),this.matchMakeManager.onIsMatchMakingChange((()=>{this.updateLoadingText()})),this.boundUpdateGameSquadPlayers=this.updateGameSquadPlayers.bind(this),i.onActiveGameChange((t=>{t instanceof Game&&(t&&t.onSquadPlayersChange(this.boundUpdateGameSquadPlayers),this.updateGameSquadPlayers())})),window.addEventListener("hashchange",(()=>{this.joinSquadFromCurrentHash()}))}init(){this.waitingForSquadLoadingText=getMainInstance().mainInfoTextManager.requestInfoText("Waiting for squad...",{shouldBounce:!1}),this.waitingForSquadStartLoadingText=getMainInstance().mainInfoTextManager.requestInfoText("Waiting for squad to start",{shouldBounce:!1}),getMainInstance().profileState.onStateChanged((()=>{this.matchmakeServerSquadId&&this.sendCurrentUsername()})),getMainInstance().skins.onSkinConfigChange((()=>{this.sendMySkinIds()})),this.joinSquadFromCurrentHash(!0)}get userVisibleSquadId(){return this.matchmakeServerSquadId||this.gameServerSquadId}get isInSquad(){return null!=this.userVisibleSquadId}get startButtonEnabled(){return this.serverReadyForStartState&&!this.startClicked}updateGameSquadPlayers(){this.gameSquadPlayers=[];const t=this.gameManager.getOnlineGame();if(t)for(const e of t.players.values())e.sameSquadOrOwned&&this.gameSquadPlayers.push({id:e.squadPlayerId,name:e.playerName,teamId:e.teamId,skinData:e.equippedSkinData,leader:e.isSquadLeader});this.updateSquadMembersData()}*getSquadMembers(){if(this.onBeforeJoinFired){const t=new Map(this.matchMakeSquadMembersOnGameJoin);for(const e of this.gameSquadPlayers)t.delete(e.id),yield{name:e.name,teamId:e.teamId,ready:!0,joined:!0,skinData:e.skinData,leader:e.leader};for(const e of t.values())yield{name:e.name,teamId:0,ready:e.ready,joined:!1,skinData:sanitizeSkinData(),leader:e.leader}}else for(const t of this.matchMakeSquadMembers.values())yield{name:t.name,teamId:0,ready:t.ready,joined:!1,skinData:t.skinData,leader:t.leader}}get totalSquadMemberCount(){let t=0;for(const e of this.getSquadMembers())t++;return t}setSquadSetting(t,e){this.currentSquadSettings&&"boolean"==typeof e&&(this.currentSquadSettings[t]=e),this.matchMakeManager.connected&&this.matchMakeManager.sendSquadSettingChange(t,e)}onSquadSettingChange(t){this.onSquadSettingChangeCbs.add(t)}onMySquadLeaderStateChange(t){this.onMySquadLeaderStateChangeCbs.add(t)}sendCurrentUsername(){if(!this.matchMakeManager.connected)return;const t=getMainInstance().profileState.username;t!=this.lastSentUsername&&(this.lastSentUsername=t,this.matchMakeManager.sendUsername(t))}sendMySkinIds(){if(!this.matchMakeManager.connected)return;const t=getMainInstance().skins.getClassSkinDataWithAppliedPreset("assault"),e=JSON.stringify(t);e!=this.lastSentSkinDataStr&&(this.lastSentSkinDataStr=e,this.matchMakeManager.sendMySkinData(e))}setMyClientIsSquadLeader(t){this.myClientIsSquadLeader=t,t&&this.beforeMatchmakeConnectSquadSettings&&(this.matchMakeManager.sendAllSquadSettings(this.beforeMatchmakeConnectSquadSettings),this.beforeMatchmakeConnectSquadSettings=null),this.onMySquadLeaderStateChangeCbs.forEach((t=>t()))}setIsJoiningSquad(t){t!=this.isJoiningSquad&&(this.isJoiningSquad=t,this.onIsJoiningSquadChangeCbs.forEach((t=>t())))}async requestInitialSquadId(){if(!this.isJoiningSquad&&!this.isInSquad){if(this.setIsJoiningSquad(!0),this.networkManager.hasGameServerConnection)this.networkManager.sendRequestSquadId();else{try{await this.matchMakeManager.sendRequestSquadId()}catch(t){throw this.setIsJoiningSquad(!1),t}this.setIsJoiningSquad(!1)}this.sendCurrentUsername(),this.sendMySkinIds()}}handleSquadJoinError(t,e){if(this.setIsJoiningSquad(!1),"squad-not-found"==t){let t="The squad you are trying to join does not exist.";null!=e&&(t=`The squad with code "${e}" does not exist.`),getMainInstance().dialogManager.showAlert({title:"Squad not found",text:t})}else if("client-version-too-old"==t)if(getIsInstalled()){const t=[{text:"Ok"},{text:"Update now",onClick(){skipWaiting()},enabled:getUpdateReady()}],e=getMainInstance().dialogManager.showAlert({title:"Joining squad failed",text:"The version of your game is too old for this squad.",buttons:t});onUpdateReady((()=>{t[1].enabled=!0,e.setButtons(t)}))}else getMainInstance().dialogManager.showAlert({title:"Joining squad failed",text:"Your version is too old to join this squad. Refresh the page to update to the latest version."});else"client-version-too-new"==t?getMainInstance().dialogManager.showAlert({title:"Joining squad failed",text:"Your squadmates have an older version of the game, ask your squadmates to update the game."}):"no-mm-connection"==t?getMainInstance().dialogManager.showAlert({title:"Joining squad failed",text:"Could not connect to the matchmake server. Please try again later."}):"proxy-create-timed-out"==t?getMainInstance().dialogManager.showAlert({title:"Failed to create squad id",text:"The matchmake server timed out. Please try again later."}):(getMainInstance().dialogManager.showAlert({title:"Joining squad failed",text:"An unknown error occurred. Please try again later."}),console.error(`Squad join error: ${t}`));this.updateUserVisibleSquadId()}async joinExistingSquad(t,e=!0,i=!0){if(this.isJoiningSquad)return;i&&this.networkManager.hasGameServerConnection&&this.networkManager.closeCurrentConnection(),this.setIsJoiningSquad(!0);let s=[];try{s=await getMainInstance().indexedDb.get("recentSquadIds")}catch(t){console.error(t)}let n=!1;s&&s.includes(t)&&(n=!0);try{await this.matchMakeManager.sendJoinSquad(t,e,n)}catch(t){return console.error(t),getMainInstance().dialogManager.showAlert({title:"Failed to join the squad",text:"Couldn't connect to the server. Please try again later."}),this.setIsJoiningSquad(!1),void this.setMatchmakeServerSquadId(null)}this.sendCurrentUsername(),this.sendMySkinIds()}setMatchmakeServerSquadId(t){this.matchmakeServerSquadId=t,this.addRecentSquadId(t),this.updateUserVisibleSquadId()}setGameServerSquadId(t){this.gameServerSquadId=t,this.addRecentSquadId(t),this.updateUserVisibleSquadId()}addRecentSquadId(t){if(!t)return;getMainInstance().indexedDb.getSet("recentSquadIds",(e=>{e||(e=[]);const i=new Set(e);return i.delete(t),i.add(t),(e=Array.from(i)).length>5&&e.splice(0,e.length-5),e}))}squadIdReceivedFromGameServer(t){this.setIsJoiningSquad(!1),this.setGameServerSquadId(t)}onUserVisibleSquadIdChange(t){this.onUserVisibleSquadIdChangeCbs.add(t)}removeOnUserVisibleSquadIdChange(t){this.onUserVisibleSquadIdChangeCbs.delete(t)}updateUserVisibleSquadId(){let t=this.userVisibleSquadId||"";t&&(t="#"+t),t=window.location.pathname+window.location.search+t,history.replaceState(null,"",t),this.userVisibleSquadId!=this.prevUserVisibleSquadId&&(this.prevUserVisibleSquadId=this.userVisibleSquadId,this.matchmakeServerSquadId&&!this.gameServerSquadId&&(this.shouldShowSquadDialogForCurrentSquadId=!0),this.updateLoadingText(),this.onUserVisibleSquadIdChangeCbs.forEach((t=>t(this.userVisibleSquadId))))}updateLoadingText(){if(!this.waitingForSquadLoadingText)return;if(!this.waitingForSquadStartLoadingText)return;const t=!this.isInSquad||this.serverStartClicked;this.matchMakeManager.setShouldApplyLoadingText(t),!t&&this.matchMakeManager.isMatchMaking?this.matchMakeAllReady?(this.waitingForSquadStartLoadingText.setIsLoading(!0),this.waitingForSquadLoadingText.setIsLoading(!1)):(this.waitingForSquadStartLoadingText.setIsLoading(!1),this.waitingForSquadLoadingText.setIsLoading(!0)):(this.waitingForSquadLoadingText.setIsLoading(!1),this.waitingForSquadStartLoadingText.setIsLoading(!1))}updateStartClicked(){const t=this.clientStartClicked||this.serverStartClicked;t!=this.startClicked&&(this.startClicked=t,this.onStartClickedChangeCbs.forEach((t=>t())))}joinSquadFromCurrentHash(t=!1){let e=null;const i=window.location.hash;if(i.startsWith("#")){const t=i.substring(1);t&&(e=t)}t&&!e||e!=this.matchmakeServerSquadId&&e!=this.gameServerSquadId&&(this.isJoiningSquad||(e&&e.length>7?this.updateUserVisibleSquadId():e&&this.joinExistingSquad(e)))}startSquad(){this.matchMakeManager.sendStartSquad(),this.clientStartClicked=!0,this.updateStartClicked(),this.clientStartClickedTimeout.start()}onIsJoiningSquadChange(t){this.onIsJoiningSquadChangeCbs.add(t)}removeOnIsJoiningSquadChange(t){this.onIsJoiningSquadChangeCbs.delete(t)}onSquadMembersChange(t){this.onSquadMembersChangeCbs.add(t)}removeOnSquadMembersChange(t){this.onSquadMembersChangeCbs.delete(t)}onServerReadyForStartStateChange(t){this.onServerReadyForStartStateChangeCbs.add(t)}removeOnServerReadyForStartStateChange(t){this.onServerReadyForStartStateChangeCbs.delete(t)}async waitForServerReadyForStart(){const t=new Promise((t=>{this.onServerReadyForStartTrueCbs.add(t)}));await t}onStartClickedChange(t){this.onStartClickedChangeCbs.add(t)}removeOnStartClickedChange(t){this.onStartClickedChangeCbs.delete(t)}updateSquadMembersData(){let t=!0;for(const e of this.matchMakeSquadMembers.values())e.ready||(t=!1);this.matchMakeAllReady!=t&&(this.matchMakeAllReady=t,this.updateLoadingText()),this.onSquadMembersChangeCbs.forEach((t=>t()))}}function normalize(t,e=-1,i=1,s=8){return t=mapValue(e,i,0,2**s-1,t,!0),t=Math.round(t)}function normalizeU32(t,e=1){return normalize(t,0,e,32)}function normalizeS16(t,e,i){return normalize(t,e,i,16)}function normalizeU16(t,e=1){return normalize(t,0,e,16)}function normalizeS8(t,e=1){return normalize(t,-e,e,8)}function normalizeU8(t,e=1){return normalize(t,0,e,8)}function unnormalize(t,e=-1,i=1,s=8){return t=mapValue(0,2**s-1,e,i,t,!0)}function unnormalizeU32(t,e=1){return unnormalize(t,0,e,32)}function unnormalizeS16(t,e,i){return unnormalize(t,e,i,16)}function unnormalizeU16(t,e=1){return unnormalize(t,0,e,16)}function unnormalizeS8(t,e=1){return unnormalize(t,-e,e,8)}function unnormalizeU8(t,e=1){return unnormalize(t,0,e,8)}function parseStringMessage(t,e=4){if(t.byteLength<e+4)return null;const i=new Uint32Array(t,e,1)[0];try{const s=new Uint8Array(t,e+4,i);return(new TextDecoder).decode(s)}catch(t){return null}}function parseJsonMessage(t){const e=parseStringMessage(t);if(e)try{return JSON.parse(e)}catch(t){return null}}function ceilBytesLength(t){return 4*Math.ceil(t/4)}function createStringMessage(t,e){const i=(new TextEncoder).encode(e),s=ceilBytesLength(i.length),n=new ArrayBuffer(8+s),a=new Uint32Array(n);a[0]=t,a[1]=i.length;return new Uint8Array(n,8).set(i),n}const WORLD_BOUNDS_MARGIN=5;class NetworkManager{constructor(t){this.ws=null,this.joiningLoadingText=null,this.lastReceiveMessageTime=0,this.connectionOpenedAndDataSent=!1,this.onConnectionOpenCbs=new Set,this.onNextConnectionOpenCbs=new Set,this.onConnectionClosedCbs=new Set,this.onSquadJoinErrorCbs=new Set,this.onBeforeConnectGameServerCbs=new Set,this.lastSentSkinData="",this.lastDisconnectReason="unknown",this.lastDisconnectReasonExtra=[],this.nextCloseIsIntentional=!1,this.nextJoinGameId=-1,this.nextJoinRequestId=null,this.matchMaking=new MatchMakingManager,this.matchMaking.onJoinServerReceived((t=>{let e;if(this.joiningLoadingText&&this.joiningLoadingText.setIsLoading(!0),this.nextJoinGameId=t.gameId,this.nextJoinRequestId=t.joinRequestId??null,t.isLocal)e=NetworkManager.getLocalGameServerUrl();else{e=(t.insecure?"ws":"wss")+"://"+t.url4}this.connect(e),this.matchMaking.closeMatchMakingConnection(),getMainInstance().preferredMapManager.disableForcedSoloMap()})),this.matchMaking.onConnectionCloseDuringMatchMaking((()=>{this.fireConnectionClosed()})),this.squadManager=new SquadManager(this,this.matchMaking,t),this.isInit=!1,this.onInitCbs=new Set}init(){const t=getMainInstance();this.joiningLoadingText=t.mainInfoTextManager.requestInfoText("Joining game...");const e=parseSearch();this.matchMaking.init(),t.auth.onLoggedInAccountChange((()=>{this.sendCurrentSession()})),t.auth.onGuestSessionDataChange((()=>{this.sendCurrentSession()})),this.squadManager.init(),this.isInit=!0;for(const t of this.onInitCbs)t();this.onInitCbs.clear(),e.ip&&this.prepareJoinGame()}async waitForInit(){this.isInit||await new Promise((t=>this.onInitCbs.add((()=>t(void 0)))))}get shouldUseMatchMaking(){const t=parseSearch();if(t.useProductionServers)return!0;if(t.ip)return!1;const e=getMainInstance();return"dev"!=e.env&&"staging"!=e.env}static getLocalGameServerUrl(){let t="ws";return"https:"==location.protocol&&(t="wss"),`${t}://${location.host}/gameServer`}async prepareJoinGame(){let t=null;const e=parseSearch();if(this.nextCloseIsIntentional=!1,e.ip&&!this.squadManager.isInSquad)t=e.ip;else if(this.shouldUseMatchMaking)try{await this.matchMaking.updateQueueState()}catch(t){return void this.fireConnectionClosed()}else{let e="ws";"https:"==location.protocol&&(e="wss");let i=window.location.host;getMainInstance().poki.isPokiBuild&&(i=getMainInstance().env+".narrow.one");t=e+"://"+i+"/"+("local"==getMainInstance().env?"gameServer":"ws")}t&&(this.joiningLoadingText&&this.joiningLoadingText.setIsLoading(!0),this.connect(t))}static get MinusOne(){return new Uint32Array([-1])[0]}static get ReceiveAction(){return{JOINED_GAME_ID:0,CREATE_PLAYER:1,DESTROY_PLAYER:2,PLAYER_OWNERSHIP:3,PLAYER_DATA:4,CREATE_ARROW:5,CHANGE_FLAG:6,SCOREBOARD:7,FLAG_POSITION:8,PING:9,PLAYER_PING_DATA:10,GAME_END:11,CLAIM_HIT_BY_ARROW:12,DISCONNECT_REASON:13,GAME_MAP_HASH:14,PLAYER_PERFORM_ACTION:15,PLAYER_NAME:16,PLAYER_SCORES:17,CHANGE_SELECTED_CLASS:18,GAME_START:19,SET_AUTOSHOOT_VALUE:20,EQUIPPED_SKIN_DATA:21,OFFSET_PLAYER_SCORE:22,GAME_END_ACCOUNT_STATS:23,GUEST_DATA_CHANGED:24,PLAYER_TEAM_ID:25,SAME_SQUAD_PLAYERS:26,SQUAD_ID_RESPONSE:27,SQUAD_JOIN_ERROR_RESPONSE:28,REQUEST_MAP_HASH:29,GAME_TIME:30,PLAYER_NAME_VERIFIED:31,GAME_SEED:32,SET_PLAYER_HEALTH:33,CHAT_MESSAGE:34,SPAWN:35,SAME_SQUAD_PLAYER_DATA:36,ACTIVE_WEAPON_TYPE:37,HIT_VALIDATION_DATA:38,MELEE_HIT_PLAYER:39,AVG_TEAM_ELO:40,ARROW_HIT_PLAYER:41,PLAYER_KILL_PLAYER:42}}static get SendAction(){return{MY_CLIENT_VERSION:0,REQUEST_JOIN_GAME_ID:1,PLAYER_DATA:2,CREATE_ARROW:3,CHANGE_FLAG:4,PONG:5,CURRENT_LOADED_MAP_HASH:6,CLAIM_HIT_BY_ARROW:7,REQUEST_MAP_HASH:8,PLAYER_PERFORM_ACTION:9,CHANGE_SELECTED_CLASS:10,MY_SKILL_LEVEL:11,REQUEST_NEXT_GAME_STATE:12,SET_AUTOSHOOT_VALUE:13,EQUIPPED_SKIN_DATA:14,FLAG_RETURN_PROGRESS:15,ACCOUNT_SESSION_DATA:16,SQUAD_ID:17,REQUEST_SQUAD_ID:18,MAP_BOUNDS:19,DEFAULT_FLAG_POSITIONS:20,REPORT_CHEATER:21,VALID_ARROW_HIT:22,CHAT_MESSAGE:23,SPAWN:24,SQUAD_DATA:25,ACTIVE_WEAPON_TYPE:26,MELEE_HIT_PLAYER:27}}static get FlagChangeOperation(){return{GRAB:0,CAPTURE:1,DROP:2,RETURN:3}}static get DisconnectReason(){return{UNKNOWN:0,VERSION_OUT_OF_DATE:1,AFK:2,GAME_DOESNT_EXIST:3,PING_TOO_HIGH:4,SUSPECTED_CHEATER:5,TEMPORARILY_BANNED:6}}static get PlayerScoreOffsetReason(){return{UNKNOWN:0,KILL:1,ASSIST:2,FLAG_CARRIER_KILL:3,FLAG_GRAB:4,FLAG_CARRY:5,FLAG_CAPTURE:6,FLAG_CARRY_ASSIST:7,WIN_BONUS:8,FLAG_RETURN:9,HEADSHOT:10,LONG_RANGE:11,FLAG_CAPTURE_ASSIST:12}}closeCurrentConnection(t=!0,e=!0){this.ws&&this.ws.readyState==WebSocket.OPEN&&(t&&this.markNextCloseAsIntentional(),this.ws.close()),this.ws=null,e&&(t&&this.markNextCloseAsIntentional(),this.fireConnectionClosed())}async connect(t){this.onBeforeConnectGameServerCbs.forEach((t=>t())),this.closeCurrentConnection(!0,!1);try{this.ws=new WebSocket(t)}catch(t){console.error("failed to connect to websocket",t),this.fireConnectionClosed()}if(this.ws){const t=this.ws;this.ws.binaryType="arraybuffer",this.ws.addEventListener("message",(e=>{this.ws==t&&this.onMessage(new Uint8Array(e.data))})),this.ws.addEventListener("close",(e=>{this.ws==t&&this.fireConnectionClosed()})),this.ws.addEventListener("open",(e=>{this.ws==t&&this.onOpen()})),this.ws.addEventListener("error",(e=>{console.error("websocket error: ",e),this.ws==t&&this.fireConnectionClosed()}))}}onMessage(t){const e=t.buffer,i=new Float32Array(e,0,Math.floor(e.byteLength/4)),s=new Uint32Array(e,0,Math.floor(e.byteLength/4)),n=new Int32Array(e,0,Math.floor(e.byteLength/4)),a=new Uint16Array(e,0,Math.floor(e.byteLength/2));if(this.lastReceiveMessageTime=performance.now(),s[0]==NetworkManager.ReceiveAction.JOINED_GAME_ID)getMainInstance().gameManager.joinedGameId(s[1]);else if(s[0]==NetworkManager.ReceiveAction.CREATE_PLAYER){const t=s[1],e=s[2],i=getMainInstance().gameManager.getOnlineGame();i&&i.createPlayer(t,{teamId:e})}else if(s[0]==NetworkManager.ReceiveAction.DESTROY_PLAYER){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;let e=1;for(;e<s.length;)t.destroyPlayer(s[e++])}else if(s[0]==NetworkManager.ReceiveAction.PLAYER_OWNERSHIP){const t=s[1],e=!!s[2],i=getMainInstance().gameManager.getOnlineGame();i&&i.setPlayerOwnership(t,e),e&&this.joiningLoadingText&&this.joiningLoadingText.setIsLoading(!1)}else if(s[0]==NetworkManager.ReceiveAction.PLAYER_DATA){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;const i=1==a[2];let s=6;const n=12;for(;s<=e.byteLength-n;){const a=new Uint8Array(e,s,n),o=new Uint8Array(n);o.set(a);const r=new Uint16Array(o.buffer);s+=n;const l=r[0],[h,d,c]=this.mapNetworkPosToWorldPos(t,r[1],r[2],r[3]),u=unnormalizeU8(r[4],2*Math.PI),p=unnormalizeS8(r[5],.5*Math.PI);t.setPlayerServerData(l,h,d,c,u,p,i)}t.playerServerDataFrameEnded()}else if(s[0]==NetworkManager.ReceiveAction.CREATE_ARROW){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;const e=a[2],i=a[3],[s,n,o]=this.mapNetworkPosToWorldPos(t,a[4],a[5],a[6]),r=unnormalizeS16(a[7],-1,1),l=unnormalizeS16(a[8],-1,1),h=unnormalizeS16(a[9],-1,1),d=unnormalizeU16(a[10]);t.createServerArrow(e,i,s,n,o,r,l,h,d)}else if(s[0]==NetworkManager.ReceiveAction.CHANGE_FLAG){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;const e=s[1],i=s[2],n=s[3];t.playerChangeFlag(e,i,n)}else if(s[0]==NetworkManager.ReceiveAction.SCOREBOARD){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;const e=[];for(let t=1;t<s.length;t++)e.push(s[t]);t.updateScoreboard(e)}else if(s[0]==NetworkManager.ReceiveAction.FLAG_POSITION){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;const e=a[2],[i,s,n]=this.mapNetworkPosToWorldPos(t,a[3],a[4],a[5]),[o,r,l]=this.mapNetworkVelocityToWorldVelocity(a[6],a[7],a[8]);t.setFlagDroppedPosition(e,i,s,n,o,r,l)}else if(s[0]==NetworkManager.ReceiveAction.PING)this.send([NetworkManager.SendAction.PONG]);else if(s[0]==NetworkManager.ReceiveAction.PLAYER_PING_DATA){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;let i=4;const s=4;for(;i<=e.byteLength-s;){const n=new Uint8Array(e,i,s),a=new Uint8Array(s);a.set(n);const o=new Uint16Array(a.buffer);i+=s;const r=o[0],l=o[1];t.setPlayerPingData(r,l)}}else if(s[0]==NetworkManager.ReceiveAction.GAME_END){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;t.notifyGameEnded()}else if(s[0]==NetworkManager.ReceiveAction.CLAIM_HIT_BY_ARROW){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;const e=s[1],i=s[2],n=s[3],a=s[4];t.playerClaimedHitByArrow(e,i,n,a)}else if(s[0]==NetworkManager.ReceiveAction.MELEE_HIT_PLAYER){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;const e=s[1],i=s[2];t.playerHitByMelee(e,i)}else if(s[0]==NetworkManager.ReceiveAction.ARROW_HIT_PLAYER){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;const e=s[1],i=s[2];t.playerHitByArrow(e,i)}else if(s[0]==NetworkManager.ReceiveAction.SET_PLAYER_HEALTH){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;const e=s[1],i=unnormalizeU32(s[2]);t.forceSetPlayerHealthFromServer(e,i)}else if(s[0]==NetworkManager.ReceiveAction.PLAYER_KILL_PLAYER){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;const e=s[1],i=s[2];t.verifiedKillByServer(e,i)}else if(s[0]==NetworkManager.ReceiveAction.DISCONNECT_REASON){const[,t,...e]=s;switch(this.lastDisconnectReasonExtra=e,t){case NetworkManager.DisconnectReason.VERSION_OUT_OF_DATE:this.lastDisconnectReason="version-out-of-date";break;case NetworkManager.DisconnectReason.AFK:this.lastDisconnectReason="afk";break;case NetworkManager.DisconnectReason.GAME_DOESNT_EXIST:this.lastDisconnectReason="game-doesnt-exist";break;case NetworkManager.DisconnectReason.PING_TOO_HIGH:this.lastDisconnectReason="ping-too-high";break;case NetworkManager.DisconnectReason.SUSPECTED_CHEATER:this.lastDisconnectReason="suspected-cheater";break;case NetworkManager.DisconnectReason.TEMPORARILY_BANNED:this.lastDisconnectReason="temporarily-banned";break;case NetworkManager.DisconnectReason.UNKNOWN:default:this.lastDisconnectReason="unknown"}}else if(s[0]==NetworkManager.ReceiveAction.GAME_MAP_HASH){const t=parseStringMessage(e);if(!t)return;const i=getMainInstance(),s=i.gameManager.getOnlineGame();s&&(s.loadMap(t),i.preferredMapManager.markRecentMap(t))}else if(s[0]==NetworkManager.ReceiveAction.PLAYER_PERFORM_ACTION){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;const e=s[1],i=s[2];t.receivedPlayerPerformAction(e,i)}else if(s[0]==NetworkManager.ReceiveAction.SPAWN){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;const e=s[1],i=s[2];t.receivedPlayerSpawn(e,i)}else if(s[0]==NetworkManager.ReceiveAction.PLAYER_NAME){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;const i=s[1],n=parseStringMessage(e,8)||"";t.setPlayerName(i,n)}else if(s[0]==NetworkManager.ReceiveAction.PLAYER_SCORES){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;const e=s[1],n=s[2],a=s[3],o=s[4],r=s[5],l=i[6],h=i[7];t.setPlayerScores({playerId:e,flags:n,kills:a,deaths:o,total:r,skillLevel:l,elo:h})}else if(s[0]==NetworkManager.ReceiveAction.CHANGE_SELECTED_CLASS){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;const e=s[1],i=s[2];t.receivePlayerChangeClass(e,i)}else if(s[0]==NetworkManager.ReceiveAction.ACTIVE_WEAPON_TYPE){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;const e=s[1],i=1==s[2];t.receivePlayerChangeWeaponType(e,i)}else if(s[0]==NetworkManager.ReceiveAction.GAME_START){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;t.notifyGameStarted()}else if(s[0]==NetworkManager.ReceiveAction.EQUIPPED_SKIN_DATA){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;const i=s[1],n=parseSkinDataString(parseStringMessage(e,8)||"");t.setPlayerEquippedSkinData(i,n)}else if(s[0]==NetworkManager.ReceiveAction.OFFSET_PLAYER_SCORE){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;const e=s[1],i=n[2],a=s[3];t.offsetPlayerScore(e,i,a)}else if(s[0]==NetworkManager.ReceiveAction.GAME_END_ACCOUNT_STATS){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;const e=s[1],i=s[2];t.receivedGameEndAccountStats({receivedCoins:e,newCoinCount:i})}else if(s[0]==NetworkManager.ReceiveAction.GUEST_DATA_CHANGED){const t=parseStringMessage(e);t&&getMainInstance().auth.setGuestAccountData(t,!1)}else if(s[0]==NetworkManager.ReceiveAction.PLAYER_TEAM_ID){const t=s[1],e=s[2],i=getMainInstance().gameManager.getOnlineGame();if(!i)return;i.setPlayerTeamId(t,e)}else if(s[0]==NetworkManager.ReceiveAction.SAME_SQUAD_PLAYERS){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;const e=[];for(let t=1;t<s.length;t++)e.push({playerId:s[t],squadPlayerId:0,isLeader:!1});t.setSameSquadPlayerData(e)}else if(s[0]==NetworkManager.ReceiveAction.SAME_SQUAD_PLAYER_DATA){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;const i=parseJsonMessage(e);t.setSameSquadPlayerData(i.playerDatas)}else if(s[0]==NetworkManager.ReceiveAction.SQUAD_ID_RESPONSE){const t=parseStringMessage(e);t&&this.squadManager.squadIdReceivedFromGameServer(t)}else if(s[0]==NetworkManager.ReceiveAction.SQUAD_JOIN_ERROR_RESPONSE){const t=parseStringMessage(e);this.onSquadJoinErrorCbs.forEach((e=>e(t)))}else if(s[0]==NetworkManager.ReceiveAction.REQUEST_MAP_HASH){const t=getMainInstance(),e=t.preferredMapManager.forcingSoloMap||t.preferredMapManager.getRandomPreferredMapHash();e&&this.sendRequestMapHash(e)}else if(s[0]==NetworkManager.ReceiveAction.GAME_TIME){const t=s[1],e=getMainInstance().gameManager.getOnlineGame();if(!e)return;e.setServerGameTime(t)}else if(s[0]==NetworkManager.ReceiveAction.GAME_SEED){const t=s[1],e=getMainInstance().gameManager.getOnlineGame();if(!e)return;e.setServerGameSeed(t)}else if(s[0]==NetworkManager.ReceiveAction.PLAYER_NAME_VERIFIED){const t=s[1],e=getMainInstance().gameManager.getOnlineGame();if(!e)return;e.setPlayerNameVerified(t)}else if(s[0]==NetworkManager.ReceiveAction.CHAT_MESSAGE){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;const i=parseStringMessage(e);if(i){const e=JSON.parse(i);t.chat.receivedChatMessage(e)}}else if(s[0]==NetworkManager.ReceiveAction.HIT_VALIDATION_DATA){const t=parseJsonMessage(e),i=getMainInstance().gameManager.getOnlineGame();if(!i)return;i.arrowManager.receivedHitValidationData(t)}else if(s[0]==NetworkManager.ReceiveAction.AVG_TEAM_ELO){const t=getMainInstance().gameManager.getOnlineGame();if(!t)return;const e=i[1],s=i[2];t.updateAvgTeamElo(e,s)}}markNextCloseAsIntentional(){this.nextCloseIsIntentional=!0}fireConnectionClosed(){this.ws=null,this.joiningLoadingText&&this.joiningLoadingText.setIsLoading(!1),getMainInstance().gameManager.connectionClosed(),this.onConnectionClosedCbs.forEach((t=>t(this.nextCloseIsIntentional,this.lastDisconnectReason)));if(!this.nextCloseIsIntentional){getMainInstance().mainMenu.setJoinState("joinable");let t,e=null;switch(this.lastDisconnectReason){case"version-out-of-date":e="Your version is out of date, update your client in order to play online.",getUpdateReady()&&(t=[{text:"Update now",onClick:()=>{skipWaiting()}}]);break;case"afk":e="You have been kicked for being afk for too long";break;case"game-doesnt-exist":e="Game not found.";break;case"ping-too-high":e="Your ping is too high, please try again later.";break;case"suspected-cheater":e=`Cheats detected. (code ${this.lastDisconnectReasonExtra[0]||0})`;break;case"temporarily-banned":e="You have been temporarily banned, please try again later.";break;default:e="The connection closed abruptly :("}e&&getMainInstance().dialogManager.showAlert({title:"Connection closed",text:e,buttons:t})}}onOpen(){this.lastDisconnectReason="unknown",this.lastSentSkinData="",this.nextCloseIsIntentional=!1;const t=parseSearch();t.gameId?this.sendJoinGameId(Number(t.gameId)):(this.sendJoinGameId(this.nextJoinGameId,this.nextJoinRequestId),this.nextJoinGameId=-1),this.sendCurrentVersion(),this.sendCurrentSession(),this.sendMySkillLevel(),this.connectionOpenedAndDataSent=!0,this.onConnectionOpenCbs.forEach((t=>t())),this.onNextConnectionOpenCbs.forEach((t=>t())),this.onNextConnectionOpenCbs.clear()}async waitForConnectionOpen(){if(!this.connectionOpenedAndDataSent)return await new Promise((t=>this.onConnectionOpenCbs.add((()=>t(void 0)))))}onConnectionOpen(t){this.onConnectionOpenCbs.add(t)}onNextConnectionOpen(t){this.onNextConnectionOpenCbs.add(t)}onConnectionClosed(t){this.onConnectionClosedCbs.add(t)}onSquadJoinError(t){this.onSquadJoinErrorCbs.add(t)}onBeforeConnectGameServer(t){this.onBeforeConnectGameServerCbs.add(t)}get hasGameServerConnection(){return this.ws&&this.ws.readyState==WebSocket.OPEN}send(t){if(this.ws&&this.hasGameServerConnection){t instanceof Array&&(t=new Uint32Array(t));try{return this.ws.send(t),!0}catch(e){throw console.log("error sending message",t),e}}}sendStringMessage(t,e){const i=createStringMessage(t,e);this.send(i)}sendJsonMessage(t,e){const i=JSON.stringify(e);this.sendStringMessage(t,i)}sendCurrentVersion(){this.sendStringMessage(NetworkManager.SendAction.MY_CLIENT_VERSION,"1685095066")}sendMySkillLevel(){const t=new ArrayBuffer(12),e=new Uint32Array(t),i=new Float32Array(t);e[0]=NetworkManager.SendAction.MY_SKILL_LEVEL,i[1]=this.matchMaking.getMappedSmoothSkillLevel(),i[2]=this.matchMaking.elo,this.send(t)}sendMySkinData(t){const e=JSON.stringify(t);e!=this.lastSentSkinData&&(this.lastSentSkinData=e,this.sendStringMessage(NetworkManager.SendAction.EQUIPPED_SKIN_DATA,e))}sendJoinGameId(t,e=null){let i=8;e&&(i+=16);const s=new ArrayBuffer(i),n=new Uint32Array(s);if(n[0]=NetworkManager.SendAction.REQUEST_JOIN_GAME_ID,n[1]=t,e){const t=uuidToBinary(e);new Uint8Array(s).set(new Uint8Array(t),8)}this.send(s)}sendPlayerData(t,e,{posX:i=0,posY:s=0,posZ:n=0,rotX:a=0,rotY:o=0}={}){if(t!=getMainInstance().gameManager.getOnlineGame())return;const r=new ArrayBuffer(16),l=new Uint32Array(r,0,1),h=new Uint16Array(r,0);l[0]=NetworkManager.SendAction.PLAYER_DATA,h[2]=e;const[d,c,u]=this.mapWorldPosToNetworkPos(t,i,s,n);h[3]=d,h[4]=c,h[5]=u;const p=2*Math.PI;h[6]=normalizeU8(mod(a,p),p),h[7]=normalizeS8(o,.5*Math.PI),this.send(r)}getWorldBounds(t){let e=0,i=0,s=0,n=0,a=0,o=0;if(t){const r=t.physics.mapBounds;r&&(e=r.min.x-5,i=r.min.y-5,s=r.min.z-5,n=r.max.x+5,a=r.max.y+5,o=r.max.z+5)}return{minX:e,minY:i,minZ:s,maxX:n,maxY:a,maxZ:o}}*getDefaultFlagNetworkPositions(t){for(const e of t.flags)yield this.mapWorldPosToNetworkPos(t,e.position.x,e.position.y,e.position.z)}mapWorldPosToNetworkPos(t,e,i,s){const n=this.getWorldBounds(t);return[normalizeS16(e,n.minX,n.maxX),normalizeS16(i,n.minY,n.maxY),normalizeS16(s,n.minZ,n.maxZ)]}mapNetworkPosToWorldPos(t,e,i,s){const n=this.getWorldBounds(t);return[unnormalizeS16(e,n.minX,n.maxX),unnormalizeS16(i,n.minY,n.maxY),unnormalizeS16(s,n.minZ,n.maxZ)]}mapNetworkVelocityToWorldVelocity(t,e,i){return[unnormalizeS16(t,-30,30),unnormalizeS16(e,-30,30),unnormalizeS16(i,-30,30)]}sendCreateArrow(t,e,{arrowId:i,pos:s,dir:n,fireAmount01:a}){const o=new ArrayBuffer(22),r=new Uint32Array(o,0,4),l=new Uint16Array(o,0);r[0]=NetworkManager.SendAction.CREATE_ARROW,l[2]=e,l[3]=i;const[h,d,c]=this.mapWorldPosToNetworkPos(t,s.x,s.y,s.z);l[4]=h,l[5]=d,l[6]=c;const[u,p,g]=this.mapNetworkPosToWorldPos(t,h,d,c),m=normalizeS16(n.x,-1,1),f=normalizeS16(n.y,-1,1),w=normalizeS16(n.z,-1,1);l[7]=m,l[8]=f,l[9]=w;const b=unnormalizeS16(m,-1,1),y=unnormalizeS16(f,-1,1),S=unnormalizeS16(w,-1,1),C=normalizeU16(a);l[10]=C;const v=unnormalizeU16(C);this.send(o);return{arrowId:i,pos:new Vector3(u,p,g),dir:new Vector3(b,y,S),fireAmount01:v,networkOffsetPos:new Vector3(0,0,0)}}sendChangeFlag(t,e,i){this.send([NetworkManager.SendAction.CHANGE_FLAG,t,e,i])}sendCurrentLoadedMapHash(t){this.sendStringMessage(NetworkManager.SendAction.CURRENT_LOADED_MAP_HASH,t)}sendWorldBounds(t){const e=new ArrayBuffer(28);new Uint32Array(e,0,1)[0]=NetworkManager.SendAction.MAP_BOUNDS;const i=new Float32Array(e,0),s=this.getWorldBounds(t);i[1]=s.minX,i[2]=s.minY,i[3]=s.minZ,i[4]=s.maxX,i[5]=s.maxY,i[6]=s.maxZ,this.send(e)}sendDefaultFlagPositions(t){const e=Array.from(this.getDefaultFlagNetworkPositions(t)),i=new ArrayBuffer(4+3*e.length*2);new Uint32Array(i,0,1)[0]=NetworkManager.SendAction.DEFAULT_FLAG_POSITIONS;const s=new Uint16Array(i,4);for(const[t,i]of e.entries())s[3*t+0]=i[0],s[3*t+1]=i[1],s[3*t+2]=i[2];this.send(i)}sendReportCheater(t,e,i){i=normalizeU16(i),this.send([NetworkManager.SendAction.REPORT_CHEATER,t,e,i])}sendHitByArrow(t,e,i,s,n){this.send([NetworkManager.SendAction.CLAIM_HIT_BY_ARROW,t,e,i,s,n])}sendValidArrowHit(t,e,i){const s=normalizeU32(i);this.send([NetworkManager.SendAction.VALID_ARROW_HIT,t,e,s])}sendChatMessage(t){this.sendStringMessage(NetworkManager.SendAction.CHAT_MESSAGE,t)}sendRequestMapHash(t){this.sendStringMessage(NetworkManager.SendAction.REQUEST_MAP_HASH,t)}sendRequestNextGameState(){this.send([NetworkManager.SendAction.REQUEST_NEXT_GAME_STATE])}sendPlayerPerformAction(t,e){this.send([NetworkManager.SendAction.PLAYER_PERFORM_ACTION,t,e])}sendPlayerSpawn(t,e){this.send([NetworkManager.SendAction.SPAWN,t,e])}sendChangeSelectedClass(t,e){this.send([NetworkManager.SendAction.CHANGE_SELECTED_CLASS,t,e])}sendChangeActiveWeaponType(t,e){const i=e?1:0;this.send([NetworkManager.SendAction.ACTIVE_WEAPON_TYPE,t,i])}sendMeleeHitPlayer(t,e,i){this.send([NetworkManager.SendAction.MELEE_HIT_PLAYER,t,e,i])}sendFlagReturnProgress(t,e){const i=normalizeU32(e);this.send([NetworkManager.SendAction.FLAG_RETURN_PROGRESS,t,i])}async sendCurrentSession(){const t=await getMainInstance().auth.getSessionDataForGameServer();this.sendSession(t)}sendSession(t){const e=JSON.stringify(t);this.sendStringMessage(NetworkManager.SendAction.ACCOUNT_SESSION_DATA,e)}sendSquadData(t,e,i){const s={squadId:t,playerId:e,leaderToken:i};this.sendStringMessage(NetworkManager.SendAction.SQUAD_DATA,JSON.stringify(s))}sendRequestSquadId(){this.send([NetworkManager.SendAction.REQUEST_SQUAD_ID])}}class PlayerSphereCollider{constructor(t,e,i,s,n){this.rigidBody=t,this.radius=e,this.heightOffset=i,this.bodyPart=s,this.arrowDamage=n}get center(){const t=this.rigidBody.pos.clone();return t.y+=this.heightOffset,t}rayCast(t,e){const i=t.x,s=t.y,n=t.z,a=e.x,o=e.y,r=e.z,l=this.center,h=l.x,d=l.y,c=l.z,u=2*(i*a+s*o+n*r-a*h-o*d-r*c),p=u*u-4*(i*i-2*i*h+h*h+s*s-2*s*d+d*d+n*n-2*n*c+c*c-this.radius*this.radius);if(p<0)return null;const g=(-u-Math.sqrt(p))/2;if(g<0)return null;const m=t.clone().addScaledVector(e,g);return{dist:m.distanceTo(t),pos:m,collider:this}}}class MapCollider{constructor(t,{ignoreArrows:e=!1,isLadder:i=!1,isLadderAllSides:s=!1,excludeTeamId:n=-1,isDeathTrigger:a=!1,shootSfx:o="",allowJump:r=!0,allowWalk:l=!0,movePlayerUp:h=!0,slippery:d=!1,slowDownPlayerAmount:c=0,airFrictionModifier:u=0,touchDamageAmount:p=0,touchDamageDistance:g=1.5,triggerHingeId:m=-1,triggerAppearingObjectId:f=-1}){this.invWorldMatrix=t.clone().invert(),this.invWorldMatrixNoTranslate=this.invWorldMatrix.clone().setPosition(0,0,0),this.worldMatrix=t,this.aabb=null,this.ignoreArrows=e,this.isLadder=i,this.isLadderAllSides=s,this.isDeathTrigger=a,this.shootSfx=o,this.allowJump=r,this.allowWalk=l,this.movePlayerUp=h,this.slippery=d,this.slowDownPlayerAmount=c,this.airFrictionModifier=u,this.touchDamageAmount=p,this.touchDamageDistance=g,this.triggerHingeId=m,this.triggerAppearingObjectId=f,this.excludeTeamId=n}rayCast(t,e){throw new Error("base class")}getSphereManifold(t,e){throw new Error("base class")}isTriggerCollider(){return this.slowDownPlayerAmount>0||this.airFrictionModifier>0}}const BoxFace={up:1,down:2,left:3,right:4,front:5,back:6};class BoxMapCollider extends MapCollider{constructor(...t){super(...t),this.box=new Box3(new Vector3(-1,-1,-1),new Vector3(1,1,1)),this.aabb=this.box.clone(),this.aabb.applyMatrix4(this.worldMatrix),this.cachedUpFaces=null}getSphereManifold(t,e){const i=t.clone().applyMatrix4(this.invWorldMatrix),s=this.box.clampPoint(i,new Vector3);let n=0;(s.x<=-1||s.x>=1)&&n++,(s.y<=-1||s.y>=1)&&n++,(s.z<=-1||s.z>=1)&&n++;const a=n>=2,o=this.getUpFaces(),r=this.getIsOnFace(s,o[0]),l=this.getIsOnFace(s,o[1]);s.applyMatrix4(this.worldMatrix);const h=e-t.distanceTo(s);return{colliderType:"box",pos:s,isAtEdge:a,isAtUpFace:r,isAtSecondUpFace:l,normal:t.clone().sub(s).normalize(),penetration:h}}getUpFaces(){if(this.cachedUpFaces)return this.cachedUpFaces;const t=new Vector3,e=new Vector3(1,0,0),i=new Vector3(0,1,0),s=new Vector3(0,0,1);t.applyMatrix4(this.worldMatrix),e.applyMatrix4(this.worldMatrix),i.applyMatrix4(this.worldMatrix),s.applyMatrix4(this.worldMatrix),e.sub(t),i.sub(t),s.sub(t),e.normalize(),i.normalize(),s.normalize();const n=e.clone().negate(),a=i.clone().negate(),o=s.clone().negate(),r=new Vector3(0,1,0),l=[{face:BoxFace.up,normal:i,dot:0},{face:BoxFace.down,normal:a,dot:0},{face:BoxFace.left,normal:e,dot:0},{face:BoxFace.right,normal:n,dot:0},{face:BoxFace.front,normal:s,dot:0},{face:BoxFace.back,normal:o,dot:0}];for(const t of l)t.dot=t.normal.dot(r);return l.sort(((t,e)=>e.dot-t.dot)),this.cachedUpFaces=l,this.cachedUpFaces}getIsOnFace(t,e){switch(e.face){case BoxFace.up:return t.y>=1;case BoxFace.down:return t.y<=-1;case BoxFace.left:return t.x>=1;case BoxFace.right:return t.x<=-1;case BoxFace.front:return t.z>=1;case BoxFace.back:return t.z<=-1}return!1}rayCast(t,e){const i=t;t=t.clone().applyMatrix4(this.invWorldMatrix),e=e.clone().applyMatrix4(this.invWorldMatrixNoTranslate);const s=(this.box.min.x-t.x)/e.x,n=(this.box.max.x-t.x)/e.x,a=(this.box.min.y-t.y)/e.y,o=(this.box.max.y-t.y)/e.y,r=(this.box.min.z-t.z)/e.z,l=(this.box.max.z-t.z)/e.z,h=Math.min(Math.max(s,n),Math.max(a,o),Math.max(r,l));if(h<0)return null;const d=Math.max(Math.min(s,n),Math.min(a,o),Math.min(r,l));if(d<h){const s=t.clone().addScaledVector(e,d);s.applyMatrix4(this.worldMatrix);return{dist:s.distanceTo(i),pos:s,collider:this}}return null}}class RigidBody{constructor(){this.enabled=!0}beginPhysicsSteps(){}stepVelocity(t){}resolveMapCollisionsOctree(t){}endPhysicsSteps(){}}const MIN_UPDOT_FOR_ISONFLOOR=.3;class PlayerRigidBody extends RigidBody{constructor(t,e){super(),this.physicsManager=t,this.player=e,this.pos=new Vector3,this.velocity=new Vector3,this.totalForce=new Vector3,this.colliders=[new PlayerSphereCollider(this,.4,.4,"feet",1/3),new PlayerSphereCollider(this,.5,1.1,"body",.5),new PlayerSphereCollider(this,.3,1.7,"head",1)],this.aabb=new Box3;for(const t of this.colliders){const e=t.radius,i=new Box3(new Vector3(-e,-e,-e),new Vector3(e,e,e));i.translate(t.center),this.aabb.union(i)}this.gravity=new Vector3(0,-20,0),this.prevLastFloorTouchTime=0,this.lastLandTime=0,this.lastFloorTouchTime=0,this.lastJumpableColliderTouchTime=0,this.isOnFloor=!1,this.isOnJumpableCollider=!1,this.isOnUnwalkableCollider=!1,this.lastJumpTime=0,this.inAirAfterJump=!1,this.climbingLadder=null,this.climbingLadderNormal=null,this.isTouchingDamageCollider=!1,this.lastTouchDamageColliderPosition=null,this.lastTouchDamageColliderTime=-1/0,this.wasOnFloorLastFrame=!1,this.isOnSlipperyCollider=!1,this.slowDownColliderAmount=0,this.airFrictionModifier=0}beginPhysicsSteps(){this.wasOnFloorLastFrame=this.isOnFloor,this.isOnFloor=!1,this.isOnSlipperyCollider=!1,this.isOnJumpableCollider=!1,this.isOnUnwalkableCollider=!1}stepVelocity(t){this.climbingLadder||this.velocity.addScaledVector(this.gravity,t),this.velocity.addScaledVector(this.totalForce,t);let e=.9995,i=e;this.isOnSlipperyCollider?(e=.2,i=.2):this.climbingLadder?(e=.9999,i=.9999):this.wasOnFloorLastFrame||(i=.2,e=.9),e=Math.max(e,this.airFrictionModifier),i=Math.max(i,this.airFrictionModifier);const s=Math.pow(1-e,t),n=Math.pow(1-i,t);this.velocity.x*=s,this.velocity.y*=n,this.velocity.z*=s,this.pos.addScaledVector(this.velocity,t)}updateLastFloorTouchTime(){this.lastFloorTouchTime=getMainInstance().now}endPhysicsSteps(){this.isOnFloor&&!this.wasOnFloorLastFrame&&(this.prevLastFloorTouchTime=this.lastFloorTouchTime,this.lastLandTime=getMainInstance().now),(this.isOnFloor||this.climbingLadder)&&(this.updateLastFloorTouchTime(),this.inAirAfterJump=!1),this.isOnJumpableCollider&&(this.lastJumpableColliderTouchTime=getMainInstance().now),this.totalForce.set(0,0,0)}get inAirTime(){return this.isOnFloor||this.climbingLadder?0:getMainInstance().now-this.lastFloorTouchTime}get prevInAirTime(){return this.isOnFloor||this.climbingLadder?this.lastLandTime-this.prevLastFloorTouchTime:this.inAirTime}get onFloorTime(){return this.isOnFloor?getMainInstance().now-this.lastLandTime:0}get onJumpableColliderTime(){return this.isOnJumpableCollider||this.climbingLadder?0:getMainInstance().now-this.lastJumpableColliderTouchTime}getCurrentPlayerAabb(){const t=this.aabb.clone();return t.translate(this.pos),t}getIntersectingOctreeNodes(){const t=this.getCurrentPlayerAabb();return this.physicsManager.getOctreeNodesInAabb(t)}getPlayerManifolds(t){const e=this.getCurrentPlayerAabb();return this.getManifoldsHelper(e,this.colliders,t)}getManifoldsHelper(t,e,i){const s=[];for(const n of this.physicsManager.getCollidersForAabbUsingOctree(t))if(n.aabb&&n.aabb.intersectsBox(t)&&n.excludeTeamId!=this.player.teamId&&(i||!n.isTriggerCollider()))for(const t of e){const e=n.getSphereManifold(t.center,t.radius);e.penetration>0&&s.push({manifold:e,mapCollider:n,playerCollider:t})}return s}isAboveJumpableCollider(){let t=null;for(const e of this.colliders)if("feet"==e.bodyPart){t=e;break}if(!t)return!1;const e=[],i=t.center;for(let s=0;s<5;s++){const n=i.clone();n.y-=.1*s,e.push({center:n,radius:t.radius})}const s=new Box3;s.expandByPoint(e[0].center),s.expandByPoint(e[e.length-1].center),s.expandByScalar(t.radius);const n=this.getManifoldsHelper(s,e,!1);for(const{manifold:t}of n){const e=t.normal.dot(new Vector3(0,1,0));if(e>.3||this.manifoldShouldMovePlayerUp(t,e))return!0}return!1}manifoldShouldMovePlayerUp(t,e){return"box"==t.colliderType&&t.isAtEdge&&t.isAtUpFace&&e>.1}resolveMapCollisionsOctree(t){const e=this.getPlayerManifolds(!1);this.slowDownColliderAmount=0,this.airFrictionModifier=0;let i=0,s=0,n=1/0;for(const{manifold:t,mapCollider:a,playerCollider:o}of e){const e=t.normal.dot(new Vector3(0,1,0));if(a.isDeathTrigger)continue;if(!a.movePlayerUp)continue;if(this.needsLadderPhysics(t,a))continue;let r=!1;if("feet"==o.bodyPart&&(e>.6||this.manifoldShouldMovePlayerUp(t,e))&&(r=!0),r&&t.penetration>0){const e=t.normal.clone();e.setLength(t.penetration+1e-7);const o=t.normal.clone().cross(new Vector3(0,1,0));if(o.lengthSq()>0){const i=o.clone().cross(t.normal);let s=0;0!=i.x?s=Math.abs(e.x/i.x):0!=i.z&&(s=Math.abs(e.z/i.z)),i.multiplyScalar(s),e.add(i)}e.y>0&&e.y<1&&(i=Math.max(e.y,i),this.isOnFloor=!0,s=Math.max(s,a.touchDamageAmount),n=Math.min(n,a.touchDamageDistance),a.allowJump&&(this.isOnJumpableCollider=!0),a.allowWalk||(this.isOnUnwalkableCollider=!0),a.slippery&&(this.isOnSlipperyCollider=!0))}}let a=e;const o=this.pos.clone();i>0&&(this.pos.y+=i);const r=new Map;for(const{manifold:t,mapCollider:i}of e){let e=r.get(i)||0;e=Math.max(e,t.penetration),r.set(i,e)}let l=!1;const h=this.getPlayerManifolds(!0);for(const{manifold:t,mapCollider:e}of h)if(!e.isTriggerCollider()){if(!r.has(e)){l=!0;break}{const i=r.get(e);if(null!=i&&t.penetration>i){l=!0;break}}}l?this.pos.copy(o):a=h;let d=null;for(const{manifold:t,mapCollider:e,playerCollider:i}of a){const a=this.needsLadderPhysics(t,e);if(s=Math.max(s,e.touchDamageAmount),n=Math.min(n,e.touchDamageDistance),e.slowDownPlayerAmount>0){const i=mapValue(0,.5,0,e.slowDownPlayerAmount,t.penetration,!0);this.slowDownColliderAmount=Math.max(this.slowDownColliderAmount,i);continue}if(e.airFrictionModifier>0){this.airFrictionModifier=Math.max(this.airFrictionModifier,e.airFrictionModifier);continue}const o=this.velocity.dot(t.normal);if(o<0){const s=t.normal.dot(new Vector3(0,1,0));e.isDeathTrigger?this.player.dieFromFall():a&&(e.isLadderAllSides||"head"!=i.bodyPart&&s>-.1)&&(d=e,this.climbingLadderNormal=t.normal.clone()),this.velocity.addScaledVector(t.normal,-o);const n=.8,r=.001,l=Math.max(t.penetration-r,0)*n,h=t.normal.clone().multiplyScalar(l);this.pos.add(h),"feet"==i.bodyPart&&s>.3&&!a&&(this.isOnFloor=!0,e.allowJump&&(this.isOnJumpableCollider=!0),e.allowWalk||(this.isOnUnwalkableCollider=!0),e.slippery&&(this.isOnSlipperyCollider=!0))}}if(!d){const t=this.climbingLadder;if(t)for(const e of this.colliders){t.getSphereManifold(e.center,e.radius).penetration>-.05&&(d=t)}}!d&&this.climbingLadder&&getMainInstance().now-this.lastJumpTime>300&&(this.velocity.y*=.3),this.climbingLadder=d;{const t=getMainInstance().now,e=s>0,i=t-this.lastTouchDamageColliderTime<300;let a=!1;e&&(this.lastTouchDamageColliderTime=t);const o=e&&!i;if(o!=this.isTouchingDamageCollider&&(this.isTouchingDamageCollider=o,o&&(a=!0)),e&&this.lastTouchDamageColliderPosition){this.lastTouchDamageColliderPosition.distanceTo(this.pos)>n&&(a=!0)}a&&(this.player.touchedDamageCollider(s),this.lastTouchDamageColliderPosition=this.pos.clone())}}needsLadderPhysics(t,e){if(!(e instanceof BoxMapCollider))return!1;if("box"!=t.colliderType)return!1;if(!e.isLadder&&!e.isLadderAllSides)return!1;const i=new Vector3(0,1,0),s=t.normal.dot(i);if(s>-1e-4&&s<1e-4){if(e.getUpFaces()[0].normal.dot(i)>.9999)return!0}return!!e.isLadderAllSides||t.isAtSecondUpFace&&!t.isAtEdge}applyForce(t){this.totalForce.add(t)}getAllowJump(){return!(this.onJumpableColliderTime>200)&&(!this.inAirAfterJump&&!(this.velocity.y>5))}jump(t){this.isOnFloor=!1,this.isOnJumpableCollider=!1,this.isOnUnwalkableCollider=!1,this.isOnSlipperyCollider=!1,this.inAirAfterJump=!0,this.lastJumpTime=getMainInstance().now;const e=Math.max(0,t-this.velocity.y);this.velocity.y+=e}}const REPORT_COOLDOWN=1e3,CheatKickReason={UNKNOWN:0,FLY:1,INVULNERABLE:2,INVALID_ARROW:3,INVALID_ARROW_FREQUENCY:4,INVALID_DEATH_OPERATION:5};class AntiCheatManager{constructor(){this.reportedPlayerTimes=new Map,this.onPlayerNeedsReportCbs=new Set}reportPlayer(t,e,i){const s=this.reportedPlayerTimes.get(t),n=getMainInstance().now;s&&n<s+1e3||(this.reportedPlayerTimes.set(t,n),this.onPlayerNeedsReportCbs.forEach((s=>s(t,e,i))))}onPlayerNeedsReport(t){this.onPlayerNeedsReportCbs.add(t)}}class ActivityWeight{constructor({speed:t=.01}={}){this.weight=0,this.speed=t,this.active=!1,this.onActiveChangeCbs=new Set}loop(t,e){t?this.weight+=e*this.speed:this.weight-=e*this.speed,t!=this.active&&(this.active=t,this.onActiveChangeCbs.forEach((e=>e(t)))),this.weight=clamp01(this.weight)}onActiveChange(t){this.onActiveChangeCbs.add(t)}}function getDefaultSkeletonMultipliers(t,e,i){return{armR:e*t,armL:i*t}}function makeBowSkeletonWeights(t,e,i){return[{name:`bows/${t}/running`,weight:1},{name:`bows/${t}/shooting`,weight:e.weight},{name:`bows/${t}/shootingLoaded`,weight:i}]}function makeMeleeSkeletonWeights(t,e,i){return[{name:`melee/${t}/idle`,weight:1},{name:`melee/${t}/attackStart`,weight:e.weight},{name:`melee/${t}/attackEnd`,weight:i.weight}]}class PullingBowSfx{constructor(t,{player:e,sfxOptions:i}){this.sfxName=t,this.player=e,this.sfxOptions=i,this.playingState=!1,this.currentSfxInstance=null}setPlayingState(t){t!=this.playingState&&(t?this.startPullSfx():this.stopPullSfx(),this.playingState=t)}async startPullSfx(){this.currentPullSfx||(this.currentPullSfx=await getMainInstance().sfx.playSound(this.sfxName,{pos:this.player.getSfxPos(),...this.sfxOptions}),this.playingState||this.stopPullSfx())}stopPullSfx(){this.currentPullSfx&&this.currentPullSfx.stop(),this.currentPullSfx=null}}function randomRotateVec(t,e){const i=t.clone();i.x+=1,i.cross(t).normalize();const s=new Quaternion;s.setFromAxisAngle(t,Math.random()*Math.PI*2),i.applyQuaternion(s);const n=new Quaternion;return n.setFromAxisAngle(i,lerp(-e,e,Math.random())),t.clone().applyQuaternion(n)}class HoldingHandlerManager{constructor(t,{upConfig:e,downConfig:i,offscreenConfig:s,minDownVelocity:n=8}){if(this.holdingHandler=t,this.upConfig=e,this.downConfig=i,!s){let t,e;i.posOffset?(t=i.posOffset.clone(),t.y-=.5):t=new Vector3(-.6,-2,-1.3),e=i.rotOffset?i.rotOffset.clone():new Vector3(-.6,0,-1.3),s={posOffset:t,rotOffset:e,pitchHeightMultiplier:0,maxFov:i.maxFov},null!=i.posBaseFovMultiplierX&&(s.posBaseFovMultiplierX=i.posBaseFovMultiplierX),null!=i.posFovMultiplierX&&(s.posFovMultiplierX=i.posFovMultiplierX),null!=i.posFovMultiplierY&&(s.posFovMultiplierY=i.posFovMultiplierY)}this.offscreenConfig=s,this.minDownVelocity=n,this.forcedConfig=null,this.prevUsePrimaryPosition=!0,this.usePrimaryPosition=!0,this.holdingHandlerDown=!1,this.updateHoldingHandler(!0)}setUsePrimaryPosition(t){this.usePrimaryPosition=t,t&&(this.holdingHandlerDown=!1),this.updateHoldingHandler()}loop(t,e,{forceDown:i=!1,forceConfig:s=null}={}){let n=this.holdingHandlerDown;if(i)n=!0;else if(t)n=!1;else{const t=e.rigidBody.velocity.clone();t.y=0,t.length()>this.minDownVelocity&&(n=!0)}let a=!1;this.usePrimaryPosition!=this.prevUsePrimaryPosition&&(this.prevUsePrimaryPosition=this.usePrimaryPosition,a=!0),n!=this.holdingHandlerDown&&(this.holdingHandlerDown=n,a=!0),s!=this.forcedConfig&&(this.forcedConfig=s,a=!0),a&&this.updateHoldingHandler()}updateHoldingHandler(t=!1){let e;e=this.usePrimaryPosition?this.forcedConfig?this.forcedConfig:this.holdingHandlerDown?this.downConfig:this.upConfig:this.offscreenConfig,this.holdingHandler.setFirstPersonConfig(e,t)}}class Weapon{constructor(t,e,i){this.player=t,this.actionIsDown=!1,this.rawActionIsDown=!1,this.isPrimaryWeapon=!0,this.equipSfxName="",this.holdingHandler=this.player.createHoldingHandler({holdingObject:e,thirdPersonParentName:i.thirdPersonParentName,secondaryThirdPersonParentName:i.secondaryThirdPersonParentName}),this.holdingHandlerManager=new HoldingHandlerManager(this.holdingHandler,i.holdingHandlerManagerOptions)}destructor(){this.holdingHandler.destructor()}playerSkinUpdated(){}actionDown(){this.rawActionIsDown=!0,this.actionIsDown||(this.actionIsDown=!0,this.onActionDown())}actionUp(){this.rawActionIsDown=!1,this.actionIsDown&&(this.actionIsDown=!1,this.onActionUp())}onActionDown(){}onActionUp(){}onPlayerDied(){}onPlayerRespawned(){}getToggleCooldownValue(){return 300}setIsPrimaryWeapon(t){this.isPrimaryWeapon!=t&&(this.isPrimaryWeapon=t,this.holdingHandler.setUsePrimaryParent(this.isPrimaryWeapon),this.holdingHandlerManager.setUsePrimaryPosition(this.isPrimaryWeapon),t?this.equipSfxName&&this.playSfx(this.equipSfxName):this.actionUp())}playSfx(t,e){getMainInstance().sfx.playSound(t,{pos:this.player.getSfxPos(),...e})}loop(t,e){}adjustFov(t){return t}getWalkSpeedMultiplier(){return 1}getAdditionalWalkAcceleration(){return null}getAdditionalWalkAccelerationClampLength(){return 1}getLookInputMultiplier(){return 1}getJumpForceMultiplier(){return 1}getThirdPersonSkeletonLayers(){return[]}getThirdPersonSkeletonMultipliers(t){return{}}}class WeaponBow extends Weapon{constructor(t,e,i){const s=new BowAssetLoader;super(t,s.obj,i),this.bowWeaponId=e,this.equipSfxName="weapon/equipBow",this.bowAssetLoader=s}destructor(){super.destructor(),this.bowAssetLoader.destructor()}getAutoShootEnabled(){if(!this.player.hasOwnership)return!1;return getMainInstance().settingsManager.getValue("autoShoot")}actionDown(){if(this.rawActionIsDown=!0,this.actionIsDown)return;const t=this.player.recentlyDestroyedWeapons.get(this.bowWeaponId);t&&performance.now()-t<1e3||(this.actionIsDown=!0,this.onActionDown())}actionUp(){this.rawActionIsDown=!1,this.actionIsDown&&(!this.getAutoShootEnabled()||this.getAutoShootActionUp()||this.player.dead)&&(this.actionIsDown=!1,this.onActionUp())}shootArrow(t){if(this.player.hasOwnership){const e=this.player.getCamPos(),i=this.player.getShootDirection(),s=this.player.game.crosshair.currentAccuracy,n=randomRotateVec(i,mapValue(0,30,0,.05,s)),a=this.player.getSendArrowId(),o=getMainInstance().network.sendCreateArrow(this.player.game,this.player.id,{arrowId:a,pos:e,dir:n,fireAmount01:t});this.player.game.arrowManager.createArrow(this.player,o)}}getArrowOpts(t){throw new Error("getArrowOpts is not implemented")}loop(t,e){super.loop(t,e),this.actionIsDown&&!this.rawActionIsDown&&this.getAutoShootEnabled()&&this.getAutoShootActionUp()&&(this.actionIsDown=!1,this.onActionUp())}getAutoShootActionUp(){return!0}getAccuracyOffset(){return 0}getClonedArrowObject(t){return this.bowAssetLoader.getClonedArrowObject(t)}getLoadSpeed(t,e){const i=this.player.getStatClassValue("arrowLoadingSpeed");return lerp(t,e,i)}}const MAX_ARORW_COUNT=3;class WeaponSmallBow extends WeaponBow{constructor(...t){super(...t,{thirdPersonParentName:"bowHoldingPos",secondaryThirdPersonParentName:"bowSecondaryPos",holdingHandlerManagerOptions:{downConfig:{posOffset:new Vector3(-.3,-.1,-1.1),rotOffset:new Vector3(-.6,0,-1.3),posFovMultiplierX:.65,posFovMultiplierY:1,minFov:0,maxFov:90},upConfig:{posOffset:new Vector3(0,0,-1.1),rotOffset:new Vector3(0,0,-.2),posFovMultiplierX:.65,valuesSmoothing:.4,minFov:0,maxFov:90}}}),this.shootingActivity=new ActivityWeight,this.shootingMultipleActivity=new ActivityWeight,this.fireAmount01=0,this.arrowCount=1,this.nextArrowTimer=0,this.lastFireUp=0,this.prevArrowReady=!1,this.isShootingMultiple=!1,this.shootingMultipleVisualLoadState=!1,this.shootingMultipleVisualFireAmount=0,this.pullSfx=new PullingBowSfx("weapon/bow/pull",{player:this.player,sfxOptions:{minPitch:1.3,maxPitch:1.5}}),this.updateBowAsset()}getAccuracyOffset(){return lerp(40,20,this.fireAmount01)}adjustFov(t){const e=this.player.getStatClassValue("shootingFocus");return lerp(t,t-lerp(10,30,e),this.fireAmount01)}getWalkSpeedMultiplier(){return this.getIsPullingBow()?.5:1}getToggleCooldownValue(){return 100}getArrowOpts(t){const e=new Vector3;return e.set(1,1,1),this.bowAssetLoader.assetLoaded&&e.copy(this.bowAssetLoader.getLoadedArrowPointScale()),{visualOffset:new Vector3(0,0,.25),damageMultiplier:.6,travelDistanceMultiplier:.4,scale:e}}onActionUp(){this.getFireUpCooldownActive()||(this.shootMultiple(this.arrowCount,this.fireAmount01),this.arrowCount=1,this.fireAmount01=0,this.lastFireUp=getMainInstance().now)}async shootMultiple(t,e){this.isShootingMultiple=!0;for(let i=0;i<t;i++)this.shootArrow(e),getMainInstance().sfx.playSound("weapon/bow/shoot",{pos:this.player.getSfxPos(),minPitch:1,maxPitch:1.1}),this.holdingHandler.addFirstPersonImpulse(new Vector3(0,0,.005*e)),i<t-1&&(await Timeout.promise(50),this.shootingMultipleVisualLoadState=!0,await Timeout.promise(50),this.shootingMultipleVisualLoadState=!1);this.isShootingMultiple=!1}getFireUpCooldownActive(){if(this.isShootingMultiple)return!0;const t=this.getLoadSpeed(350,250);return getMainInstance().now-this.lastFireUp<t}getIsPullingBow(){return this.actionIsDown&&!this.getFireUpCooldownActive()}loop(t,e){super.loop(t,e);const i=this.getIsPullingBow();if(this.pullSfx.setPlayingState(i),i){const t=this.getLoadSpeed(.002,.0035);this.fireAmount01+=e*t,this.fireAmount01=clamp01(this.fireAmount01)}if(this.fireAmount01>=1&&this.arrowCount<3){const t=this.getLoadSpeed(.006,.012);this.nextArrowTimer+=e*t,this.nextArrowTimer>1&&(this.nextArrowTimer=0,this.arrowCount++,this.playArrowReadySfx())}else this.nextArrowTimer=0;const s=!this.getFireUpCooldownActive();s!=this.prevArrowReady&&(s&&this.playArrowReadySfx(),this.prevArrowReady=s),this.shootingMultipleActivity.loop(this.shootingMultipleVisualLoadState,e);const n=s&&this.isPrimaryWeapon;this.bowAssetLoader.updateFireAmount(this.getVisualFireAmount(),n?this.arrowCount:0),this.holdingHandlerManager.loop(i,this.player),this.shootingActivity.loop(i||this.isShootingMultiple,e)}getAutoShootActionUp(){return this.arrowCount>=3}playArrowReadySfx(){getMainInstance().sfx.playSound("weapon/bow/arrowReady",{pos:this.player.getSfxPos(),minPitch:.95,maxPitch:1.05})}getVisualFireAmount(){return this.isShootingMultiple?this.shootingMultipleActivity.weight:this.fireAmount01}getThirdPersonSkeletonLayers(){return makeBowSkeletonWeights("smallBow",this.shootingActivity,this.getVisualFireAmount())}getThirdPersonSkeletonMultipliers(){return getDefaultSkeletonMultipliers(this.shootingActivity.weight,.6,.3)}playerSkinUpdated(){this.updateBowAsset()}updateBowAsset(){const{skins:t,arrowSkin:e}=getMainInstance().skins.skinNetworkDataToBowAssetData("smallBow",this.player.equippedSkinData);this.bowAssetLoader.setConfig({bowId:"smallBow",teamId:this.player.teamId,skins:t,arrowSkin:e,arrowCount:3})}}class WeaponMediumBow extends WeaponBow{constructor(...t){super(...t,{thirdPersonParentName:"bowHoldingPos",secondaryThirdPersonParentName:"bowSecondaryPos",holdingHandlerManagerOptions:{downConfig:{posOffset:new Vector3(-.3,-.1,-1.1),rotOffset:new Vector3(-.6,0,-1.3),posFovMultiplierX:.55,posFovMultiplierY:1,minFov:0,maxFov:90},upConfig:{posOffset:new Vector3(0,0,-1.1),rotOffset:new Vector3(0,0,-.2),posFovMultiplierX:.55,valuesSmoothing:.4,minFov:0,maxFov:90}}}),this.shootingActivity=new ActivityWeight,this.fireAmount01=0,this.lastFireUp=0,this.prevArrowReady=!1,this.pullSfx=new PullingBowSfx("weapon/bow/pull",{player:this.player,sfxOptions:{minPitch:.7,maxPitch:1}}),this.updateBowAsset()}getAccuracyOffset(){return lerp(30,0,this.fireAmount01)}adjustFov(t){const e=this.player.getStatClassValue("shootingFocus");return lerp(t,t-lerp(10,30,e),this.fireAmount01)}getWalkSpeedMultiplier(){return this.getIsPullingBow()?.3:1}getJumpForceMultiplier(){return this.getIsPullingBow()?.8:1}getArrowOpts(t){const e=new Vector3;return e.set(1,1,1),this.bowAssetLoader.assetLoaded&&e.copy(this.bowAssetLoader.getLoadedArrowPointScale()),{visualOffset:new Vector3(0,0,.25),damageMultiplier:1,scale:e}}onActionUp(){this.getFireUpCooldownActive()||(this.shootArrow(this.fireAmount01),this.holdingHandler.addFirstPersonImpulse(new Vector3(0,0,.005*this.fireAmount01)),getMainInstance().sfx.playSound("weapon/bow/shoot",{pos:this.player.getSfxPos(),minPitch:.9,maxPitch:1}),this.fireAmount01=0,this.lastFireUp=getMainInstance().now)}getFireUpCooldownActive(){const t=this.getLoadSpeed(500,320);return getMainInstance().now-this.lastFireUp<t}getIsPullingBow(){return this.actionIsDown&&!this.getFireUpCooldownActive()}loop(t,e){super.loop(t,e);const i=this.getIsPullingBow();if(this.pullSfx.setPlayingState(i),i){const t=this.getLoadSpeed(.0015,.0025);this.fireAmount01+=e*t,this.fireAmount01=clamp01(this.fireAmount01)}const s=!this.getFireUpCooldownActive();s!=this.prevArrowReady&&(s&&getMainInstance().sfx.playSound("weapon/bow/arrowReady",{pos:this.player.getSfxPos(),minPitch:.95,maxPitch:1.05}),this.prevArrowReady=s);const n=s&&this.isPrimaryWeapon;this.bowAssetLoader.updateFireAmount(this.fireAmount01,n?1:0),this.holdingHandlerManager.loop(i,this.player),this.shootingActivity.loop(i,e)}getAutoShootActionUp(){return this.fireAmount01>=1}getThirdPersonSkeletonLayers(){return makeBowSkeletonWeights("mediumBow",this.shootingActivity,this.fireAmount01)}getThirdPersonSkeletonMultipliers(t){if("female"==t)return getDefaultSkeletonMultipliers(this.shootingActivity.weight,.4,-.2);if("male"==t)return getDefaultSkeletonMultipliers(this.shootingActivity.weight,.4,0);throw new Error("Invalid gender")}playerSkinUpdated(){this.updateBowAsset()}updateBowAsset(){const{skins:t,arrowSkin:e}=getMainInstance().skins.skinNetworkDataToBowAssetData("mediumBow",this.player.equippedSkinData);this.bowAssetLoader.setConfig({bowId:"mediumBow",teamId:this.player.teamId,skins:t,arrowSkin:e})}}class WeaponLargeBow extends WeaponBow{constructor(...t){super(...t,{thirdPersonParentName:"bowHoldingPos",secondaryThirdPersonParentName:"bowSecondaryPos",holdingHandlerManagerOptions:{downConfig:{posOffset:new Vector3(-.3,-.1,-1.1),rotOffset:new Vector3(-.6,0,-1.3),walkBobMultiplier:.3,valuesSmoothing:.1,posFovMultiplierX:.55,posFovMultiplierY:1,minFov:20,maxFov:90},upConfig:{posOffset:new Vector3(0,0,-1.1),rotOffset:new Vector3(0,0,-.2),walkBobMultiplier:.3,valuesSmoothing:.1,posFovMultiplierX:.55,minFov:20,maxFov:90},minDownVelocity:5}}),this.shootingActivity=new ActivityWeight,this.fireAmount01=0,this.lastFireDown=0,this.lastFireUp=0,this.prevCooldownActive=!1,this.isPullingBow=!1,this.pullSfx=new PullingBowSfx("weapon/bow/pullHeavy",{player:this.player,sfxOptions:{minPitch:.9,maxPitch:1.1}}),this.updateBowAsset()}getAccuracyOffset(){return lerp(30,0,this.fireAmount01)}adjustFov(t){const e=this.player.getStatClassValue("shootingFocus"),i=lerp(40,10,e);return lerp(t,i,this.fireAmount01)}getWalkSpeedMultiplier(){return this.getIsPullingBow()?.1:.8}getJumpForceMultiplier(){return this.getIsPullingBow()?.8:1}getToggleCooldownValue(){return 500}getArrowOpts(t){const e=new Vector3;return e.set(1,1,1),this.bowAssetLoader.assetLoaded&&e.copy(this.bowAssetLoader.getLoadedArrowPointScale()),{visualOffset:new Vector3(0,0,.25),damageMultiplier:2,travelDistanceMultiplier:3,scale:e,trailThicknessMultiplier:3,trailDurationMultiplier:5}}onActionUp(){this.getFireCooldownActive()||(this.shootArrow(this.fireAmount01),this.holdingHandler.addFirstPersonImpulse(new Vector3(0,0,.01*this.fireAmount01)),getMainInstance().sfx.playSound("weapon/largeBow/shoot",{pos:this.player.getSfxPos(),minPitch:.9,maxPitch:1.1}),this.fireAmount01=0,this.lastFireUp=getMainInstance().now,this.isPullingBow=!1)}getFireCooldownActive(){const t=getMainInstance().now;if(!this.isPullingBow){const e=this.getLoadSpeed(1300,1e3);if(t-this.lastFireDown<e)return!0}const e=this.getLoadSpeed(500,300);return t-this.lastFireUp<e}getIsPullingBow(){return this.actionIsDown&&!this.getFireCooldownActive()}loop(t,e){super.loop(t,e);const i=this.getIsPullingBow();if(i!=this.isPullingBow&&(i&&(this.lastFireDown=t),this.isPullingBow=i),this.pullSfx.setPlayingState(i),i){const t=this.getLoadSpeed(7e-4,.001);this.fireAmount01+=e*t,this.fireAmount01=clamp01(this.fireAmount01)}const s=this.getFireCooldownActive();s!=this.prevCooldownActive&&(s||getMainInstance().sfx.playSound("weapon/bow/arrowReady",{pos:this.player.getSfxPos(),minPitch:.95,maxPitch:1.05}),this.prevCooldownActive=s);const n=!s&&this.isPrimaryWeapon;this.bowAssetLoader.updateFireAmount(this.fireAmount01,n?1:0),this.holdingHandlerManager.loop(i,this.player),this.shootingActivity.loop(i,e)}getAutoShootActionUp(){return this.fireAmount01>=1}getThirdPersonSkeletonLayers(){return makeBowSkeletonWeights("largeBow",this.shootingActivity,this.fireAmount01)}getThirdPersonSkeletonMultipliers(){return getDefaultSkeletonMultipliers(this.shootingActivity.weight,.4,-.2)}playerSkinUpdated(){this.updateBowAsset()}updateBowAsset(){const{skins:t,arrowSkin:e}=getMainInstance().skins.skinNetworkDataToBowAssetData("largeBow",this.player.equippedSkinData);this.bowAssetLoader.setConfig({bowId:"largeBow",teamId:this.player.teamId,skins:t,arrowSkin:e})}}class WeaponSmallCrossBow extends WeaponBow{constructor(...t){super(...t,{thirdPersonParentName:"bowHoldingPos",secondaryThirdPersonParentName:"crossbowSecondaryPos",holdingHandlerManagerOptions:{downConfig:{posOffset:new Vector3(-.3,.1,-1.1),rotOffset:new Vector3(-.5,Math.PI/2,0),posFovMultiplierX:.2,posFovMultiplierY:1,minFov:0,maxFov:90},upConfig:{posOffset:new Vector3(0,-.4,-1.1),rotOffset:new Vector3(0,0,.2),posFovMultiplierX:.4,valuesSmoothing:.4,minFov:0,maxFov:90}}}),this.lastFireTime=0,this.prevArrowVisible=!1,this.playNextFirstPersonLoadAnimation=!1,this.loadingActivity=new ActivityWeight,this.shootingActivity=new ActivityWeight,this.updateBowAsset()}getAccuracyOffset(){return 10}getWalkSpeedMultiplier(){return 1.1}getToggleCooldownValue(){return 100}getArrowOpts(t){const e=new Vector3;return e.set(1,1,1),this.bowAssetLoader.assetLoaded&&e.copy(this.bowAssetLoader.getLoadedArrowPointScale()),{visualOffset:new Vector3(0,-.12,.15),damageMultiplier:1/3,scale:e}}onActionDown(){this.getFireUpCooldownActive()||(this.shootArrow(1),this.holdingHandler.addFirstPersonImpulse(new Vector3(0,0,.005)),getMainInstance().sfx.playSound("weapon/smallCrossbow/shoot",{pos:this.player.getSfxPos(),minPitch:.9,maxPitch:1.1}),this.fireAmount01=0,this.lastFireTime=getMainInstance().now,this.playNextFirstPersonLoadAnimation=!this.holdingHandlerManager.holdingHandlerDown)}getFireUpCooldownActive(){return getMainInstance().now-this.lastFireTime<this.getArrowReadyMs()}getArrowVisibleMs(){return this.getLoadSpeed(300,180)}getArrowReadyMs(){return this.getLoadSpeed(700,400)}loop(t,e){super.loop(t,e);const i=t-this.lastFireTime,s=i<3e3,n=i<this.getArrowReadyMs(),a=n&&this.playNextFirstPersonLoadAnimation||this.player.dead,o=mapValue(this.getArrowVisibleMs(),this.getArrowReadyMs(),0,1,i,!0),r=i>this.getArrowVisibleMs();r!=this.prevArrowVisible&&(r&&getMainInstance().sfx.playSound("weapon/bow/arrowReady",{pos:this.player.getSfxPos(),minPitch:.95,maxPitch:1.05}),this.prevArrowVisible=r),this.bowAssetLoader.updateFireAmount(o,r&&this.isPrimaryWeapon?1:0),this.holdingHandlerManager.loop(s,this.player,{forceDown:a}),this.loadingActivity.loop(n,e),this.shootingActivity.loop(s,e)}getThirdPersonSkeletonLayers(){return[{name:"bows/smallCrossbow/running",weight:1},{name:"bows/smallCrossbow/shooting",weight:this.shootingActivity.weight},{name:"bows/smallCrossbow/loading",weight:this.loadingActivity.weight}]}getThirdPersonSkeletonMultipliers(t){const e=this.shootingActivity.weight*(1-this.loadingActivity.weight);if("female"==t)return getDefaultSkeletonMultipliers(e,.4,0);if("male"==t)return getDefaultSkeletonMultipliers(e,.4,-.2);throw new Error("invalid gender")}playerSkinUpdated(){this.updateBowAsset()}updateBowAsset(){const{skins:t,arrowSkin:e}=getMainInstance().skins.skinNetworkDataToBowAssetData("smallCrossbow",this.player.equippedSkinData);this.bowAssetLoader.setConfig({bowId:"smallCrossbow",teamId:this.player.teamId,skins:t,arrowSkin:e})}}const MAX_ARROW_LOAD_COUNT=10,HANDLE_OBJECT_NAME="handleRotation",ARROW_BOX_OBJECT_NAME="arrowBoxRotation";class WeaponRepeatingCrossbow extends WeaponBow{constructor(...t){super(...t,{thirdPersonParentName:"bowHoldingPos",secondaryThirdPersonParentName:"crossbowSecondaryPos",holdingHandlerManagerOptions:{downConfig:{posOffset:new Vector3(0,.2,-.7),rotOffset:new Vector3(-.5,.4,0),valuesSmoothing:.25,pitchHeightMultiplier:.1,posFovMultiplierX:.4,posFovMultiplierY:1,minFov:60,maxFov:110},upConfig:{posOffset:new Vector3(.2,-.1,-.3),rotOffset:new Vector3(0,0,0),walkBobMultiplier:.1,valuesSmoothing:.25,pitchHeightMultiplier:.02,posFovMultiplierX:.1,posFovMultiplierY:.2,minFov:70,maxFov:90},minDownVelocity:6}}),this.loadingOrShootingState=!1,this.loadedArrowCount=10,this.shootOrLoadTimer=0,this.hasReleasedAction=!0,this.loadingActivity=new ActivityWeight,this.loadingEndActivity=new ActivityWeight,this.shootingActivity=new ActivityWeight,this.currentHandleObject=null,this.currentArrowBoxObject=null,this.bowAssetLoader.onAssetChange((t=>{this.currentHandleObject=t.getObjectByName("handleRotation"),this.currentArrowBoxObject=t.getObjectByName("arrowBoxRotation")})),this.emptyFirstPersonConfig={posOffset:new Vector3(.1,-.5,-.2),rotOffset:new Vector3(.8,1.2,0),valuesSmoothing:.25,pitchHeightMultiplier:.2,posFovMultiplierX:-.1},this.loadingFirstPersonConfig={posOffset:new Vector3(.1,-.3,-.2),rotOffset:new Vector3(.3,1.1,.5),valuesSmoothing:.25,pitchHeightMultiplier:0,walkBobMultiplier:0},this.updateBowAsset()}getAccuracyOffset(){const t=this.player.rigidBody.velocity.clone();return t.y=0,t.length()>1?40:10}adjustFov(t){if(this.isFiringArrows()){const e=this.player.getStatClassValue("shootingFocus");return t-lerp(10,30,e)}return t}getWalkSpeedMultiplier(){return this.isFiringArrows()?.2:.8}getArrowOpts(t){const e=new Vector3;return e.set(1,1,1),this.bowAssetLoader.assetLoaded&&e.copy(this.bowAssetLoader.getLoadedArrowPointScale()),{visualOffset:new Vector3(0,-.2,.2),damageMultiplier:.4,scale:e}}onActionUp(){this.hasReleasedAction=!0}onPlayerRespawned(){this.loadingOrShootingState=!1,this.loadedArrowCount=10,this.shootOrLoadTimer=0}isFiringArrows(){return this.hasReleasedAction&&this.actionIsDown&&!this.loadingOrShootingState}isLoading(){return this.hasReleasedAction&&this.actionIsDown&&this.loadingOrShootingState}getShootArrowInterval(){return this.getLoadSpeed(300,200)}getFireAmount(){return this.isFiringArrows()?this.shootOrLoadTimer/this.getShootArrowInterval():0}loop(t,e){if(super.loop(t,e),this.hasReleasedAction&&this.actionIsDown)if(this.shootOrLoadTimer+=e,this.loadingOrShootingState){const t=this.getLoadSpeed(150,80);this.shootOrLoadTimer>t&&(this.shootOrLoadTimer=0,getMainInstance().sfx.playSound("weapon/bow/arrowReady",{pos:this.player.getSfxPos(),minPitch:.95,maxPitch:1.05}),this.loadedArrowCount++,this.loadedArrowCount>=10&&(this.loadingOrShootingState=!1,this.hasReleasedAction=!1))}else this.shootOrLoadTimer>this.getShootArrowInterval()&&(this.shootOrLoadTimer=0,this.shootArrow(1),getMainInstance().sfx.playSound("weapon/bow/shoot",{pos:this.player.getSfxPos(),minPitch:.9,maxPitch:1.1}),this.loadedArrowCount--,this.loadedArrowCount<=0&&(this.loadingOrShootingState=!0,this.hasReleasedAction=!1));const i=this.getFireAmount();this.bowAssetLoader.updateFireAmount(i,this.isPrimaryWeapon?this.loadedArrowCount:0);const s=this.isLoading();let n=null;s?n=this.loadingFirstPersonConfig:this.loadingOrShootingState&&(n=this.emptyFirstPersonConfig),this.holdingHandlerManager.loop(this.isFiringArrows(),this.player,{forceConfig:n}),this.loadingActivity.loop(s,e),this.loadingEndActivity.loop(this.shootOrLoadTimer<this.getShootArrowInterval()/2,e),this.shootingActivity.loop(this.isFiringArrows(),e);const a=1-i;this.currentHandleObject&&(this.currentHandleObject.rotation.x=lerp(0,1,a)),this.currentArrowBoxObject&&(this.currentArrowBoxObject.rotation.x=lerp(0,.2,a*(1-this.loadingActivity.weight)))}getAutoShootActionUp(){return!this.hasReleasedAction}getThirdPersonSkeletonLayers(){const t=this.shootingActivity.weight,e=this.loadingActivity.weight;return[{name:"bows/repeatingCrossbow/running",weight:1},{name:"bows/repeatingCrossbow/loadingStart",weight:e},{name:"bows/repeatingCrossbow/loadingEnd",weight:e*this.loadingEndActivity.weight},{name:"bows/repeatingCrossbow/shootStart",weight:t},{name:"bows/repeatingCrossbow/shootEnd",weight:t*(1-this.getFireAmount())}]}getThirdPersonSkeletonMultipliers(){return getDefaultSkeletonMultipliers(this.shootingActivity.weight,.4,.2)}playerSkinUpdated(){this.updateBowAsset()}updateBowAsset(){const{skins:t,arrowSkin:e}=getMainInstance().skins.skinNetworkDataToBowAssetData("repeatingCrossbow",this.player.equippedSkinData);this.bowAssetLoader.setConfig({bowId:"repeatingCrossbow",teamId:this.player.teamId,skins:t,arrowSkin:e,separateObjectNames:["handleRotation","arrowBoxRotation"],arrowCount:10,arrowPositions:"stacked"})}}class WeaponLargeCrossbow extends WeaponBow{constructor(...t){super(...t,{thirdPersonParentName:"bowHoldingPos",secondaryThirdPersonParentName:"crossbowSecondaryPos",holdingHandlerManagerOptions:{downConfig:{posOffset:new Vector3(0,.2,-.7),rotOffset:new Vector3(-.5,.4,0),valuesSmoothing:.25,pitchHeightMultiplier:.1,posFovMultiplierX:.4,posFovMultiplierY:1,minFov:60,maxFov:110},upConfig:{posOffset:new Vector3(0,-.1,-.5),rotOffset:new Vector3(0,0,0),walkBobMultiplier:.1,valuesSmoothing:.25,pitchHeightMultiplier:.02,posFovMultiplierX:.1,posFovMultiplierY:.2,minFov:70,maxFov:90},minDownVelocity:6}}),this.loadAmount01=1,this.lastShootTime=0,this.prevArrowReady=!1,this.loadWeightStart=new ActivityWeight,this.shootingWeight=new ActivityWeight,this.pullSfx=new PullingBowSfx("weapon/bow/pullHeavy",{player:this.player,sfxOptions:{minPitch:1.3,maxPitch:1.5}}),this.loadingFirstPersonConfig={posOffset:new Vector3(0,.3,-1),rotOffset:new Vector3(-.5,.5,.3),valuesSmoothing:.25,pitchHeightMultiplier:.1,posFovMultiplierX:.1,posFovMultiplierY:1,minFov:60,maxFov:110},this.updateBowAsset()}adjustFov(t){if(this.weaponIsLoaded()){const e=this.player.getStatClassValue("shootingFocus");return t-lerp(10,30,e)}return t}getWalkSpeedMultiplier(){return this.isLoadingWeapon()?.05:.8}getJumpForceMultiplier(){return this.isLoadingWeapon()?0:1}getArrowOpts(t){const e=new Vector3;return e.set(1,1,1),this.bowAssetLoader.assetLoaded&&e.copy(this.bowAssetLoader.getLoadedArrowPointScale()),{visualOffset:new Vector3(0,-.12,.05),damageMultiplier:2,scale:e}}onActionDown(){this.weaponIsLoaded()&&(this.shootArrow(1),this.holdingHandler.addFirstPersonImpulse(new Vector3(0,0,.005)),getMainInstance().sfx.playSound("weapon/largeCrossbow/shoot",{pos:this.player.getSfxPos(),minPitch:.9,maxPitch:1.1}),this.loadAmount01=0,this.lastShootTime=getMainInstance().now)}onPlayerRespawned(){this.loadAmount01=1}getFireUpCooldownActive(){const t=this.getLoadSpeed(500,300);return getMainInstance().now-this.lastShootTime<t}weaponIsLoaded(){return this.loadAmount01>=1}isLoadingWeapon(){return!this.getFireUpCooldownActive()&&(!this.weaponIsLoaded()&&(this.actionIsDown||this.loadAmount01>.4))}loop(t,e){super.loop(t,e);const i=this.isLoadingWeapon();if(this.pullSfx.setPlayingState(i),i){const t=this.getLoadSpeed(.001,.0015);this.loadAmount01+=e*t,this.loadAmount01=clamp01(this.loadAmount01)}else this.weaponIsLoaded()||(this.loadAmount01=0);const s=!this.getFireUpCooldownActive();s!=this.prevArrowReady&&(s&&getMainInstance().sfx.playSound("weapon/bow/arrowReady",{pos:this.player.getSfxPos(),minPitch:.95,maxPitch:1.05}),this.prevArrowReady=s);const n=s&&this.isPrimaryWeapon;this.bowAssetLoader.updateFireAmount(this.loadAmount01,n?1:0);const a=i?this.loadingFirstPersonConfig:null;this.holdingHandlerManager.loop(i,this.player,{forceConfig:a}),this.loadWeightStart.loop(i,e),this.shootingWeight.loop(this.weaponIsLoaded(),e)}getAutoShootActionUp(){return!this.isLoadingWeapon()}getThirdPersonSkeletonLayers(){return[{name:"bows/largeCrossbow/running",weight:1},{name:"bows/largeCrossbow/loadingStart",weight:this.loadWeightStart.weight},{name:"bows/largeCrossbow/loadingEnd",weight:this.loadAmount01},{name:"bows/largeCrossbow/shooting",weight:this.shootingWeight.weight}]}getThirdPersonSkeletonMultipliers(t){const e=this.shootingWeight.weight;if("female"==t)return getDefaultSkeletonMultipliers(e,.5,.5);if("male"==t)return getDefaultSkeletonMultipliers(e,.5,1);throw new Error("Invalid gender")}playerSkinUpdated(){this.updateBowAsset()}updateBowAsset(){const{skins:t,arrowSkin:e}=getMainInstance().skins.skinNetworkDataToBowAssetData("largeCrossbow",this.player.equippedSkinData);this.bowAssetLoader.setConfig({bowId:"largeCrossbow",teamId:this.player.teamId,skins:t,arrowSkin:e})}}class LongMeleeAttackHelper{constructor(t){this.weapon=t,this.isAttacking=!1}startAttacking(){this.isAttacking=!0}stopAttacking(){this.isAttacking=!1}loop(){if(this.isAttacking){if(this.weapon.attack())return this.isAttacking=!1,!0}return!1}}class WeaponMelee extends Weapon{constructor(t,e){const i=new ConfigObjectAssetLoader({label:"melee"});super(t,i.obj,e),this.equipSfxName="weapon/equipMelee",this.hitSfxName="",this.swingSfxName="",this.hitSfxOptions=null,this.meleeAssetLoader=i}destructor(){super.destructor(),this.meleeAssetLoader.destructor()}getRequiredHorizontalAngleMultiplier(){return 1}getRequiredVerticalAngleMultiplier(){return 1}attack(){if(!this.player.hasOwnership)return!1;if(this.player.dead)return!1;const t=this.player.getCamPos(),e=this.player.getLookDirection();let i=lerp(2,4,this.player.getStatClassValue("meleeAttackReach"));i*=this.getRangeMultiplier();let s=null;for(const n of this.player.game.physics.getPlayerColliders()){if(n.rigidBody.player.teamId==this.player.teamId)continue;if(n.rigidBody.player.dead)continue;const a=t.clone().sub(n.center),o=a.clone();o.y=0;const r=e.clone();r.y=0;const l=o.angleTo(r),h=o.clone(),d=new Quaternion;d.setFromAxisAngle(new Vector3(0,1,0),.5*Math.PI),h.applyQuaternion(d);const c=e.clone();c.projectOnPlane(h);const u=a.angleTo(c),p=a.length();if(p<i){const t=1/p*this.getRequiredHorizontalAngleMultiplier(),i=1/p*this.getRequiredVerticalAngleMultiplier();if(l<t&&u<i){const t=a.angleTo(e)*p;(!s||t<s.score)&&(s={collider:n,score:t})}}}if(s){const e=s.collider,i=this.player.game.physics.getRayCastCache(t,e.center);if(i){const s=this.player.game.physics.rayCastMapColliders(i,(t=>!t.collider.ignoreArrows&&t.collider.excludeTeamId!=this.player.teamId));if(s){const i=t.distanceTo(e.center)-e.radius;if(s.dist<i)return!1}}const n=e.rigidBody.player;return n.addMeleeHitFlash(),getMainInstance().sfx.playSound("feedback/hitPlayer"),this.playHitSfx(),getMainInstance().network.sendMeleeHitPlayer(n.id,n.currentSpawnId,this.player.id),!0}return!1}playHitSfx(){this.hitSfxName&&this.playSfx(this.hitSfxName,this.hitSfxOptions||void 0)}validateHit(t){return t.pos.distanceTo(this.player.pos)<5}getDamageMultiplier(){return 0}getStunData(){return{amount:.2,duration:300,fadeDuration:500}}getRangeMultiplier(){return 1}getAttackSpeedStat(){return this.player.getStatClassValue("meleeAttackSpeed")}updateMeleeAsset(t){this.meleeAssetLoader.setConfig({skinAssetName:t,teamId:this.player.teamId})}}class WeaponMeleeBladedLight extends WeaponMelee{constructor(...t){super(...t,{thirdPersonParentName:"meleeHoldingPos",secondaryThirdPersonParentName:"meleeSecondaryPosLight",holdingHandlerManagerOptions:{downConfig:{posOffset:new Vector3(0,0,-.6),rotOffset:new Vector3(-1.9,0,0),posFovMultiplierX:.4,posFovMultiplierY:.7,valuesSmoothing:.4,minFov:60,maxFov:90},upConfig:{posOffset:new Vector3(0,.2,-.6),rotOffset:new Vector3(-.4,.6,0),posFovMultiplierX:.4,posFovMultiplierY:.7,valuesSmoothing:.4,minFov:60,maxFov:90}}}),this.hitSfxName="weapon/melee/bladedHit",this.attackT=0,this.stamina=1,this.isAttacking=!1,this.longAttackHelper=new LongMeleeAttackHelper(this),this.attackStartPos=new Vector3,this.attackEndPos=new Vector3,this.attackStartConfig={posOffset:this.attackStartPos,rotOffset:new Vector3(-1.9,0,0),posFovMultiplierX:.4,posFovMultiplierY:.5,valuesSmoothing:.3,minFov:60,maxFov:90},this.attackEndConfig={posOffset:this.attackEndPos,rotOffset:new Vector3(-1.5,.3,0),posFovMultiplierX:.4,posFovMultiplierY:.5,valuesSmoothing:.6,minFov:60,maxFov:90},this.attackStartActivity=new ActivityWeight,this.attackEndActivity=new ActivityWeight,this.attackEndActivity.onActiveChange((t=>{t?(this.playSfx("weapon/melee/bladedSwing",{minPitch:1.1,maxPitch:1.3,volume:.02}),this.longAttackHelper.startAttacking()):(this.attackStartPos.set(randRange(-.1,.1),0,randRange(-.7,-.5)),this.attackEndPos.set(randRange(-.4,-.2),0,randRange(-1.1,-.8)),this.longAttackHelper.stopAttacking())}))}getWalkSpeedMultiplier(){return this.isAttacking?lerp(.7,1.1,this.stamina):1.1}getDamageMultiplier(){return.2}getToggleCooldownValue(){return 100}loop(t,e){super.loop(t,e);let i=null,s=!1,n=!1;if(this.actionIsDown&&(this.isAttacking=!0),this.isAttacking){this.attackT+=e*lerp(.5,1,this.stamina);const t=this.attackT*lerp(.8,1.4,this.getAttackSpeedStat()),a=mod(t,200);a<100&&!this.actionIsDown&&!this.attackEndActivity.active?this.isAttacking=!1:a<100?(i={...this.attackEndConfig},s=!0,n=!0):(i={...this.attackStartConfig},s=!0),this.stamina-=3e-4*e}else this.stamina+=3e-4*e;this.stamina=clamp01(this.stamina),this.holdingHandlerManager.loop(this.isAttacking,this.player,{forceConfig:i}),this.attackStartActivity.loop(s,e),this.attackEndActivity.loop(n,e),this.longAttackHelper.loop()}onActionDown(){this.isAttacking||(this.attackT=0)}getThirdPersonSkeletonLayers(){return makeMeleeSkeletonWeights("bladedLight",this.attackStartActivity,this.attackEndActivity)}}class AttackConfigRandomizer{constructor(t){if(0==t.length)throw new Error("zero configs provided");this.configs=t,this.currentConfig=null,this.randomize()}randomize(){this.currentConfig=randFromArray(this.configs)}getCurrentConfig(){if(!this.currentConfig)throw new Error("no active config");return this.currentConfig}}class HoldAttackManager{constructor({weapon:t,prepareDurationMsLowAttackSpeed:e,prepareDurationMsHighAttackSpeed:i,cooldownDurationMsLowAttackSpeed:s,cooldownDurationMsHighAttackSpeed:n}){this.weapon=t,this.prepareDurationMsLowAttackSpeed=e,this.prepareDurationMsHighAttackSpeed=i,this.cooldownDurationMsLowAttackSpeed=s,this.cooldownDurationMsHighAttackSpeed=n,this.actionIsDown=!1,this.attackTime=0,this.isPreparingAttack=!1,this.cooldownIsActive=!1}onActionDown(){this.actionIsDown=!0}onActionUp(){this.actionIsDown=!1,this.isPreparingAttack&&(this.attackTime=Math.max(this.attackTime,getMainInstance().now))}get timeSinceAttack(){const t=getMainInstance().now-this.attackTime;return this.actionIsDown?Math.min(-1e-6,t):t}loop(t,e,i){if(this.actionIsDown&&!this.cooldownIsActive&&!this.isPreparingAttack){this.isPreparingAttack=!0;const t=lerp(this.prepareDurationMsLowAttackSpeed,this.prepareDurationMsHighAttackSpeed,i);this.attackTime=getMainInstance().now+t}if(this.isPreparingAttack)t>this.attackTime&&!this.actionIsDown&&(this.isPreparingAttack=!1,this.cooldownIsActive=!0);else if(this.cooldownIsActive){const e=lerp(this.cooldownDurationMsLowAttackSpeed,this.cooldownDurationMsHighAttackSpeed,i);t>this.attackTime+e&&(this.cooldownIsActive=!1)}return{preparing:this.isPreparingAttack,cooldownActive:this.cooldownIsActive}}}class WeaponMeleeBladedHeavy extends WeaponMelee{constructor(...t){super(...t,{thirdPersonParentName:"meleeHoldingPos",secondaryThirdPersonParentName:"meleeSecondaryPosBladedHeavy",holdingHandlerManagerOptions:{downConfig:{posOffset:new Vector3(-.5,-.1,-1.1),rotOffset:new Vector3(.3,0,-1.2),posFovMultiplierX:.55,posFovMultiplierY:1,valuesSmoothing:.4,minFov:0,maxFov:90},upConfig:{posOffset:new Vector3(0,-.5,-.7),rotOffset:new Vector3(0,0,-.4),posFovMultiplierX:.3,minFov:60,maxFov:90,valuesSmoothing:.2}}}),this.hitSfxName="weapon/melee/bladedHit",this.holdAttack=new HoldAttackManager({weapon:this,prepareDurationMsLowAttackSpeed:300,prepareDurationMsHighAttackSpeed:150,cooldownDurationMsLowAttackSpeed:400,cooldownDurationMsHighAttackSpeed:200}),this.longAttackHelper=new LongMeleeAttackHelper(this),this.attackStartActivity=new ActivityWeight,this.attackEndActivity=new ActivityWeight,this.attackEndActivity.onActiveChange((t=>{t?(this.longAttackHelper.startAttacking(),this.playSfx("weapon/melee/bladedSwing",{minPitch:.9,maxPitch:1.1})):this.randomizer.randomize()})),this.randomizer=new AttackConfigRandomizer([{start:{posOffset:new Vector3(0,-.3,-.8),rotOffset:new Vector3(.3,0,-.4),posFovMultiplierX:.3,minFov:60,maxFov:90,valuesSmoothing:.1},end:{posOffset:new Vector3(-.5,-.5,-.8),rotOffset:new Vector3(-.7,1.9,-1.5),posFovMultiplierX:.3,minFov:60,maxFov:90,valuesSmoothing:.7}},{start:{posOffset:new Vector3(0,-.3,-.8),rotOffset:new Vector3(.3,0,.4),posFovMultiplierX:-.3,minFov:60,maxFov:90,valuesSmoothing:.2},end:{posOffset:new Vector3(.5,-.5,-.8),rotOffset:new Vector3(-2.4,1.4,-1.5),posFovMultiplierX:-.3,minFov:60,maxFov:90,valuesSmoothing:.7}}])}getDamageMultiplier(){return.6}onActionUp(){this.holdAttack.onActionUp()}onActionDown(){this.holdAttack.onActionDown()}getRequiredVerticalAngleMultiplier(){return.7}getRequiredHorizontalAngleMultiplier(){return 2}loop(t,e){super.loop(t,e);const{preparing:i,cooldownActive:s}=this.holdAttack.loop(t,e,this.getAttackSpeedStat());let n=null,a=!1,o=!1;i?(n=this.randomizer.getCurrentConfig().start,a=!0):s&&(n=this.randomizer.getCurrentConfig().end,a=!0,o=!0),this.longAttackHelper.isAttacking&&this.holdAttack.timeSinceAttack>200&&this.longAttackHelper.stopAttacking(),this.holdingHandlerManager.loop(this.actionIsDown,this.player,{forceConfig:n}),this.attackStartActivity.loop(a,e),this.attackEndActivity.loop(o,e),this.longAttackHelper.loop()}getThirdPersonSkeletonLayers(){return makeMeleeSkeletonWeights("bladedHeavy",this.attackStartActivity,this.attackEndActivity)}}class WeaponMeleeBluntHeavy extends WeaponMelee{constructor(...t){super(...t,{thirdPersonParentName:"meleeHoldingPos",secondaryThirdPersonParentName:"meleeSecondaryPosBluntHeavy",holdingHandlerManagerOptions:{downConfig:{posOffset:new Vector3(-.5,-.7,-.6),rotOffset:new Vector3(0,0,-1),posFovMultiplierX:.55,valuesSmoothing:.1,minFov:0,maxFov:90},upConfig:{posOffset:new Vector3(-.4,-.5,-.6),rotOffset:new Vector3(0,0,-.6),posFovMultiplierX:.55,valuesSmoothing:.1,walkBobMultiplier:.5,maxFov:70}}}),this.hitSfxName="weapon/melee/bluntHit",this.holdAttack=new HoldAttackManager({weapon:this,prepareDurationMsLowAttackSpeed:500,prepareDurationMsHighAttackSpeed:200,cooldownDurationMsLowAttackSpeed:700,cooldownDurationMsHighAttackSpeed:200}),this.longAttackHelper=new LongMeleeAttackHelper(this),this.attackStartTime=0,this.attackStartActivity=new ActivityWeight({speed:.003}),this.attackStartActivity.onActiveChange((t=>{t&&(this.attackStartTime=getMainInstance().now)})),this.attackEndActivity=new ActivityWeight,this.attackEndActivity.onActiveChange((t=>{t&&(this.longAttackHelper.startAttacking(),this.playSfx("weapon/melee/bluntSwing",{minPitch:.9,maxPitch:1.1}))})),this.attackStartConfig={posOffset:new Vector3(-.1,-.3,-.8),rotOffset:new Vector3(.7,0,0),posFovMultiplierX:.4,valuesSmoothing:.1,walkBobMultiplier:0,maxFov:90},this.attackEndConfig={posOffset:new Vector3(0,-.3,-.4),rotOffset:new Vector3(-2,0,.6),posFovMultiplierX:.4,valuesSmoothing:.5,walkBobMultiplier:0,maxFov:90}}getWalkSpeedMultiplier(){if(this.attackStartActivity.active){const t=getMainInstance().now-this.attackStartTime,e=lerp(800,500,this.getAttackSpeedStat());return mapValue(300,e,.3,.9,t,!0)}return this.attackEndActivity.active?.7:.9}getDamageMultiplier(){return 1}getStunData(){return{amount:.7,duration:700,fadeDuration:500}}getToggleCooldownValue(){return 600}onActionDown(){this.holdAttack.onActionDown()}onActionUp(){this.holdAttack.onActionUp()}getRequiredVerticalAngleMultiplier(){return 2}getRequiredHorizontalAngleMultiplier(){return.7}loop(t,e){super.loop(t,e);const{cooldownActive:i,preparing:s}=this.holdAttack.loop(t,e,this.getAttackSpeedStat());let n=null,a=!1,o=!1;s?(n=this.attackStartConfig,a=!0):i&&(n=this.attackEndConfig,o=!0),this.holdingHandlerManager.loop(this.actionIsDown,this.player,{forceConfig:n}),this.longAttackHelper.isAttacking&&this.holdAttack.timeSinceAttack>400&&this.longAttackHelper.stopAttacking(),this.attackStartActivity.loop(a,e),this.attackEndActivity.loop(o,e),this.longAttackHelper.loop()}getThirdPersonSkeletonLayers(){return makeMeleeSkeletonWeights("bluntHeavy",this.attackStartActivity,this.attackEndActivity)}}class WeaponMeleeBluntLight extends WeaponMelee{constructor(...t){super(...t,{thirdPersonParentName:"meleeHoldingPos",secondaryThirdPersonParentName:"meleeSecondaryPosLight",holdingHandlerManagerOptions:{downConfig:{posOffset:new Vector3(.2,.1,-.5),rotOffset:new Vector3(-1.3,.1,1),posFovMultiplierX:.4,posFovMultiplierY:.9,valuesSmoothing:.2,maxFov:90},upConfig:{posOffset:new Vector3(-.2,-.5,-.8),rotOffset:new Vector3(0,0,-.2),posFovMultiplierX:.7,posFovMultiplierY:0,valuesSmoothing:.1,maxFov:80}}}),this.hitSfxName="weapon/melee/bluntHit",this.hitSfxOptions={minPitch:1.3,maxPitch:1.4},this.longAttackHelper=new LongMeleeAttackHelper(this),this.lastActionDownTime=0,this.didHit=!1,this.lastHitTime=0,this.attackStartConfig={posOffset:new Vector3(-.2,-.3,-.8),rotOffset:new Vector3(.5,0,-.2),posFovMultiplierX:.5,posFovMultiplierY:0,valuesSmoothing:.3,maxFov:80},this.attackBounceConfig={posOffset:new Vector3(.1,-.1,-.4),rotOffset:new Vector3(-.5,0,0),posFovMultiplierX:0,posFovMultiplierY:0,valuesSmoothing:.3,maxFov:80},this.attackSwingConfig={posOffset:new Vector3(-.1,-.4,-.8),rotOffset:new Vector3(-1.5,0,.4),posFovMultiplierX:0,posFovMultiplierY:0,valuesSmoothing:.3,maxFov:80},this.attackStartActivity=new ActivityWeight,this.attackEndActivity=new ActivityWeight,this.attackEndActivity.onActiveChange((t=>{t&&(this.playSfx("weapon/melee/bluntSwing",{minPitch:1.4,maxPitch:1.6,volume:.03}),this.longAttackHelper.startAttacking())}))}getDamageMultiplier(){return.6}getStunData(){return{amount:.5,duration:200,fadeDuration:1100}}getWalkSpeedMultiplier(){return this.attackEndActivity.active&&!this.didHit?.8:1}getCooldownIsActive(){const t=this.didHit?200:600;return getMainInstance().now-this.lastActionDownTime<t*this.getAnimationDurationMultiplier()}getAnimationDurationMultiplier(){return lerp(1.5,.8,this.getAttackSpeedStat())}loop(t,e){super.loop(t,e);let i=null,s=!1,n=!1;const a=t-this.lastActionDownTime,o=t-this.lastHitTime,r=100*this.getAnimationDurationMultiplier(),l=(this.didHit?150:500)*this.getAnimationDurationMultiplier();a<r?(i=this.attackStartConfig,s=!0,this.didHit=!1):this.didHit?o<100&&(i=this.attackBounceConfig,n=!0):a<l&&(i=this.attackSwingConfig,n=!0),this.holdingHandlerManager.loop(a<1e3,this.player,{forceConfig:i}),this.longAttackHelper.isAttacking&&a>300&&this.longAttackHelper.stopAttacking(),this.attackStartActivity.loop(s,e),this.attackEndActivity.loop(n,e);this.longAttackHelper.loop()&&(this.didHit=!0,this.lastHitTime=t)}onActionDown(){this.getCooldownIsActive()||(this.lastActionDownTime=getMainInstance().now)}getThirdPersonSkeletonLayers(){return makeMeleeSkeletonWeights("bluntLight",this.attackStartActivity,this.attackEndActivity)}}class WeaponMeleePokeLight extends WeaponMelee{constructor(...t){super(...t,{thirdPersonParentName:"meleeHoldingPos",secondaryThirdPersonParentName:"meleeSecondaryPosPoke",holdingHandlerManagerOptions:{downConfig:{posOffset:new Vector3(.8,-.2,-.6),rotOffset:new Vector3(-1.7,0,1.2),posFovMultiplierX:-.3,posFovMultiplierY:.5,valuesSmoothing:.2,pitchHeightMultiplier:.1,minFov:60,maxFov:90},upConfig:{posOffset:new Vector3(0,0,-.5),rotOffset:new Vector3(-1.9,0,.2),posFovMultiplierX:.4,posFovMultiplierY:.5,valuesSmoothing:.2,minFov:60,maxFov:90}}}),this.hitSfxName="weapon/melee/pokeHit",this.lastActionDownTime=0,this.stamina=1,this.isAttacking=!1,this.attackEndActiveCountSinceStaminaReset=0,this.longAttackHelper=new LongMeleeAttackHelper(this),this.attackStartPos=new Vector3,this.attackEndPos=new Vector3,this.attackStartConfig={posOffset:this.attackStartPos,rotOffset:new Vector3(-1.9,0,0),posFovMultiplierX:.4,posFovMultiplierY:.5,valuesSmoothing:.1,minFov:60,maxFov:90},this.attackEndConfig={posOffset:this.attackEndPos,rotOffset:new Vector3(-1.6,0,0),posFovMultiplierX:.4,posFovMultiplierY:.5,valuesSmoothing:.8,minFov:60,maxFov:90},this.attackStartActivity=new ActivityWeight,this.attackEndActivity=new ActivityWeight,this.attackEndActivity.onActiveChange((t=>{t?(this.playSfx("weapon/melee/pokeSwing",{minPitch:1.2,maxPitch:1.3,volume:.03}),this.longAttackHelper.startAttacking(),this.attackEndActiveCountSinceStaminaReset++):(this.attackStartPos.set(randRange(-.1,.1),0,randRange(.1,.3)),this.attackEndPos.set(randRange(-.2,.1),-.1,randRange(-1.1,-.9)),this.longAttackHelper.stopAttacking())}))}getDamageMultiplier(){return.4}getAdditionalWalkAcceleration(){let t=0;return this.isAttacking&&this.attackEndActiveCountSinceStaminaReset<3&&(t=this.attackEndActivity.active?3.5:-1.5,2==this.attackEndActiveCountSinceStaminaReset&&(t*=.5)),new Vector2(0,-t)}getAdditionalWalkAccelerationClampLength(){return 3.5}getWalkSpeedMultiplier(){return this.actionIsDown?lerp(.5,1,this.stamina):1}getLookInputMultiplier(){return this.isAttacking?.8:1}getRangeMultiplier(){return 1.3}getToggleCooldownValue(){return 200}loop(t,e){super.loop(t,e);let i=null,s=!1,n=!1;if(this.actionIsDown&&(this.isAttacking=!0),this.isAttacking){const a=(t-this.lastActionDownTime)*lerp(.8,1.4,this.getAttackSpeedStat()),o=mod(a,350);o<100&&!this.actionIsDown&&!this.attackEndActivity.active?this.isAttacking=!1:o<100?(i={...this.attackEndConfig},s=!0,n=!0):(i={...this.attackStartConfig},s=!0),this.stamina-=5e-4*e}else this.stamina+=5e-4*e;this.stamina=clamp01(this.stamina),this.stamina>=1&&(this.attackEndActiveCountSinceStaminaReset=0),this.holdingHandlerManager.loop(this.isAttacking,this.player,{forceConfig:i}),this.attackStartActivity.loop(s,e),this.attackEndActivity.loop(n,e),this.longAttackHelper.loop()}onActionDown(){this.isAttacking||(this.lastActionDownTime=getMainInstance().now)}getThirdPersonSkeletonLayers(){return makeMeleeSkeletonWeights("pokeLight",this.attackStartActivity,this.attackEndActivity)}}class WeaponMeleePokeHeavy extends WeaponMelee{constructor(...t){super(...t,{thirdPersonParentName:"meleeHoldingPos",secondaryThirdPersonParentName:"meleeSecondaryPosPoke",holdingHandlerManagerOptions:{downConfig:{posOffset:new Vector3(1.3,.1,-.2),rotOffset:new Vector3(-1.9,0,1.2),posFovMultiplierX:-.3,posFovMultiplierY:.5,valuesSmoothing:.2,pitchHeightMultiplier:.1,minFov:60,maxFov:90},upConfig:{posOffset:new Vector3(0,0,-.5),rotOffset:new Vector3(-1.9,0,.2),posFovMultiplierX:.4,posFovMultiplierY:.5,valuesSmoothing:.2,minFov:60,maxFov:90}}}),this.hitSfxName="weapon/melee/pokeHit",this.chargeDuration=0,this.lastChargeDuration=0,this.lastActionUpTime=0,this.longAttackHelper=new LongMeleeAttackHelper(this),this.attackStartActivity=new ActivityWeight,this.attackEndActivity=new ActivityWeight,this.attackEndActivity.onActiveChange((t=>{t?(this.playSfx("weapon/melee/pokeSwing",{minPitch:.9,maxPitch:1.1}),this.longAttackHelper.startAttacking()):(this.didHitCurrentAttack=!1,this.longAttackHelper.stopAttacking())})),this.didHitCurrentAttack=!1,this.attackStartConfig={posOffset:new Vector3(0,0,.2),rotOffset:new Vector3(-1.9,0,0),posFovMultiplierX:.4,posFovMultiplierY:.5,valuesSmoothing:.1,minFov:60,maxFov:90},this.attackEndConfig={posOffset:new Vector3(-.1,.2,-1),rotOffset:new Vector3(-1.6,0,0),posFovMultiplierX:.4,posFovMultiplierY:.5,valuesSmoothing:.6,minFov:60,maxFov:90,walkBobMultiplier:.5}}getDamageMultiplier(){return.5}getWalkSpeedMultiplier(){return this.attackStartActivity.active?.4:1}getJumpForceMultiplier(){return this.attackStartActivity.active||this.attackEndActivity.active?.7:1}getCooldownDuration(){return lerp(700,400,this.getAttackSpeedStat())}getAdditionalWalkAcceleration(){let t=0;getMainInstance().now-this.lastActionUpTime<200&&(t=3);return t*=mapValue(100,this.getCooldownDuration(),0,1,this.lastChargeDuration,!0),new Vector2(0,-t)}getAdditionalWalkAccelerationClampLength(){return 3}getLookInputMultiplier(){return mapValue(200,500,0,1,getMainInstance().now-this.lastActionUpTime,!0)}getAttackCooldownActive(){return getMainInstance().now-this.lastActionUpTime<this.getCooldownDuration()}onActionUp(){this.getAttackCooldownActive()||(this.lastActionUpTime=getMainInstance().now,this.lastChargeDuration=this.chargeDuration,this.chargeDuration=0)}getRequiredVerticalAngleMultiplier(){return.4}getRequiredHorizontalAngleMultiplier(){return.4}getIsCharging(){return this.actionIsDown&&!this.getAttackCooldownActive()}loop(t,e){super.loop(t,e);let i=null,s=!1,n=!1;if(this.getIsCharging())this.chargeDuration+=e,i=this.attackStartConfig,s=!0;else{const e=lerp(400,200,this.getAttackSpeedStat());t-this.lastActionUpTime<e&&(i=this.attackEndConfig,n=!0)}this.holdingHandlerManager.loop(this.actionIsDown,this.player,{forceConfig:i}),this.attackStartActivity.loop(s,e),this.attackEndActivity.loop(n,e),this.longAttackHelper.loop()}onActionDown(){this.lastActionDownTime=getMainInstance().now}getThirdPersonSkeletonLayers(){return makeMeleeSkeletonWeights("pokeHeavy",this.attackStartActivity,this.attackEndActivity)}}function getConstructor(t){return t}const bowWeaponTypes={smallBow:getConstructor(WeaponSmallBow),mediumBow:getConstructor(WeaponMediumBow),largeBow:getConstructor(WeaponLargeBow),smallCrossbow:getConstructor(WeaponSmallCrossBow),repeatingCrossbow:getConstructor(WeaponRepeatingCrossbow),largeCrossbow:getConstructor(WeaponLargeCrossbow)},meleeWeaponTypes={bladedLight:getConstructor(WeaponMeleeBladedLight),bladedHeavy:getConstructor(WeaponMeleeBladedHeavy),bluntLight:getConstructor(WeaponMeleeBluntLight),bluntHeavy:getConstructor(WeaponMeleeBluntHeavy),pokeLight:getConstructor(WeaponMeleePokeLight),pokeHeavy:getConstructor(WeaponMeleePokeHeavy)};class WeaponSelectionItemUi{constructor({classId:t,keyNumber:e}){this.keyNumber=e,this.el=document.createElement("div"),this.el.classList.add("weaponSelectionItem"),this.classSelectionImage=new ClassSelectionImage(t,{extraClasses:["in-game"]}),this.el.appendChild(this.classSelectionImage.el),this.el.addEventListener("click",(()=>{for(const t of this.onClickCbs)t()})),this._selected=!1,this.keyEl=document.createElement("div"),this.keyEl.classList.add("weaponSelectionItemKeyNumber","blueNight"),this.keyEl.textContent=String(e),this.el.appendChild(this.keyEl),this.onClickCbs=new Set}get selected(){return this._selected}set selected(t){this._selected=t,this.el.classList.toggle("selected",t)}set needsAvatarUpdates(t){this.classSelectionImage.needsUpdates=t}onClick(t){this.onClickCbs.add(t)}setCssColor(t,e){this.classSelectionImage.setCssColor(t,e)}}let currentSelectedWeaponIndex=1;function getSelectedWeaponIndex(){return currentSelectedWeaponIndex}const onSelectionChangeCbs=new Set;function onWeaponSelectionChange(t){onSelectionChangeCbs.add(t)}function removeOnWeaponSelectionChange(t){onSelectionChangeCbs.delete(t)}function fireSelectionChangeCbs(){onSelectionChangeCbs.forEach((t=>t(currentSelectedWeaponIndex)))}let loadSelectedWeaponIndexCalled=!1;async function loadSelectedWeaponIndex(){if(loadSelectedWeaponIndexCalled)return;loadSelectedWeaponIndexCalled=!0;let t=await getMainInstance().indexedDb.get("selectedWeaponId");t=sanitizeSelectedWeaponId(t),isNaN(t)||t==currentSelectedWeaponIndex||(currentSelectedWeaponIndex=t,fireSelectionChangeCbs())}function sanitizeSelectedWeaponId(t){let e=Number(t);return isNaN(e)&&(e=1),e=mod(e,classConfigs.length),e}class WeaponSelectionDialogUi extends DialogUi{constructor(){super({allowCurtainClose:!1,needsCurtain:!1,needsUnlockedPointer:!1,startVisible:!1,extraClasses:["weaponSelectionDialog"]}),this.selectionItemsContainer=document.createElement("div"),this.selectionItemsContainer.classList.add("weaponSelectionContainer"),this.el.appendChild(this.selectionItemsContainer),this.weaponSelectionItems=[];for(const[t,e]of classConfigs.entries()){const i=e.id,s=new WeaponSelectionItemUi({classId:i,keyNumber:t+1});s.onClick((()=>{this.selectWeapon(t)})),this.weaponSelectionItems.push(s),this.selectionItemsContainer.appendChild(s.el)}this.updateSelectedUi(),this.boundPrevPress=()=>this.deltaSelectWeapon(-1),this.boundNextPress=()=>this.deltaSelectWeapon(1),this.prevKey=getMainInstance().input.getKey("prevWeapon"),this.prevKey.onPressedDown(this.boundPrevPress),this.nextKey=getMainInstance().input.getKey("nextWeapon"),this.nextKey.onPressedDown(this.boundNextPress),this.boundKeyDown=this.onKeyDown.bind(this),window.addEventListener("keydown",this.boundKeyDown),this.addOnVisibilityChangeCb((()=>{this.updateNeedsAvatarUpdates()})),this.addOnInertChangeCb((()=>{this.updateNeedsAvatarUpdates()})),this.boundUpdateSelectedUi=()=>{this.updateSelectedUi()},onWeaponSelectionChange(this.boundUpdateSelectedUi),loadSelectedWeaponIndex(),getMainInstance()}destructor(){super.destructor(),this.prevKey.removeCb(this.boundPrevPress),this.nextKey.removeCb(this.boundNextPress),window.removeEventListener("keydown",this.boundKeyDown),removeOnWeaponSelectionChange(this.boundUpdateSelectedUi),getMainInstance()}updateSelectedUi(){for(const[t,e]of this.weaponSelectionItems.entries())e.selected=t==currentSelectedWeaponIndex}updateNeedsAvatarUpdates(){const t=this.visible&&!this.inert;for(const e of this.weaponSelectionItems)e.needsAvatarUpdates=t}setCssColor(t,e){for(const i of this.weaponSelectionItems)i.setCssColor(t,e)}onKeyDown(t){for(const[e,i]of this.weaponSelectionItems.entries())t.code=="Digit"+i.keyNumber&&this.selectWeapon(e)}selectWeapon(t){return!!this.visible&&(currentSelectedWeaponIndex=sanitizeSelectedWeaponId(t),getMainInstance().indexedDb.set("selectedWeaponId",currentSelectedWeaponIndex),fireSelectionChangeCbs(),!0)}deltaSelectWeapon(t){return this.selectWeapon(currentSelectedWeaponIndex+t)}}const REQUIRED_MS_FOR_IN_AIR=200,TOGGLE_ACTIVE_WEAPON_ANIMATION_DURATION=150,SPHERE_DEATH_FADE_DURATION=5e3;class Player{constructor(t,e,i,s,n,a,o,{teamId:r=0,needsPlayerModel:l=!0,needsSkeleton:h=!0}={}){this.game=t,this.inputManager=e,this.sfxManager=i,this.physicsManager=s,this.settingsManager=n,this.hudIconsManager=a,this.id=o,this.hasOwnership=!1,this.creationTime=performance.now(),this.teamId=r,this.equippedSkinData={},this.isSameSquadPlayer=!1,this.isSquadLeader=!1,this.squadPlayerId=0,this.gender="male",this.walkSpeed=60,this.recentStunEvents=new Set,this.airWalkSpeedMultiplier=.4,this.flagWalkSpeed=45,this.jumpForce=8.6,this.ladderClimbSpeed=1,this.ladderTangentWalkSpeed=.5,this.health=1,this.lastHitTime=0,this.damageReceivedHistory=[],this.currentHealthRegenSfx=null,this.playerName="",this.playerNameVerified=!1,this.scoreFlags=0,this.scoreKills=0,this.scoreDeaths=0,this.scoreTotal=0,this.scoreSkillLevel=0,this.elo=0,this.serverPos=new Vector3,this.hasValidPosition=!1,this.recentForcedServerPositions=new Set,this.lastReceivedServerPosTime=0,this.maxPredictedServerPosDistance=3,this.predictedServerPos=new Vector3,this.lastPredictedServerVelocity=new Vector3,this.predictedServerVelocity=new Vector3,this.predictedServerAcceleration=new Vector3,this.serverPosSmooth=new Vector3,this.velocity=new Vector3,this.networkPosIsMovingUp=!1,this.antiFlyAccumulator=0,this.antiFlyInAirTimeRaw=0,this.antiFlyInAirTimeAccumulator=0,this.lastAntiFlyRaycastTime=0,this.lastAntiFlyRaycastDist=0,this.lastReceivedActionTime=0,this.pos=new Vector3,this.negativeHealthStartTime=0,this.prevHealthIsNegative=!1,this.negativeHealthCounter=0,this.cachedCamPos=new Vector3,this.cachedCamPosDirty=!0,this.cachedCamRot=new Quaternion,this.cachedCamRotDirty=!0,this.lookRot=new Vector2,this.deadLookRot=new Vector2,this.frontThirdPersonLookRot=new Vector2,this.smoothLookRotTarget=new Vector2,this.noSentDataChangeUpdateCount=0,this.lastSentPos=new Vector3,this.lastSentRot=new Vector2,this.lastPosSentTime=0,this.prevPos=new Vector3,this.smoothMovementSpeed=0,this.ping=0,this.positionHistory=[],this.rigidBody=new PlayerRigidBody(this.game.physics,this),this.physicsManager.registerRigidBody(this.rigidBody),this.boundOnJumpPress=this.onJumpPress.bind(this),this.boundOnFireDown=this.onFireDown.bind(this),this.boundOnFireUp=this.onFireUp.bind(this),this.boundToggleActiveWeapon=this.toggleActiveWeapon.bind(this),this.boundOnThirdPersonChange=this.onThirdPersonChange.bind(this),this.boundUpdateToggleWeaponTouchButtonVisibility=this.updateToggleWeaponTouchButtonVisibility.bind(this),this.boundUpdateSmoothCam=this.updateSmoothCam.bind(this),this.lastAirJumpPressTime=-1,this.prevWasOnFloor=!1,this.hasTouchedFloorEver=!1,this.lastJumpTime=0,this.lastJumpLandTime=0,this.lastJumpLandAmount=0,this.highestInAirPoint=0,this.currentFallingSfx=null,this.hasKeyEvents=!1,this.useFirstPersonHoldingHandlers=!1,this.noclip=!1,this.noclipSpeed=0,this.movementAccuracyOffset=null,this.holdingFlag=null,this.sentChangeFlagMessages=[],this.statClassValues=null,this.holdingHandlers=new Set,this.needsPlayerModel=l,this.loadingModel=null,this.activeModel=null,this.skeleton=null,h&&(this.skeleton=new PlayerSkeleton({player:this})),this.mostRecentWeaponSkeletonLayers=[],this.weaponActionIsDown=!1,this.bowWeapon=null,this.meleeWeapon=null,this.meleeWeaponId=null,this.hasActiveMeleeWeapon=!1,this.lastActiveWeaponToggleTime=0,this.didUpdateActiveWeaponAfterToggle=!1,this.recentlyDestroyedWeapons=new Map,this.lastSentArrowId=0,this.weaponAccuracyOffset=null,this.lastWeaponLayersKey="",this.weaponLayers=[],this.recentInvalidArrowTimes=[],this.dead=!1,this.currentSpawnId=0,this.dieTime=0,this.deadAnimationWeight=0,this.deadFallForward=!1,this.deadFromFall=!1,this.sphereDeathTimer=0,this.sphereDeathScreenFlash=null,this.didInitRespawn=!1,this.hasWalkedAwayFromSpawn=!1,this.lastRespawnPosition=new Vector3,this.onWeaponSelectionChangeFromDialog=()=>{this.updateMySelectedWeapon(),!this.dead&&this.hasOwnership&&this.sendMyEquippedSkinData()},this.onSkinConfigChange=()=>{this.hasOwnership&&this.sendMyEquippedSkinData()},getMainInstance().skins.onSkinConfigChange(this.onSkinConfigChange),this.smoothCamSetting=!1,this.smoothCamDebug=!1,this.smoothCam=!1,this.nextHitFlashIndex=0,this.obj=null,this.legsMoveT=0,this.legsMoveAmount=0,this.walkHeadBobAmount=0,this.legsMoveSpeed=2,this.lastSfxStep=0,this.updateUseFirstPersonHoldingHandlers(),this.icon=this.hudIconsManager.createIcon({url:"static/img/hudIcons/playerIcon.svg",size:.03}),this.destructed=!1}init(){this.skeleton&&(this.skeleton.init(),this.skeleton.addPoseLayer("baseRig"),this.equippingWeaponLayer=this.skeleton.addPoseLayer("equippingWeapon"),this.deadForwardLayer=this.skeleton.addPoseLayer("deadForward"),this.deadBackwardLayer=this.skeleton.addPoseLayer("deadBackward"),this.waitForSkeletonLoad()),this.resetDeadPoseWeights(),this.setPlayerEquippedSkinData(this.equippedSkinData),this.updateIconVisibility()}async waitForSkeletonLoad(){if(!this.skeleton)throw new Error("Player was created without a skeleton");await this.skeleton.waitForLoad(),this.destructed||this.updateModelVisibility()}destructor(){if(this.destructed)return;this.destructed=!0;const t=getMainInstance();this.obj&&t.scene.remove(this.obj),this.activeModel&&this.activeModel.destructor(),this.loadingModel&&this.loadingModel.destructor(),this.physicsManager.removeRigidBody(this.rigidBody),t.skins.removeOnSkinConfigChange(this.onSkinConfigChange),t.hudIcons.removeIcon(this.icon),this.setHasKeyEvents(!1),this.stopFallSound(),this.stopHealthRegenSound(),this.removeActiveBowWeapon(),this.removeActiveMeleeWeapon()}get sameSquadOrOwned(){return this.isSameSquadPlayer||this.hasOwnership}removeActiveBowWeapon(){this.bowWeapon&&(this.recentlyDestroyedWeapons.set(this.bowWeapon.bowWeaponId,performance.now()),this.bowWeapon.destructor()),this.bowWeapon=null}removeActiveMeleeWeapon(){this.meleeWeapon&&this.meleeWeapon.destructor(),this.meleeWeapon=null,this.updateToggleWeaponTouchButtonVisibility(),this.hasActiveMeleeWeapon&&this.toggleActiveWeapon()}setActiveBowWeapon(t,e=!1){if(this.bowWeapon&&t==this.bowWeapon.bowWeaponId&&!e)return;if(this.removeActiveBowWeapon(),t<0||t>=classConfigs.length)return;getMainInstance().renderer.renderWorthyEventHappened();const i=classConfigs[t],s=new(0,bowWeaponTypes[i.bowId])(this,t);this.bowWeapon=s,this.updateActiveWeapon(),this.hasOwnership&&getMainInstance().network.sendChangeSelectedClass(this.id,t)}updateActiveMeleeWeapon(){const t=getMainInstance().skins.skinNetworkDataToMeleeSkinConfig(this.equippedSkinData);t?(this.setActiveMeleeWeapon(t.meleeId),this.meleeWeapon&&this.meleeWeapon.updateMeleeAsset(t.skin)):this.setActiveMeleeWeapon(null)}setActiveMeleeWeapon(t){if(t!=this.meleeWeaponId){if(this.removeActiveMeleeWeapon(),this.meleeWeaponId=t,t){const e=meleeWeaponTypes[t];if(e){const t=new e(this);this.meleeWeapon=t,this.updateToggleWeaponTouchButtonVisibility()}}getMainInstance().renderer.renderWorthyEventHappened(),this.updateActiveWeapon()}}updateToggleWeaponTouchButtonVisibility(){if(!this.hasOwnership)return;const t=Boolean(this.meleeWeapon),e=getMainInstance().input.touch;e.toggleWeaponButton&&e.toggleWeaponButton.setVisibility(t)}get currentToggleWeaponCooldown(){let t=0,e=0;return this.bowWeapon&&(t=this.bowWeapon.getToggleCooldownValue()),this.meleeWeapon&&(e=this.meleeWeapon.getToggleCooldownValue()),Math.max(t,e)}get activeWeaponToggleCooldownActive(){return getMainInstance().now-this.lastActiveWeaponToggleTime<this.currentToggleWeaponCooldown}get activeWeapon(){return this.activeWeaponToggleCooldownActive?null:this.hasActiveMeleeWeapon?this.meleeWeapon:this.bowWeapon}updateMySelectedWeapon(t=!1){this.hasOwnership&&this.setActiveBowWeapon(getSelectedWeaponIndex(),t)}sendMyEquippedSkinData(){const t=getMainInstance(),e=classConfigs[getSelectedWeaponIndex()],i=t.skins.getClassSkinDataWithAppliedPreset(e.id);t.network.sendMySkinData(i)}getSendArrowId(){return this.lastSentArrowId++,this.lastSentArrowId>=65536&&(this.lastSentArrowId=0),this.lastSentArrowId}getClonedArrowObject(t){return this.bowWeapon?this.bowWeapon.getClonedArrowObject(t):null}loop(t,e){const i=this.prevPos.clone().sub(this.pos);this.prevPos=this.pos.clone();const s=getMainInstance();this.velocity=i.clone().multiplyScalar(1e3/-e);const n=this.game instanceof Game?this.game:null;if(this.didUpdateActiveWeaponAfterToggle||this.activeWeaponToggleCooldownActive||(this.didUpdateActiveWeaponAfterToggle=!0,this.updateActiveWeapon()),this.bowWeapon&&(this.bowWeapon.loop(t,e),this.weaponAccuracyOffset&&(this.weaponAccuracyOffset.offset=this.bowWeapon.getAccuracyOffset())),this.meleeWeapon&&this.meleeWeapon.loop(t,e),this.hasOwnership){if(!this.deadFromFall){let t=this.lookRot,e=.5*Math.PI;"front"==s.cam.thirdPersonMode&&(t=this.frontThirdPersonLookRot,e=1);const i=this.inputManager.lookInput.clone();if(this.activeWeapon&&i.multiplyScalar(this.activeWeapon.getLookInputMultiplier()),this.smoothCam)(n&&n.gameEndStepsReachedStatScreens||s.dialogManager.needsUnlockedPointer)&&i.multiplyScalar(.1),i.length()>.1&&s.renderer.renderWorthyEventHappened(1e4),this.smoothLookRotTarget.addScaledVector(i,-.002),t.lerp(this.smoothLookRotTarget,.1);else{i.length()>.1&&s.renderer.renderWorthyEventHappened();const e=s.cam.fovOffset,n=mapValue(0,180,1,.1,e,!0);t.addScaledVector(i,-.002*n)}t.y=clamp(t.y,.5*-Math.PI,e),this.cachedCamRotDirty=!0}let a=new Vector2;s.mainMenu.visible||s.dialogManager.needsUnlockedPointer||(a=this.inputManager.walkInput),a.length()>.01&&(s.renderer.renderWorthyEventHappened(),s.gameManager.joinIfNotJoined());const o=new Vector3(a.x,0,a.y);if(o.applyQuaternion(this.getClampedCamRot()),o.clampLength(0,1),this.activeWeapon){const t=this.activeWeapon.getAdditionalWalkAcceleration();if(t){const e=new Vector3(t.x,0,t.y);e.applyQuaternion(this.getCamRot()),o.add(e),o.clampLength(0,this.activeWeapon.getAdditionalWalkAccelerationClampLength())}}const r=o.length();this.noclip||(o.y=0),o.setLength(r);let l=this.holdingFlag?this.flagWalkSpeed:this.walkSpeed;this.rigidBody.isOnUnwalkableCollider?l=0:this.rigidBody.isOnSlipperyCollider?l*=.15:this.rigidBody.climbingLadder?l*=this.ladderClimbSpeed:this.rigidBody.isOnFloor||(l*=this.airWalkSpeedMultiplier);const h=.8;l*=1/(this.rigidBody.slowDownColliderAmount*h+1),l*=lerp(.9,1.1,this.getStatClassValue("movementSpeed")),this.activeWeapon&&(l*=this.activeWeapon.getWalkSpeedMultiplier());for(const e of this.recentStunEvents){const i=t-e.time;if(i<e.stun.duration+e.stun.fadeDuration){const t=e.stun.duration,s=t+e.stun.fadeDuration;l*=1-mapValue(t,s,e.stun.amount,0,i,!0)}else this.recentStunEvents.delete(e)}if(this.rigidBody.climbingLadder&&this.rigidBody.climbingLadderNormal){const t=o.dot(this.rigidBody.climbingLadderNormal),e=s.now-this.lastJumpTime>500&&!this.rigidBody.isOnFloor;let i=!0;if(t>0&&!e&&(i=!1),i){const t=new Quaternion;t.setFromUnitVectors(new Vector3(0,1,0),this.rigidBody.climbingLadderNormal),o.applyQuaternion(t)}const n=this.rigidBody.climbingLadderNormal.clone().cross(new Vector3(0,1,0));n.normalize();const a=o.dot(n),r=n.clone().multiplyScalar(a*(1-this.ladderTangentWalkSpeed));o.sub(r)}if(this.noclip&&(this.inputManager.getKey("flyUp").pressed&&(o.y+=1,s.renderer.renderWorthyEventHappened()),this.inputManager.getKey("flyDown").pressed&&(o.y-=1,s.renderer.renderWorthyEventHappened())),o.multiplyScalar(l),this.noclip&&this.noclipCamVelocity&&this.noclipCamPos){const t=e/1e3;this.noclipCamVelocity.addScaledVector(o,t*1.001**this.noclipSpeed),this.noclipCamVelocity.multiplyScalar(.1**t),this.noclipCamPos.addScaledVector(this.noclipCamVelocity,t)}else this.dead||this.rigidBody.applyForce(o);let d=0,c=0;const u=this.rigidBody.velocity,p=new Vector2(u.x,u.z);if(c=Math.max(0,u.y),d=p.length(),this.rigidBody.inAirTime<200&&!this.rigidBody.climbingLadder&&(this.legsMoveT+=d*(e/1e3)*this.physicsManager.timeScale),this.legsMoveAmount+=.005*e,this.legsMoveAmount=Math.min(this.legsMoveAmount,d),this.legsMoveAmount=clamp01(this.legsMoveAmount),this.walkHeadBobAmount+=3e-4*e,this.walkHeadBobAmount=Math.min(this.walkHeadBobAmount,d),this.walkHeadBobAmount=clamp01(this.walkHeadBobAmount),this.movementAccuracyOffset&&(this.movementAccuracyOffset.offset=10*c+2*d),!this.dead&&n){const t=1.5;if(this.holdingFlag)for(const e of n.getMyFlags(this.teamId)){e.defaultPosition.distanceTo(this.pos)<t&&this.sendChangeFlag(this.holdingFlag.id,NetworkManager.FlagChangeOperation.CAPTURE)}else for(const e of n.getEnemyFlags(this.teamId)){if(e.currentHoldingPlayer)continue;e.position.distanceTo(this.pos)<t&&this.sendChangeFlag(e.id,NetworkManager.FlagChangeOperation.GRAB)}let i=1/0,s=null;for(const e of n.getMyFlags(this.teamId))if(!e.isNearDefaultPos&&!e.currentHoldingPlayer){const n=e.position.distanceTo(this.pos);n<t&&n<i&&(i=n,s=e)}if(s){const t=n.gameTime/1e3,i=1/mapValue(5,60,300,1e4,t/60,!0);s.addReturnProgress(e*i),n.crosshair.setFlagReturnProgress(s.returnProgress),s.returnProgress>1&&this.sendChangeFlag(s.id,NetworkManager.FlagChangeOperation.RETURN)}n.crosshair.setFlagReturnProgressVisibility(null!=s)}const g=i.length()*e;this.smoothMovementSpeed=lerp(this.smoothMovementSpeed,g,.1);const m=Math.round(e/s.smoothDt);for(let t=0;t<m;t++)this.positionHistory.unshift(this.pos.clone());const f=Math.round(2e3/s.smoothDt);this.positionHistory.length>f&&this.positionHistory.splice(f);const w=s.mapLoader.mapVariablesManager.get("floorDeathHeight");"number"==typeof w&&this.pos.y<w&&this.dieFromFall();const b=s.mapLoader.mapVariablesManager.get("sphereDeathRadius");if("number"==typeof b&&b>0&&this.pos.length()>b?(this.sphereDeathTimer+=e,this.sphereDeathScreenFlash||(this.sphereDeathScreenFlash=getMainInstance().screenFlash.flash({color:new Vector3(1,.9,.6),autoFade:!1,hasDirection:!1})),this.sphereDeathTimer>5e3&&(this.die(),this.sphereDeathTimer=0)):this.sphereDeathTimer>0&&(this.sphereDeathTimer-=e,this.sphereDeathTimer=Math.max(0,this.sphereDeathTimer),this.sphereDeathScreenFlash&&this.sphereDeathTimer<=0&&(this.sphereDeathScreenFlash.shouldBeDestroyed=!0,this.sphereDeathScreenFlash=null)),this.sphereDeathScreenFlash){const t=this.sphereDeathTimer/5e3;this.sphereDeathScreenFlash.opacity=mapValue(0,.5,0,2,t,!0),this.sphereDeathScreenFlash.baseOpacity=mapValue(.5,1,0,1,t,!0)}for(const e of this.recentForcedServerPositions)(t>e.time+1e4||e.pos.distanceTo(this.pos)>10)&&this.recentForcedServerPositions.delete(e)}else{const i=s.now-this.lastReceivedServerPosTime,n=mapValue(0,800,1,0,i,!0);this.predictedServerPos.addScaledVector(this.predictedServerVelocity,e*n);const a=this.predictedServerPos.clone().sub(this.serverPos);a.clampLength(0,this.maxPredictedServerPosDistance-.01),this.predictedServerPos.copy(this.serverPos).add(a),i<100&&this.predictedServerVelocity.addScaledVector(this.predictedServerAcceleration,e);const o=.02;this.predictedServerVelocity.multiplyScalar((1-o)**e);const r=this.serverPosSmooth.clone();this.serverPosSmooth.lerp(this.predictedServerPos,1-.8**(e/16.66));const l=this.serverPosSmooth.clone().sub(r),h=new Vector2(l.x,l.z).length();this.rigidBody.inAirTime<200&&(this.legsMoveT+=h),this.legsMoveAmount+=.005*e,this.legsMoveAmount=Math.min(this.legsMoveAmount,1e3*h/e),this.legsMoveAmount=clamp01(this.legsMoveAmount),this.pos.distanceTo(this.serverPos)>this.maxPredictedServerPosDistance?(this.rigidBody.pos.copy(this.serverPos),this.serverPosSmooth.copy(this.serverPos),this.rigidBody.velocity.set(0,0,0)):this.rigidBody.pos.copy(this.serverPosSmooth);const d=Math.max(this.lastReceivedServerPosTime,this.lastReceivedActionTime);if(this.rigidBody.inAirTime>200&&!this.rigidBody.climbingLadder){if(t-d<200){const t=l.clone(),i=t.angleTo(new Vector3(0,1,0));t.multiplyScalar(mapValue(0,Math.PI,1,0,i,!0)),this.antiFlyAccumulator+=t.length(),this.antiFlyInAirTimeRaw+=e,this.antiFlyInAirTimeAccumulator+=e*mapValue(2,10,0,10,this.lastAntiFlyRaycastDist,!0)}}else this.antiFlyAccumulator=0,this.antiFlyInAirTimeRaw=0,this.antiFlyInAirTimeAccumulator=0;if(!this.dead&&this.hasTouchedFloorEver){const e=mapValue(17,30,0,1,this.antiFlyAccumulator,!0);let i=0;if(t-d<200&&(i=mapValue(0,1e4,0,1,this.antiFlyInAirTimeAccumulator,!0)),this.antiFlyInAirTimeRaw>5e3){if(t>this.lastAntiFlyRaycastTime+1e3){this.lastAntiFlyRaycastTime=t;let e=1/0;const i=this.pos,s=this.pos.clone();s.y-=10;const n=this.physicsManager.getRayCastCache(i,s);if(n){const t=this.physicsManager.rayCastMapColliders(n,(t=>!t.collider.ignoreArrows&&!(t.collider.slowDownPlayerAmount>0)));t&&t.dist<5&&(e=t.dist)}this.lastAntiFlyRaycastDist=e}}else this.lastAntiFlyRaycastDist=0;const s=Math.max(e,i);this.report(CheatKickReason.FLY,s)}}if(this.dead){const e=.004*(t-this.dieTime);this.deadAnimationWeight=1-Math.pow(2,-e),this.legsMoveAmount=Math.min(this.legsMoveAmount,1-this.deadAnimationWeight);const i=1+Math.pow(2,.05*-this.rigidBody.onFloorTime),s=Math.min(i,2*this.deadAnimationWeight);this.deadFallForward?this.deadForwardLayer&&(this.deadForwardLayer.weight=s):this.deadBackwardLayer&&(this.deadBackwardLayer.weight=s)}if(this.health<1&&!this.dead){const i=(t-this.lastHitTime)/1e3,s=lerp(8,0,this.getStatClassValue("healthRegenSpeed")),n=clamp01((.3*(i-s))**5);this.hasOwnership&&(n>.1?this.startHealthRegenSound():this.stopHealthRegenSound()),this.health+=5e-4*e*n,this.health=Math.min(1,this.health),this.hasOwnership&&this.updateHealthUi()}const a=this.health<0;if(a!=this.prevHealthIsNegative&&(this.prevHealthIsNegative=a,a&&(this.negativeHealthStartTime=t)),a&&!this.dead){t-this.negativeHealthStartTime>1e3&&(this.health=1,this.hasOwnership&&this.updateHealthUi(),this.negativeHealthCounter++,this.negativeHealthCounter>=2&&(this.report(CheatKickReason.INVULNERABLE,1),this.negativeHealthCounter=0))}const o=Math.floor((this.legsMoveTForCos+Math.PI/2)/Math.PI);if(o>this.lastSfxStep){this.lastSfxStep=o;const t=o%2==0?"L":"R";let e=.9,i=1.1;"female"==this.gender&&(e=1.4,i=1.8),this.sfxManager.playSound("player/walk"+t,{pos:this.getSfxPos(),minPitch:e,maxPitch:i})}this.activeModel&&this.activeModel.setHitFlashMaterialsTime(t),this.loadingModel&&this.loadingModel.setHitFlashMaterialsTime(t)}get legsMoveTForCos(){return this.legsMoveT*this.legsMoveSpeed}afterPhysicsLoop(t,e){if(this.prevWasOnFloor!=this.rigidBody.isOnFloor){if(this.prevWasOnFloor=this.rigidBody.isOnFloor,this.rigidBody.isOnFloor&&this.rigidBody.prevInAirTime>300){t-this.lastAirJumpPressTime<300&&this.lastAirJumpPressTime>=0&&this.rigidBody.getAllowJump()&&(this.lastAirJumpPressTime=-1,this.jump());const e=this.highestInAirPoint-this.pos.y;if(e>0){const i=this.sfxManager.cachedSfx["player/land"],s=mapValue(.5,20,0,i.opts.volume||0,e,!0);s>0&&(this.sfxManager.playSound("player/land",{volume:s,pos:this.getSfxPos(),minPitch:"female"==this.gender?1.1:.9,maxPitch:"female"==this.gender?1.2:1}),this.lastJumpLandTime=t,this.lastJumpLandAmount=s),this.hasTouchedFloorEver=!0}}this.highestInAirPoint=this.pos.y}if(this.rigidBody.isOnFloor||(this.highestInAirPoint=Math.max(this.highestInAirPoint,this.pos.y)),this.hasOwnership&&(this.rigidBody.inAirTime>50&&this.rigidBody.velocity.y<-3?this.startFallSound():this.stopFallSound(),!this.hasWalkedAwayFromSpawn&&this.game.gameStarted)){this.pos.distanceTo(this.lastRespawnPosition)>5&&(this.hasWalkedAwayFromSpawn=!0,this.setWeaponSelectionDialogVisibility(!1),getMainInstance().adBanners.setPageVisibility("respawn",!1))}if(this.holdingFlag&&this.holdingFlag.updateRenderPosition(),this.deadFromFall||this.pos.copy(this.rigidBody.pos),this.cachedCamPosDirty=!0,this.activeModel&&this.activeModel.isInit&&this.obj){this.obj.position.copy(this.pos);let e=this.lookRot;if(this.dead&&(e=this.deadLookRot),this.obj.rotation.y=e.x+Math.PI,this.obj.updateWorldMatrix(!1,!0),this.skeleton&&this.skeleton.isInit){this.activeWeapon&&(this.mostRecentWeaponSkeletonLayers=this.activeWeapon.getThirdPersonSkeletonLayers());const e=this.mostRecentWeaponSkeletonLayers;let i=t-this.lastActiveWeaponToggleTime;i-=this.currentToggleWeaponCooldown,i/=150,this.equippingWeaponLayer&&(this.equippingWeaponLayer.weight=Math.max(0,1-Math.abs(i)));const s=e.map((t=>t.name.replaceAll(",","\\,"))).join(",");if(s!=this.lastWeaponLayersKey){const t=[...this.weaponLayers];for(const e of t)this.skeleton.removePoseLayer(e);this.weaponLayers=[];for(const[t,i]of e.entries())this.weaponLayers[t]=this.skeleton.insertPoseLayer(t+1,i.name);this.lastWeaponLayersKey=s}for(const[t,i]of e.entries()){this.weaponLayers[t].weight=i.weight}this.skeleton.applyLayers();let n={};this.activeWeapon&&(n=this.activeWeapon.getThirdPersonSkeletonMultipliers(this.gender));let a=this.lookRot;this.dead&&(a=this.deadLookRot.clone(),a.y=lerp(this.deadLookRot.y,0,this.deadAnimationWeight)),this.skeleton.setLookRot